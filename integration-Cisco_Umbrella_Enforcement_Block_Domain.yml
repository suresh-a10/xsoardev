category: Network Security
commonfields:
  id: Cisco Umbrella Enforcement Block Domain
  version: -1
configuration:
- defaultvalue: https://s-platform.api.opendns.com
  display: Server URL (e.g., https://example.net)
  name: url
  required: true
  type: 0
- display: API Key
  name: api_key
  required: true
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Add and remove domains in Cisco OpenDNS.
detaileddescription: "Cisco Enforcement is part of the Cisco Umbrella package. When
  you log into the Cisco Umbrella portal you will need to \nobtain the API Token for
  the Cisco Enforcement Feature.\nOpenDNS enterprise security products have been rebranded
  to Cisco Umbrella.\n\nTo retrieve your key:\n1. Navigate to **Policies > Policy
  Components > Integrations**.\n2. Expand the appropriate integration or click **Add**
  to generate a custom integration.\n\nFor more information, see Cisco Umbrella:  [Umbrella
  Support](https://support.umbrella.com/hc/en-us/articles/231248748).\n\n\n---\n[View
  Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/cisco-umbrella-enforcement)"
display: Cisco Umbrella Enforcement Block Domain
image: data:image/png;base64,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
name: Cisco Umbrella Enforcement Block Domain
script:
  commands:
  - arguments:
    - description: Alert time of the new event in datetime format, e.g., 2013-02-08T09:30:26.0Z.
      name: alert_time
      required: true
    - description: Device ID of the new event.
      name: device_id
      required: true
    - description: Destination domain of the new event.
      isArray: true
      name: destination_domain
      required: true
    - description: Destination URL of the new event.
      name: destination_url
      required: true
    - description: Device version for the new event.
      name: device_version
      required: true
    - description: The destination IP address of the domain, specified in IPv4 dotted-decimal
        notation e.g., '8.8.8.8'.
      name: destination_ip
    - description: The partner threat level or rating, e.g., severe, bad, high, and
        so on.
      name: event_severity
    - description: Common name or classification of the threat.
      name: event_type
    - description: Variant or other descriptor of the event type.
      name: event_description
    - description: Path to the file exhibiting malicious behavior.
      name: file_name
    - description: SHA-1 of file reported by the appliance.
      name: file_hash
    - description: IP/Host of the infected computer/device that was patient 0 for
        the event.
      name: source
    - auto: PREDEFINED
      default: true
      defaultValue: "True"
      description: Block domain even if umbrella score is less
      name: disableDstSafeguards
      predefined:
      - "True"
      - "False"
    description: Posts a malware event to the API for processing and optionally adding
      to a customer's domain lists.
    name: umbrella-domain-event-add
  - arguments:
    - description: Number of page to return. Default is "1".
      name: page
    - defaultValue: "50"
      description: The maximum number of queries per page. Default is "50".
      name: limit
    description: List of domains.
    name: umbrella-domains-list
    outputs:
    - contextPath: UmbrellaEnforcement.Domains.name
      description: Name of the domains.
      type: String
    - contextPath: UmbrellaEnforcement.Domains.id
      description: ID of the domains.
      type: Number
    - contextPath: UmbrellaEnforcement.Domains.IsDeleted
      description: True if the domain has been deleted from list.
      type: Boolean
  - arguments:
    - description: ID of the domain.
      name: id
    - description: Name of the domain.
      name: name
    description: Delete domain.
    name: umbrella-domain-delete
  dockerimage: demisto/python3:3.10.6.33415
  runonce: true
  script: |
    register_module_line('Cisco Umbrella Enforcement', 'start', __line__())



    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()


    class Client(BaseClient):
        """
        Client to use in the Cisco Umbrella Enforcement integration. Overrides BaseClient
        """

        def __init__(self, base_url, verify, proxy, api_key):
            super().__init__(base_url=base_url, verify=verify, proxy=proxy, ok_codes=(200, 202, 204))
            self.api_key = api_key

        def get_domains_list(self, page: str = '', limit: str = '') -> list:
            domains_list: list = []
            response = self.get_domain_request(
                f'{self._base_url}domains?customerKey={self.api_key}&{prepare_suffix(page=page, limit=limit)}')
            limit = int(limit)
            while response and len(domains_list) < limit:
                response_data = response.get('data', [])
                for domain in response_data:
                    domain.pop('lastSeenAt')
                    domain['IsDeleted'] = False
                    domains_list.append(domain)
                response_next_page = response.get('meta', {}).get('next', '')
                if response_next_page:
                    response = self.get_domain_request(response_next_page)
                else:
                    break
            return domains_list

        def get_domain_request(self, request: str):
            return self._http_request('GET', url_suffix='', full_url=request)

        def delete_domains(self, domain_name: str, domain_id: str):
            url_suffix = f"domains/{domain_id}?customerKey={self.api_key}" if domain_id \
                else f"domains?customerKey={self.api_key}&where[name]={domain_name}"
            return self._http_request('DELETE', url_suffix,
                                      return_empty_response=True)

        def add_event_to_domain(self, event: dict):
            return self._http_request('POST', f"events?customerKey={self.api_key}", json_data=event,
                                      return_empty_response=True)


    def prepare_suffix(page: Optional[str] = '', limit: Optional[str] = '') -> str:
        """
        Create the relevant suffix for the domains command,
         Either there is a complete request that should be sent or page and limit arguments.
        :param page: The number of the requested page for domains command.
        :param limit: The limit of the queries to return from the domains command.
        :return: (str) with the suffix.
        """
        suffix = ''
        if page:
            suffix += f'page={page}&'
        if limit:
            suffix += f'limit={limit}&'
        return suffix


    def domains_list_command(client: Client, args: dict) -> CommandResults:
        """
        :param client: Cisco Umbrella Client for the api request.
        :param args: args from the user for the command.
        """
        page = args.get('page', '')
        limit = args.get('limit', '')
        response = client.get_domains_list(page=page, limit=limit)
        readable_output = tableToMarkdown(t=response, name='List of Domains', headers=['id', 'name'])
        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='UmbrellaEnforcement.Domains',
            outputs_key_field='id',
            outputs=response
        )


    def domain_event_add_command(client: Client, args: dict) -> str:
        """
        :param client: Cisco Umbrella Client for the api request.
        :param args: args from the user for the command.
        :returns (str) confirmation or error regarding adding a new domain.
        """
        alert_time = args.get('alert_time')
        device_id = args.get('device_id')
        dst_domain = argToList(args.get('destination_domain'))
        dst_url = args.get('destination_url')
        device_version = args.get('device_version')
        destination_ip = args.get('destination_ip')
        event_severity = args.get('event_severity')
        event_type = args.get('event_type')
        event_description = args.get('event_description')
        file_name = args.get('file_name')
        file_hash = args.get('file_hash')
        source = args.get('source')
        disableDstSafeguards = args.get('disableDstSafeguards')
        if disableDstSafeguards=="True":
            disableDstSafeguards=True
        else:
            disableDstSafeguards=False

        for domain in dst_domain:
            new_event = {
                "alertTime": alert_time,
                "deviceId": device_id,
                "deviceVersion": device_version,
                "dstDomain": domain,
                "dstUrl": dst_url,
                "eventTime": alert_time,
                "protocolVersion": "1.0a",
                "providerName": "Security Platform",
                "dstIP": destination_ip,
                "eventSeverity": event_severity,
                "eventType": event_type,
                "eventDescription": event_description,
                "fileName": file_name,
                "fileHash": file_hash,
                "src": source,
                "disableDstSafeguards":disableDstSafeguards
            }

            response: dict = client.add_event_to_domain(new_event)
            if id := str(response.get('id')):
                action_result = f"New event was added successfully, The Event id is {id}."
            else:
                action_result = "New event's addition failed."
            return action_result


    def domain_delete_command(client: Client, args: dict) -> CommandResults:
        """
        :param client: Cisco Umbrella Client for the api request.
        :param args: args from the user for the command.
        :returns (str) confirmation or error regarding deleting a domain.
        """
        response = {}
        domain_name = args.get('name', '')
        domain_id = args.get('id', '')
        if not domain_name and not domain_id:
            raise DemistoException(
                'Both domain name and domain id do not exist, Please supply one of them in order to set the domain to '
                'delete command')
        try:
            response = client.delete_domains(domain_id=domain_id, domain_name=domain_name)
        except Exception as e:
            # When deleting a domain by id and the id does not exist.
            if any(exp in str(e) for exp in ["Domain not in domain list", "Not Found"]):
                return CommandResults(
                    readable_output='The domain was not found in the list, Please insert an existing domain name or id.'
                )
        if domain_name:
            curr_context = demisto.dt(demisto.context(), f'UmbrellaEnforcement.Domains(val.name == "{domain_name}")')
        else:
            curr_context = demisto.dt(demisto.context(), f'UmbrellaEnforcement.Domains(val.id == "{domain_id}")')

        if curr_context:
            if isinstance(curr_context, list):
                curr_context = curr_context[0]
            curr_context['IsDeleted'] = True
        if response and int(response.status_code) == 204:  # type: ignore
            message = f"{domain_name if domain_name else domain_id} domain was removed from blacklist"
        else:
            # When deleting a domain by name, if name does not exist the returned code is 200 but the response is empty.
            message = f"{domain_name if domain_name else domain_id} domain not in the blacklist or Error"
        return CommandResults(
            readable_output=message,
            outputs_prefix='UmbrellaEnforcement.Domains',
            outputs_key_field='id',
            outputs=curr_context
        )


    def test_module(client: Client) -> str:
        """
        :param client: Cisco Umbrella Client for the api request.
        :return: 'ok' if there is a connection with the api and exception otherwise.
        """
        client.get_domains_list(limit='1', page='1')
        return 'ok'


    def main():
        params = demisto.params()
        base_url = f"{params.get('url')}/1.0/"
        api_key = params.get('api_key')
        verify = not params.get('insecure', False)
        proxy = params.get('proxy', False)
        command = demisto.command()

        commands = {
            'umbrella-domain-event-add': domain_event_add_command,
            'umbrella-domains-list': domains_list_command,
            'umbrella-domain-delete': domain_delete_command,
        }

        try:
            client = Client(base_url=base_url, api_key=api_key, verify=verify, proxy=proxy)

            if command == 'test-module':
                return_results(test_module(client))

            elif command in commands:
                return_results(commands[command](client, demisto.args()))

            else:
                raise NotImplementedError(f'Command "{command}" is not implemented.')

        except Exception as e:
            return_error(str(e))


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()

    register_module_line('Cisco Umbrella Enforcement', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: Cisco Umbrella Enforcement
