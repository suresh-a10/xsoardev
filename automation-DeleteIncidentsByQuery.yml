args:
- description: Max incidents to delete.
  name: size
- description: The query should be in the same format as used in incident page.
  name: query
  required: true
comment: Use this automation to delete incidents using query parameter with the same
  format as used in incidents search. Core REST API integration instance should be
  created.
commonfields:
  id: DeleteIncidentsByQuery
  version: -1
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.5.0
    itemVersion: 1.3.8
    packID: CommunityCommonScripts
    packName: Community Common Scripts
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
dependson:
  must: []
dockerimage: demisto/python3:3.11.10.115186
enabled: true
engineinfo: {}
mainengineinfo: {}
name: DeleteIncidentsByQuery
pswd: ""
runas: DBotWeakRole
runonce: false
script: |
  register_module_line('DeleteIncidentsByQuery', 'start', __line__())
  demisto.debug('pack name = Community Common Scripts, pack version = 1.3.8')




  def main():
      query = demisto.args().get('query')
      size = demisto.args().get('size')

      if size:
          incidents = demisto.executeCommand('SearchIncidentsV2', {'query': query, 'size': size})
      else:
          incidents = demisto.executeCommand('SearchIncidentsV2', {'query': query})

      try:
          incidents_data = incidents[0].get("Contents")[0].get("Contents").get("data")
          ids = []

          for item in incidents_data:
              i = item.get("id")
              ids.append(i)

          text_ids = ','.join(ids)
          demisto.executeCommand('core-delete-incidents', {'ids': text_ids})
      except TypeError:
          demisto.results("No incidents to delete according to the query")

      except ValueError as err:
          if "core-delete-incidents" in str(err):
              raise Exception("Please enable Core REST API integration")


  if __name__ in ['__main__', 'builtin', 'builtins']:
      main()

  register_module_line('DeleteIncidentsByQuery', 'end', __line__())
scripttarget: 0
subtype: python3
system: true
tags: []
type: python
