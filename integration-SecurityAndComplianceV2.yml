category: Email
commonfields:
  id: SecurityAndComplianceV2
  version: -1
configuration:
- additionalinfo: Password used to sign the certificate.
  advanced: true
  display: Certificate Password
  hidden: true
  name: certificate_password
  required: false
  section: Connect
  type: 4
- additionalinfo: A pfx certificate encoded in Base64.
  advanced: true
  display: Certificate
  hidden: true
  name: certificate
  required: false
  section: Connect
  type: 4
- additionalinfo: These fields are required for Delegated Access. Details regarding
    delegated access can be found here - https://xsoar.pan.dev/docs/reference/integrations/security-and-compliance#delegated-authentication
  display: UPN/Email
  displaypassword: Password
  hiddenpassword: true
  name: delegated_auth
  required: true
  section: Connect
  type: 9
- advanced: true
  display: The organization used in app-only authentication.
  name: organization
  required: false
  section: Connect
  type: 0
- advanced: true
  display: The application ID from the Azure portal
  name: app_id
  required: false
  section: Connect
  type: 0
- advanced: true
  defaultvalue: "false"
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  section: Connect
  type: 8
- advanced: true
  display: App Secret
  name: app_secret
  required: false
  section: Connect
  type: 4
- advanced: true
  display: Tenant ID
  name: tenant_id
  required: false
  section: Connect
  type: 0
- additionalinfo: Please refer to the documentation for a list of known endpoints.
  advanced: true
  defaultvalue: https://ps.compliance.protection.outlook.com/powershell-liveid/
  display: Connection URI
  name: connection_uri
  required: false
  section: Connect
  type: 0
- additionalinfo: Excluding /common or /<tenantID>
  advanced: true
  defaultvalue: https://login.microsoftonline.com
  display: AzureADAuthorizedEndpointURI Base
  name: azure_ad_authorized_endpoint_uri_base
  required: false
  section: Connect
  type: 0
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 5.5.0
    itemVersion: 1.5.1
    packID: MicrosoftExchangeOnline
    packName: Microsoft Exchange Online
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: This integration allows you to manage and interact with Microsoft security
  and compliance content search.
detaileddescription: "# O365 - Security And Compliance - Content Search V2\n\nThis
  integration enables you to manage the features that are available in the Security
  & Compliance Center from XSOAR.\n\nFor this integration, the UPN/Email is the account
  you wish to use in order to interface with Security & Compliance. \nThe account
  may require additional permissions and roles associated with it in order to execute
  all commands. \nPlease refer to the [documentation](https://xsoar.pan.dev/docs/reference/integrations/security-and-compliance-v2#authentication)
  for additional information.\n\nSupported authentication methods:\n- OAuth2.0 (For
  MFA enabled accounts) -\n    1. Fill in the UPN parameter in the integration configuration.\n
  \   2. Run the ***o365-sc-auth-start*** command and follow the instructions.\n    3.
  For testing completion of authorization process run the ***o365-sc-auth-test***
  command.\n\n## Security and Compliance Integration Changes\n\n### Overview\nIn response
  to Microsoft's deprecation of the App ID, the following changes to app registration
  in Azure are required:\n1. Add the `Exchange.Manage` delegated permissions.\n2.
  Enable \"Allow public client flows\" in the authentication section.\n3. Add an app
  secret to the app registration.\n\n### Step-by-Step Instructions\n\n#### 1. Add
  Exchange.Manage Delegated Permissions\n\n1. **Navigate to Azure Portal:**\n   Go
  to the [Azure Portal](https://portal.azure.com/) and sign in with your administrator
  account.\n\n2. **Access App Registrations:**\n   In the left-hand navigation pane,
  select **Azure Active Directory**. Then, under **Manage**, select **App registrations**.\n\n3.
  **Select Your App:**\n   Find and select the app registration you are working on.\n\n4.
  **Add Permissions:**\n   - Under **Manage**, select **API permissions**.\n   - Click
  on **Add a permission**.\n   - Select **APIs my organization uses**.\n   - Type
  \"Office\" in the search bar and select **Office 365 Exchange Online**.\n   - Choose
  **Delegated permissions**.\n   - Search for `Exchange.Manage` and check the corresponding
  box.\n   - Click on **Add permissions**.\n   - Ensure the permissions are granted
  for your organization by selecting **Grant admin consent for [Your Organization]**
  and confirming the action.\n\n#### 2. Enable \"Allow Public Client Flows\"\n\n1.
  **Navigate to Authentication Settings:**\n   From your app registration, under **Manage**,
  select **Authentication**.\n\n2. **Enable Public Client Flows:**\n   - Scroll down
  to the **Advanced settings** section.\n   - Locate the setting **Allow public client
  flows** and set it to **Yes**.\n   - Click **Save** at the top to apply the changes.\n\n####
  3. Add an App Secret\n\n1. **Navigate to Certificates & Secrets:**\n   From your
  app registration, under **Manage**, select **Certificates & secrets**.\n\n2. **Add
  a Client Secret:**\n   - Click on **New client secret**.\n   - Provide a description
  for the client secret.\n   - Choose an expiration period that meets your organization's
  security policy.\n   - Click **Add**.\n   - After the secret is created, copy the
  value immediately as it will not be displayed again. Store this secret securely,
  as it will be used in your application to authenticate.\n\n\n### Additional Resources\n-
  [Azure Active Directory App Registrations](https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app)\n-
  [API Permissions in Microsoft Graph](https://docs.microsoft.com/en-us/graph/permissions-reference)\n-
  [Configure Authentication in Azure AD](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow)\n-
  [Add a Client Secret](https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#option-2-create-a-new-application-secret)\n\nThese
  steps will ensure your app registration is updated correctly to maintain the necessary
  functionality after Microsoft's deprecation of the App ID. If you have any questions
  or run into issues, please refer to the provided documentation links or contact
  your Azure support team.\n\n---\n[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/security-and-compliance-v2)"
display: O365 - Security And Compliance - Content Search v2
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAAAXNSR0IArs4c6QAADIVJREFUeAHtXHt0FNUZv/fOYzebJ3k1CQ8THiaBBLAEiuIRAu2hoqinSrR6xIqeoq1gRast2rr8UThYPT5QKigeDvScUkCl1lePWiggL4MYFWMMLxMgaTYk2WR3Z+dx7+13JxGBJmQ3BJgN+U4mMztzHzPf737f/b7vfjMYXQLEEcJos1ea21SWUdUSzg1o+PKcZNeiIQr62Uu3jfy0L7NA7ksPZwM5BUmPPeSLqzrRMPh4IDysNmiMzOB0tL6djKC8ZRjjPJViBVWeCKH7ipNpX3r+zp4lZgEGMAniXJr28s7MFtM1tMGkBUMYv0K3+KhARVUuZySLEqJSJEExghADLDmDDWoiHbkUAj/6PjkeYFsqvUiae3lVylet5sCmkJ7fRq3R2RYr1hbvHGoYbBDF4RQmKYhxDEACbgz2Akza5wW02xHqKICFVK6tqI/72z5fVnMofHlDiBRkWdaoMLVGWQdP5FFK0ylRJQpTajuIUEMIpACV6t0+7KVYwDEAZyz5+Pl0JuVbbx8YYZhYqFdPu3oVYIKKtdUrHFPjUsSpx8/sGIBPGMp8G0RbvYJYUgseSmz9dC4ccAzAyOpXsecCZFd1Qff1U1/mgHMk+CJyGSYEmNzB7eoFElZCLzTTa030AwysnLyi/OffhMhcFu65AUdgjGAiaWNUa/1n/vdXY6/XEX52HwIYZEfIYfu/dqs7Qjlo0HFug4avQYbwuXpKoi5HfpNMn5o1swUh7xs9bak368UQwICerNr4EQzH4DYRsQNrW+wwYjpIURh+BCBaxUyGIbAVIWAYGrN96W6sdtyFFrf7ae8rbCKUlpSyGkDqBzjykYqRR0XNOfFog85oYxxRmjjiTUR1t0im0ZzgSWpNdfMADVttlw0YEPq2pWn81nrrA93sBrCOG4jjKKQS1GxJ0gDWWfQLgJUFtpw3wQA6Y9TACYaSKIcAt7gEYDMuJ0b+bOe3ZGxIMCEoXiGHqhZMeACkFWTk7PST5XtMGABnL3TK1fEu9Gp6Bt54pF564ts26X7LFF101AdwVRlrYzKUB5BO35FMelrDASiZlOC6fo/PXGWZHfaVCMo4hGIDYGAWhdUDWPLjqNTbLessiiMT3Y6WVs4tCcFhiM9C8/LG7/LVIemPZof0KyC6eUl83u77x7/WVcelK8r3d6G8u6pywc7HDMBncsTr9ZKjRTcXyUx1n3mtJqgV86ZuBf1ktVXbfYl+PZyEpg0+fnjDxEVjn9+buL8FP4RBegtT2Cv75l+5GjQHWry1OkOicS5RkWqavnDGCJ/dCOhke+/Af469se54lTrhjoSVn/ve9VtkIFhapxSHORHmQdOKXE2+9kXNvZUh6cmnl2xf+eLU3KUN/67N58SFBrv0TxYWJy2Axjm4UvOf2dn0OKXMDf4QSnPxCl6+YhoumRv5SDrlLi/UYcwCHAoQ3GoyosFsa8ewz4FjPoO7WkJWssyk387/T81Mn44KXFhvGJul3jWrdFSwdOW++Xsa9Gd1g4rRY4dEMOcp59DlBavq1KkjIgaAW3SawRNRpU4KSQAb/CHLstDxAC8gkoRyEvnCN2ePq5wM4O4W4OoWFBFaQXTJERauVQxQzEpwWGkVmLgRLPTDemI7q2kHAOfAe0xklC7TD6sXXLVmwrJdd++pDz1jmCKT4IyxxL+fd1VFMTF3pqaOWYCTTE0fkqxuqg/hzKBuIsqYlJWgZPtNKzWg4yFiHo6eMHJJNDxjROLDE5fvufWLRrbCsCDnxw6sfN8egUGV5eZfo7fr7Mm/uiU01U5CiL7D814jZgFeUHaVBiy/FzgkDNx27r87T82vuqMsRPEaakYeV6aMSzanJRllx7F/VjUG8z73sVcNisBL4m2AsGZgNZNbIKXgkw+KY7tfmzl8Dhrh5WNe2DXnqya+CLJNzjtYPekgpudgoTdhs1ME7OMZy3S/haPmdKab1Kki7gkg1Qf5tPJ66+865eAOcZQaLx+bOyZj+tB4ssyjyiYCFd4YZtnz3jv446v/su/2b/x8BWgPiKF+L+E9AeJ81YlpgDtjCqMsqiCHaGNb6sE1RSn4adWlIM3iqTpFLtuggrm8McgLNh3wP7t8Suofpg2Mn5Kqsu0aUoZ82Wy9vrc+tAYsa/lcrfjOnqO3zsWsivau369WmujGD462tRimruclxKHBKW50rNUobhER/yjocVdh+p4hrz9ZYFznO8KUpeYp6p2BZV0bIlNmf/Tfd2bnqdf9YbQ89fZtaFFNK3/U4BhUu7ON6ZgFGCmG56MD2gpYnhuAwaCt8luoujUImpKBpo2O6Zvr9DlDtRsmX53tfkTmAfJ1q7SYU/B5Yb71SJyGTZM06OqkVdXGO1/V6DdVPVL6+I9e3Lujus1c4ddJDqLRDagoxt45F41ZFe02k7hBuQZAQE47Ax+WIgPix0YUEazvuNdiIFajSdPXVzXt+DZoXI+gLQxLkyky33/zsJQ5qkJMbupiuWnSNt21acYLW9P3PDDu7Ruz5GlZHrxTlHUqxSzAvc5QSMeFxaDEkEUmcVnBCTKtunek/NNtxwMFBpJsBLlloDYAeWeb/OaUlzZnrb675Os7c6VrM1T6vvCfnUgxC7AIdBDMPUgBY1dIkAh4EJgSIU58MqsjWo4L3xl83niJVhV76Iwqf2JSncYeZPbyYXtjNshUmXSo1f0KX79eWlpW4i9KUv+ktDta0fZ43ss7c9hF8NgjTTU0PJktqWzS0xNceHDAYImShDMYJymMsR+AnZUctesCUpiisNpJGcrNb6X8+ejwmoe36EzynGlIcZhzgwrPQ0ObxWiiTBHpIM50k2IW4LKyUSKS8ZQYC7DoDk4sbLNm4S1PrVdu+evOe3RZflFIW0Qk4BHgqqz2mgz3DZt+ecX+0c+VP1ar8StVrGscQt7gAMed6g5BcOSkv82pCHU5k2JLRfu8nYqJHeQQAY8NG2hpHg6fCJhtsBwQMcddYIZnqbz+6kzP9QDuZzNe/fSaA23WkyLhqyQr7jeFae5b4t2K3wV6WIUEAFWWkCdG3k6MIQnG0sejfR7unaUh7xYRverSF5JkFtUy08RsZXVynLJ26cxRNfetqcjceDS4SqdSnEeix2/KSXjjkZn5jbPXVU5o0klKyIQwh6IgjxFuQyVzow6qRDzqeqlgbAAM7/b6NVJ47YbqClVZ7CNL0LFsjGrcRD6a4SE+i9PaAYpSn+NJavzduGEtEzZuJ1oUDHq5bOwxURwWKNx5T+9e3WxKw8VLbmEk5yz5vHHdnWsqbl9zW+E3Zzb5nY4gWMzBzqTYABh4BzlZStAkeUGM89qtZUg0h/NHdYYwDAAMKwES0VrfONLQoBCcEDaMiM0eYQ2vHDAuYeyyT547HibX8o73pBik5LZgddpH9eF/3bq6/JZ1d42r6QzG6as+TT+LQumsygU7FzMA2xwR67xiFhZv6wOJw5OWDsIK5EKnAeppYBXBLnKhmuwf/ouKw/4nQpqVe+aqkDDU6oPy2LeOmDtSF+9s/H8gCSRbsgwT8gFOku2qnfx1UQ9iC+CzsgrgFn6sQB2oY9f+o5v/9SGW2WaS3C6/CADrFzommbrOM9v97FMbFH0CuN8lGQiDmrK2U0tczOM+BHDP2QivNUBlcCgikbyuEglEXdhUt4p8geCven43vVuzH2Dg52XxUpOGpIMUXn7pKREYIEGLN+bFm//Yer+2DjsE4n6AAdEP7/nhqjpUtzYbZUej2U8bC3V1CGevLDXwwi0WfvC0Sxf1Rz/AwH6M7TchHO/T9mSk9Fwn9aS3/joXnAOOkWAMq0K2/XLaB8t6rDEvOCOd2qFjAIZVnF+7JFwEHzMrChg8lzL4lBKWFWp/0A6APg14p7LTefflGIBP/H7icoARI/jW5KJHqz2fHDeHHNNCw5tCKD9IaTFHpChM8SDOWJoFr+LaAQ57lQ6OmJD0fmnvbHg5BmBxcyJcgLbAx7G2jGiFn192bAI6jMrL5bsPpaXVBAJDj7Vp+ZCdM7rVRPmagYZZBA2E96/jYRBASBNqnZT2yKNZUKtPkqMA7orDNvAlJSKzrb5j2yHKApZk0ebD6vbDjTmBsJTfEDALwpwXBy1WCEDnQfgwnRFZYvYHSQFskVF7iUl7TAAswOyMAHiGSvPCcO1Qx/aeLe3w8dKFoyuTdzXQQbUBbYRu0TGgEgogEaOQUTzYQiRJUmBB11Khib5NMQ1wZ9DY0u4V30AsPAHXxVYB20Yh7WCmS2Vr92YfaFVzMzx8wqB4ubmzNvrSuf8BON13AZrf558AAAAASUVORK5CYII=
name: SecurityAndComplianceV2
script:
  commands:
  - arguments: []
    description: OAuth2.0 - Start authorization.
    name: o365-sc-auth-start
  - arguments: []
    description: OAuth2.0 - Complete authorization.
    name: o365-sc-auth-complete
  - arguments: []
    description: OAuth2.0 - Test authorization.
    name: o365-sc-auth-test
  - arguments:
    - description: |
        The name of the compliance search.
        If not specified, will have the prefix "XSOAR-" followed by the GUID e.g., XSOAR-d6228fd0-756b-4e4b-8721-76776df91526.
      name: search_name
    - description: The name of a Core eDiscovery case to associate with the new compliance
        search.
      name: case
    - description: Text search string or a query that is formatted using the Keyword
        Query Language (KQL).
      name: kql
    - description: Description of the compliance search.
      name: description
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search. Default is "false".
      name: allow_not_found_exchange_locations
      predefined:
      - "true"
      - "false"
    - defaultValue: All
      description: Comma-separated list of mailboxes/distribution groups to include,
        or you can use the value "All" to include all.
      isArray: true
      name: exchange_location
    - description: Comma-separated list of mailboxes/distribution groups to exclude
        when you use the value "All" for the exchange_location parameter.
      isArray: true
      name: exchange_location_exclusion
    - description: Comma-separated list of public folders to include, or you can use
        the value "All" to include all.
      isArray: true
      name: public_folder_location
    - description: Comma-separated list of SharePoint online sites to include. You
        can identify the sites by their URL value, or you can use the value "All"
        to include all sites.
      isArray: true
      name: share_point_location
    - description: Comma-separated list of SharePoint online sites to exclude when
        you use the value "All" for the share_point_location argument. You can identify
        the sites by their URL value.
      isArray: true
      name: share_point_location_exclusion
    description: Create compliance search in the Security & Compliance Center.
    name: o365-sc-new-search
    outputs:
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.AllowNotFoundExchangeLocationsEnabled
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.AzureBatchFrameworkEnabled
      description: Whether the Azure Batch Framework is enabled for job processing.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CaseId
      description: Identity of a Core eDiscovery case which is associated with the
        compliance search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CaseName
      description: Name of a Core eDiscovery case which is associated with the compliance
        search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.ContentMatchQuery
      description: Compliance text search string or a query that is formatted using
        the Keyword Query Language (KQL).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CreatedBy
      description: Security and compliance search creator.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CreatedTime
      description: Security and compliance search creation time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Description
      description: Security and compliance search description.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Errors
      description: Security and compliance search errors.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.ExchangeLocation
      description: Security and compliance search exchange locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Identity
      description: Security and compliance search identity.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.IsValid
      description: Whether the security and compliance search is valid.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Items
      description: The number of security and compliance search scanned items.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobEndTime
      description: Security and compliance search job end time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobId
      description: Security and compliance search job ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobRunId
      description: Security and compliance search job run ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobStartTime
      description: Security and compliance search job run start time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.LastModifiedTime
      description: Security and compliance search last modification time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.LogLevel
      description: Security and compliance search Azure log level.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Name
      description: Security and compliance search name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.OneDriveLocation
      description: Security and compliance search OneDrive locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.OneDriveLocationExclusion
      description: Security and compliance search OneDrive locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.PublicFolderLocation
      description: Security and compliance search public folder locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.PublicFolderLocationExclusion
      description: Security and compliance search public folder locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.RunBy
      description: Security and compliance search last run by UPN (Email representation).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.RunspaceId
      description: Security and compliance search run space ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SharePointLocation
      description: Security and compliance search SharePoint locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Size
      description: Security and compliance search bytes results size.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Status
      description: Security and compliance search status.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.TenantId
      description: Security and compliance search Tenant ID.
      type: String
  - arguments:
    - description: The name of the compliance search.
      name: search_name
      required: true
    - description: Modify the text search string or a query that is formatted using
        the Keyword Query Language (KQL).
      name: kql
    - description: Modify the description for the compliance search.
      name: description
    - auto: PREDEFINED
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      name: allow_not_found_exchange_locations
      predefined:
      - "true"
      - "false"
    - description: Comma-separated list of added mailboxes/distribution groups to
        include, or you can use the value "All" to include all mailboxes.
      isArray: true
      name: add_exchange_location
    - description: Comma-separated list of added mailboxes/distribution groups to
        exclude when you use the value "All" for the exchange_location (used in create
        new compliance search) or the add_exchange_location argument.
      isArray: true
      name: add_exchange_location_exclusion
    - description: Comma-separated list of added public folders to include, or you
        can use the value "All" to include all.
      isArray: true
      name: add_public_folder_location
    - description: Comma-separated list of added SharePoint online sites to include.
        You identify the sites by their URL value, or you can use the value "All"
        to include all sites.
      isArray: true
      name: add_share_point_location
    - description: Comma-separated list of added SharePoint online sites to exclude
        when you use the value "All" for the exchange_location (used in create new
        compliance search) argument or the share_point_location argument. You can
        identify the sites by their URL value.
      isArray: true
      name: add_share_point_location_exclusion
    - description: Comma-separated list of removed mailboxes/distribution group to
        include.
      isArray: true
      name: remove_exchange_location
    - description: Comma-separated list of removed mailboxes/distribution group to
        exclude when you use the value "All" for the exchange_location (Used in create
        new compliance search) or the add_exchange_location argument.
      isArray: true
      name: remove_exchange_location_exclusion
    - description: Comma-separated list of removed public folders to include.
      isArray: true
      name: remove_public_folder_location
    - description: Comma-separated list of removed SharePoint online sites to include.
        You can identify the sites by their URL value.
      isArray: true
      name: remove_share_point_location
    - description: Comma-separated list of removed SharePoint online sites to exclude
        when you use the value "All" for the exchange_location (Used in create new
        compliance search) argument or the share_point_location argument. You can
        identify the sites by their URL value.
      isArray: true
      name: remove_share_point_location_exclusion
    description: Modifies non-running compliance searches in the Security & Compliance
      Center.
    name: o365-sc-set-search
  - arguments:
    - description: The name of the compliance search.
      name: search_name
      required: true
    description: Remove compliance search by name from the Security & Compliance Center.
    name: o365-sc-remove-search
  - arguments: []
    description: List compliance searches in the Security & Compliance Center.
    name: o365-sc-list-search
    outputs:
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.AllowNotFoundExchangeLocationsEnabled
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.AzureBatchFrameworkEnabled
      description: Whether the Azure Batch Framework is enabled for job processing.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CaseId
      description: Identity of a Core eDiscovery case which is associated with the
        compliance search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CaseName
      description: Name of a Core eDiscovery case which is associated with the compliance
        search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.ContentMatchQuery
      description: Compliance text search string or a query that is formatted using
        the Keyword Query Language (KQL).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CreatedBy
      description: Security and compliance search creator.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CreatedTime
      description: Security and compliance search creation time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Description
      description: Security and compliance search description.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Errors
      description: Security and compliance search errors.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.ExchangeLocation
      description: Security and compliance search exchange locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Identity
      description: Security and compliance search identity.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.IsValid
      description: Whether the security and compliance search is valid.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Items
      description: The number of security and compliance search scanned items.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobEndTime
      description: Security and compliance search job end time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobId
      description: Security and compliance search job ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobRunId
      description: Security and compliance search job run ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobStartTime
      description: Security and compliance search job run start time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.LastModifiedTime
      description: Security and compliance search last modification time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.LogLevel
      description: Security and compliance search Azure log level.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Name
      description: Security and compliance search name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.OneDriveLocation
      description: Security and compliance search OneDrive locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.OneDriveLocationExclusion
      description: Security and compliance search OneDrive locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.PublicFolderLocation
      description: Security and compliance search public folder locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.PublicFolderLocationExclusion
      description: Security and compliance search public folder locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.RunBy
      description: Security and compliance search last run by UPN (Email representation).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.RunspaceId
      description: Security and compliance search run space ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SharePointLocation
      description: Security and compliance search SharePoint locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Size
      description: Security and compliance search bytes results size.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Status
      description: Security and compliance search status.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.TenantId
      description: Security and compliance search Tenant ID.
      type: String
  - arguments:
    - description: The name of the compliance search.
      name: search_name
      required: true
    - defaultValue: "100"
      description: The maximum number of results to return. If you want to return
        all requests that match the query, use "-1" for the value of this argument.
      name: limit
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to include mailboxes which have no results in results entry
        context.
      name: all_results
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to export search results as json file to war-room.
      name: export
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      defaultValue: "false"
      description: Show search statistics. Default is "false".
      name: statistics
      predefined:
      - "true"
      - "false"
    description: Gets compliance search by name from the Security & Compliance Center.
    name: o365-sc-get-search
    outputs:
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.AllowNotFoundExchangeLocationsEnabled
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.AzureBatchFrameworkEnabled
      description: Whether the Azure Batch Framework is enabled for job processing.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CaseId
      description: Identity of a Core eDiscovery case which is associated with the
        compliance search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CaseName
      description: Name of a Core eDiscovery case which is associated with the compliance
        search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.ContentMatchQuery
      description: Compliance text search string or a query that is formatted using
        the Keyword Query Language (KQL).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CreatedBy
      description: Security and compliance search creator.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.CreatedTime
      description: Security and compliance search creation time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Description
      description: Security and compliance search description.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Errors
      description: Security and compliance search errors.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.ExchangeLocation
      description: Security and compliance search exchange locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Identity
      description: Security and compliance search identity.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.IsValid
      description: Whether the security and compliance search is valid.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Items
      description: Number of security and compliance search scanned items.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobEndTime
      description: Security and compliance search job end time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobId
      description: Security and compliance search job ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobRunId
      description: Security and compliance search job run ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.JobStartTime
      description: Security and compliance search job run start time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.LastModifiedTime
      description: Security and compliance search last modification time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.LogLevel
      description: Security and compliance search the Azure log level.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Name
      description: Security and compliance search name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.OneDriveLocation
      description: Security and compliance search OneDrive locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.OneDriveLocationExclusion
      description: Security and compliance search OneDrive locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.PublicFolderLocation
      description: Security and compliance search public folder locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.PublicFolderLocationExclusion
      description: Security and compliance search public folder locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.RunBy
      description: Security and compliance search last run by UPN (Email representation).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.RunspaceId
      description: Security and compliance search run space ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SharePointLocation
      description: Security and compliance search SharePoint locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Size
      description: Security and compliance search bytes results size.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.Status
      description: Security and compliance search status.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.TenantId
      description: Security and compliance search Tenant ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SuccessResults.Location
      description: Security and compliance search result location.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SuccessResults.ItemsCount
      description: The number of security and compliance search results in location.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SuccessResults.Size
      description: The byte size of the security and compliance search results in
        location.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.Search.SearchStatus
      description: The status indicating whether or not the search for a given search_name
        was successful.
      type: String
  - arguments:
    - description: The name of the compliance search.
      name: search_name
      required: true
    description: Starts stopped, completed, or not started compliance search in the
      Security & Compliance Center.
    name: o365-sc-start-search
  - arguments:
    - description: The name of the compliance search.
      name: search_name
      required: true
    description: Stop running compliance search in the Security & Compliance Center.
    name: o365-sc-stop-search
  - arguments:
    - description: The name of the compliance search.
      name: search_name
      required: true
    - auto: PREDEFINED
      defaultValue: Preview
      description: 'Search action to perform. Possible values are: "Preview" and "Purge".
        Default is "Preview".'
      name: action
      predefined:
      - Preview
      - Purge
      - Export
    - auto: PREDEFINED
      defaultValue: SoftDelete
      description: 'Purge type. Possible values are: "Soft Delete" and "HardDelete".
        Default is "SoftDelete".'
      name: purge_type
      predefined:
      - SoftDelete
      - HardDelete
    - auto: PREDEFINED
      description: 'Specifies how to export SharePoint and OneDrive search results.
        IndividualMessage: Export the files uncompressed. This is the default value.
        PerUserZip: One ZIP file for each user. Each ZIP file contains the exported
        files for the user. SingleZip: One ZIP file for all users. The ZIP file contains
        all exported files from all users. This output setting is available only in
        PowerShell. To specify the format for Exchange search results, use the exchange_archive_format
        parameter.'
      name: share_point_archive_format
      predefined:
      - IndividualMessage
      - PerUserZip
      - SingleZip
    - auto: PREDEFINED
      description: 'Specifies the format of the search results when you use the Export
        action. Valid values are: FxStream: Export to PST files. This is the only
        option that''s available when you export search results from the Microsoft
        Purview compliance portal. Mime: Export to .eml message files. This is the
        default value when you use cmdlets to export the search results. Msg: Export
        to .msg message files.'
      name: format
      predefined:
      - FxStream
      - Mime
      - Msg
    - auto: PREDEFINED
      description: Specifies whether to export previous versions of the document when
        you use the Export action.
      name: include_sharepoint_document_versions
      predefined:
      - "true"
      - "false"
    - description: Specifies the email address target for the search results when
        you use the Export action.
      name: notify_email
    - description: Specifies the cc email address target for the search results when
        you use the Export action.
      name: notify_email_cc
    - auto: PREDEFINED
      description: Specifies the scenario type when you use the Export action.
      name: scenario
      predefined:
      - AnalyzeWithZoom
      - General
      - GenerateReportsOnly
      - Inventory
      - RetentionReports
      - TriagePreview
    - auto: PREDEFINED
      description: Specifies the items to include when the action is Export.
      name: scope
      predefined:
      - IndexedItemsOnly
      - UnindexedItemsOnly
      - BothIndexedAndUnindexedItems
    description: After you create a content search using the o365-sc-new-search command
      and run it using the o365-sc-start-search command, you assign a search action
      to the search using the o365-sc-new-search-action command.
    name: o365-sc-new-search-action
    outputs:
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Action
      description: Security and compliance search action type. Either "Purge" or "Preview".
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.AllowNotFoundExchangeLocationsEnabled
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.AzureBatchFrameworkEnabled
      description: Whether the Azure Batch Framework is enabled for job processing.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CaseId
      description: Identity of a Core eDiscovery case which is associated with the
        compliance search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CaseName
      description: Name of a Core eDiscovery case which is associated with the compliance
        search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CreatedBy
      description: Security and compliance search action creator.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CreatedTime
      description: Security and compliance search action creation time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Description
      description: Security and compliance search action description.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Errors
      description: Security and compliance search action errors.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.EstimateSearchJobId
      description: Security and compliance search action job ID estimation.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.EstimateSearchRunId
      description: Security and compliance search action run ID estimation.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.ExchangeLocation
      description: Security and compliance search action exchange locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.ExchangeLocationExclusion
      description: Security and compliance search action exchange locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Identity
      description: Security and compliance search action identity.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.IsValid
      description: Whether the security and compliance search action is valid.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobEndTime
      description: Security and compliance search action job end time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobId
      description: Security and compliance search action job ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobRunId
      description: Security and compliance search action job run ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobStartTime
      description: Security and compliance search action job start time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.LastModifiedTime
      description: Security and compliance search action last modified time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Name
      description: Security and compliance search action name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.PublicFolderLocation
      description: Security and compliance search action public folder locations to
        include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.PublicFolderLocationExclusion
      description: Security and compliance search action public folder locations to
        exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Retry
      description: Whether to retry if the search action failed.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.RunBy
      description: Security and compliance search action run by UPN (email address).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.RunspaceId
      description: Security and compliance search action run space ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SearchName
      description: Security and compliance search action search name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SharePointLocation
      description: Security and compliance search action SharePoint locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SharePointLocationExclusion
      description: Security and compliance search action SharePoint locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Status
      description: Security and compliance search action status. Either "Started"
        or "Completed".
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.TenantId
      description: Security and compliance search action Tenant ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SearchStatus
      description: The status indicating whether or not the search for a given search_name
        was successful.
      type: String
  - arguments:
    - description: The name of the compliance search action.
      name: search_action_name
      required: true
    description: Removes a compliance search action by searching for the action name
      in the Security & Compliance Center.
    name: o365-sc-remove-search-action
  - arguments: []
    description: Lists compliance search actions from the Security & Compliance Center.
    name: o365-sc-list-search-action
    outputs:
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Action
      description: Security and compliance search action type. Either "Purge or "Preview".
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.AllowNotFoundExchangeLocationsEnabled
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.AzureBatchFrameworkEnabled
      description: Whether the Azure Batch Framework is enabled for job processing.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CaseId
      description: Identity of a Core eDiscovery case which is associated with the
        compliance search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CaseName
      description: Name of a Core eDiscovery case which is associated with the compliance
        search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CreatedBy
      description: Security and compliance search action creator.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CreatedTime
      description: Security and compliance search action creation time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Description
      description: Security and compliance search action description.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Errors
      description: Security and compliance search action errors.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.EstimateSearchJobId
      description: Security and compliance search action job ID estimation.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.EstimateSearchRunId
      description: Security and compliance search action run ID estimation.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.ExchangeLocation
      description: Security and compliance search action exchange locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.ExchangeLocationExclusion
      description: Security and compliance search action exchange locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Identity
      description: Security and compliance search action identity.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.IsValid
      description: Whether the security and compliance search action is valid.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobEndTime
      description: Security and compliance search action job end time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobId
      description: Security and compliance search action job ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobRunId
      description: Security and compliance search action job run ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobStartTime
      description: Security and compliance search action job start time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.LastModifiedTime
      description: Security and compliance search action last modified time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Name
      description: Security and compliance search action name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.PublicFolderLocation
      description: Security and compliance search action public folder locations to
        include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.PublicFolderLocationExclusion
      description: Security and compliance search action public folder locations to
        exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Retry
      description: Whether to retry if the search action failed.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.RunBy
      description: Security and compliance search action run by UPN (email address).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.RunspaceId
      description: Security and compliance search action run space ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SearchName
      description: Security and compliance search action search name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SharePointLocation
      description: Security and compliance search action SharePoint locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SharePointLocationExclusion
      description: Security and compliance search action SharePoint locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Status
      description: Security and compliance search action status (Started/Completed).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.TenantId
      description: Security and compliance search action Tenant ID.
      type: String
  - arguments:
    - description: The name of the compliance search action.
      name: search_action_name
      required: true
    - defaultValue: "100"
      description: The maximum number of results to return. If you want to return
        all requests that match the query, use "-1" for the value of this argument.
      name: limit
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to export search results as json file to war-room.
      name: export
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to print the results in the War Room. Default is "false".
      name: results
      predefined:
      - "true"
      - "false"
    description: Gets compliance search action from the Security & Compliance Center.
    name: o365-sc-get-search-action
    outputs:
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Action
      description: Security and compliance search action type. Either "Purge" or "Preview".
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.AllowNotFoundExchangeLocationsEnabled
      description: Whether to include mailboxes other than regular user mailboxes
        in the compliance search.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.AzureBatchFrameworkEnabled
      description: Whether the Azure Batch Framework is enabled for job processing.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CaseId
      description: Identity of a Core eDiscovery case which is associated with the
        compliance search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CaseName
      description: Name of a Core eDiscovery case which is associated with the compliance
        search.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CreatedBy
      description: Security and compliance search action creator.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.CreatedTime
      description: Security and compliance search action creation time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Description
      description: Security and compliance search action description.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Errors
      description: Security and compliance search action errors.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.EstimateSearchJobId
      description: Security and compliance search action job ID estimation.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.EstimateSearchRunId
      description: Security and compliance search action run ID estimation.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.ExchangeLocation
      description: Security and compliance search action exchange locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.ExchangeLocationExclusion
      description: Security and compliance search action exchange locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Identity
      description: Security and compliance search action identity.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.IsValid
      description: Whether the security and compliance search action is valid.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobEndTime
      description: Security and compliance search action job end time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobId
      description: Security and compliance search action job ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobRunId
      description: Security and compliance search action job run ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.JobStartTime
      description: Security and compliance search action job start time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.LastModifiedTime
      description: Security and compliance search action last modified time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Name
      description: Security and compliance search action name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.PublicFolderLocation
      description: Security and compliance search action public folder locations to
        include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.PublicFolderLocationExclusion
      description: Security and compliance search action public folder locations to
        exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.Location
      description: Security and compliance search action result location.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.ItemCount
      description: Security and compliance search action result item count.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.TotalSize
      description: Security and compliance search action result total size.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.FailedCount
      description: Security and compliance search action result failed count.
      type: Number
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.Sender
      description: Security and compliance search action result mail sender.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.Subject
      description: Security and compliance search action result subject.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.Type
      description: Security and compliance search action result type.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.Size
      description: Security and compliance search action result size.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.ReceivedTime
      description: Security and compliance search action result received time.
      type: Date
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results.DataLink
      description: Security and compliance search action data link.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Retry
      description: Whether to retry if the search action failed.
      type: Boolean
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.RunBy
      description: Security and compliance search action run by UPN (email address).
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.RunspaceId
      description: Security and compliance search action run space ID.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SearchName
      description: Security and compliance search action search name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SharePointLocation
      description: Security and compliance search action SharePoint locations to include.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.SharePointLocationExclusion
      description: Security and compliance search action SharePoint locations to exclude.
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.Status
      description: Security and compliance search action status. Either "Started"
        or "Completed".
      type: String
    - contextPath: O365.SecurityAndCompliance.ContentSearch.SearchAction.TenantId
      description: Security and compliance search action Tenant ID.
      type: String
  - arguments:
    - description: Case name create.
      name: case_name
      required: true
    - auto: PREDEFINED
      defaultValue: eDiscovery
      description: |
        "AdvancedEdiscovery: Used to manage legal or other types of investigations.
         ComplianceClassifier: This type of case corresponds to a trainable classifier.
         DataInvestigation: Data investigation cases are used to investigate data spillage incidents.
         DSR: Data Subject Request (DSR) cases are used to manage General Data Protection Regulation (GDPR) DSR investigations.
         eDiscovery: eDiscovery (also called eDiscovery Standard) cases are used to manage legal or other types of investigations.
         This is the default value.
         InsiderRisk: Insider risk cases are used to manage insider risk management cases.
         Typically, insider risk management cases are manually created in the Microsoft Purview
         compliance portal to further investigate activity based on a risk alert.
         SupervisionPolicy: This type of case corresponds to communication compliance policy."
      name: case_type
      predefined:
      - AdvancedEdiscovery
      - ComplianceClassifier
      - DataInvestigation
      - DSR
      - eDiscovery
      - InsiderRisk
      - SupervisionPolicy
    - description: Case description.
      name: description
    - description: Case external ID.
      name: external_id
    description: Create eDiscovery cases in the Microsoft Purview compliance portal.
    name: o365-sc-compliance-case-create
    outputs:
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.Name
      description: Case name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.Status
      description: Case status.
      type: String
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.CreatedDateTime
      description: Case created date time.
      type: String
  - arguments:
    - description: List cases by identity.
      name: identity
    - auto: PREDEFINED
      description: Comma-separated closed list of Case Types to filter by.
      isArray: true
      name: case_type
      predefined:
      - AdvancedEdiscovery
      - ComplianceClassifier
      - DataInvestigation
      - DSR
      - eDiscovery
      - InsiderRisk
      - SupervisionPolicy
    - defaultValue: "50"
      description: Limit returned cases list size.
      name: limit
    description: List different types of compliance cases in the Microsoft Purview
      compliance portal.
    name: o365-sc-compliance-case-list
    outputs:
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.Name
      description: Case name.
      type: String
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.Status
      description: Case status.
      type: String
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.GUID
      description: Case GUID.
      type: UUID
    - contextPath: O365.SecurityAndCompliance.ComplianceCase.CreatedDateTime
      description: Case created date time.
      type: String
  - arguments:
    - description: Delete case by identity.
      name: identity
      required: true
    description: Removes compliance cases from the Microsoft Purview compliance portal
      or the Microsoft Purview compliance portal.
    name: o365-sc-compliance-case-delete
  - arguments:
    - description: Name of the policy to create.
      name: policy_name
      required: true
    - description: eDiscovery case, Case Name, Case Identity (GUID value).
      name: case
      required: true
    - description: Attach a comment to the case.
      name: comment
    - description: Mailbox or distribution group.
      isArray: true
      name: exchange_location
    - description: Comma-separated list of public folders to include, or you can use
        the value "All" to include all.
      isArray: true
      name: public_folder_location
    - description: SharePoint Online and OneDrive for Business sites to include.
      isArray: true
      name: share_point_location
    - auto: PREDEFINED
      defaultValue: "true"
      description: Set hold policy as enabled or not.
      name: enabled
      predefined:
      - "true"
      - "false"
    description: Creates new case hold policies in the Microsoft Purview compliance
      portal.
    name: o365-sc-case-hold-policy-create
    outputs:
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Name
      description: Case hold policy name.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Workload
      description: Case hold policy workload.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Enabled
      description: Is case hold policy enabled.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Mode
      description: Case hold policy mode.
      type: String
  - arguments:
    - description: Identity of the case hold policy to get.
      name: identity
    - description: Case of policy to get. Case name or case GUID.
      name: case
    - auto: PREDEFINED
      defaultValue: "true"
      description: Whether to include distribution details or not.
      name: distribution_detail
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      defaultValue: "true"
      description: Whether to include bindings or not.
      name: include_bindings
      predefined:
      - "true"
      - "false"
    description: View existing case hold policies in the Microsoft Purview compliance
      portal.
    name: o365-sc-case-hold-policy-get
    outputs:
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Name
      description: Case hold policy name.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.GUID
      description: Case hold policy GUID.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Workload
      description: Case hold policy workload.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Status
      description: Case hold policy status.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldPolicy.Mode
      description: Case hold policy mode.
      type: String
  - arguments:
    - description: Identify of the case hold policy to delete.
      name: identity
      required: true
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to use force delete or not. Can be used if current policy
        status is pending delete.
      name: force_delete
      predefined:
      - "true"
      - "false"
    description: Removes case hold policies from the Microsoft Purview compliance
      portal.
    name: o365-sc-case-hold-policy-delete
  - arguments:
    - description: Create rule with the specified name.
      name: rule_name
      required: true
    - description: Create rule for the specified policy.
      name: policy_name
      required: true
    - description: Query using Keyword Query Language (KQL).
      name: query
    - description: Attach a comment to the created rule.
      name: comment
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether the rule is disabled or not.
      name: is_disabled
      predefined:
      - "true"
      - "false"
    description: Creates new case hold rules in the Microsoft Purview compliance portal.
    name: o365-sc-case-hold-rule-create
    outputs:
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.Name
      description: Case hold policy name.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.Status
      description: Case hold policy status.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.Mode
      description: Case hold policy mode.
      type: String
  - arguments:
    - description: Get hold rule list by identity.
      name: identity
    - description: Get hold rule list by policy.
      name: policy
    - defaultValue: "50"
      description: Limit the returned items list size.
      name: limit
    description: View case hold rules in the Microsoft Purview compliance portal.
    name: o365-sc-case-hold-rule-list
    outputs:
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.Name
      description: Case hold policy name.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.GUID
      description: Case hold policy GUID.
      type: UUID
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.Enabled
      description: Whether case hold policy is enabled.
      type: String
    - contextPath: O365.SecurityAndCompliance.CaseHoldRule.Mode
      description: Case hold policy mode.
      type: String
  - arguments:
    - description: Delete rule by identity.
      name: identity
    - auto: PREDEFINED
      defaultValue: "false"
      description: Whether to use force delete or not. Can be used if current rule
        status is pending delete.
      name: force_delete
      predefined:
      - "true"
      - "false"
    description: Removes case hold rules from the Microsoft Purview compliance portal.
    name: o365-sc-case-hold-rule-delete
  - arguments:
    - description: Identity of the policy to update.
      name: identity
      required: true
    - description: Exchange locations to add to the policy.
      isArray: true
      name: add_exchange_locations
    - description: Sharepoint locations to add to the policy.
      isArray: true
      name: add_sharepoint_locations
    - description: Public locations to add to the policy.
      isArray: true
      name: add_public_locations
    - description: Exchange locations to remove from the policy.
      isArray: true
      name: remove_exchange_locations
    - description: Sharepoint locations to remove from the policy.
      isArray: true
      name: remove_sharepoint_locations
    - description: Public locations to remove from the policy.
      isArray: true
      name: remove_public_locations
    - description: Add a comment to existing policy.
      name: comment
    - auto: PREDEFINED
      defaultValue: "true"
      description: Enable or disable the policy.
      name: enabled
      predefined:
      - "true"
      - "false"
    description: Update inputs for case hold policies.
    name: o365-sc-case-hold-policy-set
  dockerimage: demisto/pwsh-exchangev3:1.0.0.88371
  runonce: true
  script: |
    ### pack version: 1.5.1



    $script:INTEGRATION_NAME = "Security And Compliance"
    $script:COMMAND_PREFIX = "o365-sc"
    $script:INTEGRATION_ENTRY_CONTEX = "O365.SecurityAndCompliance.ContentSearch"
    $script:INTEGRATION_ENTRY_COMPLIANCE_CASE = "O365.SecurityAndCompliance.ComplianceCase"
    $script:INTEGRATION_ENTRY_CASE_HOLD_POLICY = "O365.SecurityAndCompliance.CaseHoldPolicy"
    $script:INTEGRATION_ENTRY_CASE_HOLD_RULE = "O365.SecurityAndCompliance.CaseHoldRule"
    $script:SEARCH_ENTRY_CONTEXT = "$script:INTEGRATION_ENTRY_CONTEX.Search(val.Name && val.Name == obj.Name)"
    $script:SEARCH_ACTION_ENTRY_CONTEXT = "$script:INTEGRATION_ENTRY_CONTEX.SearchAction(val.Name && val.Name == obj.Name)"

    <# IMPORTANT NOTICE
    # When conencting to ExchangeOnline - only needed command between CreateSession
    # and DisconnectSession and let also the `finally` term to disconnect (it will do nothing if everything is fine).
    # This will reduce the time sessions are opened between Exchange and the server and will create
    # less problems.
    # DO NOT USE ONE FINALLY STATEMENT: we don't know if and when it'll be executed and anyway it the DisconnectSession
    # should be called before returning results to the server.
    #>
    Import-Module ExchangeOnlineManagement

    #### HELPER FUNCTIONS ####

    function UpdateIntegrationContext([OAuth2DeviceCodeClient]$client){
        $integration_context = @{
            "DeviceCode" = $client.device_code
            "DeviceCodeExpiresIn" = $client.device_code_expires_in
            "DeviceCodeCreationTime" = $client.device_code_creation_time
            "AccessToken" = $client.access_token
            "RefreshToken" = $client.refresh_token
            "AccessTokenExpiresIn" = $client.access_token_expires_in
            "AccessTokenCreationTime" = $client.access_token_creation_time
        }

        SetIntegrationContext $integration_context
        <#
            .DESCRIPTION
            Update integration context from OAuth2DeviceCodeClient client

            .EXAMPLE
            UpdateIntegrationContext $client

            .PARAMETER search_name
            OAuth2DeviceCodeClient client.
        #>
    }

    function ParseSuccessResults([string]$success_results, [int]$limit, [bool]$all_results) {
        $parsed_success_results = New-Object System.Collections.Generic.List[System.Object]
        if ($success_results) {
            $lines = $success_results.Split([Environment]::NewLine)

            if ($limit -ne -1) {
                $limit = ($limit, $lines.Count | Measure-Object -Minimum).Minimum
            } else {
                $limit = $lines.Count
            }

            # Results limit
            $results_count = 0
            # Lines iterator
            $lines_scanned = 0
            while ($results_count -lt $limit -and $lines_scanned -lt $lines.Count) {
                if ($lines[$lines_scanned] -match 'Location: (\S+), Item count: (\d+), Total size: (\d+)')
                {
                    if ($matches[2] -ne 0 -or $all_results){
                        $parsed_success_results.Add(@{
                            "Location" = $matches[1]
                            "ItemsCount" = $matches[2]
                            "Size" = $matches[3]
                        })
                        $results_count += 1
                    }
                }
                $lines_scanned += 1
            }
        }

        return $parsed_success_results
        <#
            .DESCRIPTION
            Parse string return in Search PSObject property "SuccessResults"

            .PARAMETER success_results
            SuccessResults raw string.

            .EXAMPLE
            ParseSuccessResults 'Location: Private mail box, Item count: 8, Total size: 63'

            .OUTPUTS
            List of psobject SuccessResults object.
        #>
    }



    function ParseResults([string]$results, [int]$limit = -1, [string]$type = "Preview") {
       if ($type -eq "Preview"){
            $results_matches_preview = (Select-String -AllMatches "\{?Location: (.*); Sender: (.*); Subject: (.*); Type: (.*); Size: (.*); Received Time: (.*); Data Link: (.*)[},]"  -InputObject $results).Matches
            $parsed_results = New-Object System.Collections.Generic.List[System.Object]
            foreach ($match in $results_matches_preview)
            {
                if ($parsed_results.Count -ge $limit -and $limit -ne -1){
                    break
                }

                $parsed_results.Add(@{
                    "Location" = $match.Groups[1].Value
                    "Sender" = $match.Groups[2].Value
                    "Subject" = $match.Groups[3].Value
                    "Type" = $match.Groups[4].Value
                    "Size" = $match.Groups[5].Value
                    "ReceivedTime" = $match.Groups[6].Value
                    "DataLink" = $match.Groups[7].Value
                })
            }
       }
        if ($type -eq "Purge"){
            $results_matches_purge = (Select-String -AllMatches "\{?Location: (.*); Item count: (.*); Total size: (.*); Failed count: (.*); [},]"  -InputObject $results).Matches
            $parsed_results = New-Object System.Collections.Generic.List[System.Object]
            foreach ($match in $results_matches_purge)
            {
                if ($parsed_results.Count -ge $limit -and $limit -ne -1){
                    break
                }
                $parsed_results.Add(@{
                    "Location" = $match.Groups[1].Value
                    "ItemCount" = $match.Groups[2].Value
                    "TotalSize" = $match.Groups[3].Value
                    "FailedCount" = $match.Groups[4].Value
                })
            }
        }


        return $parsed_results
        <#
            .DESCRIPTION
            Parse string return in SearchAction PSObject property "Results"

            .PARAMETER success_results
            SuccessResults raw string.

            .EXAMPLE
            ParseResults 'Location: Private mail box; Sender: user@microsoft.com; Type: mail; Size: 100; Received Time: 16 August 2010; Data Link: xxxxx,'

            .OUTPUTS
            List of psobject Results object.
        #>
    }

    function ParseSearchToEntryContext([psobject]$search, [int]$limit = -1, [bool]$all_results = $false) {
        return @{
            "AllowNotFoundExchangeLocationsEnabled" = $search.AllowNotFoundExchangeLocationsEnabled
            "AzureBatchFrameworkEnabled" = $search.AzureBatchFrameworkEnabled
            "CaseId" = $search.CaseId
            "CaseName" = $search.CaseName
            "ContentMatchQuery" = $search.ContentMatchQuery
            "CreatedBy" = $search.CreatedBy
            "CreatedTime" = $search.CreatedTime
            "Description" = $search.Description
            "Errors" = $search.Errors
            "ExchangeLocation" = $search.ExchangeLocation
            "ExchangeLocationExclusion" = $search.ExchangeLocationExclusion
            "Identity" = $search.Identity
            "IsValid" = $search.IsValid
            "Items" = $search.Items
            "JobEndTime" = $search.JobEndTime
            "JobId" = $search.JobId
            "JobRunId" = $searchJobRunId
            "JobStartTime" = $search.JobStartTime
            "LastModifiedTime" = $search.LastModifiedTime
            "LogLevel" = $search.LogLevel
            "Name" = $search.Name
            "OneDriveLocation" = $search.OneDriveLocation
            "OneDriveLocationExclusion" = $search.OneDriveLocationExclusion
            "PublicFolderLocation" = $search.PublicFolderLocation
            "PublicFolderLocationExclusion" = $search.PublicFolderLocationExclusion
            "RunBy" = $search.RunBy
            "RunspaceId" = $search_action.RunspaceId
            "SearchStatus" = "Success"
            "SharePointLocation" = $search.SharePointLocation
            "SharePointLocationExclusion" = $search.SharePointLocationExclusion
            "Size" = $search.Size
            "Status" = $search.Status
            "SuccessResults" = ParseSuccessResults -success_results $search.SuccessResults -limit $limit -all_results $all_results
            "TenantId" = $search.TenantId
        }
        <#
            .DESCRIPTION
            Parse Search raw response PSObject to Entry Context.

            .PARAMETER search
            search raw psobject.

            .PARAMETER all_results
            Whether to include also not found locations.

            .PARAMETER limit
            Limit found items.

            .EXAMPLE
            ParseSearchToEntryContext $search

            .OUTPUTS
            Search entry context.

            .Notes
            1. Microsoft internal properties: OneDriveLocationExclusion, OneDriveLocation.
            2. SuccessResults property return as string which should be parsed.
        #>
    }

    function ParseSearchActionToEntryContext([psobject]$search_action, [int]$limit = -1) {
        return @{
            "Action" = $search_action.Action
            "AllowNotFoundExchangeLocationsEnabled" = $search_action.AllowNotFoundExchangeLocationsEnabled
            "AzureBatchFrameworkEnabled" = $search_action.AzureBatchFrameworkEnabled
            "CaseId" = $search_action.CaseId
            "CaseName" = $search_action.CaseName
            "CreatedBy" = $search_action.CreatedBy
            "CreatedTime" = $search_action.CreatedTime
            "Description" = $search_action.Description
            "Errors" = $search_action.Errors
            "EstimateSearchJobId"  = $search_action.EstimateSearchJobId
            "EstimateSearchRunId" = $search_action.EstimateSearchRunId
            "ExchangeLocation" = $search_action.ExchangeLocation
            "ExchangeLocationExclusion" = $search_action.ExchangeLocationExclusion
            "Identity" = $search_action.Identity
            "IsValid" = $search_action.IsValid
            "JobEndTime" = $search_action.JobEndTime
            "JobId" = $search_action.JobId
            "JobRunId" = $search_action.JobRunId
            "JobStartTime" = $search_action.JobStartTime
            "LastModifiedTime" = $search_action.LastModifiedTime
            "PublicFolderLocation" = $search_action.PublicFolderLocation
            "PublicFolderLocationExclusion" = $search_action.PublicFolderLocationExclusion
            "Retry" = $search_action.Retry
            "RunspaceId" = $search_action.RunspaceId
            "SearchStatus" = "Success"
            "SharePointLocation" = $search_action.SharePointLocation
            "SharePointLocationExclusion" = $search_action.SharePointLocationExclusion
            "Name" = $search_action.Name
            "RunBy" = $search_action.RunBy
            "SearchName" = $search_action.SearchName
            "Status" = $search_action.Status
            "TenantId" = $search_action.TenantId
            "Results" = ParseResults -results $search_action.Results -limit $limit -type $search_action.Action
        }
        <#
            .DESCRIPTION
            Parse SearchAction raw response PSObject to Entry Context.

            .PARAMETER search
            SearchAction raw response.

            .EXAMPLE
            ParseSearchActionToEntryContext $search_action

            .OUTPUTS
            SearchAction entry context.

            .Notes
            1. Microsoft internal properties: OneDriveLocationExclusion, OneDriveLocation.
            2. Results property return as string which should be parsed.
        #>
    }

    #### OAuth Client - Access Token Management ####
    class OAuth2DeviceCodeClient {
        [string]$application_id
        [string]$application_scope = "offline_access%20https%3A//outlook.office365.com/.default"
        [string]$device_code
        [int]$device_code_expires_in
        [int]$device_code_creation_time
        [string]$access_token
        [string]$refresh_token
        [int]$access_token_expires_in
        [int]$access_token_creation_time
        [bool]$insecure
        [bool]$proxy
        [string]$app_secret
        [string]$tenant_id

        OAuth2DeviceCodeClient([string]$device_code, [string]$device_code_expires_in, [string]$device_code_creation_time, [string]$access_token,
                                [string]$refresh_token,[string]$access_token_expires_in, [string]$access_token_creation_time,
                               [bool]$insecure, [bool]$proxy, [string]$application_id, [string]$app_secret, [string]$tenant_id) {
            $this.device_code = $device_code
            $this.device_code_expires_in = $device_code_expires_in
            $this.device_code_creation_time = $device_code_creation_time
            $this.access_token = $access_token
            $this.refresh_token = $refresh_token
            $this.access_token_expires_in = $access_token_expires_in
            $this.access_token_creation_time = $access_token_creation_time
            $this.insecure = $insecure
            $this.proxy = $proxy
            $this.application_id = $application_id
            $this.app_secret = $app_secret
            $this.tenant_id = $tenant_id
            <#
                .DESCRIPTION
                OAuth2DeviceCodeClient manage state of OAuth2.0 device-code flow described in https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code.

                .DESCRIPTION
                Its not recomended to create an object using the constructor, Use static method CreateClientFromIntegrationContext() instead.

                OAuth2DeviceCodeClient states are:
                    1. Getting device-code (Will be used in stage 2) and user-code (Will be used by the user to authorize permissions) from Microsoft application.
                    2. Getting access-token and refresh-token - after use authorize (Using stage 1 - device code)
                    3. Refresh access-token if access-token is expired.

                .PARAMETER device_code
                A long string used to verify the session between the client and the authorization server.
                The client uses this parameter to request the access token from the authorization server.

                .PARAMETER device_code_expires_in
                The number of seconds before the device_code and user_code expire. (15 minutes)

                .PARAMETER access_token
                Opaque string, Issued for the scopes that were requested.

                .PARAMETER refresh_token
                Opaque string, Issued if the original scope parameter included offline_access. (Valid for 90 days)

                .PARAMETER access_token_expires_in
                Number of seconds before the included access token is valid for. (Usally - 60 minutes)

                .PARAMETER access_token_creation_time
                Unix time of access token creation (Used for knowing when to refresh the token).

                .PARAMETER access_token_expires_in
                Number of seconds before the included access token is valid for. (Usally - 60 minutes)

                .PARAMETER insecure
                Wheter to trust any TLS/SSL Certificate) or not.

                .PARAMETER proxy
                Wheter to user system proxy configuration or not.

                .NOTES
                1. Application id - a0c73c16-a7e3-4564-9a95-2bdf47383716 , This is well-known application publicly managed by Microsoft and will not work in on-premise enviorment.

                .LINK
                https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code
            #>
        }

        static [OAuth2DeviceCodeClient]CreateClientFromIntegrationContext([bool]$insecure, [bool]$proxy, [string]$application_id, [string]$app_secret, [string]$tenant_id) {
            $ic = GetIntegrationContext
            $client = [OAuth2DeviceCodeClient]::new($ic.DeviceCode, $ic.DeviceCodeExpiresIn, $ic.DeviceCodeCreationTime, $ic.AccessToken, $ic.RefreshToken,
                                                    $ic.AccessTokenExpiresIn, $ic.AccessTokenCreationTime, $insecure, $proxy, $application_id, $app_secret, $tenant_id)

            return $client
            <#
                .DESCRIPTION
                Static method which create object (factory method) from populated values in integration context.

                .EXAMPLE
                [OAuth2DeviceCodeClient]::CreateClientFromIntegrationContext()

                .OUTPUTS
                OAuth2DeviceCodeClient initialized object.
            #>
        }

        [PSObject]AuthorizationRequest() {
            # Reset object-properties
            $this.device_code = $null
            $this.device_code_expires_in = $null
            $this.device_code_creation_time = $null
            # Get device-code and user-code
            $params = @{
                "URI" = "https://login.microsoftonline.com/$($this.tenant_id)/oauth2/v2.0/devicecode"
                "Method" = "Post"
                "Headers" = @{
                    "Content-Type" = "application/x-www-form-urlencoded"
                }
                "Body" = "client_id=$($this.application_id)&scope=$($this.application_scope)"
                "NoProxy" = !$this.proxy
                "SkipCertificateCheck" = $this.insecure
            }
            $response = Invoke-WebRequest @params
            $response_body = ConvertFrom-Json $response.Content
            # Update object properties
            $this.device_code = $response_body.device_code
            $this.device_code_creation_time = [int][double]::Parse((Get-Date -UFormat %s))
            $this.device_code_expires_in = [int]::Parse($response_body.expires_in)

        return $response_body

            <#
                .DESCRIPTION
                Reset values populated in instance context and getting new device-code and user-code.

                .EXAMPLE
                $client.AuthorizationRequest()

                .OUTPUTS
                psobject - Raw body response.

                .LINK
                https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code#device-authorization-request
            #>
        }

        [psobject]AccessTokenRequest() {
            # Get new token using device-code
            try {
                $params = @{
                    "URI" = "https://login.microsoftonline.com/$($this.tenant_id)/oauth2/v2.0/token"
                    "Method" = "Post"
                    "Headers" = (New-Object "System.Collections.Generic.Dictionary[[String],[String]]").Add("Content-Type", "application/x-www-form-urlencoded")
                    "Body" = "grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Adevice_code&code=$($this.device_code)&client_id=$($this.application_id)"
                    "NoProxy" = !$this.proxy
                    "SkipCertificateCheck" = $this.insecure
                }
                $response = Invoke-WebRequest @params
                $response_body = ConvertFrom-Json $response.Content
            }
            catch {
                $response_body = ConvertFrom-Json $_.ErrorDetails.Message
                if ($response_body.error -eq "authorization_pending" -or $response_body.error -eq "invalid_grant") {
                    $error_details = "Please run command !$script:COMMAND_PREFIX-auth-start , before running this command."
                }
                elseif ($response_body.error -eq "expired_token") {
                    $error_details = "At least $($this.access_token_expires_in) seconds have passed from executing !$script:COMMAND_PREFIX-auth-start, Please run the ***$script:COMMAND_PREFIX-auth-start*** command again."
                } else {
                    $error_details = $response_body
                }

                throw "Unable to get access token for your account, $error_details"
            }
            # Update object properties
            $this.access_token = $response_body.access_token
            $this.refresh_token = $response_body.refresh_token
            $this.access_token_expires_in = [int]::Parse($response_body.expires_in)
            $this.access_token_creation_time = [int][double]::Parse((Get-Date -UFormat %s))

            return $response_body

            <#
                .DESCRIPTION
                Getting access-token and refresh-token from Microsoft application based on the device-code we go from AuthorizationRequest() method.

                .EXAMPLE
                $client.AccessTokenRequest()

                .OUTPUTS
                psobject - Raw body response.

                .LINK
                https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code#authenticating-the-user
            #>
        }

        [psobject]RefreshTokenRequest() {
            # Get new token using refresh token
            try {
                $params = @{
                    "URI" = "https://login.microsoftonline.com/$($this.tenant_id)/oauth2/v2.0/token"
                    "Method" = "Post"
                    "Headers" = (New-Object "System.Collections.Generic.Dictionary[[String],[String]]").Add("Content-Type", "application/x-www-form-urlencoded")
                    "Body" = "grant_type=refresh_token&client_id=$($this.application_id)&refresh_token=$($this.refresh_token)&scope=$($this.application_scope)"
                    "NoProxy" = !$this.proxy
                    "SkipCertificateCheck" = $this.insecure
                }
                $response = Invoke-WebRequest @params
                $response_body = ConvertFrom-Json $response.Content
            }
            catch {
                $response_body = ConvertFrom-Json $_.ErrorDetails.Message
                $error_details = "Unable to refresh access token for your account"

                # AADSTS50173 points to password change https://login.microsoftonline.com/error?code=50173.
                # In that case, the integration context should be overwritten and the user should execute the auth process from the begining.
                if ($response_body.error_description -like "*AADSTS50173*") {
                    $this.ClearContext()
                    $error_details = "The account password has been changed or reset. Please run !$script:COMMAND_PREFIX-auth-start to re-authenticate"
                }
                elseif ($response_body.error -eq "invalid_grant") {
                    $error_details = "Please login to grant account permissions (After 90 days grant is expired) !$script:COMMAND_PREFIX-auth-start"
                }
                throw "$error_details. Full error message: $response_body"
            }

            # Update object properties
            $this.access_token = $response_body.access_token
            $this.refresh_token = $response_body.refresh_token
            $this.access_token_expires_in = [int]::Parse($response_body.expires_in)
            $this.access_token_creation_time = [int][double]::Parse((Get-Date -UFormat %s))

            return $response_body

            <#
                .DESCRIPTION
                Getting new access-token and refresh-token from Microsoft application based on the refresh-token we got from AccessTokenRequest() method.

                .EXAMPLE
                $client.RefreshTokenRequest()

                .OUTPUTS
                PSObject - Raw body response.

                .LINK
                https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-implicit-grant-flow#refreshing-tokens
            #>
        }

        [bool]IsDeviceCodeExpired(){
            if (!$this.device_code){
                return $true
            }
            $current_time = [int][double]::Parse((Get-Date -UFormat %s)) - 30
            $valid_until = $this.device_code_creation_time + $this.access_token_expires_in

            return $current_time -gt $valid_until

            <#
                .DESCRIPTION
                Check if device-code expired.

                .EXAMPLE
                $client.IsDeviceCodeExpired()

                .OUTPUTS
                bool - True If device-code expired else False.

                .LINK
                https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-configurable-token-lifetimes#configurable-token-lifetime-properties-after-the-retirement
            #>
        }

        [bool]IsAccessTokenExpired(){
            if (!$this.access_token){
                return $true
            }
            $current_time = [int][double]::Parse((Get-Date -UFormat %s)) - 30
            $valid_until = $this.access_token_creation_time + $this.access_token_expires_in

            return $current_time -gt $valid_until
            <#
                .DESCRIPTION
                Check if access-token expired.

                .EXAMPLE
                $client.IsAccessTokenExpired()

                .OUTPUTS
                bool - True If access-token expired else False.

                .LINK
                https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-configurable-token-lifetimes#configurable-token-lifetime-properties-after-the-retirement
            #>
        }

        RefreshTokenIfExpired(){
            if ($this.access_token -and $this.IsAccessTokenExpired()) {
                $this.RefreshTokenRequest()
            }
            <#
                .DESCRIPTION
                Refresh access token if expired, with offset of 30 seconds.

                .EXAMPLE
                $client.RefreshTokenIfExpired()
            #>
        }

        ClearContext(){
            $this.access_token = $null
            $this.refresh_token = $null
            $this.access_token_expires_in = $null
            $this.access_token_creation_time = $null
            UpdateIntegrationContext $this
            <#
                .DESCRIPTION
                Clear the token fields from the integration context on password change case.

                .EXAMPLE
                $client.ClearContext()
            #>

        }
    }

    #### Security And Compliance client ####
    [Diagnostics.CodeAnalysis.SuppressMessageAttribute('PSAvoidUsingConvertToSecureStringWithPlainText', '', Scope='Class')]
    [Diagnostics.CodeAnalysis.SuppressMessageAttribute('PSAvoidUsingPlainTextForPassword', '', Scope='Class')]
    class SecurityAndComplianceClient {
        [string]$access_token
        [string]$upn
        [string]$tenant_id
        [string]$connection_uri
        [string]$azure_ad_authorization_endpoint_uri_base
        [string]$azure_ad_authorization_endpoint_uri

        SecurityAndComplianceClient([string]$access_token, [string]$upn, [string]$tenant_id, [string]$connection_uri, [string]$azure_ad_authorization_endpoint_uri_base) {

            $this.access_token = $access_token

            $this.upn = $upn

            if ($tenant_id) {
                $this.tenant_id = $tenant_id
            } else {
                $this.tenant_id = $null
            }

            if ($connection_uri) {
                $this.connection_uri = $connection_uri
            } else {
                $this.connection_uri = $null
            }

            if ($azure_ad_authorization_endpoint_uri_base) {
                if ($tenant_id){
                    $this.azure_ad_authorization_endpoint_uri = "$azure_ad_authorization_endpoint_uri_base/$tenant_id"
                } else {
                    $this.azure_ad_authorization_endpoint_uri = "$azure_ad_authorization_endpoint_uri_base/common"
                }
            } else {
                $this.azure_ad_authorization_endpoint_uri = $null
            }
        }

        CreateDelegatedSession([string]$CommandName){
            $cmd_params = @{
                "UserPrincipalName" = $this.upn
                "Organization" = $this.organization
                "AccessToken" = $this.access_token
                "ConnectionUri" = $this.connection_uri
                "AzureADAuthorizationEndpointUri" = $this.azure_ad_authorization_endpoint_uri
            }
            Connect-ExchangeOnline @cmd_params -CommandName $CommandName -WarningAction:SilentlyContinue -ShowBanner:$false | Out-Null
        }

        DisconnectSession(){
            Disconnect-ExchangeOnline -Confirm:$false -WarningAction:SilentlyContinue 6>$null | Out-Null
        }

        [psobject]NewSearch([string]$search_name,  [string]$case, [string]$kql, [string]$description, [bool]$allow_not_found_exchange_locations, [string[]]$exchange_location,
                            [string[]]$exchange_location_exclusion, [string[]]$public_folder_location, [string[]]$share_point_location, [string[]]$share_point_location_exclusion) {

            # Establish session to remote
            $this.CreateDelegatedSession("New-ComplianceSearch")
            # Import and Execute command
            $cmd_params = @{
                "Name" = $search_name
                "Case" = $case
                "ContentMatchQuery" = $kql
                "Description" = $description
                "AllowNotFoundExchangeLocationsEnabled" = $allow_not_found_exchange_locations
                "ExchangeLocation" = $exchange_location
                "ExchangeLocationExclusion" = $exchange_location_exclusion
                "PublicFolderLocation" = $public_folder_location
                "SharePointLocation" = $share_point_location
                "SharePointLocationExclusion" = $share_point_location_exclusion
            }
            $response = New-ComplianceSearch @cmd_params
            # Close session to remote
            $this.DisconnectSession()

            return $response
            <#
                .DESCRIPTION
                Create compliance search in the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .PARAMETER case
                Name of a Core eDiscovery case to associate the new compliance search with.

                .PARAMETER kql
                Text search string or a query that's formatted by using the Keyword Query Language (KQL).

                .PARAMETER description
                Optional description for the compliance search.

                .PARAMETER allow_not_found_exchange_locations
                Whether to include mailboxes other than regular user mailboxes in the compliance search.

                .PARAMETER exchange_location
                Mailboxes to include.

                .PARAMETER exchange_location_exclusion
                Mailboxes to exclude when you use the value "All" for the exchange_location parameter.

                .PARAMETER public_folder_location
                Whether to include all public folders in the search.

                .PARAMETER share_point_location
                SharePoint Online sites to include. You identify the site by its URL value, or you can use the value All to include all sites.

                .PARAMETER share_point_location_exclusion
                SharePoint Online sites to exclude when you use the value All for the SharePointLocation parameter. You identify the site by its URL value.

                .EXAMPLE
                $client.NewSearch("new-search")
                $client.NewSearch("new-search", "new-search-description")

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/new-compliancesearch?view=exchange-ps
            #>
        }

        SetSearch([string]$search_name, [string]$kql, [string]$description, [bool]$allow_not_found_exchange_locations, [string[]]$add_exchange_location,
                  [string[]]$add_exchange_location_exclusion, [string[]]$add_public_folder_location, [string[]]$add_share_point_location, [string[]]$add_share_point_location_exclusion,
                  [string[]]$remove_exchange_location, [string[]]$remove_exchange_location_exclusion, [string[]]$remove_public_folder_location, [string[]]$remove_share_point_location,
                  [string[]]$remove_share_point_location_exclusion) {

            # Establish session to remote
            $this.CreateDelegatedSession("Set-ComplianceSearch")
            # Execute command
            $cmd_params = @{
                "Identity" = $search_name
                "ContentMatchQuery" = $kql
                "Description" = $description
                "AllowNotFoundExchangeLocationsEnabled" = $allow_not_found_exchange_locations
                "AddExchangeLocation" = $add_exchange_location
                "AddExchangeLocationExclusion" = $add_exchange_location_exclusion
                "PublicFolderLocation" = $add_public_folder_location
                "AddSharePointLocation" = $add_share_point_location
                "AddSharePointLocationExclusion" = $add_share_point_location_exclusion
                "RemoveExchangeLocation" = $remove_exchange_location
                "RemoveExchangeLocationExclusion" = $remove_exchange_location_exclusion
                "RemovePublicFolderLocation" = $remove_public_folder_location
                "RemoveSharePointLocation" = $remove_share_point_location
                "RemoveSharePointLocationExclusion" = $remove_share_point_location_exclusion
            }
            Set-ComplianceSearch @cmd_params
            # Close session to remote
            $this.DisconnectSession()
            <#
                .DESCRIPTION
                Set compliance search in the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .PARAMETER kql
                Text search string or a query that's formatted by using the Keyword Query Language (KQL).

                .PARAMETER description
                Optional description for the compliance search.

                .PARAMETER allow_not_found_exchange_locations
                Whether to include mailboxes other than regular user mailboxes in the compliance search.

                .PARAMETER add_exchange_location
                Add mailboxes to include.

                .PARAMETER add_exchange_location_exclusion
                Add mailboxes to exclude when you use the value "All" for the exchange_location parameter.

                .PARAMETER add_public_folder_location
                Add public folders to include.

                .PARAMETER add_share_point_location
                Add sharePoint online sites to include. You identify the site by its URL value.

                .PARAMETER add_share_point_location_exclusion
                Add sharePoint online sites to exclude when you use the value "All" for the SharePointLocation parameter. You identify the site by its URL value.

                .PARAMETER remove_exchange_location
                Remove mailboxes to include.

                .PARAMETER remove_exchange_location_exclusion
                Remove mailboxes to exclude when you use the value "All" for the exchange_location parameter.

                .PARAMETER remove_public_folder_location
                Remove public folders to include.

                .PARAMETER remove_share_point_location
                Remove sharePoint online sites to include. You identify the site by its URL value.

                .PARAMETER remove_share_point_location_exclusion
                Remove sharePoint online sites to exclude when you use the value "All" for the exchange_location (Used in create new compliance search) argument or share_point_location argument. You identify the site by its URL value.

                .EXAMPLE
                $client.SetSearch("new-search", "new-search-description")

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/set-compliancesearch?view=exchange-ps
            #>
        }

        RemoveSearch([string]$search_name) {
            # Establish session to remote
            $this.CreateDelegatedSession("Remove-ComplianceSearch")
            # Import and Execute command
            Remove-ComplianceSearch -Identity $search_name -Confirm:$false

            # Close session to remote
            $this.DisconnectSession()

           <#
                .DESCRIPTION
                Remove compliance search by name from the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .EXAMPLE
                $client.RemoveSearch("new-search")

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/remove-compliancesearch?view=exchange-ps
            #>
        }

        [array]ListSearch() {
            # Establish session to remote
            $this.CreateDelegatedSession("Get-ComplianceSearch")
            # Execute command
            $response = Get-ComplianceSearch

            # Close session to remote
            $this.DisconnectSession()

            return $response

           <#
                .DESCRIPTION
                List compliance searches in the Security & Compliance Center.

                .EXAMPLE
                $client.ListSearch()

                .OUTPUTS
                array - Raw response.

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/get-compliancesearch?view=exchange-ps
            #>
        }

        [psobject]GetSearch([string]$search_name) {
            # Establish session to remote
            $this.CreateDelegatedSession("Get-ComplianceSearch")
            # Import and Execute command
            $response = Get-ComplianceSearch -Identity $search_name

            # Close session to remote
            $this.DisconnectSession()

            return $response
            <#
                .DESCRIPTION
                Get compliance search by name from the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .EXAMPLE
                $client.GetSearch("new-search")

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/get-compliancesearch?view=exchange-ps
            #>
        }

        StartSearch([string]$search_name) {
            # Establish session to remote
            $this.CreateDelegatedSession("Start-ComplianceSearch")
            # Execute command
            Start-ComplianceSearch -Identity $search_name -Confirm:$false -Force:$true

            # Close session to remote
            $this.DisconnectSession()
            <#
                .DESCRIPTION
                Start stopped, completed or not started compliance search in the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .EXAMPLE
                $client.StartSearch("new-search")

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/start-compliancesearch?view=exchange-ps
            #>
        }

        StopSearch([string]$search_name) {

            # Establish session to remote
            $this.CreateDelegatedSession("Stop-ComplianceSearch")
            # Execute command
            Stop-ComplianceSearch -Identity $search_name -Confirm:$false

            # Close session to remote
            $this.DisconnectSession()

            <#
                .DESCRIPTION
                Stop compliance search by name in the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .EXAMPLE
                $client.StopSearch("new-search")

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/stop-compliancesearch?view=exchange-ps
            #>
        }

        [psobject]NewSearchAction([string]$search_name, [string]$action, [string]$purge_type,
                                  [string]$share_point_archive_format, [string]$format,
                                  [bool]$include_sharepoint_document_versions, [string]$notify_email,
                                  [string]$notify_email_cc, [string]$scenario, [string]$scope) {
            # Establish session to remote
            $this.CreateDelegatedSession("New-ComplianceSearchAction")
            # Execute command
            $cmd_params = @{
                "SearchName" = $search_name
            }
            if ($action -eq "Preview") {
                $cmd_params.Preview = $true
                $cmd_params.Confirm = $false
            } elseif ($action -eq "Purge") {
                $cmd_params.Purge = $true
                $cmd_params.PurgeType = $purge_type
                $cmd_params.Confirm = $false
                $cmd_params.Force = $true
            } elseif ($action -eq "Export") {
                $cmd_params.Export = $true
                $cmd_params.Confirm = $false
                if ($share_point_archive_format) {
                    $cmd_params.SharePointArchiveFormat = $share_point_archive_format
                }
                if ($format) {
                    $cmd_params.Format = $format
                }
                if ($include_sharepoint_document_versions -eq "true") {
                    $cmd_params.IncludeSharePointDocumentVersions = $true
                }
                if ($notify_email) {
                    $cmd_params.NotifyEmail = $notify_email
                }
                if ($notify_email_cc) {
                    $cmd_params.NotifyEmailCC = $notify_email_cc
                }
                if ($scenario) {
                    $cmd_params.Scenario = $scenario
                }
                if ($scope) {
                    $cmd_params.Scope = $scope
                }
            } else {
                throw "New action must include valid action - Preview/Purge/Export"
            }
            $response = New-ComplianceSearchAction @cmd_params

            # Close session to remote
            $this.DisconnectSession()

            return $response
            <#
                .DESCRIPTION
                Create compliance search action in the Security & Compliance Center.

                .PARAMETER search_name
                The name of the compliance search.

                .PARAMETER action
                Search action type - Preview (Showing results) / Purge (Delete found emails) / Export (Create Export file in UI)

                .PARAMETER purge_type
                Used if action type is purge, Search action purge type - SoftDelete (allow recover) / HardDelete (not recoverable).

                .EXAMPLE
                $client.NewSearchAction("search-name", "Preview")
                $client.NewSearchAction("search-name", "Purge", "HardDelete")
                $client.NewSearchAction("search-name", "Export")
             #>

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/new-compliancesearchaction?view=exchange-ps
            #>
        }

        RemoveSearchAction([string]$search_action_name) {
            # Establish session to remote
            $this.CreateDelegatedSession("Remove-ComplianceSearchAction")
            # Execute command
            Remove-ComplianceSearchAction -Identity $search_action_name -Confirm:$false
            # Close session to remote
            $this.DisconnectSession()

            <#
                .DESCRIPTION
                Remove compliance search action from the Security & Compliance Center.

                .PARAMETER search_action_name
                The name of the compliance search action.

                .EXAMPLE
                $client.RemoveSearchAction("search-name")

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/remove-compliancesearchaction?view=exchange-ps
            #>
        }

        [array]ListSearchActions() {
            # Establish session to remote
            $this.CreateDelegatedSession("Get-ComplianceSearchAction")
            # Execute command
            $response = Get-ComplianceSearchAction

            # Close session to remote
            $this.DisconnectSession()

            return $response
            <#
                .DESCRIPTION
                List all compliance search action in the Security & Compliance Center.

                .EXAMPLE
                $client.ListearchAction()

                .OUTPUTS
                array - Raw response.

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/get-compliancesearchaction?view=exchange-ps
            #>
        }

        [psobject]GetSearchAction([string]$search_action_name) {
            # Establish session to remote
            $this.CreateDelegatedSession("Get-ComplianceSearchAction")

            # Execute command
            $response = Get-ComplianceSearchAction -Identity $search_action_name

            # Close session to remote
            $this.DisconnectSession()
            return $response
            <#
                .DESCRIPTION
                Get compliance search action in the Security & Compliance Center.

                .PARAMETER search_action_name
                The name of the compliance search action.

                .EXAMPLE
                $client.GetSearchAction("search-name")

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://docs.microsoft.com/en-us/powershell/module/exchange/get-compliancesearchaction?view=exchange-ps
            #>
        }

        [psobject]ComplianceCaseCreate([string]$case_name, [string]$case_type, [string]$description, [string]$external_id) {
            # Establish session to remote
            $this.CreateDelegatedSession("New-ComplianceCase")

            $cmd_params = @{
                "Name" = $case_name
                "CaseType" = $case_type
            }
            if ($description) {
                $cmd_params.Description = $description
            }
            if ($external_id) {
                $cmd_params.ExternalId = $external_id
            }

            # Execute command
            $response = New-ComplianceCase @cmd_params
            # Close session to remote
            $this.DisconnectSession()
            return $response
               <#
                .DESCRIPTION
                Create eDiscovery cases in the Microsoft Purview compliance portal.

                .PARAMETER case_name
                The name of the case to create.
                .PARAMETER case_type
                Type of case from a closed list.
                .PARAMETER description
                Attach a description to case.
                .PARAMETER external_id
                Optional ID or external case number that you can associate with the new compliance case.

                .EXAMPLE
                $client.ComplianceCaseCreate("case_name", "case_type", "description", "external_id")

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://learn.microsoft.com/en-us/powershell/module/exchange/new-compliancecase?view=exchange-ps
            #>
        }

        [psobject]ComplianceCaseList([string]$identity, [string]$case_type, [int]$limit) {
            # Establish session to remote
            $this.CreateDelegatedSession("Get-ComplianceCase")

            $cmd_params = @{}
            if ($identity) {
                $cmd_params.Identity = $identity
            }
            if ($case_type) {
                $case_type_list = ArgToList($case_type)
                $response = @()
                $case_type_list | ForEach-Object{
                    $cmd_params.CaseType = $_
                    $response += Get-ComplianceCase @cmd_params
                }
            } else {
                $response = Get-ComplianceCase @cmd_params
            }
            $response = $response | Select-Object -First $limit
            if (-not $response){
                # Close session to remote
                $this.DisconnectSession()
                throw "The list action didn't return any results. The Compliance cases do not exist or have been deleted."
            }
            # Close session to remote
            $this.DisconnectSession()
            return $response
               <#
                .DESCRIPTION
                List different types of compliance cases in the Microsoft Purview compliance portal

                .PARAMETER identity
                List case with the identity.
                .PARAMETER case_type
                List cases of the sepecified case_type.
                .PARAMETER limit
                Limit the amount of results default is 50.

                .EXAMPLE
                $client.ComplianceCaseList()

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://learn.microsoft.com/en-us/powershell/module/exchange/get-compliancecase?view=exchange-ps
            #>
        }

        [psobject]ComplianceCaseDelete([string]$identity) {
            # Establish session to remote
            $this.CreateDelegatedSession("Remove-ComplianceCase")

            # Execute command
            $response = Remove-ComplianceCase -Identity $identity -Confirm:$false
            # Close session to remote
            $this.DisconnectSession()
            return $response
               <#
                .DESCRIPTION
                Removes compliance cases from the Microsoft Purview compliance portal or the Microsoft Purview compliance portal.

                .PARAMETER identity
                Identity of the case to remove.

                .EXAMPLE
                $client.ComplianceCaseDelete("case_identity")

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://learn.microsoft.com/en-us/powershell/module/exchange/remove-compliancecase?view=exchange-ps
            #>
        }

        [psobject]CaseHoldPolicyCreate([string]$policy_name, [string]$case, [string]$comment, [string]$exchange_location,
                                       [string]$public_folder_location, [string]$share_point_location, [bool]$enabled) {
            # Establish session to remote
            $this.CreateDelegatedSession("New-CaseHoldPolicy")
            $cmd_params = @{
                "Name" = $policy_name
                "Case" = $case
                "Enabled" = $enabled
            }
            if ($comment) {
                $cmd_params.Comment = $comment
            }
            if ($exchange_location) {
                $cmd_params.ExchangeLocation = $exchange_location
            }
            if ($public_folder_location) {
                $cmd_params.PublicFolderLocation = $public_folder_location
            }
            if ($share_point_location) {
                $cmd_params.SharePointLocation = $share_point_location
            }
            # Execute command
            $response = New-CaseHoldPolicy @cmd_params
            # Close session to remote
            $this.DisconnectSession()
            return $response
               <#
                .DESCRIPTION
                Creates new case hold policies in the Microsoft Purview compliance portal

                .PARAMETER policy_name
                 Name of a new policy name to create.

                .PARAMETER case
                Case to connect the policy to.

                .PARAMETER comment
                Attach a comment to the policy.

                .PARAMETER exchange_location
                The ExchangeLocation parameter specifies the mailboxes to include in the policy.

                .PARAMETER public_folder_location
                Specifies that you want to include all public folders in the case hold policy.

                .PARAMETER share_point_location
                Specifies the SharePoint Online and OneDrive for Business sites to include.

                .PARAMETER enabled
                Whether the policy is enabled or disabled.

                .EXAMPLE
                New-CaseHoldPolicy -Name "Regulation 123 Compliance" -Case "123 Compliance Case" -ExchangeLocation "Kitty Petersen", "Scott Nakamura" -SharePointLocation "https://contoso.sharepoint.com/sites/teams/finance"

                .OUTPUTS
                psobject - Raw response.

                .LINK
                https://learn.microsoft.com/en-us/powershell/module/exchange/new-caseholdpolicy?view=exchange-ps
            #>
        }

        [psobject]CaseHoldPolicyGet([string]$identity, [string]$case, [bool]$distribution_detail, [bool]$include_bindings){
            # Establish session to remote
            $this.CreateDelegatedSession("Get-CaseHoldPolicy")
            $cmd_params = @{
                "DistributionDetail" = $distribution_detail
                "IncludeBindings" = $include_bindings
            }
            if ($identity) {
                $cmd_params.Identity = $identity
            }
            if ($case) {
                $cmd_params.Case = $case
            }
            # Execute command
            $response = Get-CaseHoldPolicy @cmd_params
            if (-not $response) {
                # Close session to remote
                $this.DisconnectSession()
                throw "The Get action didn't return any results. The Policy does not exist or has been deleted."
            }
            # Close session to remote
            $this.DisconnectSession()
            return $response
            <#
            .DESCRIPTION
            View existing case hold policies in the Microsoft Purview compliance portal

            .PARAMETER identity
            Specifies the case hold policy that you want to view.

            .PARAMETER case
            The Case parameter specifies the case hold policy that you want to view by using the eDiscovery case that's associated with the policy.

            .PARAMETER distribution_detail
            Returns detailed policy distribution information on the case hold policy.

            .PARAMETER include_bindindgs
            The ExchangeLocation parameter specifies the mailboxes to include in the policy.

            .EXAMPLE
            Get-CaseHoldPolicy -Case "Contoso Legal"
            Get-CaseHoldPolicy -Identity "Regulation 123 Compliance"

            .OUTPUTS
            psobject - Raw response.

            .LINK
            https://learn.microsoft.com/en-us/powershell/module/exchange/get-caseholdpolicy?view=exchange-ps
            #>
        }

        [psobject]CaseHoldPolicyDelete([string]$identity, [bool]$force_delete){
            # Establish session to remote
            $this.CreateDelegatedSession("Remove-CaseHoldPolicy")
            # Execute command
            if($force_delete) {
                $response = Remove-CaseHoldPolicy -Identity $identity -ForceDeletion -Confirm:$false
            } else {
                $response = Remove-CaseHoldPolicy -Identity $identity -Confirm:$false
            }
            # Close session to remote
            $this.DisconnectSession()
            return $response
            <#
            .DESCRIPTION
            Remove case hold policies from the Microsoft Purview compliance portal.

            .PARAMETER identity
            Specify the case hold policy to remove.

            .PARAMETER distribution_detail
            Returns detailed policy distribution information on the case hold policy.

            .EXAMPLE
            Remove-CaseHoldPolicy -Identity "Regulation 123 Compliance"

            .OUTPUTS
            psobject - Raw response.

            .LINK
            https://learn.microsoft.com/en-us/powershell/module/exchange/remove-caseholdpolicy?view=exchange-ps
            #>
        }


        CaseHoldPolicySet([string]$identity, [bool]$enabled, [string[]]$add_exchange_locations, [string[]] $add_sharepoint_locations, [string[]]$add_public_locations,
            [string[]]$remove_exchange_locations, [string[]]$remove_sharepoint_locations, [string[]]$remove_public_locations, [string]$comment){
            $this.CreateDelegatedSession("Set-CaseHoldPolicy")
          $cmd_params = @{}

          if ($identity) { $cmd_params.Identity = $identity }
          if ($enabled) { $cmd_params.Enabled = $enabled }
          if ($add_exchange_locations) { $cmd_params.AddExchangeLocation = $add_exchange_locations }
          if ($add_sharepoint_locations) { $cmd_params.AddSharePointLocation = $add_sharepoint_locations }
          if ($add_public_locations) { $cmd_params.AddPublicFolderLocation = $add_public_locations }
          if ($remove_exchange_locations) { $cmd_params.RemoveExchangeLocation = $remove_exchange_locations }
          if ($remove_sharepoint_locations) { $cmd_params.RemoveSharePointLocation = $remove_sharepoint_locations }
          if ($remove_public_locations) { $cmd_params.RemovePublicFolderLocation = $remove_public_locations }
          if ($comment) { $cmd_params.Comment = $comment }

            Set-CaseHoldPolicy @cmd_params
            $this.DisconnectSession()
        }


        [psobject]CaseHoldRuleCreate([string]$rule_name, [string]$policy_name, [string]$query, [string]$comment, [bool]$is_disabled){
            # Establish session to remote
            $this.CreateDelegatedSession("New-CaseHoldRule")
            $cmd_params = @{
                "Name" = $rule_name
                "Policy" = $policy_name
                "Disabled" = $is_disabled
            }
            if ($comment) {
                $cmd_params.Comment = $comment
            }
            if ($query) {
                $cmd_params.ContentMatchQuery = $query
            }
            # Execute command
            $response = New-CaseHoldRule @cmd_params
            # Close session to remote
            $this.DisconnectSession()
            return $response
            <#
            .DESCRIPTION
            Creates new case hold rules in the Microsoft Purview compliance portal.

            .PARAMETER rule_name
            The rule name to create.
            .PARAMETER policy_name
            Policy to attach the newly created rule to.
            .PARAMETER query
            Query using Keyword Query Language (KQL).
            .PARAMETER comment
            Attach a comment to the rule.
            .PARAMETER is_disabled
            Whether the rule is disabled or not. Default is false.
            .EXAMPLE
            New-CaseHoldRule -Name "2016 Budget Spreadsheets" -Policy "CaseHoldPolicy 16" -ContentMatchQuery "filename:2016 budget filetype:xlsx"

            .OUTPUTS
            psobject - Raw response.

            .LINK
            https://learn.microsoft.com/en-us/powershell/module/exchange/new-caseholdrule
            #>
        }

        [psobject]CaseHoldRuleList([string]$identity, [string]$policy, [int]$limit){
            # Establish session to remote
            $this.CreateDelegatedSession("Get-CaseHoldRule")
            if ($identity) {
                $response = Get-CaseHoldRule -Identity $identity
            } elseif ($policy){
                $response = Get-CaseHoldRule -Policy $policy
            } else {
                $response = Get-CaseHoldRule
            }
            if (-not $response){
                # Close session to remote
                $this.DisconnectSession()
                throw "The list action didn't return any results. The rules do not exist or have been deleted."
            }
            $response = $response | Select-Object -First $limit
            # Close session to remote
            $this.DisconnectSession()
            return $response
            <#
            .DESCRIPTION
            View case hold rules in the Microsoft Purview compliance portal.

            .PARAMETER identity
            List rules by policy identity.
            .PARAMETER policy
            List rules by policy.
            .PARAMETER limit
            Limit number of rules returned. Default is 50.

            .EXAMPLE
            Get-CaseHoldRule  -Identity "Test Rule 66"

            .OUTPUTS
            psobject - Raw response.

            .LINK
            https://learn.microsoft.com/en-us/powershell/module/exchange/get-caseholdrule
            #>
        }

        [psobject]CaseHoldRuleDelete([string]$identity, [bool]$force_delete){
            # Establish session to remote
            $this.CreateDelegatedSession("Remove-CaseHoldRule")
            # Execute command
            if ($force_delete) {
                $response = Remove-CaseHoldRule -Identity $identity -ForceDeletion -Confirm:$false
            } else {
                $response = Remove-CaseHoldRule -Identity $identity -Confirm:$false
            }
            # Close session to remote
            $this.DisconnectSession()
            return $response
            <#
            .DESCRIPTION
            Removes case hold rules from the Microsoft Purview compliance portal.

            .PARAMETER identity
            Identity of rule to delete.
            .PARAMETER force_delete
            Wethere to use force_delete or not.

            .EXAMPLE
            Remove-CaseHoldRule -Identity "Test Rule 3" -Confirm:$false

            .OUTPUTS
            psobject - Raw response.

            .LINK
            https://learn.microsoft.com/en-us/powershell/module/exchange/remove-caseholdrule
            #>
        }
    }


    #### COMMAND FUNCTIONS ####

    function TestModuleCommand () {
        $raw_response = $null
        $human_readable = "The test module does not work for MFA auth. Use the command !$script:COMMAND_PREFIX-auth-start for Oauth2.0 authorization and !$script:COMMAND_PREFIX-auth-test to instead."
        $entry_context = $null

        return $human_readable, $entry_context, $raw_response
    }

    function StartAuthCommand ([OAuth2DeviceCodeClient]$client) {
        $raw_response = $client.AuthorizationRequest()
        $human_readable = "## $script:INTEGRATION_NAME - Authorize instructions
    1. To sign in, use a web browser to open the page [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) and enter the code **$($raw_response.user_code)** to authenticate.
    2. Run the **!$script:COMMAND_PREFIX-auth-complete** command in the War Room.
    3. Run the **!$script:COMMAND_PREFIX-auth-test** command in the War Room to test the completion of the authorization process and the configured parameters."
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function CompleteAuthCommand ([OAuth2DeviceCodeClient]$client) {
        # Verify that user run start before complete
        if (!$client.device_code) {
            throw "Please run !o365-sc-auth-start and follow the command instructions"
        }
        $raw_response = $client.AccessTokenRequest()
        $human_readable = "Your account **successfully** authorized!"
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function TestAuthCommand ([OAuth2DeviceCodeClient]$oclient, [SecurityAndComplianceClient]$cs_client) {
        $raw_response = $oclient.RefreshTokenRequest()
        $human_readable = "**Test ok!**"
        $entry_context = @{}
        try {
            $cs_client.CreateDelegatedSession("Start-ComplianceSearch")
        }
        finally {
            $cs_client.DisconnectSession()
        }

        return $human_readable, $entry_context, $raw_response
    }

    function NewSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Command arguemnts parsing
        $allow_not_found_exchange_locations = ConvertTo-Boolean $kwargs.allow_not_found_exchange_locations
        $exchange_location = ArgToList $kwargs.exchange_location
        $exchange_location_exclusion = ArgToList $kwargs.exchange_location_exclusion
        $public_folder_location = ArgToList $kwargs.public_folder_location
        $share_point_location = ArgToList $kwargs.share_point_location
        $share_point_location_exclusion = ArgToList $kwargs.share_point_location_exclusion
        if (!$kwargs.search_name -or $kwargs.search_name -eq "") {
            $kwargs.search_name = "XSOAR-$(New-Guid)"
        }
        # Raw response
        $raw_response = $client.NewSearch($kwargs.search_name, $kwargs.case, $kwargs.kql, $kwargs.description, $allow_not_found_exchange_locations,
                                          $exchange_location, $exchange_location_exclusion, $public_folder_location, $share_point_location, $share_point_location_exclusion)
        # Human readable
        $md_columns = $raw_response | Select-Object -Property Name, Description, CreatedBy, LastModifiedTime, ContentMatchQuery
        $human_readable = TableToMarkdown $md_columns  "$script:INTEGRATION_NAME - New search '$($kwargs.search_name)' created"
        # Entry context
        $entry_context = @{
            $script:SEARCH_ENTRY_CONTEXT = ParseSearchToEntryContext $raw_response
        }

        return $human_readable, $entry_context, $raw_response
    }

    function SetSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Command arguemnts parsing
        if ($kwargs.allow_not_found_exchange_locations) {
            $allow_not_found_exchange_locations = ConvertTo-Boolean $kwargs.allow_not_found_exchange_locations
        }
        $add_exchange_location = ArgToList $kwargs.add_exchange_location
        $add_exchange_location_exclusion = ArgToList $kwargs.add_exchange_location_exclusion
        $add_public_folder_location = ArgToList $kwargs.add_public_folder_location
        $add_share_point_location = ArgToList $kwargs.add_share_point_location
        $add_share_point_location_exclusion = ArgToList $kwargs.add_share_point_location_exclusion
        $remove_exchange_location = ArgToList $kwargs.remove_exchange_location
        $remove_exchange_location_exclusion = ArgToList $kwargs.remove_exchange_location_exclusion
        $remove_public_folder_location = ArgToList $kwargs.remove_public_folder_location
        $remove_share_point_location = ArgToList $kwargs.remove_share_point_location
        $remove_share_point_location_exclusion = ArgToList $kwargs.remove_share_point_location_exclusion
        # Set operation doesn't return any output
        $client.SetSearch($kwargs.search_name, $kwargs.kql, $kwargs.description, $allow_not_found_exchange_locations,
                          $add_exchange_location, $add_exchange_location_exclusion, $add_public_folder_location, $add_share_point_location, $add_share_point_location_exclusion,
                          $remove_exchange_location, $remove_exchange_location_exclusion, $remove_public_folder_location, $remove_share_point_location, $remove_share_point_location_exclusion)
        # Raw response
        $raw_response = @{}
        # Human readable
        $human_readable = "$script:INTEGRATION_NAME - Search **$($kwargs.search_name)** modified!"
        # Entry context
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function RemoveSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Remove operation doesn't return any output
        $client.RemoveSearch($kwargs.search_name)
        # Raw response
        $raw_response = @{}
        # Human readable
        $human_readable = "$script:INTEGRATION_NAME - Search **$($kwargs.search_name)** removed!"
        # Entry context
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function ListSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Raw response
        $raw_response = $client.ListSearch()

        if ($raw_response.count -eq 0){
            return "#### No compliance searches were retrieved from the Compliance Center.", @{}, $raw_response
        }

        # Human readable
        $md_columns = $raw_response | Select-Object -Property Name, Description, CreatedBy, LastModifiedTime, RunBy
        $human_readable = TableToMarkdown $md_columns "$script:INTEGRATION_NAME - Search configurations"
        # Entry context
        $entry_context = @{
            $script:SEARCH_ENTRY_CONTEXT =  $raw_response | ForEach-Object {
                ParseSearchToEntryContext $_
            }
        }

        return $human_readable, $entry_context, $raw_response
    }

    function GetSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Command arguemnts parsing
        $statistics = ConvertTo-Boolean $kwargs.statistics
        $all_results = ConvertTo-Boolean $kwargs.all_results
        $export = ConvertTo-Boolean $kwargs.export
        # Raw response
        $raw_response = $client.GetSearch($kwargs.search_name)
        # Check if raw_response is null
        if ($null -eq $raw_response) {
            # Handle the scenerio if a search is not found:
            $human_readable = "Failed to retrieve search for the name: $($kwargs.search_name)"
            $entry_context = @{
                $script:SEARCH_ENTRY_CONTEXT = @{
                    "SearchStatus" = "NotFound"
                    "Name" = $kwargs.search_name
                }
            }
            $raw_response = "Failed to retrieve search for the name: $($kwargs.search_name)"
            return $human_readable, $entry_context, $raw_response
        }
        # Entry context
        $entry_context = @{
            $script:SEARCH_ENTRY_CONTEXT = ParseSearchToEntryContext -search $raw_response -limit $kwargs.limit -all_results $all_results
        }
        # Human readable - Basic info
        $md_columns = $raw_response | Select-Object -Property Name, Description, CreatedBy, LastModifiedTime, RunBy, Status
        $human_readable = TableToMarkdown $md_columns  "$script:INTEGRATION_NAME - '$($kwargs.search_name)' search"
        # Human readable - Statistics
        $parsed_results = $entry_context[$script:SEARCH_ENTRY_CONTEXT].SuccessResults
        if ($parsed_results -and $statistics) {
            $human_readable += TableToMarkdown $parsed_results "Search statistics"
        }
        # Results file export
        if ($export) {
            $parsed_results_all = ParseSuccessResults -success_results $raw_response.SuccessResults -limit $kwargs.limit -all_results $all_results
            if ($parsed_results_all.Count -ne 0){
                $file_entry = FileResult "$($kwargs.search_name)_search.json" $($parsed_results_all | ConvertTo-Json) $true
            }
        }

        return $human_readable, $entry_context, $raw_response, $file_entry
    }

    function StartSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Start operation doesn't return any output
        $client.StartSearch($kwargs.search_name)
        # Raw response
        $raw_response = @{}
        # Human readable
        $human_readable = "$script:INTEGRATION_NAME - search **$($kwargs.search_name)** started !"
        # Entry context
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function StopSearchCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Stop operation doesn't return any output
        $client.StopSearch($kwargs.search_name)
        # Raw response
        $raw_response = @{}
        # Human readable
        $human_readable = "$script:INTEGRATION_NAME - search **$($kwargs.search_name)** stopped !"
        # Entry context
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function NewSearchActionCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Raw response
        $raw_response = $client.NewSearchAction($kwargs.search_name, $kwargs.action, $kwargs.purge_type,
                                                $kwargs.share_point_archive_format, $kwargs.format,
                                                $kwargs.include_sharepoint_document_versions, $kwargs.notify_email,
                                                $kwargs.notify_email_cc, $kwargs.scenario, $kwargs.scope)

        if ($null -eq $raw_response) {
            # Handle the scenario if a search is not found:
            $human_readable = "Failed to retrieve search for the name: $($kwargs.search_name)"
            $entry_context = @{
                $script:SEARCH_ACTION_ENTRY_CONTEXT = @{
                    "SearchStatus" = "NotFound"
                    "Name" = $kwargs.search_name
                }
            }
            $raw_response = "Failed to retrieve search for the name: $($kwargs.search_name)"
            return $human_readable, $entry_context, $raw_response
        }

        # Human readable
        $md_columns = $raw_response | Select-Object -Property Name, SearchName, Action, LastModifiedTime, RunBy, Status
        $human_readable = TableToMarkdown $md_columns "$script:INTEGRATION_NAME - search action '$($raw_response.Name)' created"
        # Entry context
        $entry_context = @{
            $script:SEARCH_ACTION_ENTRY_CONTEXT = ParseSearchActionToEntryContext $raw_response
        }

        return $human_readable, $entry_context, $raw_response
    }

    function RemoveSearchActionCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Remove operation doesn't return any output
        $client.RemoveSearchAction($kwargs.search_action_name)
        # Raw response
        $raw_response = @{}
        # Human readable
        $human_readable = "$script:INTEGRATION_NAME - search action **$($kwargs.search_action_name)** removed!"
        # Entry context
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    function GetSearchActionCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Command arguemnts parsing
        $results = ConvertTo-Boolean $kwargs.results
        $export = ConvertTo-Boolean $kwargs.export
        # Raw response
        $raw_response = $client.GetSearchAction($kwargs.search_action_name)
        # Entry context
        $entry_context = @{
            $script:SEARCH_ACTION_ENTRY_CONTEXT = ParseSearchActionToEntryContext $raw_response $kwargs.limit
        }
        # Human readable
        $md_columns = $raw_response | Select-Object -Property Name, SearchName, Action, LastModifiedTime, RunBy, JobEndTime, Status
        $human_readable = TableToMarkdown $md_columns "$script:INTEGRATION_NAME - search action '$($kwargs.search_action_name)'"
        # Human readable - Mail results
        $parsed_results = $entry_context[$script:SEARCH_ACTION_ENTRY_CONTEXT].Results
        if ($parsed_results -and $results) {
            $human_readable += TableToMarkdown $parsed_results "Search action results"
        }
        # Results file export
        if ($export) {
            $parsed_results_all = ParseResults -results $raw_response.Results -limit $kwargs.limit
            if ($parsed_results_all.Count -ne 0){
                $file_entry = FileResult "$($kwargs.search_action_name)_search_action.json" $($parsed_results_all | ConvertTo-Json) $true
            }
        }
        return $human_readable, $entry_context, $raw_response, $file_entry
    }

    function ListSearchActionsCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Raw response
        $raw_response = $client.ListSearchActions()

        # Human readable
        $md_columns = $raw_response | Select-Object -Property Name, SearchName, Action, LastModifiedTime, RunBy, JobEndTime, Status
        $human_readable = TableToMarkdown $md_columns "$script:INTEGRATION_NAME - search actions"
        # Entry context
        $entry_context = @{
            $script:SEARCH_ACTION_ENTRY_CONTEXT = $raw_response | ForEach-Object {
                ParseSearchActionToEntryContext $_
            }
        }

        return $human_readable, $entry_context, $raw_response
    }

    function ComplianceCaseCreateCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Raw response
        $raw_response = $client.ComplianceCaseCreate($kwargs.case_name, $kwargs.case_type, $kwargs.description, $kwargs.external_id)
        $md_columns = $raw_response | Select-Object -Property Identity, Name, Status, CreatedDateTime, CaseType
        $human_readable = TableToMarkdown $md_columns "Results of $command"
        $entry_context = @{"$script:INTEGRATION_ENTRY_COMPLIANCE_CASE" = $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function ComplianceCaseListCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Raw response
        $raw_response = $client.ComplianceCaseList($kwargs.identity, $kwargs.case_type, $kwargs.limit)
        $md_columns = $raw_response | Select-Object -Property Identity, Name, Status, CreatedDateTime, CaseType
        $human_readable = TableToMarkdown $md_columns "Results of $command"
        $entry_context = @{"$script:INTEGRATION_ENTRY_COMPLIANCE_CASE(obj.Identity === val.Identity)" = $raw_response}
        return $human_readable, $entry_context, $raw_response
    }

    function ComplianceCaseDeleteCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        # Raw response
        $raw_response = $client.ComplianceCaseDelete($kwargs.identity)
        # Human readable
        $human_readable = "$script:INTEGRATION_ENTRY_COMPLIANCE_CASE - Case **$($kwargs.identity)** removed!"
        # Entry context
        $entry_context = @{}
        return $human_readable, $entry_context, $raw_response
    }

    function CaseHoldPolicyCreateCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        $enabled = ConvertTo-Boolean $kwargs.enabled
        $exchange_location = @()
        if ($kwargs.exchange_location) {
            $exchange_location = ArgToList($kwargs.exchange_location)
        }
        $public_folder_location = @()
        if ($kwargs.public_folder_location) {
            $public_folder_location = ArgToList($kwargs.public_folder_location)
        }
        $share_point_location = @()
        if ($kwargs.share_point_location) {
            $share_point_location = ArgToList($kwargs.share_point_location)
        }
        # Raw response
        $raw_response = $client.CaseHoldPolicyCreate($kwargs.policy_name, $kwargs.case, $kwargs.comment, $exchange_location,
        $public_folder_location, $share_point_location, $enabled)
        $entry_context = @{"$script:INTEGRATION_ENTRY_CASE_HOLD_POLICY(obj.Guid === val.Guid)" = $raw_response}
        $md_columns = $raw_response | Select-Object -Property Name, Workload, Enabled, Mode, @{Name = "Guid";Expression = {$_.Guid.ToString()}}
        $human_readable = TableToMarkdown $md_columns "Results of $command"
        return $human_readable, $entry_context, $raw_response
    }

    function CaseHoldPolicyGetCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        if ($kwargs.Identity -And $kwargs.case) {
            return "Invlid. Include Indentity or Case. Not both."
        }
        $distribution_detail = ConvertTo-Boolean $kwargs.distribution_detail
        $include_bindings = ConvertTo-Boolean $kwargs.include_bindings
        $raw_response = $client.CaseHoldPolicyGet($kwargs.identity, $kwargs.case, $distribution_detail, $include_bindings)
        $entry_context = @{"$script:INTEGRATION_ENTRY_CASE_HOLD_POLICY(obj.Guid === val.Guid)" = $raw_response}
        $md_columns = $raw_response | Select-Object -Property Name, Workload, Status, Mode, @{Name = "Guid";Expression = {$_.Guid.ToString()}}
        $human_readable = TableToMarkdown $md_columns "Results of $command"
        return $human_readable, $entry_context, $raw_response
    }

    function CaseHoldPolicyDeleteCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        $force_delete = ConvertTo-Boolean $kwargs.force_delete
        $raw_response = $client.CaseHoldPolicyDelete($kwargs.identity, $force_delete)
        $human_readable = "$script:INTEGRATION_ENTRY_COMPLIANCE_CASE - Case Hold policy **$($kwargs.identity)** was removed successfully"
        $entry_context = @{}
        return $human_readable, $entry_context, $raw_response
    }

    function CaseHoldRuleCreateCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        $rule_name = $kwargs.rule_name
        $policy_name = $kwargs.policy_name
        $query = $kwargs.query
        $comment = $kwargs.comment
        $is_disabled = ConvertTo-Boolean $kwargs.is_disabled
        $raw_response = $client.CaseHoldRuleCreate($rule_name, $policy_name, $query, $comment, $is_disabled)
        $md_columns = $raw_response | Select-Object -Property Name, Status, Mode, @{Name = "Guid";Expression = {$_.Guid.ToString()}}
        $human_readable = TableToMarkdown $md_columns "Results of $command"
        $entry_context = @{"$script:INTEGRATION_ENTRY_CASE_HOLD_RULE(obj.Guid === val.Guid)" = $raw_response}
        return $human_readable, $entry_context, $raw_response
    }
    function CaseHoldRuleListCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        $identity = $kwargs.identity
        $policy = $kwargs.policy
        $limit = $kwargs.limit
        $raw_response = $client.CaseHoldRuleList($identity, $policy, $limit)
        $md_columns = $raw_response | Select-Object -Property Name, Status, Mode, @{Name = "Guid";Expression = {$_.Guid.ToString()}}
        $human_readable = TableToMarkdown $md_columns "Results of $command"
        $entry_context = @{"$script:INTEGRATION_ENTRY_CASE_HOLD_RULE(obj.Guid === val.Guid)" = $raw_response}
        return $human_readable, $entry_context, $raw_response
    }

    function CaseHoldRuleDeleteCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs) {
        $identity = $kwargs.identity
        $force_delete = ConvertTo-Boolean $kwargs.force_delete
        $raw_response = $client.CaseHoldRuleDelete($identity, $force_delete)
        $human_readable = "$script:INTEGRATION_ENTRY_COMPLIANCE_CASE - Case Hold rule **$($kwargs.identity)** was removed successfully"
        $entry_context = @{}
        return $human_readable, $entry_context, $raw_response
    }

    function CaseHoldPolicySetCommand([SecurityAndComplianceClient]$client, [hashtable]$kwargs){
        $enabled = ConvertTo-Boolean $kwargs.enabled
        $add_exchange_locations = ArgToList $kwargs.add_exchange_locations
        $add_sharepoint_locations = ArgToList $kwargs.add_sharepoint_locations
        $add_public_locations = ArgToList $kwargs.add_public_locations
        $remove_exchange_locations = ArgToList $kwargs.remove_exchange_locations
        $remove_sharepoint_locations = ArgToList $kwargs.remove_sharepoint_locations
        $remove_public_locations = ArgToList $kwargs.remove_public_locations

        $client.CaseHoldPolicySet($kwargs.identity, $enabled, $add_exchange_locations,
                                    $add_sharepoint_locations, $add_public_locations, $remove_exchange_locations,
                                    $remove_sharepoint_locations, $remove_public_locations, $kwargs.comment)

        $raw_response = @{}
        # Human readable
        $human_readable = "$script:INTEGRATION_NAME - case hold policy **$($kwargs.identity)** modified!"
        # Entry context
        $entry_context = @{}

        return $human_readable, $entry_context, $raw_response
    }

    #### INTEGRATION COMMANDS MANAGER ####

    function Main {
        $command = $Demisto.GetCommand()
        $command_arguments = $Demisto.Args()
        $integration_params = $Demisto.Params()

        if ($integration_params.insecure -eq $true) {
            # Bypass SSL verification if insecure is true
            [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
        }

        try {
            $Demisto.Debug("Command being called is $Command")

            # Creating Compliance and search client
            $oauth2_client = [OAuth2DeviceCodeClient]::CreateClientFromIntegrationContext($insecure, $false,
                $integration_params.app_id, $integration_params.app_secret, $integration_params.tenant_id)

            # Executing oauth2 commands
            switch ($command) {
                "$script:COMMAND_PREFIX-auth-start" {
                    ($human_readable, $entry_context, $raw_response) = StartAuthCommand $oauth2_client
                }
                "$script:COMMAND_PREFIX-auth-complete" {
                    ($human_readable, $entry_context, $raw_response) = CompleteAuthCommand $oauth2_client
                }
            }

            # Refreshing tokens if expired
            if ($command -ne "$script:COMMAND_PREFIX-auth-start")
            {
                $oauth2_client.RefreshTokenIfExpired()
            }

            $cs_client = [SecurityAndComplianceClient]::new(
                $oauth2_client.access_token,
                $integration_params.delegated_auth.identifier,
                $integration_params.tenant_id,
                $integration_params.connection_uri,
                $integration_params.azure_ad_authorized_endpoint_uri_base
            )

            # Executing command
            switch ($command) {
                "test-module" {
                    ($human_readable, $entry_context, $raw_response) = TestModuleCommand
                }
                "$script:COMMAND_PREFIX-auth-test" {
                    ($human_readable, $entry_context, $raw_response) = TestAuthCommand $oauth2_client $cs_client
                }
                "$script:COMMAND_PREFIX-new-search" {
                    ($human_readable, $entry_context, $raw_response) = NewSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-set-search" {
                    ($human_readable, $entry_context, $raw_response) = SetSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-remove-search" {
                    ($human_readable, $entry_context, $raw_response) = RemoveSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-list-search" {
                    ($human_readable, $entry_context, $raw_response) = ListSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-get-search" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = GetSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-start-search" {
                    ($human_readable, $entry_context, $raw_response) = StartSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-stop-search" {
                    ($human_readable, $entry_context, $raw_response) = StopSearchCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-new-search-action" {
                    ($human_readable, $entry_context, $raw_response) = NewSearchActionCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-remove-search-action" {
                    ($human_readable, $entry_context, $raw_response) = RemoveSearchActionCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-list-search-action" {
                    ($human_readable, $entry_context, $raw_response) = ListSearchActionsCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-get-search-action" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = GetSearchActionCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-compliance-case-create" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = ComplianceCaseCreateCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-compliance-case-list" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = ComplianceCaseListCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-compliance-case-delete" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = ComplianceCaseDeleteCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-policy-create" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = CaseHoldPolicyCreateCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-policy-get" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = CaseHoldPolicyGetCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-policy-delete" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = CaseHoldPolicyDeleteCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-rule-create" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = CaseHoldRuleCreateCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-rule-list" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = CaseHoldRuleListCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-rule-delete" {
                    ($human_readable, $entry_context, $raw_response, $file_entry) = CaseHoldRuleDeleteCommand $cs_client $command_arguments
                }
                "$script:COMMAND_PREFIX-case-hold-policy-set" {
                    ($human_readable, $entry_context, $raw_response) = CaseHoldPolicySetCommand $cs_client $command_arguments
                }
            }

            # Updating integration context if access token changed
            UpdateIntegrationContext $oauth2_client

            # Return results to Demisto Server
            ReturnOutputs $human_readable $entry_context $raw_response | Out-Null
            if ($file_entry) {
                $Demisto.results($file_entry)
            }
        } catch {
            $Demisto.debug("Integration: $script:INTEGRATION_NAME
    Command: $command
    Arguments: $($command_arguments | ConvertTo-Json)
    Error: $($_.Exception.Message)")
            if ($_.Exception.Message -like "*Unable to open a web page using xdg-open*" ) {
               Write-Host "It looks like the access token has expired. Please run the command !$script:COMMAND_PREFIX-auth-start, before running this command."
            } elseif ($command -ne "test-module") {
                ReturnError "Error:
                Integration: $script:INTEGRATION_NAME
                Command: $command
                Arguments: $($command_arguments | ConvertTo-Json)
                Error: $($_.Exception)" | Out-Null
            } else {
                ReturnError $_.Exception.Message
            }
        }
    }

    # Execute Main when not in Tests
    if ($MyInvocation.ScriptName -notlike "*.tests.ps1" -AND -NOT $Test) {
        Main
    }
  type: powershell
sectionorder:
- Connect
- Collect
system: true
