args:
- name: entryID
  required: true
commonfields:
  id: 88a31c3b-158d-464f-8625-2887120ad86d
  version: -1
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
dockerimage: xlwings:latest
enabled: true
engineinfo: {}
mainengineinfo: {}
name: ShiftManagement_v2_WIP
pswd: ""
runas: DBotWeakRole
runonce: false
script: |2+


  """
  1) Check General Shift and Weekend Shift logics
  2) If any new person is added in roaster/ any existing person changes name/surname add them to list
  3) Adding exception for Aman
  4) Mail should be sent to demisto with the data of one week buffer time since last sheet(tom_index logic)
  """


  # import pandas as pd
  import csv
  from datetime import date,timedelta


  args=demisto.args()

  entryID=args.get("entryID")

  file_info = demisto.getFilePath(entryID)
  file_path = file_info['path']

  shifts={}
  next_day_shifts={}
  weekoffs={}

  today = date.today()
  tomorrow = today + timedelta(1)
  # cur_day = today.strftime("%d-%b")
  cur_day = today.strftime("%m/%d")
  print("today is =", cur_day)
  # tom_day = tomorrow.strftime("%d-%b")
  tom_day = tomorrow.strftime("%m/%d")
  print("tomorrow is =", tom_day)




  #code for finding the index of the current day

  with open(file_path, encoding="utf8", newline='', errors='ignore') as csvfile:
  # with open(file_path, newline='') as csvfile:
      spamreader = csv.reader(csvfile, delimiter=',')
      header = []
      header = next(spamreader)
      #print(header)

  for i in header:
      try:
          dt = datetime.strptime(i, "%m/%d/%Y").strftime('%m/%d')
          header = list(map(lambda x: x.replace(i, dt), header))
      except ValueError:
          pass
  # print(header)

  cur_index = header.index(cur_day)
  # tom_index = header.index(tom_day)
  print(cur_index)

  if (cur_day in header):
      cur_index = header.index(cur_day)
      # if(cur_index==6):
      #     tom_index = header.index(cur_day)
  else:
      print("Todays date not found in sheet")

  # if (tom_day in header):
  #     tom_index = header.index(tom_day)
  # else:
  #     print("Tommorows date not found in sheet")
  #     tom_index = header.index(cur_day)




  userlist=json.loads(demisto.executeCommand('getList', {'listName':"CSOC Team"})[0]['Contents'])

  with open(file_path, encoding="utf8", newline='', errors='ignore') as csvfile:
      print("DONEEEEEEEEEEEEE")


  '''
      spamreader = csv.reader(csvfile, delimiter=',')
      for col in spamreader:
          if col[4].strip().upper()=="L2" or col[4].strip().upper()=="MANAGER" or col[5].strip().upper()=="L2" or col[5].strip().upper()=="MANAGER" or col[1].strip()=="1318949" or col[1].strip()=="1838252" or col[1].strip()=="2038571" or col[1].strip()=="1838455" or col[1].strip()=="2539424":
              pass
          else:
              username=userlist.get(col[1].strip())
              if username:
                  shifts[username]=col[cur_index]#Todays shifts for all-->While mapping will be for noon n night
                  # next_day_shifts[username]=col[tom_index]# Tomorrows shifts for all-->while mapping will be for morning

              # if not username:
              #     #Fetch users ad details and add in the username in the userlist and the orignal list
              #     #username=userlist.get(col[1])
              #     rs = demisto.executeCommand('ad-get-user', { "username" : col[1] })[0]["Contents"]
              #     # username=rs[0].get('attributes').get('displayName')[0]
              #     # rs = demisto.executeCommand('ad-get-user', { "username" : col[1].strip() })
              #     # rs1=rs[0].get('Contents')[0]
              #     if rs[0]:
              #         demsito.results(rs[0])
              #     # username=rs1[0].get('attributes', {}).get('displayName')
              #     # userlist[col[1].strip()]=username
              #     # reslist = demisto.executeCommand('setList', {'listName':"CSOC Team", 'listData':userlist})
              #     # if is_error(reslist[0]):
              #     #     return_error(reslist[0])
              #     # else:
              #     #     return_results('CSOC Team List Updated')










  def getKeysByValue(dictOfElements, valueToFind):

      possible_notations=['M','N','A','WO','CO','L','HOLIDAY','H','BA','BM','BN']
      listOfKeys = list()
      listOfItems = dictOfElements.items()
      if valueToFind in possible_notations:
          for item  in listOfItems:
              if item[1].strip().upper() == valueToFind:
                  listOfKeys.append(item[0].strip())
      return  listOfKeys

  # #will have to think about general shift people where to add them




  # first_shift=getKeysByValue(shifts,"E1")
  first_shift=getKeysByValue(shifts,"M")
  # second_shift=getKeysByValue(shifts,"N1")
  second_shift=getKeysByValue(shifts,"A")
  # third_shift=getKeysByValue(shifts,"T2")
  third_shift=getKeysByValue(shifts,"N")
  weekoffs=getKeysByValue(shifts,"WO")
  weekoffs.extend(getKeysByValue(shifts,"CO"))
  weekoffs.extend(getKeysByValue(shifts,"L"))
  weekoffs.extend(getKeysByValue(shifts,"HOLIDAY"))
  weekoffs.extend(getKeysByValue(shifts,"H"))
  weekoffs.extend(getKeysByValue(shifts,"BA"))
  weekoffs.extend(getKeysByValue(shifts,"BM"))
  weekoffs.extend(getKeysByValue(shifts,"BN"))




  print("Below are the list of people in 3 shift")
  print(first_shift)
  print(second_shift)
  print(third_shift)
  print(weekoffs)
  demisto.setContext('FirstShift',first_shift)
  demisto.setContext('SecondShift',second_shift)
  demisto.setContext('ThirdShift',third_shift)


  """
  We can enter a small code that will fetech the username of these emp id present in list
  using azure ad integration comand and get the fist name and last name from context data which is our nomenclature for username
  and then run the integration command

  """

  def maproles(shiftrole,shiftlist):
      if shiftrole=='WeekOff':
          roles=["Operator"]
      else:
          roles=[shiftrole,"Operator"]
      for i in shiftlist:
          # if i=="Porkodi G":
          #     body={
          #         'id':i,
          #         'roles':{
          #             'roles':[shiftrole,"Operator","CSOC-XSOAR-Architect"],
          #             'defaultAdmin':False
          #         }
          #     }
          # else:
          body={
                  'id':i,
                  'roles':{
                      'roles':roles,
                      'defaultAdmin':False
                  }
              }
          demisto.executeCommand('demisto-api-post', {'body':body,'uri':"/users/update"})

  maproles('First-Shift',first_shift)
  maproles('Second-Shift',second_shift)
  maproles('Third-Shift',third_shift)
  maproles('WeekOff',weekoffs)


  '''












scripttarget: 0
subtype: python3
tags: []
type: python
