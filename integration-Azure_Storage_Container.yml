category: IT Services
commonfields:
  id: Azure Storage Container
  version: -1
configuration:
- display: Storage account name
  displaypassword: Account SAS Token
  name: credentials
  required: false
  type: 9
- additionalinfo: Relevant only if the integration is running on Azure VM. If selected,
    authenticates based on the value provided for the Azure Managed Identities Client
    ID field. If no value is provided for the Azure Managed Identities Client ID field,
    authenticates based on the System Assigned Managed Identity. For additional information,
    see the Help tab.
  display: Use Azure Managed Identities
  name: use_managed_identities
  required: false
  type: 8
- additionalinfo: The Managed Identities client ID for authentication - relevant only
    if the integration is running on Azure VM.
  display: ""
  displaypassword: Azure Managed Identities Client ID
  hiddenusername: true
  name: managed_identities_client_id
  required: false
  type: 9
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Account key
  hidden: true
  name: key
  required: false
  type: 0
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.0.0
    itemVersion: 1.0.22
    packID: AzureStorageContainer
    packName: Azure Storage Container
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: Create and Manage Azure Storage Container services.
detaileddescription: "To configure an instance of the integration in Cortex XSOAR,
  you need to supply your Storage Account Name and credentials.\n\nCredentials are
  one of the following:\n- Storage Account SAS Token. \n- Azure Managed Identities
  client ID (relevant only if Cortex XSOAR is installed on Azure VM).\n   \nWhen you
  configure the integration instance, enter the Storage Account name in the Storage
  Account field, and the credentials details in the relevant field.\n\n#### Authentication
  with Storage Account SAS Token\n\nTo create and copy your storage account SAS token:\n\n1.
  Navigate to your storage account in the Azure portal.\n2. Under the **Settings**
  section, select the **Shared access signature** option.\n3. In the **Shared Access
  Signature** window, make the following selections:  \n    - Specify the signed key
  Start and Expiry date and time.\n    - Select the Time zone for the Start and Expiry
  date and time (default is Local).\n    - Define your Permissions by checking and/or
  clearing the appropriate check boxes.\n      - Allow the 'Blob' and 'File' services.\n
  \     - Allow the 'Service', 'Container' and 'Object' resource types.\n      - Allow
  the 'Read', 'Write', 'Delete', 'List', 'Create', 'Add', 'Update' and 'Immutable
  storage' permissions to be able to implement all integration use cases.\n      -
  Allow 'Blob versioning permissions'.\n4. Review and select \"Generate\".    \n   A
  new window will appear with the SAS token.  \n5. Copy and paste the SAS token. Note:
  it will only be displayed once and can't be retrieved once the window is closed.\n\n
  \ For more information about Azure Storage and SAS, see:  \n  - [Azure Storage services](https://docs.microsoft.com/en-us/rest/api/storageservices/)
  \ \n  - [Grant limited access to Azure Storage resources using shared access signatures
  (SAS)](https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview)\n
  \ - [SAS permissions overview](https://docs.microsoft.com/en-us/rest/api/storageservices/create-service-sas)\n\n####
  Azure Managed Identities Authentication\n##### Note: This option is relevant only
  if the integration is running on Azure VM.\nFollow one of these steps for authentication
  based on Azure Managed Identities:\n\n- ##### To use System Assigned Managed Identity\n
  \  - Select the **Use Azure Managed Identities** checkbox and leave the **Azure
  Managed Identities Client ID** field empty.\n\n- ##### To use User Assigned Managed
  Identity\n   1. Go to [Azure Portal](https://portal.azure.com/) -> **Managed Identities**.\n
  \  2. Select your User Assigned Managed Identity -> copy the Client ID -> paste
  it in the **Azure Managed Identities Client ID** field in the instance settings.\n
  \  3. Select the **Use Azure Managed Identities** checkbox.\n\nFor more information,
  see [Managed identities for Azure resources](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview).\n\n\n---\n[View
  Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/azure-storage-container)"
display: Azure Storage Container
image: data:image/png;base64,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
name: Azure Storage Container
script:
  commands:
  - arguments:
    - defaultValue: "50"
      description: Number of Containers to retrieve. Default is 50.
      name: limit
    - description: Filters the results to return only Containers whose names begin
        with the specified prefix.
      name: prefix
    - defaultValue: "1"
      description: Page number. Default is 1.
      name: page
    description: List Containers under the specified storage account.
    name: azure-storage-container-list
    outputs:
    - contextPath: AzureStorageContainer.Container.name
      description: Container name.
      type: String
  - arguments:
    - description: |
        The name of the Container to create. Rules for naming containers can be found here:
        https://docs.microsoft.com/en-us/rest/api/storageservices/naming-and-referencing-containers--blobs--and-metadata
      name: container_name
      required: true
    description: Create a new Container under the specified account.
    name: azure-storage-container-create
  - arguments:
    - description: The name of the Container.
      name: container_name
      required: true
    description: Retrieve properties for the specified Container.
    name: azure-storage-container-property-get
    outputs:
    - contextPath: AzureStorageContainer.Container.Property.last_modified
      description: Last modified time of the container.
      type: Date
    - contextPath: AzureStorageContainer.Container.Property.etag
      description: The entity tag for the container.
      type: String
    - contextPath: AzureStorageContainer.Container.Property.lease_status
      description: The lease status of the container.
      type: String
    - contextPath: AzureStorageContainer.Container.Property.lease_state
      description: The lease state of the container.
      type: String
    - contextPath: AzureStorageContainer.Container.Property.has_immutability_policy
      description: Indicates whether the container has an immutability policy set
        on it.
      type: String
    - contextPath: AzureStorageContainer.Container.Property.has_legal_hold
      description: Indicates whether the container has a legal hold.
      type: String
    - contextPath: AzureStorageContainer.Container.name
      description: Container name.
      type: String
  - arguments:
    - description: The name of the Container to delete.
      name: container_name
      required: true
    description: Marks the specified Container for deletion. The Container and any
      Blobs contained within it, will be deleted during garbage collection.
    execution: true
    name: azure-storage-container-delete
  - arguments:
    - description: The name of the Container.
      name: container_name
      required: true
    - defaultValue: "50"
      description: Number of blobs to retrieve. Default is 50.
      name: limit
    - description: Filters the results to return only blobs whose names begin with
        the specified prefix.
      name: prefix
    - defaultValue: "1"
      description: Page number. Default is 1.
      name: page
    description: List Blobs under the specified container.
    name: azure-storage-container-blob-list
    outputs:
    - contextPath: AzureStorageContainer.Container.Blob.name
      description: Blob name.
      type: String
    - contextPath: AzureStorageContainer.Container.name
      description: Container name.
      type: String
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The entry ID of the file to upload as a new blob. Available from
        XSOAR war room while the context data contains file output.
      name: file_entry_id
      required: true
    - description: The name of the Blob to create. Default is XSOAR file name.
      name: blob_name
    description: Create a new Blob under the specified Container.
    name: azure-storage-container-blob-create
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The entry ID of the file to upload as a new blob. Available from
        XSOAR war room while the context data contains file output.
      name: file_entry_id
      required: true
    - description: The name of the Blob to update.
      name: blob_name
      required: true
    description: Update the content of an existing Blob.
    name: azure-storage-container-blob-update
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The name of the Blob to retrieve.
      name: blob_name
      required: true
    description: Retrieve Blob from Container.
    name: azure-storage-container-blob-get
    outputs:
    - contextPath: File.Size
      description: The size of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA256 hash of the file.
      type: String
    - contextPath: File.Name
      description: The name of the file.
      type: String
    - contextPath: File.SSDeep
      description: The SSDeep hash of the file.
      type: String
    - contextPath: File.EntryID
      description: The entry ID of the file.
      type: String
    - contextPath: File.Info
      description: File information.
      type: String
    - contextPath: File.Type
      description: The file type.
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: Unknown
    - contextPath: File.Extension
      description: The file extension.
      type: String
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The name of the blob.
      name: blob_name
      required: true
    description: Retrieve the tags of the specified Blob.
    name: azure-storage-container-blob-tag-get
    outputs:
    - contextPath: AzureStorageContainer.Container.Blob.Tag.Key
      description: Tag key.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Tag.Value
      description: Tag value.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.name
      description: Blob name.
      type: String
    - contextPath: AzureStorageContainer.Container.name
      description: Container name.
      type: String
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The name of the blob.
      name: blob_name
      required: true
    - description: 'Tags fields in JSON format: {"tag-name-1": "tag-value-1", "tag-name-2":
        "tag-value-2"}. The tags fields may contain at most 10 tags.'
      name: tags
      required: true
    description: Sets the tags for the specified Blob. The command replace the entire
      tags of the Blob and can be used to remove tags.
    name: azure-storage-container-blob-tag-set
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The name of the Blob to delete.
      name: blob_name
      required: true
    description: Marks the specified Blob for deletion. The Blob will be deleted during
      garbage collection.
    execution: true
    name: azure-storage-container-blob-delete
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The name of the blob.
      name: blob_name
      required: true
    description: Retrieve Blob properties.
    name: azure-storage-container-blob-property-get
    outputs:
    - contextPath: AzureStorageContainer.Container.Blob.Property.last_modified
      description: Last modified time of the blob.
      type: Date
    - contextPath: AzureStorageContainer.Container.Blob.Property.etag
      description: The entity tag for the blob.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Property.lease_status
      description: The lease status of the blob.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Property.lease_state
      description: The lease state of the blob.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Property.blob_type
      description: The blob type.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Property.content_length
      description: The size of the blob in bytes.
      type: Number
    - contextPath: AzureStorageContainer.Container.Blob.Property.content_type
      description: The content type specified for the blob. If no content type was
        specified, the default content type is application/octet-stream.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Property.content-md5
      description: The MD5 hash of the blob content.
      type: String
    - contextPath: AzureStorageContainer.Container.Blob.Property.creation_time
      description: The date at which the blob was created.
      type: Date
    - contextPath: AzureStorageContainer.Container.Blob.name
      description: Blob name.
      type: String
  - arguments:
    - description: The name of the Blob Container.
      name: container_name
      required: true
    - description: The name of the blob.
      name: blob_name
      required: true
    - description: Blob content type. Indicates the media type of the blob.
      name: content_type
    - description: Blob MD5 hash value. Can be used by the client to check for content
        integrity.
      name: content_md5
    - description: Blob content encoding. Used to specify the compression algorithm
        of the blob content.
      name: content_encoding
    - description: Blob content language. Describes the human languages of the blob
        content.
      name: content_language
    - description: Blob content disposition. Conveys additional information about
        how to process the response payload, and also can be used to attach additional
        metadata.
      name: content_disposition
    - description: Modifies the cache control string for the blob. Indicates directives
        for caching in both requests and responses.
      name: cache_control
    - description: Request ID generated by the client and recorded in the analytics
        logs when storage analytics logging is enabled.
      name: request_id
    - description: Required if the blob has an active lease.
      name: lease_id
    description: Set Blob properties.
    name: azure-storage-container-blob-property-set
  - arguments:
    - description: Name of a container.
      name: container_name
      required: true
    - defaultValue: "1"
      description: Expiry time for sas token(hours).
      name: expiry_time
      required: true
    - auto: PREDEFINED
      defaultValue: c
      description: specifies which resources are accessible via the shared access
        signature. Options available c(container), b(blob), bv(blob version),bs(blob
        snapshot),d(directory).
      name: signed_resources
      predefined:
      - c
      - b
      - bv
      - bs
      - d
      required: true
    - defaultValue: r
      description: 'The permissions that are associated with the shared access signature.
        The user is restricted to operations that are allowed by the permissions.
        Possible permission: r = Read, a=access, c=create, w=write. Also must follow
        the  this order "racwdxltmeop"Example: r,c,a,w,rac, racw.'
      name: signed_permissions
      required: true
    - description: specifies a public IP address or a range of public IP addresses
        from which to accept requests.
      name: signed_ip
      type: unknown
    - description: The account key to create the SAS token with.
      name: account_key
    description: create SAS token for container.
    name: azure-storage-container-sas-create
  dockerimage: demisto/python3:3.10.14.100715
  runonce: false
  script: |
    register_module_line('Azure Storage Container', 'start', __line__())
    demisto.debug('pack name = Azure Storage Container, pack version = 1.0.22')


    import hashlib
    import hmac
    import shutil
    from collections.abc import Callable
    from urllib import parse  # noqa: F401
    import defusedxml.ElementTree as defused_ET
    from requests import Response


    DATE_FORMAT = '%a, %d %b %Y %H:%M:%S GMT'
    account_sas_token = ""
    storage_account_name = ""


    class Client:
        """
        API Client
        """

        def __init__(self, server_url, verify, proxy, account_sas_token, storage_account_name,
                     api_version, managed_identities_client_id: Optional[str] = None):
            self.ms_client = MicrosoftStorageClient(server_url, verify, proxy, account_sas_token, storage_account_name,
                                                    api_version, managed_identities_client_id)

        def list_containers_request(self, limit: str = None, prefix: str = None, marker: str = None) -> str:
            """
            List Containers under the specified storage account.

            Args:
                limit (str): Number of Containers to retrieve.
                prefix (str): Filters the results to return only Containers whose name begins with the specified prefix.
                marker (str): Identifies the portion of the list to be returned.

            Returns:
                str: API response from Azure.

            """
            params = assign_params(maxresults=limit, prefix=prefix, comp='list', marker=marker)

            response = self.ms_client.http_request(method='GET', url_suffix='', params=params, resp_type="text")

            return response

        def create_container_request(self, container_name: str) -> Response:
            """
            Create a new Container under the specified account.

            Args:
                container_name (str): Container name.

            Returns:
                Response: API response from Azure.

            """
            params = assign_params(restype="container")

            response = self.ms_client.http_request(method='PUT', url_suffix=f'{container_name}', params=params,
                                                   return_empty_response=True)

            return response

        def get_base_url(self):
            return self.ms_client._base_url

        def get_api_version(self):
            return self.ms_client._api_version

        def get_container_properties_request(self, container_name: str) -> Response:
            """
            Retrieve properties for the specified Container.

            Args:
                container_name (str): Container name.

            Returns:
                Response: API response from Azure.

            """
            params = assign_params(restype="container")

            response = self.ms_client.http_request(method='GET', url_suffix=f'{container_name}', params=params,
                                                   return_empty_response=True)

            return response

        def delete_container_request(self, container_name: str) -> Response:
            """
            Delete Container under the specified account.

            Args:
                container_name (str): Container name.

            Returns:
                Response: API response from Azure.

            """
            params = assign_params(restype="container")

            response = self.ms_client.http_request(method='DELETE', url_suffix=f'{container_name}', params=params,
                                                   return_empty_response=True)

            return response

        def list_blobs_request(self, container_name: str, limit: str = None, prefix: str = None, marker: str = None) -> str:
            """
            List Blobs under the specified container.

            Args:
                container_name (str): Container name.
                limit (str): Number of Blob to retrieve.
                prefix (str): Filters the results to return only Blob whose name begins with the specified prefix.
                marker (str): Identifies the portion of the list to be returned.

            Returns:
                str: API response from Azure.

            """
            params = assign_params(container_name=container_name, maxresults=limit,
                                   prefix=prefix, restype='container', comp='list', marker=marker)

            response = self.ms_client.http_request(method='GET', url_suffix=f'{container_name}', params=params,
                                                   resp_type="text")

            return response

        def put_blob_request(self, container_name: str, file_entry_id: str, file_name: str = None) -> Response:
            """
            Create or update Blob under the specified Container.

            Args:
                container_name (str): Container name.
                file_entry_id (str): File War room Entry ID.
                file_name (str): File name. Default is XSOAR file name.

            Returns:
                Response: API response from Azure.

            """

            xsoar_file_data = demisto.getFilePath(
                file_entry_id)  # Retrieve XSOAR system file path and name, given file entry ID.
            xsoar_system_file_path = xsoar_file_data['path']
            blob_name = file_name if file_name else xsoar_file_data['name']

            headers = {'x-ms-blob-type': 'BlockBlob'}

            try:
                shutil.copy(xsoar_system_file_path, blob_name)
            except FileNotFoundError:
                raise Exception('Failed to prepare file for upload. '
                                'The process of importing and copying the file data from XSOAR failed.')

            try:
                with open(blob_name, 'rb') as file:
                    response = self.ms_client.http_request(method='PUT',
                                                           url_suffix=f'{container_name}/{blob_name}',
                                                           headers=headers,
                                                           return_empty_response=True,
                                                           data=file)

            finally:
                shutil.rmtree(blob_name, ignore_errors=True)

            return response

        def get_blob_request(self, container_name: str, blob_name: str) -> Response:
            """
            Retrieve Blob from Container.

            Args:
                container_name (str): Container name.
                blob_name (str): Blob name.

            Returns:
                Response: API response from Azure.

            """
            response = self.ms_client.http_request(method='GET', url_suffix=f'{container_name}/{blob_name}',
                                                   resp_type="response")

            return response

        def get_blob_tags_request(self, container_name: str, blob_name: str) -> str:
            """
            Retrieve the tags of the specified Blob.

            Args:
                container_name (str): Container name.
                blob_name (str): Blob name.

            Returns:
                str: API response from Azure.

            """
            params = assign_params(comp="tags")

            response = self.ms_client.http_request(method='GET', url_suffix=f'{container_name}/{blob_name}', params=params,
                                                   resp_type="text")

            return response

        def set_blob_tags_request(self, container_name: str, blob_name: str, tags: str) -> Response:
            """
            Set the tags for the specified Blob.

            Args:
                container_name (str): Container name.
                blob_name (str): Blob name.
                tags (str): XML tags data.

            Returns:
                Response: API response from Azure.

            """
            params = assign_params(comp="tags")

            response = self.ms_client.http_request(method='PUT', url_suffix=f'{container_name}/{blob_name}',
                                                   params=params, return_empty_response=True, data=tags)

            return response

        def delete_blob_request(self, container_name: str, blob_name: str) -> Response:
            """
            Delete Blob from Container.

            Args:
                container_name (str): Container name.
                blob_name (str): Blob name.

            Returns:
                Response: API response from Azure.

            """

            response = self.ms_client.http_request(method='DELETE', url_suffix=f'{container_name}/{blob_name}',
                                                   return_empty_response=True)

            return response

        def get_blob_properties_request(self, container_name: str, blob_name: str) -> Response:
            """
            Retrieve Blob properties.

            Args:
                container_name (str): Container name.
                blob_name (str): Blob name.

            Returns:
                Response: API response from Azure.

            """

            response = self.ms_client.http_request(method='HEAD', url_suffix=f'{container_name}/{blob_name}',
                                                   resp_type="response")

            return response

        def set_blob_properties_request(self, container_name: str, blob_name: str, headers: dict) -> Response:
            """
            Set Blob properties.

            Args:
                container_name (str): Container name.
                blob_name (str): Blob name.
                headers (dict): Request Headers.

            Returns:
                Response: API response from Azure.

            """

            params = assign_params(comp='properties')
            response = self.ms_client.http_request(method='PUT', url_suffix=f'{container_name}/{blob_name}',
                                                   params=params, headers=headers, return_empty_response=True)

            return response


    def get_pagination_next_marker_element(limit: str, page: int, client_request: Callable, params: dict) -> str:
        """
        Get next marker element for request pagination.
        'marker' is a string value that identifies the portion of the list to be returned with the next list operation.
        The operation returns a NextMarker element within the response body if the list returned was not complete.
        This value may then be used as a query parameter in a subsequent call to request the next portion of the list items.
        Args:
            limit (str): Number of elements to retrieve.
            page (str): Page number.
            client_request (Callable): Client request function.
            params (dict): Request params.

        Returns:
            str: Next marker.

        """
        offset = int(limit) * (page - 1)
        response = client_request(limit=str(offset), **params)
        tree = ET.ElementTree(defused_ET.fromstring(response))
        root = tree.getroot()

        return root.findtext('NextMarker')  # type: ignore


    def list_containers_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        List Containers under the specified storage account.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        limit = args.get('limit') or '50'
        prefix = args.get('prefix')
        page = arg_to_number(args.get('page') or '1')

        marker = ''
        readable_message = f'Containers List:\n Current page size: {limit}\n Showing page {page} out others that may exist'

        if page > 1:  # type: ignore
            marker = get_pagination_next_marker_element(limit=limit, page=page,  # type: ignore
                                                        client_request=client.list_containers_request,
                                                        params={"prefix": prefix})

            if not marker:
                return CommandResults(
                    readable_output=readable_message,
                    outputs_prefix='AzureStorageContainer.Container',
                    outputs=[],
                    raw_response=[]
                )

        response = client.list_containers_request(limit, prefix, marker)

        tree = ET.ElementTree(defused_ET.fromstring(response))
        root = tree.getroot()

        raw_response = []
        outputs = []

        for element in root.iter('Container'):
            outputs.append({'name': element.findtext('Name')})
            data = {'Name': element.findtext('Name')}
            properties = {}
            for container_property in element.findall('Properties'):
                for attribute in container_property:
                    properties[attribute.tag] = attribute.text

            data['Property'] = properties  # type: ignore
            raw_response.append(data)

        readable_output = tableToMarkdown(
            readable_message,
            outputs,
            headers=['name'],
            headerTransform=string_to_table_header
        )

        command_results = CommandResults(
            readable_output=readable_output,
            outputs_prefix='AzureStorageContainer.Container',
            outputs_key_field='name',
            outputs=outputs,
            raw_response=raw_response
        )

        return command_results


    def create_container_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Create a new Container under the specified account.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']

        container_name_regex = "^[a-z0-9](?!.*--)[a-z0-9-]{1,61}[a-z0-9]$"
        # Rules for naming containers can be found here:
        # https://docs.microsoft.com/en-us/rest/api/storageservices/naming-and-referencing-containers--blobs--and-metadata

        if not re.search(container_name_regex, container_name):
            raise Exception('The specified container name is invalid.')

        client.create_container_request(container_name)

        command_results = CommandResults(
            readable_output=f'Container {container_name} successfully created.',
        )

        return command_results


    def convert_dict_time_format(data: dict, keys: list):
        """
        Convert dictionary data values time format.
        Args:
            data (dict): Data.
            keys (list): Keys list to convert

        """
        for key in keys:
            if data.get(key):
                time_value = datetime.strptime(data.get(key), DATE_FORMAT)  # type: ignore
                iso_time = FormatIso8601(time_value)
                data[key] = iso_time


    def get_container_properties_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Retrieve properties for the specified Container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']

        response = client.get_container_properties_request(container_name)

        raw_response = response.headers
        raw_response = dict(raw_response)  # Convert raw_response from 'CaseInsensitiveDict' to 'dict'

        response_headers = list(raw_response.keys())
        outputs = {}

        properties = transform_response_to_context_format(raw_response, response_headers)

        outputs['name'] = container_name
        outputs['Property'] = properties

        convert_dict_time_format(outputs['Property'], ['last_modified', 'date'])

        readable_output = tableToMarkdown(
            f'Container {container_name} Properties:',
            outputs.get('Property'),
            headers=['last_modified', 'etag', 'lease_status', 'lease_state', 'has_immutability_policy', 'has_legal_hold'],
            headerTransform=string_to_table_header
        )

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='AzureStorageContainer.Container',
            outputs_key_field='name',
            outputs=outputs,
            raw_response=raw_response
        )


    def delete_container_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Delete Container under the specified account.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']

        client.delete_container_request(container_name)

        command_results = CommandResults(
            readable_output=f'Container {container_name} successfully deleted.',
        )

        return command_results


    def list_blobs_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        List Blobs under the specified container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        limit = args.get('limit') or '50'
        prefix = args.get('prefix')
        page = arg_to_number(args.get('page') or '1')

        marker = ''
        readable_message = f'{container_name} Container Blobs List:\n Current page size: {limit}\n ' \
                           f'Showing page {page} out others that may exist'
        if page > 1:  # type: ignore
            marker = get_pagination_next_marker_element(limit=limit, page=page,  # type: ignore
                                                        client_request=client.list_blobs_request,
                                                        params={"container_name": container_name,
                                                                "prefix": prefix})  # type: ignore

            if not marker:
                return CommandResults(
                    readable_output=readable_message,
                    outputs_prefix='AzureStorageContainer.Container',
                    outputs=[],
                    raw_response=[]
                )

        response = client.list_blobs_request(container_name, limit, prefix, marker)

        tree = ET.ElementTree(defused_ET.fromstring(response))
        root = tree.getroot()

        raw_response = []
        blobs = []

        for element in root.iter('Blob'):
            data = {'name': element.findtext('Name')}
            blobs.append(dict(data))
            properties = {}
            for blob_property in element.findall('Properties'):
                for attribute in blob_property:
                    properties[attribute.tag] = attribute.text

            data['Property'] = properties  # type: ignore
            raw_response.append(data)

        outputs = {"name": container_name, "Blob": blobs}
        readable_output = tableToMarkdown(
            readable_message,
            outputs.get('Blob'),
            headers='name',
            headerTransform=string_to_table_header
        )

        command_results = CommandResults(
            readable_output=readable_output,
            outputs_prefix='AzureStorageContainer.Container',
            outputs_key_field='name',
            outputs=outputs,
            raw_response=raw_response

        )

        return command_results


    def create_blob_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Create a new Blob under the specified Container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        file_entry_id = args['file_entry_id']
        blob_name = args.get('blob_name')

        client.put_blob_request(container_name, file_entry_id, blob_name)

        command_results = CommandResults(
            readable_output='Blob successfully created.',
        )

        return command_results


    def update_blob_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Update Blob under the specified Container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        file_entry_id = args['file_entry_id']
        blob_name = args['blob_name']

        client.put_blob_request(container_name, file_entry_id, blob_name)

        command_results = CommandResults(
            readable_output=f'Blob {blob_name} successfully updated.',
        )

        return command_results


    def get_blob_command(client: Client, args: Dict[str, Any]) -> fileResult:  # type: ignore
        """
        Retrieve Blob from Container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            fileResult: XSOAR File Result.

        """
        container_name = args['container_name']
        blob_name = args['blob_name']

        response = client.get_blob_request(container_name, blob_name)

        return fileResult(filename=blob_name, data=response.content)


    def get_blob_tags_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Retrieve the tags of the specified Blob.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        blob_name = args['blob_name']

        response = client.get_blob_tags_request(container_name, blob_name)

        tree = ET.ElementTree(defused_ET.fromstring(response))
        root = tree.getroot()

        raw_response = []
        outputs = {'name': container_name, 'Blob': {'name': blob_name}}

        for element in root.iter('Tag'):
            tag = {'Key': element.findtext('Key'), 'Value': element.findtext('Value')}
            raw_response.append(dict(tag))

        outputs['Blob']['Tag'] = raw_response

        readable_output = tableToMarkdown(
            f'Blob {blob_name} Tags:',
            outputs['Blob']['Tag'],
            headers=['Key', 'Value'],
            headerTransform=pascalToSpace
        )

        command_results = CommandResults(
            readable_output=readable_output,
            outputs_prefix='AzureStorageContainer.Container',
            outputs_key_field='name',
            outputs=outputs,
            raw_response=raw_response
        )

        return command_results


    def create_set_tags_request_body(tags: dict) -> str:
        """
        Create XML request body for set blob tags.
        Args:
            tags (dict): Tags data. Key represents tag name , and value represents tag Value.

        Returns:
            str: Set tags request body.

        """
        top = ET.Element('Tags')

        tag_set = ET.SubElement(top, 'TagSet')

        for key, value in tags.items():
            tag = ET.SubElement(tag_set, 'Tag')
            tag_key = ET.SubElement(tag, 'Key')
            tag_key.text = key

            tag_value = ET.SubElement(tag, 'Value')
            tag_value.text = value

        return ET.tostring(top, encoding='unicode')


    def set_blob_tags_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Sets the tags for the specified Blob.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        blob_name = args['blob_name']
        tags = args['tags']

        try:
            tags = json.loads(tags)
        except ValueError:
            raise ValueError('Failed to parse tags argument. Please provide valid JSON format tags data.')

        xml_data = create_set_tags_request_body(tags)

        client.set_blob_tags_request(container_name, blob_name, xml_data)

        command_results = CommandResults(
            readable_output=f'{blob_name} Tags successfully updated.',
        )

        return command_results


    def delete_blob_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Delete Blob from Container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        blob_name = args['blob_name']

        client.delete_blob_request(container_name, blob_name)

        command_results = CommandResults(
            readable_output=f'Blob {blob_name} successfully deleted.',
        )

        return command_results


    def transform_response_to_context_format(data: dict, keys: list) -> dict:
        """
        Transform API response data to suitable XSOAR context data.
        Remove 'x-ms' prefix and replace '-' to '_' for more readable and conventional variables.
        Args:
            data (dict): Data to exchange.
            keys (list): Keys to filter.

        Returns:
            dict: Processed data.

        """
        return {key.replace('x-ms-', '').replace('-', '_').lower(): value
                for key, value in data.items() if key in keys}


    def get_blob_properties_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Retrieve Blob properties.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        blob_name = args['blob_name']

        response = client.get_blob_properties_request(container_name, blob_name)

        raw_response = response.headers
        raw_response = dict(raw_response)  # Convert raw_response from 'CaseInsensitiveDict' to 'dict'

        response_headers = list(raw_response.keys())
        outputs = {}

        properties = transform_response_to_context_format(raw_response, response_headers)

        outputs['name'] = container_name
        outputs['Blob'] = {'name': blob_name, 'Property': properties}

        convert_dict_time_format(outputs['Blob']['Property'], ['creation_time', 'last_modified', 'date'])

        readable_output = tableToMarkdown(
            f'Blob {blob_name} Properties:',
            outputs.get('Blob').get('Property'),  # type: ignore
            headers=['creation_time', 'last_modified', 'content_length', 'content_type', 'etag'],
            headerTransform=string_to_table_header
        )

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='AzureStorageContainer.Container',
            outputs_key_field='name',
            outputs=outputs,
            raw_response=raw_response
        )


    def set_blob_properties_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Set Blob properties.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs, readable outputs and raw response for XSOAR.

        """
        container_name = args['container_name']
        blob_name = args['blob_name']
        content_type = args.get('content_type')
        content_md5 = args.get('content_md5')
        content_encoding = args.get('content_encoding')
        content_language = args.get('content_language')
        content_disposition = args.get('content_disposition')
        cache_control = args.get('cache_control')
        request_id = args.get('request_id')
        lease_id = args.get('lease_id')

        headers = remove_empty_elements({
            'x-ms-blob-cache-control': cache_control,
            'x-ms-blob-content-type': content_type,
            'x-ms-blob-content-md5': content_md5,
            'x-ms-blob-content-encoding': content_encoding,
            'x-ms-blob-content-language': content_language,
            'x-ms-blob-content-disposition': content_disposition,
            'x-ms-client-request-id': request_id,
            'x-ms-lease-id': lease_id,
        })

        client.set_blob_properties_request(container_name, blob_name, headers)

        command_results = CommandResults(
            readable_output=f'Blob {blob_name} properties successfully updated.',
        )

        return command_results


    # generate signature helper function
    def generate_sas_signature(account_key: str, cr: str, sp: str, signedstart: str, expiry: str, sr: str, api_version: str,
                               sip: str = '') -> str:
        """
        Generate sas token for Container

        Args:
            account_key: account key of conatiner.
            cr: canonicalizedResource.
            sp:SignedPermissions.
            signedstart: start time for sas token.
            expiry : Expiry time for sas token.
        Returns:
            sas token

        """
        if sip is None:
            sip = ''
        string_to_sign = (sp + "\n" +  # noqa: W504
                          signedstart + "\n"
                          + expiry + "\n"
                          + cr + "\n"
                          + "" + "\n"
                          + sip + "\n"
                          + "https" + "\n"
                          + api_version + "\n"
                          + sr + "\n"
                          + "" + "\n"
                          + "" + "\n"
                          + "" + "\n"
                          + "" + "\n"
                          + "" + "\n"
                          + "").encode('UTF-8')
        signed_hmac_sha256 = hmac.new(base64.b64decode(account_key), string_to_sign, hashlib.sha256)
        sig = base64.b64encode(signed_hmac_sha256.digest())

        token = {
            'sp': sp,
            'st': signedstart,
            'se': expiry,
            'sip': sip,
            'spr': "https",
            'sv': api_version,
            'sr': sr,
            'sig': sig
        }

        sas_token = urllib.parse.urlencode(token)
        return sas_token


    def check_valid_permission(valid_permissions: str, input_permissions: str) -> bool:
        """
        Check the permissions follows valid permission order.

        Args:
            valid_permissions : valid permissions order
            input_permissions : permissions given

        Returns:
            bool

        """
        permissions_length = len(input_permissions)
        if len(valid_permissions) < permissions_length:
            return False
        for i in range(permissions_length - 1):
            last = valid_permissions.rindex(input_permissions[i])
            first = valid_permissions.index(input_permissions[i + 1])
            if last == -1 or first == -1 or last > first:
                return False
        return True


    def generate_sas_token_command(client: Client, args: dict) -> CommandResults:  # type: ignore # pragma: no cover
        """
        Generate sas url for Container.

        Args:
            client (Client): Azure Blob Storage API client.
            args (dict): Command arguments from XSOAR.

        Returns:
            CommandResults: outputs and raw response for XSOAR.

        """
        api_version = client.get_api_version()
        container_name = args.get("container_name")
        signed_resource = args.get("signed_resources")
        signed_permissions = args.get("signed_permissions")
        valid_permissions = "racwdxltmeop"
        signed_ip = args.get("signed_ip")
        # Check Permissions
        if check_valid_permission(valid_permissions, signed_permissions):  # type: ignore
            # Set start time
            signed_start = str((datetime.utcnow() - timedelta(minutes=2)).strftime("%Y-%m-%dT%H:%M:%SZ"))
            account_key = demisto.params().get("key") or args.get("account_key")

            if not account_key:
                raise DemistoException("An account key must be given to generate the SAS token.")

            time_taken = int(args.get('expiry_time'))  # type: ignore
            signed_expiry = str((datetime.utcnow() + timedelta(hours=time_taken)).strftime("%Y-%m-%dT%H:%M:%SZ"))
            url_suffix = f"{container_name}"
            canonicalized_resource = f"/blob/{storage_account_name}/{container_name}"
            url = client.get_base_url() + url_suffix
            sas_token = generate_sas_signature(account_key, canonicalized_resource, signed_permissions, signed_start,  # type: ignore # noqa
                                               signed_expiry, signed_resource, api_version, signed_ip)  # type: ignore
            sas_url = f"{url}?{sas_token}"
            res_data = sas_url
            markdown = tableToMarkdown('Azure storage container SAS url', res_data, headers=[container_name])
            result = CommandResults(
                readable_output=markdown,
                outputs_prefix='AzureStorageContainer.Container',
                outputs_key_field=container_name,
                outputs=res_data
            )
            return result
        else:
            raise DemistoException("Permissions are invalid or in wrong order. Correct order for permissions are \'racwdl\'")


    def test_module(client: Client) -> None:
        """
        Tests API connectivity and authentication.
        Args:
            client (Client): Azure Blob Storage API client.
        Returns:
            str : 'ok' if test passed, anything else will fail the test.
        """
        try:
            client.list_containers_request()
        except Exception as exception:
            if 'Error in API call' in str(exception):
                return return_results('Authorization Error: make sure API Credentials are correctly set')

            if 'Error Type' in str(exception):
                return return_results(
                    'Verify that the storage account name is correct and that you have access to the server from your host.')

            raise exception

        return_results('ok')
        return None


    def main() -> None:  # pragma: no cover
        """
        Main function
        """
        params: Dict[str, Any] = demisto.params()
        args: Dict[str, Any] = demisto.args()
        verify_certificate: bool = not params.get('insecure', False)
        proxy = params.get('proxy', False)
        global account_sas_token
        global storage_account_name
        account_sas_token = params.get('credentials', {}).get('password')
        storage_account_name = params['credentials']['identifier']
        managed_identities_client_id = get_azure_managed_identities_client_id(params)
        api_version = "2020-10-02"
        base_url = f'https://{storage_account_name}.blob.core.windows.net/'
        # supported api versions can be found here:
        # https://learn.microsoft.com/en-us/rest/api/storageservices/previous-azure-storage-service-versions
        command = demisto.command()
        demisto.debug(f'Command being called is {command}')

        try:
            client: Client = Client(base_url, verify_certificate, proxy, account_sas_token, storage_account_name,
                                    api_version,
                                    managed_identities_client_id)

            commands = {
                'azure-storage-container-list': list_containers_command,
                'azure-storage-container-create': create_container_command,
                'azure-storage-container-property-get': get_container_properties_command,
                'azure-storage-container-delete': delete_container_command,
                'azure-storage-container-blob-list': list_blobs_command,
                'azure-storage-container-blob-create': create_blob_command,
                'azure-storage-container-blob-update': update_blob_command,
                'azure-storage-container-blob-get': get_blob_command,
                'azure-storage-container-blob-tag-get': get_blob_tags_command,
                'azure-storage-container-blob-tag-set': set_blob_tags_command,
                'azure-storage-container-blob-delete': delete_blob_command,
                'azure-storage-container-blob-property-get': get_blob_properties_command,
                'azure-storage-container-blob-property-set': set_blob_properties_command,
                'azure-storage-container-sas-create': generate_sas_token_command,
            }

            if command == 'test-module':
                test_module(client)
            elif command in commands:
                return_results(commands[command](client, args))
            else:
                raise NotImplementedError(f'{command} command is not implemented.')

        except Exception as e:
            return_error(str(e))



    ### GENERATED CODE ###: from MicrosoftAzureStorageApiModule import *  # noqa: E402
    # This code was inserted in place of an API module.
    register_module_line('MicrosoftAzureStorageApiModule', 'start', __line__(), wrapper=-3)


    import defusedxml.ElementTree as defused_ET

    MANAGED_IDENTITIES_TOKEN_URL = 'http://169.254.169.254/metadata/identity/oauth2/token?' \
                                   'api-version=2018-02-01&resource=https://storage.azure.com/'
    MANAGED_IDENTITIES_SYSTEM_ASSIGNED = 'SYSTEM_ASSIGNED'


    class MicrosoftStorageClient(BaseClient):
        """
        Microsoft Azure Storage API Client
        """

        def __init__(self, server_url, verify, proxy,
                     account_sas_token, storage_account_name,
                     api_version, managed_identities_client_id: Optional[str] = None):
            super().__init__(base_url=server_url, verify=verify, proxy=proxy)
            self._account_sas_token = account_sas_token or ""
            self._storage_account_name = storage_account_name
            self._api_version = api_version
            self._base_url = server_url

            self._managed_identities_client_id = managed_identities_client_id
            if self._managed_identities_client_id:
                token, _ = self._get_managed_identities_token()
                self._headers = {'Authorization': f'Bearer {token}'}

        def http_request(
                self, *args, url_suffix="", params=None, resp_type='response', headers=None,
                return_empty_response=False, full_url="", **kwargs):
            """
            Overrides Base client request function.
            Create and adds to the headers the Authorization Header component before sending the request.
            Parse Azure XML response.
            Args:
                url_suffix (str): Request URL suffix.
                params (dict): Request Params.
                resp_type (str): Determines which data format to return from the HTTP request.
                headers (dict): Request Header.
                return_empty_response (bool): Return the response itself if the return_code is 201 or 204.
                full_url (str): Request full URL.
            Returns:
                Response from API according to resp_type.
            """

            if 'ok_codes' not in kwargs and not self._ok_codes:
                kwargs['ok_codes'] = (200, 201, 202, 204, 206, 404)

            if not full_url:
                # This logic will chain the SAS token along with the params
                # in order to create a valid URL for requests in Microsoft Azure Storage.
                # For example:
                # SAS token = '?sv=2020-08-04&ss=bt&spr=https&sig=t8'
                # params = '{'restype': 'directory', 'comp': 'list'}'
                # url_suffix = 'container'
                # The updated url_suffix after performing this logic will be:
                # url_suffix = 'container?sv=2020-08-04&ss=ay&spr=https&sig=s5&restype=directory&comp=list'
                params_query = self.params_dict_to_query_string(params, prefix='')
                uri_token_part = self._account_sas_token if self._account_sas_token.startswith('?') else f'?{self._account_sas_token}'
                url_suffix = f'{url_suffix}{uri_token_part}{params_query}'
                params = None

            default_headers = {'x-ms-version': self._api_version}

            if headers:
                default_headers.update(headers)

            if self._headers:
                default_headers.update(self._headers)

            response = super()._http_request(  # type: ignore[misc]
                *args, url_suffix=url_suffix, params=params, resp_type='response', headers=default_headers,
                full_url=full_url, **kwargs)

            # 206 indicates Partial Content, reason will be in the warning header.
            # In that case, logs with the warning header will be written.
            if response.status_code == 206:
                demisto.debug(str(response.headers))

            is_response_empty_and_successful = (response.status_code == 204 or response.status_code == 201)
            if is_response_empty_and_successful and return_empty_response:
                return response

            # Handle 404 errors instead of raising them as exceptions:
            if response.status_code == 404:
                try:
                    error_message = response.json()
                except Exception:
                    error_message = f'Not Found - 404 Response \nContent: {response.content}'
                raise NotFoundError(error_message)

            try:
                if resp_type == 'json':
                    return response.json()
                if resp_type == 'text':
                    return response.text
                if resp_type == 'content':
                    return response.content
                if resp_type == 'xml':
                    defused_ET.parse(response.text)
                return response
            except ValueError as exception:
                raise DemistoException('Failed to parse json object from response: {}'.format(response.content), exception)

        def _get_managed_identities_token(self):
            """
            Gets a token based on the Azure Managed Identities mechanism
            in case user was configured the Azure VM and the other Azure resource correctly
            """
            try:
                # system assigned are restricted to one per resource and is tied to the lifecycle of the Azure resource
                # see https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview
                demisto.debug('try to get token based on the Managed Identities')
                use_system_assigned = (self._managed_identities_client_id == MANAGED_IDENTITIES_SYSTEM_ASSIGNED)
                params = {}
                if not use_system_assigned:
                    params['client_id'] = self._managed_identities_client_id
                response_json = requests.get(MANAGED_IDENTITIES_TOKEN_URL,
                                             params=params, headers={'Metadata': 'True'}).json()
                access_token = response_json.get('access_token')
                expires_in = int(response_json.get('expires_in', 3595))
                if access_token:
                    return access_token, expires_in

                err = response_json.get('error_description')
            except Exception as e:
                err = f'{str(e)}'

            return_error(f'Error in Microsoft authorization with Azure Managed Identities: {err}')
            return None

        def params_dict_to_query_string(self, params: dict = None, prefix: str = "") -> str:
            """
            Convert request params to string query.
            Args:
                params (dict): Request Params.
                prefix (str): String prefix.

            Returns:
                str: String query.

            """
            if not params:
                return ""
            query = prefix
            for key, value in params.items():
                query += f'&{key}={value}'

            return query


    class NotFoundError(Exception):
        """Exception raised for 404 - Not Found errors.
        Attributes:
            message -- explanation of the error
        """

        def __init__(self, message):
            self.message = message


    def get_azure_managed_identities_client_id(params: dict) -> Optional[str]:
        """"extract the Azure Managed Identities from the demisto params

        Args:
            params (dict): the demisto params

        Returns:
            Optional[str]: if the use_managed_identities are True
            the managed_identities_client_id or MANAGED_IDENTITIES_SYSTEM_ASSIGNED
            will return, otherwise - None

        """
        auth_type = params.get('auth_type') or params.get('authentication_type')
        if params and (argToBoolean(params.get('use_managed_identities') or auth_type == 'Azure Managed Identities')):
            client_id = params.get('managed_identities_client_id', {}).get('password')
            return client_id or MANAGED_IDENTITIES_SYSTEM_ASSIGNED
        return None

    register_module_line('MicrosoftAzureStorageApiModule', 'end', __line__(), wrapper=1)
    ### END GENERATED CODE ###

    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()

    register_module_line('Azure Storage Container', 'end', __line__())
  subtype: python3
  type: python
system: true
