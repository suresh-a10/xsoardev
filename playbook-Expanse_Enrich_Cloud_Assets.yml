contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.0.0
    itemVersion: 1.10.54
    packID: ExpanseV2
    packName: Cortex Xpanse by Palo Alto Networks
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: |-
  Subplaybook for Handle Expanse Incident playbooks.
  This Playbook is meant to be used as a subplaybook to enrich Public Cloud Assets (i.e. IP addresses and FQDNs) by:
  - Searching the corresponding Region and Service by correlating the provided IPs with IP range feeds retrieved from Public Cloud Providers (require TIM and Public Cloud feeds such as AWS Feed integrations to be enabled).
  - Searching IPs and FQDNs in Prisma Cloud inventory (requires Prisma Cloud).
id: Expanse Enrich Cloud Assets
inputs:
- description: IP to enrich
  key: IP
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: expanseip
      root: incident
- description: FQDN to enrich
  key: FQDN
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: expansedomain
      root: incident
- description: Cloud Provider
  key: Provider
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: expanseprovider
      root: incident
- description: Tags to identify AWS IP Ranges
  key: AWSIndicatorTags
  playbookInputQuery: null
  required: false
  value:
    simple: AWS
- description: Tags to identify GCP IP Ranges
  key: GCPIndicatorTags
  playbookInputQuery: null
  required: false
  value:
    simple: GCP
- description: Tags to identify Azure IP Ranges
  key: AzureIndicatorTags
  playbookInputQuery: null
  required: false
  value:
    simple: Azure
- description: |-
    Flag to check whether to update incident

    Update means:
    - Set Expanse Region and Expanse Service to the values found from indicators
    - Link found indicators to the incident
  key: Update Incident
  playbookInputQuery: null
  required: false
  value:
    simple: "True"
name: Expanse Enrich Cloud Assets
outputs:
- contextPath: PrismaCloud.Attribution
  description: Prisma Cloud Asset Attribution
  type: unknown
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "146"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: fc1987a8-7ca8-4eca-84c3-74956c9795d1
      iscommand: false
      name: ""
      version: -1
    taskid: fc1987a8-7ca8-4eca-84c3-74956c9795d1
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 2050,
          "y": -70
        }
      }
  "37":
    continueonerrortype: ""
    id: "37"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "147"
    note: false
    quietmode: 0
    scriptarguments:
      CloudProvider:
        complex:
          root: inputs.Provider
      PublicIPAddress:
        complex:
          root: inputs.IP
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: Find a Public Cloud resource by Public IP using Prisma Cloud inventory
      id: 77125d17-2c04-4a2d-8aac-a5966553b72e
      iscommand: false
      name: Prisma Cloud - Find Public Cloud Resource by Public IP
      playbookId: Prisma Cloud - Find Public Cloud Resource by Public IP
      type: playbook
      version: -1
    taskid: 77125d17-2c04-4a2d-8aac-a5966553b72e
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 990,
          "y": 630
        }
      }
  "38":
    continueonerrortype: ""
    id: "38"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "147"
    note: false
    quietmode: 0
    scriptarguments:
      CloudProvider:
        complex:
          root: inputs.Provider
      FQDN:
        complex:
          root: inputs.FQDN
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: Find a Public Cloud resources by FQDN using Prisma Cloud inventory
      id: a6ab6b14-5c39-499a-8d70-44b4e9b90fce
      iscommand: false
      name: Prisma Cloud - Find Public Cloud Resource by FQDN
      playbookId: Prisma Cloud - Find Public Cloud Resource by FQDN
      type: playbook
      version: -1
    taskid: a6ab6b14-5c39-499a-8d70-44b4e9b90fce
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 1670,
          "y": 630
        }
      }
  "39":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.FQDN
          operator: isNotEmpty
      label: "yes"
    continueonerrortype: ""
    id: "39"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "147"
      "yes":
      - "38"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check whether any FQDN is present.
      id: 5caa0615-7696-4ba3-8069-549f930716be
      iscommand: false
      name: Is there a FQDN?
      type: condition
      version: -1
    taskid: 5caa0615-7696-4ba3-8069-549f930716be
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1930,
          "y": 450
        }
      }
  "142":
    continueonerrortype: ""
    id: "142"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "143"
    note: false
    quietmode: 0
    scriptarguments:
      AWSIndicatorTags:
        complex:
          root: inputs.AWSIndicatorTags
      AzureIndicatorTags:
        complex:
          root: inputs.AzureIndicatorTags
      GCPIndicatorTags:
        complex:
          root: inputs.GCPIndicatorTags
      Provider:
        complex:
          root: inputs.Provider
      ip:
        complex:
          root: inputs.IP
    separatecontext: true
    skipunavailable: false
    task:
      brand: ""
      description: Find Region and Service for IP Address belonging to Public Cloud,
        using Indicators (CIDRs)
      id: ced4197e-44fd-425d-8bd1-dfa0bb95e998
      iscommand: false
      name: Find Cloud IP Address Region and Service
      playbookId: Expanse Find Cloud IP Address Region and Service
      type: playbook
      version: -1
    taskid: ced4197e-44fd-425d-8bd1-dfa0bb95e998
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 3190,
          "y": 395
        }
      }
  "143":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: value
                root: MatchingCIDRIndicator
          operator: isNotEmpty
      label: "yes"
    continueonerrortype: ""
    id: "143"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "147"
      "yes":
      - "145"
      - "160"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check whether an indicator is found.
      id: ed54ec92-008d-4e56-8349-b108825cdeb6
      iscommand: false
      name: Found Indicator?
      type: condition
      version: -1
    taskid: ed54ec92-008d-4e56-8349-b108825cdeb6
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 3190,
          "y": 545
        }
      }
  "144":
    continueonerrortype: ""
    id: "144"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "147"
    note: false
    quietmode: 0
    scriptarguments:
      customFields:
        complex:
          root: IncidentRegionAndServiceQuery
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: commands.local.cmd.set.incident
      id: 179e8ec4-f637-4f00-8b0d-2d8a37de871e
      iscommand: true
      name: Set Incident Region and Service
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: 179e8ec4-f637-4f00-8b0d-2d8a37de871e
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 3620,
          "y": 920
        }
      }
  "145":
    continueonerrortype: ""
    id: "145"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "147"
    note: false
    quietmode: 0
    scriptarguments:
      id:
        complex:
          accessor: id
          root: MatchingCIDRIndicator
      incidentId:
        complex:
          accessor: id
          root: incident
      value:
        simple: ${MatchingCIDRIndicator}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: commands.local.cmd.associate.indicator
      id: bc9ef03b-a6bf-4fb5-8c73-d08ad10c0ee5
      iscommand: true
      name: Link Indicator
      script: Builtin|||associateIndicatorToIncident
      type: regular
      version: -1
    taskid: bc9ef03b-a6bf-4fb5-8c73-d08ad10c0ee5
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 3190,
          "y": 920
        }
      }
  "146":
    continueonerrortype: ""
    id: "146"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "39"
      - "161"
      - "162"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 65a1f874-59f0-4de4-8c12-933de46f246e
      iscommand: false
      name: Public Cloud Enrichment
      type: title
      version: -1
    taskid: 65a1f874-59f0-4de4-8c12-933de46f246e
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 50
        }
      }
  "147":
    continueonerrortype: ""
    id: "147"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 51d48b58-21cb-4734-809c-995e732f6a95
      iscommand: false
      name: Done Public Cloud Enrichment
      type: title
      version: -1
    taskid: 51d48b58-21cb-4734-809c-995e732f6a95
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 1090
        }
      }
  "160":
    continueonerrortype: ""
    id: "160"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "144"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: IncidentRegionAndServiceQuery
      value:
        complex:
          filters:
          - - left:
                iscontext: true
                value:
                  simple: MatchingCIDRIndicator.CustomFields
              operator: isNotEmpty
          root: MatchingCIDRIndicator
          transformers:
          - args:
              field:
                value:
                  simple: CustomFields
            operator: getField
          - args:
              expression:
                value:
                  simple: '{"expanseregion": region, "expanseservice": service} '
            operator: jmespath
          - operator: Stringify
          - args:
              limit: {}
              replaceWith:
                value:
                  simple: '""'
              toReplace:
                value:
                  simple: "null"
            operator: replace
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: 5a1893fb-5e1b-4150-8200-d8a2b676c2d9
      iscommand: false
      name: Create formatted string for Set Incident
      script: Set
      type: regular
      version: -1
    taskid: 5a1893fb-5e1b-4150-8200-d8a2b676c2d9
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 3620,
          "y": 750
        }
      }
  "161":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.IP
          operator: isNotEmpty
      label: "yes"
    continueonerrortype: ""
    id: "161"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "147"
      "yes":
      - "37"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check whether an IP is present.
      id: 4a7d2703-1890-497a-8909-4aab02fd711a
      iscommand: false
      name: Is there an IP?
      type: condition
      version: -1
    taskid: 4a7d2703-1890-497a-8909-4aab02fd711a
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1290,
          "y": 450
        }
      }
  "162":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                root: inputs.Update Incident
          operator: isEqualString
          right:
            value:
              simple: "True"
      label: "yes"
    continueonerrortype: ""
    id: "162"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "147"
      "yes":
      - "142"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check whether the incident has to be updated.
      id: b9dfe0cb-97b0-48d6-8119-c28c88c01a59
      iscommand: false
      name: Update incident?
      type: condition
      version: -1
    taskid: b9dfe0cb-97b0-48d6-8119-c28c88c01a59
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 2780,
          "y": 220
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "161_147_#default#": 0.11,
      "39_147_#default#": 0.31
    },
    "paper": {
      "dimensions": {
        "height": 1225,
        "width": 3010,
        "x": 990,
        "y": -70
      }
    }
  }
