contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.9.0
    itemVersion: 1.1.19
    packID: GCP-Enrichment-Remediation
    packName: GCP Enrichment and Remediation
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: |-
  ## **GCP Credentials Rotation Playbook**

  ### **IAM Remediation**
  For compromised service accounts:
  - **Access Key Disabling**: Immediately disable the compromised service account access key.

  - **New Key Generation**: After ensuring the old key is disabled, generate a new access key.

  ### **GSuite Admin Remediation**
  Admin accounts are crucial:
  - **Reset Password**: Resets the user password to halt any unauthorized access.

  - **Revoke Access Token**: Revoke any suspicious or unauthorized access tokens.

  - **Combo Action**: Reset the password and revoke access tokens to ensure complete safety.
id: Cloud Credentials Rotation - GCP
inputs:
- description: |-
    The response playbook provides the following remediation actions using GSuite Admin:

    Reset: By entering "Reset" in the input, the playbook will execute password reset.

    Revoke: By entering "Revoke" in the input, the playbook will execute access key suspension. (Both the user and client IDs must be provided)

    ALL: By entering "ALL" in the input, the playbook will execute the password reset and revoke access key tasks.
  key: GSuiteRemediationType
  playbookInputQuery: null
  required: false
  value: {}
- description: Identifies the user in the API request. The value can be the user's
    primary email address, alias email address, or unique user ID.
  key: userID
  playbookInputQuery: null
  required: false
  value: {}
- description: The client ID.
  key: clientID
  playbookInputQuery: null
  required: false
  value: {}
- description: The name of the zone.
  key: zone
  playbookInputQuery: null
  required: false
  value: {}
- description: The service account email.
  key: serviceAccountEmail
  playbookInputQuery: null
  required: false
  value: {}
- description: |-
    The type of identity involved. Usually mapped to the incident field named 'cloudidentitytype'.
    e.g.
    USER,SERVICE_ACCOUNT,APPLICATION
  key: identityType
  playbookInputQuery: null
  required: false
  value: {}
- description: The relevant project that the alert relates to.
  key: cloudProject
  playbookInputQuery: null
  required: false
  value: {}
name: Cloud Credentials Rotation - GCP
outputs:
- contextPath: GoogleCloudCompute.Instances
  description: Google Cloud Compute instance information.
  type: unknown
- contextPath: GCPIAM.ServiceAccountKey
  description: The service account keys.
  type: unknown
- contextPath: GCPIAM.ServiceAccount
  description: The service account information.
  type: unknown
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "28"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 97236be9-5405-410e-8660-81f5ee7e9c65
      iscommand: false
      name: ""
      version: -1
    taskid: 97236be9-5405-410e-8660-81f5ee7e9c65
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 1440,
          "y": -40
        }
      }
  "5":
    continueonerrortype: ""
    id: "5"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "6"
    note: false
    quietmode: 0
    scriptarguments:
      zone:
        complex:
          root: inputs.zone
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Retrieves the list of instances contained within the specified
        zone.
      id: c2a274db-fb51-4049-8009-a7d72635685d
      iscommand: true
      name: List zone related instances
      script: '|||gcp-compute-list-instances'
      type: regular
      version: -1
    taskid: c2a274db-fb51-4049-8009-a7d72635685d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 420
        }
      }
  "6":
    continueonerrortype: ""
    id: "6"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "9"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: possibleCompromisedInstances
      value:
        complex:
          accessor: name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: GoogleCloudCompute.Instances.serviceAccounts.email
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.serviceAccountEmail
          root: GoogleCloudCompute.Instances
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: 55df6642-23fc-449f-88d5-41a87268aa33
      iscommand: false
      name: Set possible compromised instances
      script: Set
      type: regular
      version: -1
    taskid: 55df6642-23fc-449f-88d5-41a87268aa33
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 590
        }
      }
  "7":
    continueonerrortype: ""
    id: "7"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "24"
    note: false
    quietmode: 0
    scriptarguments:
      key_name:
        complex:
          accessor: name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: GCPIAM.ServiceAccountKey.keyType
              operator: isEqualString
              right:
                value:
                  simple: USER_MANAGED
          root: GCPIAM.ServiceAccountKey
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Disables a service account key.
      id: c8da559a-4bf0-45cb-80b5-2e12504ebc4c
      iscommand: true
      name: Disable the SA access key
      script: '|||gcp-iam-service-account-key-disable'
      type: regular
      version: -1
    taskid: c8da559a-4bf0-45cb-80b5-2e12504ebc4c
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1380
        }
      }
  "9":
    continueonerrortype: ""
    id: "9"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "27"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: d53db53c-f69d-4637-833c-52d2f7793d45
      iscommand: false
      name: GCP IAM
      type: title
      version: -1
    taskid: d53db53c-f69d-4637-833c-52d2f7793d45
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 890,
          "y": 760
        }
      }
  "10":
    continueonerrortype: ""
    id: "10"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "14"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 938c214c-b12b-4385-8f6e-3e08bb17cdee
      iscommand: false
      name: GSuite Admin
      type: title
      version: -1
    taskid: 938c214c-b12b-4385-8f6e-3e08bb17cdee
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 285
        }
      }
  "11":
    continueonerrortype: ""
    id: "11"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      client_id:
        complex:
          root: inputs.clientID
      user_key:
        complex:
          root: inputs.userID
    separatecontext: false
    skipunavailable: true
    task:
      brand: GSuiteAdmin
      description: Delete all access tokens issued by a user for an application.
      id: 583b9d1b-6b72-4016-8e0b-c74ec8a31949
      iscommand: true
      name: Revoke access token
      script: '|||gsuite-token-revoke'
      type: regular
      version: -1
    taskid: 583b9d1b-6b72-4016-8e0b-c74ec8a31949
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 2480,
          "y": 730
        }
      }
  "13":
    continueonerrortype: ""
    id: "13"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      password:
        complex:
          root: NEW_PASSWORD
      user_key:
        complex:
          root: inputs.userID
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Updates a user.
      id: 245d5d3a-a9c3-4e95-803a-d880242426bc
      iscommand: true
      name: Reset password
      script: '|||gsuite-user-update'
      type: regular
      version: -1
    taskid: 245d5d3a-a9c3-4e95-803a-d880242426bc
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 890
        }
      }
  "14":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                root: inputs.GSuiteRemediationType
          operator: isEqualString
          right:
            value:
              simple: Revoke
      label: Revoke Access Key
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                root: inputs.GSuiteRemediationType
          operator: isEqualString
          right:
            value:
              simple: Reset
      label: Reset Password
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                root: inputs.GSuiteRemediationType
          operator: isEqualString
          right:
            value:
              simple: ALL
      label: ALL
    continueonerrortype: ""
    id: "14"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      ALL:
      - "15"
      Reset Password:
      - "26"
      Revoke Access Key:
      - "11"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks the remediation type provided by the user.
      id: 6f5cb0a9-73fa-41de-87f5-aed9d1ea4314
      iscommand: false
      name: Check remediation type
      type: condition
      version: -1
    taskid: 6f5cb0a9-73fa-41de-87f5-aed9d1ea4314
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 420
        }
      }
  "15":
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "11"
      - "26"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: d286d49d-29f1-4ab2-84b5-ac4f184bf669
      iscommand: false
      name: ALL
      type: title
      version: -1
    taskid: d286d49d-29f1-4ab2-84b5-ac4f184bf669
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 2860,
          "y": 590
        }
      }
  "18":
    continueonerrortype: ""
    id: "18"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 54427b29-32dc-4a4f-8fd9-1ba930a24f1e
      iscommand: false
      name: IAM
      type: title
      version: -1
    taskid: 54427b29-32dc-4a4f-8fd9-1ba930a24f1e
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 890,
          "y": 285
        }
      }
  "22":
    continueonerrortype: ""
    id: "22"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: e3137645-f549-499c-80f6-509fa3e2f549
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: e3137645-f549-499c-80f6-509fa3e2f549
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 1710
        }
      }
  "24":
    continueonerrortype: ""
    id: "24"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key_algorithm:
        simple: KEY_ALG_RSA_2048
      service_account_name:
        complex:
          accessor: name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: GCPIAM.ServiceAccount.email
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.serviceAccountEmail
          root: GCPIAM.ServiceAccount
          transformers:
          - operator: FirstArrayElement
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Creates a service account key. A service account can have up to
        10 keys. Service account keys that you create don't have an expiry date and
        stay valid until you delete them.
      id: be4ec206-ae55-4e9f-8d22-4e85ccac6b12
      iscommand: true
      name: Rotate the SA access key
      script: '|||gcp-iam-service-account-key-create'
      type: regular
      version: -1
    taskid: be4ec206-ae55-4e9f-8d22-4e85ccac6b12
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1540
        }
      }
  "25":
    continueonerrortype: ""
    id: "25"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "7"
    note: false
    quietmode: 0
    scriptarguments:
      service_account_name:
        complex:
          accessor: name
          filters:
          - - left:
                iscontext: true
                value:
                  simple: GCPIAM.ServiceAccount.email
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.serviceAccountEmail
          root: GCPIAM.ServiceAccount
          transformers:
          - operator: FirstArrayElement
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: 'Lists service account keys, or retrieves a specific service account
        key information. One of the arguments: ''service_account_name'' or ''key_name''  must
        be provided.'
      id: 15988aab-f39b-434b-845d-67c5afd9dd42
      iscommand: true
      name: Get the service account keys
      script: '|||gcp-iam-service-account-keys-get'
      type: regular
      version: -1
    taskid: 15988aab-f39b-434b-845d-67c5afd9dd42
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1220
        }
      }
  "26":
    continueonerrortype: ""
    id: "26"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "13"
    note: false
    quietmode: 0
    scriptarguments:
      min_digits:
        simple: "5"
      min_lcase:
        simple: "5"
      min_symbols:
        simple: "1"
      min_ucase:
        simple: "1"
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: "This function generates a password and allows various parameters
        to customize the properties of the password depending on the use case (e.g.
        password complexity requirements).  The default behavior is to generate a
        password of  *random length* including all four character classes (upper,
        lower, digits, symbols) with at least five and at most ten characters per
        class. \n\nThe min_* values all default to 0. This means that if the command
        is executed in this way:\n!GeneratePassword max_lcase=10\nIt is possible that
        a password of length zero could be generated. It is therefore recommended
        to always include a min_* parameter that matches. \n\nThe debug parameter
        will print certain properties of the command into the WarRoom for easy diagnostics."
      id: 1a01cfe3-cc5b-45f0-8ed2-61cf0d109676
      iscommand: false
      name: Generate Password
      script: GeneratePassword
      type: regular
      version: -1
    taskid: 1a01cfe3-cc5b-45f0-8ed2-61cf0d109676
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 730
        }
      }
  "27":
    continueonerrortype: ""
    id: "27"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "29"
    note: false
    quietmode: 0
    scriptarguments:
      limit:
        simple: "100"
      project_name:
        complex:
          root: inputs.cloudProject
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: 'Lists service accounts in project, or retrieves a specific service
        accounts information. One of the arguments: ''service_account_name'' or ''project_name''  must
        be provided.'
      id: 7998e364-c06d-4c7e-8799-32d1ada7aa64
      iscommand: true
      name: List service accounts
      script: '|||gcp-iam-service-accounts-get'
      type: regular
      version: -1
    taskid: 7998e364-c06d-4c7e-8799-32d1ada7aa64
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 890
        }
      }
  "28":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.identityType
          operator: isEqualString
          right:
            value:
              simple: SERVICE_ACCOUNT
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.zone
          operator: isNotEmpty
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.serviceAccountEmail
          operator: isNotEmpty
      label: SA
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                root: inputs.identityType
          operator: isEqualString
          right:
            value:
              simple: User
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.userID
          operator: isNotEmpty
      label: USER
    continueonerrortype: ""
    id: "28"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      SA:
      - "18"
      USER:
      - "10"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks the identity type that was part of the alert.
      id: e4c0bc44-856f-48cd-85a9-b6e699dd8b17
      iscommand: false
      name: Check identity type
      type: condition
      version: -1
    taskid: e4c0bc44-856f-48cd-85a9-b6e699dd8b17
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 110
        }
      }
  "29":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: email
                root: GCPIAM.ServiceAccount
          operator: containsString
          right:
            iscontext: true
            value:
              complex:
                root: inputs.serviceAccountEmail
      label: "yes"
    continueonerrortype: ""
    id: "29"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "25"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks if the alerted service account is part of the 'service-accounts-get'
        response.
      id: a12c7ce8-164a-4b6f-8d46-41d0600e6ea3
      iscommand: false
      name: Was the service account retrieved in the previous task?
      type: condition
      version: -1
    taskid: a12c7ce8-164a-4b6f-8d46-41d0600e6ea3
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1050
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "14_11_Revoke Access Key": 0.77,
      "14_15_ALL": 0.33,
      "14_22_#default#": 0.21,
      "14_26_Reset Password": 0.59,
      "28_10_USER": 0.73,
      "28_18_SA": 0.68,
      "28_22_#default#": 0.1,
      "29_22_#default#": 0.37,
      "29_25_yes": 0.42
    },
    "paper": {
      "dimensions": {
        "height": 1815,
        "width": 2350,
        "x": 890,
        "y": -40
      }
    }
  }
