category: Utilities
commonfields:
  id: Sentinel
  version: -1
configuration:
- display: Server URL (e.g. https://soar.monstersofhack.com)
  name: tenantUrl
  required: true
  type: 0
- display: ""
  name: username
  required: false
  type: 0
- display: ""
  name: password
  required: false
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: This is the Hello World integration for getting started.
detaileddescription: |-
  ### Community Contributed Integration
   #### Integration Author: Cortex XSOAR
   No support or maintenance is provided by the author. Customers are encouraged to engage with the user community for questions and guidance at the [Cortex XSOAR Live Discussions](https://live.paloaltonetworks.com/t5/cortex-xsoar-discussions/bd-p/Cortex_XSOAR_Discussions).
  ***
  ## Hello World
  - This section explains how to configure the instance of HelloWorld in Cortex XSOAR.
  - You can use the following API Key: `43ea9b2d-4998-43a6-ae91-aba62a26868c`

  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/hello-world)
display: Sentinel
image: data:image/png;base64,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
name: Sentinel
script:
  commands:
  - arguments:
    - description: Enter IP to fetch details from Sentinel
      name: ip
    - description: Enter hostname to fetch details from Sentinel
      name: hostname
    - description: The device owner's employee id to fetch details from Sentinel
      name: empid
    name: sentinel-get-details
  dockerimage: demisto/python3:3.9.8.24399
  runonce: false
  script: |2-

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()  # pylint: disable=no-member

    URL = ''
    VERIFY = False
    DEFAULT_LIMIT = 100
    USERNAME = demisto.params().get('username')
    PASSWORD = demisto.params().get('password')

    # Standard headers
    HEADERS = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36','Content-Type': 'application/json', 'Accept': 'application/json'}

    TOKEN = None

    def authenticate_oauth():
        """
        Login using the credentials and store the cookie
        """
        integration_context = demisto.getIntegrationContext()
        # print(integration_context)
        TOKEN = integration_context.get('bearer_token')
        valid_until = integration_context.get('valid_until')
        time_now = int(time.time())
        # print(time_now)
        if TOKEN and valid_until:
            if time_now < valid_until:
                # Bearer Token is still valid - did not expire yet
                HEADERS['Authorization'] = f"Bearer {TOKEN}"
                return TOKEN

        TOKEN = get_token()
        t = time.time()
        expiration_time = t + 120
        integration_context = {
            'bearer_token': TOKEN,
            'valid_until': expiration_time  # Assuming the expiration time is 2 minutes
        }
        demisto.setIntegrationContext(integration_context)
        # print(integration_context)
        HEADERS['Authorization'] = f"Bearer {TOKEN}"
        return TOKEN

    def get_token():
        """
        Retrieve the token using the credentials
        """
        response = requests.post(URL + 'NonUtxMod/rest/authenticate', headers=HEADERS, verify=VERIFY, json={
            'username': USERNAME,
            'password': PASSWORD
        })

        if response.status_code != requests.codes.ok:  # pylint: disable=no-member
            raise Exception('Error authenticating to Sentinel [%d] - %s' % (response.status_code, response.text))
        try:
            response_json = response.json()
            TOKEN = response_json.get('token')
            if not TOKEN:
                demisto.debug(json.dumps(response_json))
                message = 'Could not retrieve token from server: {}'.format(response_json.get("message"))

                raise Exception(message)
        except ValueError as exception:
            demisto.log(exception)
            raise Exception('Could not parse API response.')
        bearer_token = "Bearer " + TOKEN
        HEADERS['Authorization'] = bearer_token
        return TOKEN


    def req(method, path, data=None, param_data=None):
        """
        Generic request to Sentinel
        """
        if not TOKEN:
            token=authenticate_oauth()
            # token=get_token()
        response = requests.request(method, URL + path, json=data, params=param_data, headers=HEADERS, verify=VERIFY)
        # print(response.json())
        res=response.json()
        return res


    def get_details(ip="",hostname="",empid=""):


        body={
          "ip":ip,
          "hostName":hostname,
          "deviceOwnerId":empid
        }


        results=req('POST', 'NonUtxMod/rest/senGetinventoryDetails', data=body)

        ec = {
                'Sentinel(val.ID && val.ID === obj.ID)': results
        }
        headers=[]
        res=[]
        if results:
            for i in results:
                res.append({
                    'Asset ID':i['asset_ID'],
                    'Device Owner Employee ID':i['device_Owner_ID'],
                    'Hostname':i['hostname'],
                    'IP Address':i['ip_Address'],
                    'Country':i['country'],
                    'Branch':i['branch'],
                    'Location':i['location'],
                    'Allocated SWON':i['allocated_Swon'],
                    'Allocated Project Name':i['allocated_Project_Name'],
                    'Device Status':i['device_Status'],
                    'Device Type':i['device_Type'],
                    'Type Of Asset':i['type_of_Asset'],
                    'Zone':i['zone'],
                    'Application Owner':i['application_Owner'],
                    'Managed By':i['managed_By'],
                    'Vertical Owner':i['vertical_Owner'],
                    'Geography':i['geography'],
                })

            headers = list(res[0].keys())

        title = 'Sentinel Information'
        entry = {
            'Type': entryTypes['note'],
            'Contents': results,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, res, headers),
            'EntryContext': ec
        }
        return entry


    def main():
        global URL, VERIFY
        handle_proxy()
        params = demisto.params()
        URL = params.get('tenantUrl')


        if URL[-1] != '/':
            URL += '/'
        VERIFY = not params.get('insecure', False)
        try:
            command = demisto.command()
            args = demisto.args()

            if command == 'test-module':
                results=get_token()
                return_results('ok')

            elif command == 'sentinel-get-details':
                result=get_details(**args)
                demisto.results(result)

        except Exception as err:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(str(err))


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
