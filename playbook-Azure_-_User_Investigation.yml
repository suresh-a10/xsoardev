contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.9.0
    itemVersion: 1.1.19
    packID: Azure-Enrichment-Remediation
    packName: Azure Enrichment and Remediation
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: |-
  This playbook performs an investigation on a specific user in Azure environments, using queries and logs from Azure Log Analytics to locate the following activities performed by the user:
  - Script-based user agent usage
  - Administrative user activities
  - Security rules and policies changes
  - Failed login attempt
  - MFA failed login attempt
  - Login attempt from an uncommon country
  - Anomalies activities
  - Risky users
  - Uncommon high volume of actions
  - Action uncommonly performed by the user
id: Azure - User Investigation
inputs:
- description: The username to investigate.
  key: Username
  playbookInputQuery: null
  required: false
  value: {}
- description: 'The Search Time for the Azure Log Analytics search query. Default
    value: ago(1d)'
  key: AzureSearchTime
  playbookInputQuery: null
  required: false
  value:
    simple: ago(7d)
- description: The threshold number of failed logons by the user. Required to determine
    how many failed logon events count as suspicious events.
  key: failedLogonThreshold
  playbookInputQuery: null
  required: false
  value:
    simple: "20"
- description: The threshold number of MFA failed logons by the user. Required to
    determine how many MFA failed logon events count as suspicious events.
  key: MfaAttemptThreshold
  playbookInputQuery: null
  required: false
  value:
    simple: "10"
name: Azure - User Investigation
outputs:
- contextPath: AzureScriptBasedUserAgentEvents
  description: Script-based user agent events used by the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureScriptBasedUserAgentCount
  description: The number of script-based user agent usages by the user in the Azure
    environment.
  type: number
- contextPath: AzureAdminActivitiesEvents
  description: Administrative activities performed by the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureAdminActivitiesCount
  description: The number of administrative activities performed by the user in the
    Azure environment.
  type: number
- contextPath: AzureSecurityRulesChangeEvents
  description: Security rules that were changed by the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureSecurityRulesChangeCount
  description: The number of security rules that were changed by the user in the Azure
    environment.
  type: number
- contextPath: AzureUnsuccessSecurityRulesChangeEvents
  description: Unsuccessful attempts to change security rules by the user in the Azure
    environment.
  type: string
- contextPath: CountAzureEvents.AzureUnsuccessSecurityRulesChangeCount
  description: The number of unsuccessful attempts to change security rules by the
    user in the Azure environment.
  type: number
- contextPath: AzureFailLoginCount
  description: The number of failed logins by the user in the Azure environment.
  type: number
- contextPath: AzureFailLoginMFACount
  description: The number of failed logins by the user using MFA in the Azure environment.
  type: number
- contextPath: AzureAnomaliesEvents
  description: Anomaly events on the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureAnomaliesCount
  description: The number of anomaly events on the user in the Azure environment.
  type: number
- contextPath: AzureRiskyUserCount
  description: The number of events where the user was defined as a risky user in
    the Azure environment.
  type: number
- contextPath: AzureUncommonCountryLogonEvents
  description: Uncommon country logon events by the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureUncommonCountryLogonCount
  description: The number of uncommon country logon events by the user in the Azure
    environment.
  type: number
- contextPath: AzureUncommonVolumeEvents
  description: Uncommon volume events by the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureUncommonVolumeCount
  description: The number of uncommon volume events by the user in the Azure environment.
  type: number
- contextPath: AzureUncommonActivitiesEvents
  description: Uncommon activity events by the user in the Azure environment.
  type: string
- contextPath: CountAzureEvents.AzureUncommonActivitiesCount
  description: The number of uncommon activity events by the user in the Azure environment.
  type: number
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "1"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 5aee39e8-c3e3-4825-8b99-253c7d8ddabc
      iscommand: false
      name: ""
      version: -1
    taskid: 5aee39e8-c3e3-4825-8b99-253c7d8ddabc
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 240,
          "y": -80
        }
      }
  "1":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: state
                filters:
                - - ignorecase: true
                    left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: Azure Log Analytics
                root: modules
          operator: isEqualString
          right:
            value:
              simple: active
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.Username
          operator: isNotEmpty
      label: "yes"
    continueonerrortype: ""
    id: "1"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "9"
      - "8"
      - "7"
      - "37"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks if the Azure Log Analytics integration is enabled.
      id: 4286364d-bd10-43b7-8838-3d2f13d1eb87
      iscommand: false
      name: Is Azure Log Analytics enabled and the user name is defined?
      type: condition
      version: -1
    taskid: 4286364d-bd10-43b7-8838-3d2f13d1eb87
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 240,
          "y": 60
        }
      }
  "2":
    continueonerrortype: ""
    id: "2"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "29"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureUncommonCountryLogon=
      query:
        simple: "BehaviorAnalytics\n| where ActivityInsights.FirstTimeUserConnectedFromCountry
          == \"True\"\n| where UserPrincipalName == \"${inputs.Username}\" \n| where
          TimeGenerated > ${inputs.AzureSearchTime}\n| summarize Count = count(),
          Events = make_list(ActionType)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: c793822a-6a73-4cef-87b4-cf6363c0b4ac
      iscommand: true
      name: Logon attempt from uncommon country
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: c793822a-6a73-4cef-87b4-cf6363c0b4ac
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -850,
          "y": 750
        }
      }
  "4":
    continueonerrortype: ""
    id: "4"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "39"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: e3afb9b9-75b2-40da-8154-347de63aaedb
      iscommand: false
      name: BehaviorAnalytics (Sentinel)
      type: title
      version: -1
    taskid: e3afb9b9-75b2-40da-8154-347de63aaedb
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -850,
          "y": 420
        }
      }
  "5":
    continueonerrortype: ""
    id: "5"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "40"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 251ebe3b-f61c-4a7f-8173-6b3207bb53b5
      iscommand: false
      name: IdentityInfo (Sentinel)
      type: title
      version: -1
    taskid: 251ebe3b-f61c-4a7f-8173-6b3207bb53b5
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -430,
          "y": 420
        }
      }
  "6":
    continueonerrortype: ""
    id: "6"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "38"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 5a31e359-3437-4f0c-8580-2940c2532994
      iscommand: false
      name: Anomalies (Sentinel)
      type: title
      version: -1
    taskid: 5a31e359-3437-4f0c-8580-2940c2532994
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -10,
          "y": 420
        }
      }
  "7":
    continueonerrortype: ""
    id: "7"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "14"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 4b3731b9-77c7-4702-8cad-a6e33593e1ed
      iscommand: false
      name: SigninLogs
      type: title
      version: -1
    taskid: 4b3731b9-77c7-4702-8cad-a6e33593e1ed
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 490,
          "y": 420
        }
      }
  "8":
    continueonerrortype: ""
    id: "8"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: b1c902eb-61da-4b74-8ac4-e37f117a93d2
      iscommand: false
      name: AzureActivity
      type: title
      version: -1
    taskid: b1c902eb-61da-4b74-8ac4-e37f117a93d2
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 910,
          "y": 420
        }
      }
  "9":
    continueonerrortype: ""
    id: "9"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 72248260-9922-4787-8a99-52eab98184e5
      iscommand: false
      name: AuditLogs
      type: title
      version: -1
    taskid: 72248260-9922-4787-8a99-52eab98184e5
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 420
        }
      }
  "10":
    continueonerrortype: ""
    id: "10"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "30"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureUncommonVolume=
      query:
        simple: "BehaviorAnalytics\n| where ActivityInsights.UncommonHighVolumeOfActions
          == \"True\"\n| where UserPrincipalName == \"${inputs.Username}\" \n| where
          TimeGenerated > ${inputs.AzureSearchTime}\n| summarize Count = count(),
          Events = make_list(ActionType)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: a1fb3fb9-345e-4457-86bc-68967d850bf8
      iscommand: true
      name: Uncommon high volume of actions
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: a1fb3fb9-345e-4457-86bc-68967d850bf8
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -850,
          "y": 1100
        }
      }
  "11":
    continueonerrortype: ""
    id: "11"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "31"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureUncommonActivities=
      query:
        simple: |-
          BehaviorAnalytics
          | where ActivityInsights.ActionUncommonlyPerformedByUser == "True"
          | where UserPrincipalName == "${inputs.Username}"
          | where TimeGenerated > ${inputs.AzureSearchTime}
          | summarize Count = count(), Events = make_list(ActionType)
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: 003261b4-1cbb-4e46-86db-7ddc89bd98ef
      iscommand: true
      name: Action uncommonly performed by user
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 003261b4-1cbb-4e46-86db-7ddc89bd98ef
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -850,
          "y": 1460
        }
      }
  "12":
    continueonerrortype: ""
    id: "12"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "35"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureRiskyUser=
      query:
        simple: |-
          IdentityInfo
          | where RiskState contains "Risk"
          | where RiskLevel == "High"
          | where AccountUPN == "${inputs.Username}"
          | where TimeGenerated >  ${inputs.AzureSearchTime}
          | summarize Count = count()
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: fdbda8a8-0c68-41ff-8383-b234f5796ebe
      iscommand: true
      name: Check if the user is defined as a risky user
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: fdbda8a8-0c68-41ff-8383-b234f5796ebe
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -430,
          "y": 750
        }
      }
  "13":
    continueonerrortype: ""
    id: "13"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "28"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureAnomalies=
      query:
        simple: "Anomalies \n| where UserPrincipalName ==  \"${inputs.Username}\"\n|
          where TimeGenerated >  ${inputs.AzureSearchTime}\n| summarize Count = count(),
          Events = make_list(AnomalyDetails)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: 5f98b4bb-04f8-4322-8552-6811832e17a4
      iscommand: true
      name: Anomalies for the user
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 5f98b4bb-04f8-4322-8552-6811832e17a4
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -10,
          "y": 750
        }
      }
  "14":
    continueonerrortype: ""
    id: "14"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "33"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureNumOfFailLogin=
      query:
        simple: "SigninLogs \n| where parse_json(Status) contains \"fail\"\n| where
          UserPrincipalName == \"${inputs.Username}\"\n| where TimeGenerated > ${inputs.AzureSearchTime}\n|
          summarize ActionCount = count() by UserPrincipalName\n| where ActionCount
          > ${inputs.failedLogonThreshold}\n| summarize Count = count()"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: c9c89daa-d7bf-48cc-8efd-16ce1ac02113
      iscommand: true
      name: Failed login attempts by the user
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: c9c89daa-d7bf-48cc-8efd-16ce1ac02113
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 490,
          "y": 570
        }
      }
  "15":
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "24"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureScriptBasedUserAgent=
      ignore-outputs:
        simple: "false"
      query:
        simple: "AuditLogs \n| where parse_json(tostring(InitiatedBy.user)).userPrincipalName
          == \"${inputs.Username}\" \n| where AdditionalDetails[0].value contains
          \"python\" or AdditionalDetails[0].value contains \"curl\" or AdditionalDetails[0].value
          contains \"axios\" or AdditionalDetails[0].value contains \"httpie\" or
          AdditionalDetails[0].value contains \"wget\"\n| where TimeGenerated > ${inputs.AzureSearchTime}\n|
          summarize Count = count(), Events = make_list(AdditionalDetails)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: 3f60ee79-cdd8-4732-8bf0-1eb7494a072f
      iscommand: true
      name: Check for script-based user agent
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 3f60ee79-cdd8-4732-8bf0-1eb7494a072f
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 570
        }
      }
  "18":
    continueonerrortype: ""
    id: "18"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "26"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureSuccessSecurityRulesChange=
      query:
        simple: "AzureActivity\n| where OperationName in (\"Delete Security Rule\",\"Create
          or Update Security Rule\",\"Update Alert Rules\",\"Delete Alert Rules\",\"Delete
          Watchlists\",\"Update Watchlists\",\"Microsoft.SecurityInsights/watchlists/watchlistItems/delete\",\"Create
          or Update Application Gateway WAF Policy\",\"Delete Application Gateway
          WAF Policy\",\"Update database threat detection policy\")\n| where ActivityStatus
          == \"Succeeded\"\n| where Caller ==  \"${inputs.Username}\" \n| where TimeGenerated
          > ${inputs.AzureSearchTime}\n| summarize Count = count(), Events = make_list(OperationName)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: 231a71b4-5b1f-4b2b-8a38-864e0c704167
      iscommand: true
      name: Security rules were changed successfully
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 231a71b4-5b1f-4b2b-8a38-864e0c704167
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 910,
          "y": 570
        }
      }
  "19":
    continueonerrortype: ""
    id: "19"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "27"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureUnsuccessSecurityRulesChange=
      query:
        simple: "AzureActivity\n| where OperationName in (\"Delete Security Rule\",\"Create
          or Update Security Rule\",\"Update Alert Rules\",\"Delete Alert Rules\",\"Delete
          Watchlists\",\"Update Watchlists\",\"Microsoft.SecurityInsights/watchlists/watchlistItems/delete\",\"Create
          or Update Application Gateway WAF Policy\",\"Delete Application Gateway
          WAF Policy\",\"Update database threat detection policy\")\n| where ActivityStatus
          != \"Succeeded\"\n| where Caller ==  \"${inputs.Username}\" \n| where TimeGenerated
          > ${inputs.AzureSearchTime}\n| summarize Count = count(), Events = make_list(OperationName)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: 2c78c73a-079c-4c66-884d-c30be565c963
      iscommand: true
      name: An unsuccessful attempt to change security rules
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 2c78c73a-079c-4c66-884d-c30be565c963
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 910,
          "y": 930
        }
      }
  "21":
    continueonerrortype: ""
    id: "21"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "25"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureAdminActivities=
      ignore-outputs:
        simple: "false"
      query:
        simple: "AuditLogs\n| where parse_json(tostring(InitiatedBy.user)).userPrincipalName
          ==  \"${inputs.Username}\" \n| where Category in (\"ApplicationManagement\",
          \"UserManagement\", \"PolicyManagement\", \"GroupManagement\")| where Result
          == \"success\"\n| where TimeGenerated > ${inputs.AzureSearchTime}\n| summarize
          Count = count(), Events = make_list(OperationName)"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: a4968328-3479-4eef-80f1-f42aab2c6fe4
      iscommand: true
      name: Search for administrative user activities
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: a4968328-3479-4eef-80f1-f42aab2c6fe4
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 930
        }
      }
  "22":
    continueonerrortype: ""
    id: "22"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "32"
    note: false
    quietmode: 0
    scriptarguments:
      keys:
        simple: AzureScriptBasedUserAgentCount,AzureAdminActivitiesCount,AzureSecurityRulesChangeCount,AzureUnsuccessSecurityRulesChangeCount,AzureAnomaliesCount,AzureUncommonCountryLogonCount,AzureUncommonVolumeCount,AzureUncommonActivitiesCount
      parent:
        simple: CountAzureEvents
      values:
        simple: ${AzureScriptBasedUserAgent.tables.rows.[0].[0]},${AzureAdminActivities.tables.rows.[0].[0]},${AzureSuccessSecurityRulesChange.tables.rows.[0].[0]},${AzureUnsuccessSecurityRulesChange.tables.rows.[0].[0]},${AzureAnomalies.tables.rows.[0].[0]},${AzureUncommonCountryLogon.tables.rows.[0].[0]},${AzureUncommonVolume.tables.rows.[0].[0]},${AzureUncommonActivities.tables.rows.[0].[0]}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set multiple keys/values to the context.
      id: 2a2bf514-43ab-4e9b-8e9f-c76ba315d16a
      iscommand: false
      name: Set events count
      script: SetMultipleValues
      type: regular
      version: -1
    taskid: 2a2bf514-43ab-4e9b-8e9f-c76ba315d16a
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 240,
          "y": 1810
        }
      }
  "23":
    continueonerrortype: ""
    id: "23"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "34"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureNumOfFailMFA=
      query:
        simple: "SigninLogs \n| where ResultType =~ \"50074\"\n| where UserPrincipalName
          == \"${inputs.Username}\"\n| where TimeGenerated > ${inputs.AzureSearchTime}\n|
          summarize ActionCount = count() by UserPrincipalName\n| where ActionCount
          > ${inputs.MfaAttemptThreshold}"
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an Analytics query for data.
      id: 87060e96-667d-49a4-8b5a-3072fd4553a1
      iscommand: true
      name: The user did not pass the MFA challenge
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 87060e96-667d-49a4-8b5a-3072fd4553a1
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 490,
          "y": 930
        }
      }
  "24":
    continueonerrortype: ""
    id: "24"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "21"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureScriptBasedUserAgentEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureScriptBasedUserAgent.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: e54197e5-9cf6-4f4f-8875-7e43bdef9808
      iscommand: false
      name: Set script-based user agent events
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: e54197e5-9cf6-4f4f-8875-7e43bdef9808
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 750
        }
      }
  "25":
    continueonerrortype: ""
    id: "25"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureAdminActivitiesEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureAdminActivities.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 69fa497d-ca2e-4891-8b51-842262dc8cfe
      iscommand: false
      name: Set administrative events
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 69fa497d-ca2e-4891-8b51-842262dc8cfe
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 1110
        }
      }
  "26":
    continueonerrortype: ""
    id: "26"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "19"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureSecurityRulesChangeEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureSuccessSecurityRulesChange.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 632abf51-3069-4d39-8307-d88729788b94
      iscommand: false
      name: Set security rules changed events
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 632abf51-3069-4d39-8307-d88729788b94
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 910,
          "y": 750
        }
      }
  "27":
    continueonerrortype: ""
    id: "27"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureUnsuccessSecurityRulesChangeEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureUnsuccessSecurityRulesChange.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 47fae1fd-4922-4eab-8b29-8577018f047a
      iscommand: false
      name: Set attempt to change security rules events
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 47fae1fd-4922-4eab-8b29-8577018f047a
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 910,
          "y": 1110
        }
      }
  "28":
    continueonerrortype: ""
    id: "28"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureAnomaliesEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureAnomalies.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 7f8e214d-c0df-4d8b-8867-3fd95e597d66
      iscommand: false
      name: Set anomalies events
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 7f8e214d-c0df-4d8b-8867-3fd95e597d66
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -10,
          "y": 920
        }
      }
  "29":
    continueonerrortype: ""
    id: "29"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "10"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureUncommonCountryLogonEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureUncommonCountryLogon.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: ad023e29-8a0d-4c84-87cf-bec720378b87
      iscommand: false
      name: Set event of logon attempt from uncommon country
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: ad023e29-8a0d-4c84-87cf-bec720378b87
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -850,
          "y": 920
        }
      }
  "30":
    continueonerrortype: ""
    id: "30"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "11"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureUncommonVolumeEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureUncommonVolume.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 532d2390-6293-4c2c-8873-cbe620c21414
      iscommand: false
      name: Set events of uncommon high volume of actions
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 532d2390-6293-4c2c-8873-cbe620c21414
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -850,
          "y": 1280
        }
      }
  "31":
    continueonerrortype: ""
    id: "31"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureUncommonActivitiesEvents
      value:
        complex:
          accessor: '[1]'
          root: AzureUncommonActivities.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 2add1b66-34d3-4c95-8697-2403d56660a7
      iscommand: false
      name: Set events of action uncommonly performed by the user
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 2add1b66-34d3-4c95-8697-2403d56660a7
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -850,
          "y": 1620
        }
      }
  "32":
    continueonerrortype: ""
    id: "32"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: b8af36fa-0211-4310-866b-cb9f58e16115
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: b8af36fa-0211-4310-866b-cb9f58e16115
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 240,
          "y": 1980
        }
      }
  "33":
    continueonerrortype: ""
    id: "33"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "23"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureFailLoginCount
      value:
        complex:
          accessor: '[0]'
          root: AzureNumOfFailLogin.tables.rows.[0]
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 982caec5-ce0d-46e0-81d4-54f83b6378d7
      iscommand: false
      name: Set the number of failed login attempts by the user
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 982caec5-ce0d-46e0-81d4-54f83b6378d7
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 490,
          "y": 750
        }
      }
  "34":
    continueonerrortype: ""
    id: "34"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureFailLoginMFACount
      value:
        complex:
          accessor: '[0]'
          root: AzureNumOfFailMFA.tables.rows.[0]
          transformers:
          - args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "0"
            operator: SetIfEmpty
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 881466ef-da2a-461a-8ee3-81c1d7504eb8
      iscommand: false
      name: Set the number of failed login MFA by the user
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 881466ef-da2a-461a-8ee3-81c1d7504eb8
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 490,
          "y": 1110
        }
      }
  "35":
    continueonerrortype: ""
    id: "35"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureRiskyUserCount
      value:
        complex:
          accessor: '[0]'
          root: AzureRiskyUser.tables.rows.[0]
          transformers:
          - args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "0"
            operator: SetIfEmpty
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.11/Cortex-XSOAR-Administrator-Guide/Automations
      id: 752b0d29-0d1f-4985-814f-72d96252984b
      iscommand: false
      name: Set the number that the user was defined as a risky user
      script: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 752b0d29-0d1f-4985-814f-72d96252984b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -430,
          "y": 920
        }
      }
  "37":
    continueonerrortype: ""
    id: "37"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "4"
      - "5"
      - "6"
    note: false
    quietmode: 0
    scriptarguments:
      extend-context:
        simple: AzureTables=
      query:
        simple: search "*" | summarize count() by $table | sort by count_ desc
    separatecontext: false
    skipunavailable: true
    task:
      brand: Azure Log Analytics
      description: Executes an analytics query for data.
      id: 5b2b1c42-7a11-456d-82a6-421c46feee98
      iscommand: true
      name: Search for available tables
      script: Azure Log Analytics|||azure-log-analytics-execute-query
      type: regular
      version: -1
    taskid: 5b2b1c42-7a11-456d-82a6-421c46feee98
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -430,
          "y": 230
        }
      }
  "38":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: ${AzureTables.tables.rows.[].[0]}
          operator: containsString
          right:
            value:
              simple: Anomalies
      label: "yes"
    continueonerrortype: ""
    id: "38"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "13"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks if the Azure Sentinel Anomalies table is available for querying.
      id: 6660c680-dbb2-4718-8eb2-3c52f0aa5452
      iscommand: false
      name: should perform queries on Azure Sentinel Anomalies tables?
      type: condition
      version: -1
    taskid: 6660c680-dbb2-4718-8eb2-3c52f0aa5452
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -10,
          "y": 570
        }
      }
  "39":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: ${AzureTables.tables.rows.[].[0]}
          operator: containsString
          right:
            value:
              simple: BehaviorAnalytics
      label: "yes"
    continueonerrortype: ""
    id: "39"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "2"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks if the Azure Sentinel BehaviorAnalytics table is available
        for querying.
      id: edc86152-4e2a-405c-8822-bb3677942ab1
      iscommand: false
      name: should perform queries on Azure Sentinel BehaviorAnalytics tables?
      type: condition
      version: -1
    taskid: edc86152-4e2a-405c-8822-bb3677942ab1
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -850,
          "y": 570
        }
      }
  "40":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: ${AzureTables.tables.rows.[].[0]}
          operator: containsString
          right:
            value:
              simple: IdentityInfo
      label: "yes"
    continueonerrortype: ""
    id: "40"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "12"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks if the Azure Sentinel IdentityInfo table is available for
        querying.
      id: 4bfe49ef-8907-4748-8d5e-e9ab50d96c8e
      iscommand: false
      name: should perform queries on Azure Sentinel IdentityInfo tables?
      type: condition
      version: -1
    taskid: 4bfe49ef-8907-4748-8d5e-e9ab50d96c8e
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -430,
          "y": 570
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "1_22_#default#": 0.1,
      "38_22_#default#": 0.15,
      "39_22_#default#": 0.11,
      "40_22_#default#": 0.11
    },
    "paper": {
      "dimensions": {
        "height": 2125,
        "width": 2560,
        "x": -850,
        "y": -80
      }
    }
  }
