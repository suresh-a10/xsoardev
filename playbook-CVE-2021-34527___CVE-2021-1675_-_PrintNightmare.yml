contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 5.5.0
    itemVersion: 1.6.38
    packID: MajorBreachesInvestigationandResponse
    packName: Rapid Breach Response
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: |-
  **The playbook can be triggered manually or automatically by setting up a reoccurring job.**

  Microsoft has released a security update in June 2021 Patch Tuesday for CVE-2021-1675, a Local Privilege Escalation vulnerability in the Print Spooler Service. Later that month, researchers found another method to exploit the Print Spooler service remotely, which raised the severity of the vulnerability due to the fact that the new method allows Remote Code Execution, a new ID was given to the critical vulnerability - CVE-2021-34527.

  Microsoft patched the vulnerability in June but an exploit POC and complete technical analysis were made publicly available online.

  **Update 7.8.2021 - Microsoft has released an emergency patch for the PrintNightmare. A reference for the patch can be found in "Install Microsoft spooler service patches" task.

  This playbook includes the following tasks:
  - Manual actions to mitigate the exploit
  - Search Vulnerable Devices using the CVE
  - Query SIEM, FW, XDR to detect malicious activity and compromised hosts
  - Run Dedicated Detection and Response playbook for Cortex XDR

  More details on the vulnerabilities:
  [CVE-2021-1675 LPE](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)
  [CVE-2021-34527 RCE](https://nvd.nist.gov/vuln/detail/CVE-2021-34527)

  ** Note: This is a beta playbook, which lets you implement and test pre-release software. Since the playbook is beta, it might contain bugs. Updates to the pack during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the pack to help us identify issues, fix them, and continually improve.
id: CVE-2021-1675 - PrintNightmare
inputs:
- description: PrintNightmare CVEs
  key: CVE
  playbookInputQuery: null
  required: false
  value:
    simple: CVE-2021-1675,CVE-2021-34527
- description: The earliest time for the Splunk search query.
  key: SplunkEarliestTime
  playbookInputQuery: null
  required: false
  value:
    simple: -30d
- description: The latest time for the Splunk search query.
  key: SplunkLatestTime
  playbookInputQuery: null
  required: false
  value:
    simple: now
name: CVE-2021-34527 | CVE-2021-1675 - PrintNightmare
outputs: []
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "40"
      - "41"
      - "43"
      - "42"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: f1cfc2ee-24a8-469d-842d-be83b7dc2ca1
      iscommand: false
      name: ""
      version: -1
    taskid: f1cfc2ee-24a8-469d-842d-be83b7dc2ca1
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 430,
          "y": 80
        }
      }
  "2":
    continueonerrortype: ""
    id: "2"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "39"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |+
        Run a vulnerability scan to find vulnerable devices. Either by running PowerShell script or initiate a new scan with vulnerability scanner tool.

      id: a26d7d7c-a25e-414b-83c8-8c00b2087390
      iscommand: false
      name: Run vulnerability scan
      type: regular
      version: -1
    taskid: a26d7d7c-a25e-414b-83c8-8c00b2087390
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 460,
          "y": 2830
        }
      }
  "6":
    continueonerrortype: ""
    id: "6"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 0c90e265-d762-414e-8a33-d7eed8a9bd1d
      iscommand: false
      name: Vulnerability Scan
      type: title
      version: -1
    taskid: 0c90e265-d762-414e-8a33-d7eed8a9bd1d
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 460,
          "y": 2680
        }
      }
  "7":
    continueonerrortype: ""
    id: "7"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    scriptarguments:
      CVE_ID:
        complex:
          root: inputs.CVE
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      id: 2a67bf0f-29f4-45ac-8634-8179c695e438
      iscommand: false
      name: Search Endpoint by CVE - Generic
      playbookId: Search Endpoint by CVE - Generic
      type: playbook
      version: -1
    taskid: 2a67bf0f-29f4-45ac-8634-8179c695e438
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 920,
          "y": 730
        }
      }
  "9":
    continueonerrortype: ""
    id: "9"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "13"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 21a9d6cc-f618-4656-85d9-a85ba15a4b76
      iscommand: false
      name: Splunk
      type: title
      version: -1
    taskid: 21a9d6cc-f618-4656-85d9-a85ba15a4b76
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 190,
          "y": 910
        }
      }
  "10":
    continueonerrortype: ""
    id: "10"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: b0655aa0-9ac3-42eb-84e0-8ce440b9a142
      iscommand: false
      name: Qradar
      type: title
      version: -1
    taskid: b0655aa0-9ac3-42eb-84e0-8ce440b9a142
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -970,
          "y": 910
        }
      }
  "11":
    continueonerrortype: ""
    id: "11"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "17"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: afeb0f51-42c5-4907-87bf-a8973e4ea518
      iscommand: false
      name: 'Manually Hunt Windows Event Logs '
      type: title
      version: -1
    taskid: afeb0f51-42c5-4907-87bf-a8973e4ea518
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -380,
          "y": 910
        }
      }
  "12":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: state
                filters:
                - - ignorecase: true
                    left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: SplunkPy
                root: modules
          operator: isEqualString
          right:
            value:
              simple: active
      label: Splunk
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: state
                filters:
                - - ignorecase: true
                    left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: QRadar_v2
                root: modules
          operator: isEqualString
          right:
            value:
              simple: active
      label: Qradar
    continueonerrortype: ""
    id: "12"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "11"
      Qradar:
      - "10"
      Splunk:
      - "9"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      id: 7fa0b9d9-8a02-4d94-8e57-88369afe81e8
      iscommand: false
      name: Is SIEM enabled?
      type: condition
      version: -1
    taskid: 7fa0b9d9-8a02-4d94-8e57-88369afe81e8
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -380,
          "y": 730
        }
      }
  "13":
    continueonerrortype: ""
    id: "13"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "27"
    note: false
    quietmode: 0
    scriptarguments:
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      latest_time:
        complex:
          root: inputs.SplunkLatestTime
      query:
        simple: index="*" sourcetype="WinEventLog" source="WinEventLog:Security" EventCode=
          808 OR EventCode=316 OR EventCode=31017
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: "Searches Splunk for Event IDs related to PrintNightmare vulnerability:\n808
        (Print Spooler) \n316 (Print Spooler) \n31017 (SMB)"
      id: 6051b84a-2d2e-4726-860d-f65d1eb261d5
      iscommand: true
      name: Search for suspicious Print Spooler and SMB Event IDs
      script: '|||splunk-search'
      type: regular
      version: -1
    taskid: 6051b84a-2d2e-4726-860d-f65d1eb261d5
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 190,
          "y": 1050
        }
      }
  "15":
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "16"
    note: false
    quietmode: 0
    scriptarguments:
      interval:
        simple: "1"
      query_expression:
        simple: SELECT UTF8(payload) as search_payload from events where LOGSOURCETYPENAME(devicetype)='Microsoft
          Windows Security Event Log' and LOGSOURCETYPENAME(devicetype)='Microsoft
          Windows Security Event Log' and search_payload ilike '%0x45A%' and "EventID"='808'
          or "EventID"='316' and search_payload ilike '%The print spooler failed to
          load a plug-in module%' Last 7 days
      timeout:
        simple: "600"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: This playbook runs a QRadar query and return its results to the
        context.
      id: ef8e40cb-46a1-42dd-84df-bd7cc8edbd03
      iscommand: false
      name: Search for suspicious Print Spooler Event IDs
      playbookId: QRadarFullSearch
      type: playbook
      version: -1
    taskid: ef8e40cb-46a1-42dd-84df-bd7cc8edbd03
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -970,
          "y": 1050
        }
      }
  "16":
    continueonerrortype: ""
    id: "16"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 0
      wait: 1
    nexttasks:
      '#none#':
      - "24"
    note: false
    quietmode: 0
    scriptarguments:
      interval:
        simple: "1"
      query_expression:
        simple: select * from events WHERE LogSourceTypeName(deviceType) = 'Microsoft
          Windows Security Event Log' and UTF8(payload) LIKE '%31017%' Last 7 days
      timeout:
        simple: "600"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: This playbook runs a QRadar query and return its results to the
        context.
      id: 8239c2a7-a23f-4fdb-8b88-487cadf5fd3a
      iscommand: false
      name: Search for suspicious SMB Event ID
      playbookId: QRadarFullSearch
      type: playbook
      version: -1
    taskid: 8239c2a7-a23f-4fdb-8b88-487cadf5fd3a
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -970,
          "y": 1230
        }
      }
  "17":
    continueonerrortype: ""
    id: "17"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "32"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Search for the windows event IDs 808, 316 and 31017 to find indication
        of the exploit.
      id: 5da59a60-4575-45b0-8e8d-b4fbaf20d860
      iscommand: false
      name: Search for event IDs 808, 316 and 31017
      type: regular
      version: -1
    taskid: 5da59a60-4575-45b0-8e8d-b4fbaf20d860
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -380,
          "y": 1050
        }
      }
  "18":
    continueonerrortype: ""
    id: "18"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "35"
      - "36"
      - "38"
      - "37"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 3ffe1968-e80f-4b79-8b18-369bbd7078a2
      iscommand: false
      name: CVE Mitigations
      type: title
      version: -1
    taskid: 3ffe1968-e80f-4b79-8b18-369bbd7078a2
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2300
        }
      }
  "20":
    continueonerrortype: ""
    id: "20"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: c0721a3f-91f6-4eba-8420-3f328f3c348f
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: c0721a3f-91f6-4eba-8420-3f328f3c348f
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 460,
          "y": 3620
        }
      }
  "23":
    continueonerrortype: ""
    id: "23"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    scriptarguments:
      log_type:
        simple: threat
      query:
        simple: (threatid eq 91333) or (threatid eq 91323)
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: 'Query Panorama Logs of types: traffic, threat, url, data-filtering
        and wildfire.'
      id: f5ba6e08-6201-4f0f-87e5-59c303e94345
      iscommand: false
      name: Panorama Query Logs for PrintNightmare Threat IDs
      playbookId: Panorama Query Logs
      type: playbook
      version: -1
    taskid: f5ba6e08-6201-4f0f-87e5-59c303e94345
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 1820,
          "y": 730
        }
      }
  "24":
    continueonerrortype: ""
    id: "24"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      scriptArguments:
        headers: {}
        interval:
          simple: "1"
        query_expression:
          simple: select * from events WHERE LogSourceTypeName(deviceType) = 'Microsoft
            Windows Security Event Log' and UTF8(payload) LIKE '%31017%' Last 7 days
        range: {}
        timeout:
          simple: "600"
      wait: 1
    nexttasks:
      '#none#':
      - "32"
    note: false
    quietmode: 0
    scriptarguments:
      interval:
        simple: "1"
      query_expression:
        simple: SELECT * from events where LOGSOURCETYPENAME(devicetype)='Microsoft
          Windows Security Event Log' and CATEGORYNAME(category) ILIKE 'Successful
          Registry Modification' and (UTF8(payload) ilike '%.dll%') and (UTF8(payload)
          ilike '%\spoolsv.exe') and (UTF8(payload) ilike '%\Data File%' or UTF8(payload)
          ilike '%\Configuration File%') Last 14 days
      timeout:
        simple: "600"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: This playbook runs a QRadar query and return its results to the
        context.
      id: 077f00bb-f7db-40aa-8689-56609c8cfec6
      iscommand: false
      name: Search for suspicious registry modification by Spoolsv
      playbookId: QRadarFullSearch
      type: playbook
      version: -1
    taskid: 077f00bb-f7db-40aa-8689-56609c8cfec6
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -970,
          "y": 1410
        }
      }
  "25":
    continueonerrortype: ""
    id: "25"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    scriptarguments:
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      latest_time:
        complex:
          root: inputs.SplunkLatestTime
      query:
        simple: index="*" sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
          OR source=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=7
          Image="*\\spoolsv.exe" ImageLoaded="*\\Windows\\System32\\spool\\drivers\\x64\\*"
          ImageLoaded="*.dll" | stats dc(ImageLoaded) as countImgloaded values(ImageLoaded)
          as ImgLoaded count min(_time) as firstTime max(_time) as lastTime by Image
          Computer EventCode | where countImgloaded >= 3
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Identifies potentially suspicious module loads into Spoolsv.exe
        based on DLL loading from a specific path used by CVE-2021-34527.
      id: d1c2af35-74e6-4a9a-870e-59de7ee16d4a
      iscommand: true
      name: Search for Spoolsv Suspicious Loaded Modules
      script: '|||splunk-search'
      type: regular
      version: -1
    taskid: d1c2af35-74e6-4a9a-870e-59de7ee16d4a
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 190,
          "y": 1610
        }
      }
  "26":
    continueonerrortype: ""
    id: "26"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "25"
    note: false
    quietmode: 0
    scriptarguments:
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      latest_time:
        complex:
          root: inputs.SplunkLatestTime
      query:
        simple: index="*" sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
          OR source=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=10
          SourceImage = "*\\spoolsv.exe" CallTrace="*\\Windows\\system32\\spool\\DRIVERS\\x64\\*"
          TargetImage IN ("*\\rundll32.exe", "*\\spoolsv.exe") GrantedAccess = 0x1fffff
          | stats  count min(_time) as firstTime max(_time) as lastTime by Computer
          SourceImage TargetImage GrantedAccess CallTrace  EventCode
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: 'Identifies suspicious process access events from Spoolsv.exe with
        high granted process rights access to the target process. '
      id: ac91f703-d4f8-4beb-8503-39b96331c078
      iscommand: true
      name: Search for Spoolsv Suspicious Process Access
      script: '|||splunk-search'
      type: regular
      version: -1
    taskid: ac91f703-d4f8-4beb-8503-39b96331c078
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 190,
          "y": 1420
        }
      }
  "27":
    continueonerrortype: ""
    id: "27"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "26"
    note: false
    quietmode: 0
    scriptarguments:
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      latest_time:
        complex:
          root: inputs.SplunkLatestTime
      query:
        simple: |-
          index=* sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational OR source=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventID=1  parent_process_name=spoolsv.exe process_name=rundll32.exe
            | stats count min(_time) as firstTime max(_time) as lastTime by Computer, User,
            parent_process_name, process_name, OriginalFileName, process_path, CommandLine
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: Detects Spoolsv with a child process of rundll32.exe.
      id: 7729de67-2ba0-44d9-88e3-fe032360518b
      iscommand: true
      name: Search for suspicious Spoolsv Spawning Rundll32
      script: '|||splunk-search'
      type: regular
      version: -1
    taskid: 7729de67-2ba0-44d9-88e3-fe032360518b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 190,
          "y": 1230
        }
      }
  "29":
    continueonerrortype: ""
    id: "29"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    message:
      bcc: null
      body:
        simple: Do you need to continue with the investigation?
      cc: null
      format: ""
      methods: []
      replyOptions:
      - "Yes"
      - "No"
      subject: null
      timings:
        completeafterreplies: 1
        completeaftersla: false
        completeafterv2: false
        retriescount: 2
        retriesinterval: 360
      to: null
    nexttasks:
      "No":
      - "31"
      "Yes":
      - "30"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check with the analyst whether to continue with the investigation.
      id: 23aac628-78ce-4897-8ae1-da26bdfdfaad
      iscommand: false
      name: Analysis resolution - Should continue with the investigation?
      type: condition
      version: -1
    taskid: 23aac628-78ce-4897-8ae1-da26bdfdfaad
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 460,
          "y": 3150
        }
      }
  "30":
    continueonerrortype: ""
    id: "30"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "20"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Manual step for further incident investigation.
      id: ac33c510-e7ac-44cf-8c34-9288b36172bb
      iscommand: false
      name: Investigate Further
      type: regular
      version: -1
    taskid: ac33c510-e7ac-44cf-8c34-9288b36172bb
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 0,
          "y": 3420
        }
      }
  "31":
    continueonerrortype: ""
    id: "31"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "20"
    note: false
    quietmode: 0
    scriptarguments:
      closeReason:
        simple: No further actions are required.
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Close the current incident
      id: 8e6caa72-0023-4339-8d21-12bda9f0cd26
      iscommand: true
      name: Close Investigation
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: 8e6caa72-0023-4339-8d21-12bda9f0cd26
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 460,
          "y": 3420
        }
      }
  "32":
    continueonerrortype: ""
    id: "32"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "33"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Detects Spoolsv with a child process of rundll32.exe.
      id: 7a5ed4a5-c5d4-47d0-822c-861fe3ccdfb3
      iscommand: false
      name: Search for suspicious Spoolsv Spawning Rundll32
      type: regular
      version: -1
    taskid: 7a5ed4a5-c5d4-47d0-822c-861fe3ccdfb3
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -380,
          "y": 1610
        }
      }
  "33":
    continueonerrortype: ""
    id: "33"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "34"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: 'Identifies suspicious process access events from Spoolsv.exe with
        high granted process rights access to the target process. '
      id: 3cbc6506-9d5e-46c3-8c79-3a605da669df
      iscommand: false
      name: Search for Spoolsv Suspicious Process Access
      type: regular
      version: -1
    taskid: 3cbc6506-9d5e-46c3-8c79-3a605da669df
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -380,
          "y": 1800
        }
      }
  "34":
    continueonerrortype: ""
    id: "34"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Identifies potentially suspicious module loads into Spoolsv.exe
        based on DLL loading from a specific path used by CVE-2021-34527.
      id: 57b3efdc-f9dc-4536-83ab-7d25a5507e9c
      iscommand: false
      name: Search for Spoolsv Suspicious Loaded Modules
      type: regular
      version: -1
    taskid: 57b3efdc-f9dc-4536-83ab-7d25a5507e9c
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -380,
          "y": 1990
        }
      }
  "35":
    continueonerrortype: ""
    id: "35"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "6"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |2+
         the patch is currently not effective against the vulnerability, it is still recommended to patch windows systems.
        The security patch can be found below:
        [CVE-2021-1675](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-1675)
        [CVE-2021-34527](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-34527)

      id: 4cb51f09-c911-414a-86cf-274b6cfd4c57
      iscommand: false
      name: Install Microsoft spooler service patches
      type: regular
      version: -1
    taskid: 4cb51f09-c911-414a-86cf-274b6cfd4c57
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -210,
          "y": 2500
        }
      }
  "36":
    continueonerrortype: ""
    id: "36"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "6"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Disable the Print Spooler service for unnecessary devices especially servers (like the Domain Controllers)
        [Example command to disable print spooler service](https://github.com/cube0x0/CVE-2021-1675) to disable the Print Spooler service:
        'Stop-Service Spooler
        REG ADD  "HKLM\SYSTEM\CurrentControlSet\Services\Spooler"  /v "Start " /t REG_DWORD /d "4" /f'
      id: 53b9d3d7-fe3b-40c5-8012-4cf67c070bf6
      iscommand: false
      name: Disable Print Spooler service
      type: regular
      version: -1
    taskid: 53b9d3d7-fe3b-40c5-8012-4cf67c070bf6
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 220,
          "y": 2500
        }
      }
  "37":
    continueonerrortype: ""
    id: "37"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "6"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        The exploit dropping a DLL in a subdirectory. If restricting the ACLs on the directory (and subdirectories), the exploit will be prevented.
        Relevant directory: 'C:\Windows\System32\spool\drivers'

        example of PowerShell script:
        $Path = "C:\Windows\System32\spool\drivers"

        $Acl = Get-Acl $Path

        $Ar = New-Object  System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")

        $Acl.AddAccessRule($Ar)

        Set-Acl $Path $Acl

        [Source](https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/)
      id: 6bc4cfea-31b6-4ee9-8ef1-36aa49f1c9b6
      iscommand: false
      name: Restricting the ACLs
      type: regular
      version: -1
    taskid: 6bc4cfea-31b6-4ee9-8ef1-36aa49f1c9b6
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 2500
        }
      }
  "38":
    continueonerrortype: ""
    id: "38"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "6"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Check if the following conditions are true:
        Registry Settings: HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
        NoWarningNoElevationOnInstall = 0 (DWORD) or not defined (default setting)
        UpdatePromptSettings = 0 (DWORD) or not defined (default setting)
        Group Policy: You have not configured the Point and Print Restrictions Group Policy.
      id: 818f6f49-e0cc-4ab0-8e04-a1fcce69470b
      iscommand: false
      name: Disable Print Spooler Service Point and Print
      type: regular
      version: -1
    taskid: 818f6f49-e0cc-4ab0-8e04-a1fcce69470b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 680,
          "y": 2500
        }
      }
  "39":
    continueonerrortype: ""
    id: "39"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "29"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: e67a0dcf-a48f-4a5b-8be5-a3051a4e0faa
      iscommand: false
      name: Resolution
      type: title
      version: -1
    taskid: e67a0dcf-a48f-4a5b-8be5-a3051a4e0faa
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 460,
          "y": 3000
        }
      }
  "40":
    continueonerrortype: ""
    id: "40"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "12"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 9a7c6f39-3f86-4b52-8b81-fbe81bada5d7
      iscommand: false
      name: SIEM Hunting
      type: title
      version: -1
    taskid: 9a7c6f39-3f86-4b52-8b81-fbe81bada5d7
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -380,
          "y": 550
        }
      }
  "41":
    continueonerrortype: ""
    id: "41"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "7"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 23e2edbf-c098-4ca8-8686-e603d63828f1
      iscommand: false
      name: 'Vulnerabilities Hunting '
      type: title
      version: -1
    taskid: 23e2edbf-c098-4ca8-8686-e603d63828f1
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 920,
          "y": 550
        }
      }
  "42":
    continueonerrortype: ""
    id: "42"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "23"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 68d709a8-a251-4f8d-84cd-489e06c37254
      iscommand: false
      name: 'Panorama Hunting '
      type: title
      version: -1
    taskid: 68d709a8-a251-4f8d-84cd-489e06c37254
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1820,
          "y": 550
        }
      }
  "43":
    continueonerrortype: ""
    id: "43"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "44"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 0b02372d-250f-42e6-8979-e37100d64898
      iscommand: false
      name: Cortex XDR
      type: title
      version: -1
    taskid: 0b02372d-250f-42e6-8979-e37100d64898
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1370,
          "y": 550
        }
      }
  "44":
    continueonerrortype: ""
    id: "44"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      id: 2839bb90-887e-4478-8eeb-cf1f5c1f4b62
      iscommand: false
      name: Cortex XDR - PrintNightmare Detection and Response
      playbookId: Cortex XDR - PrintNightmare Detection and Response
      type: playbook
      version: -1
    taskid: 2839bb90-887e-4478-8eeb-cf1f5c1f4b62
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 1370,
          "y": 730
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "29_31_No": 0.48
    },
    "paper": {
      "dimensions": {
        "height": 3605,
        "width": 3170,
        "x": -970,
        "y": 80
      }
    }
  }
