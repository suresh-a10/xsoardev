category: Data Enrichment & Threat Intelligence
commonfields:
  id: Prisma Access Egress IP feed
  version: -1
configuration:
- defaultvalue: "true"
  display: Fetch indicators
  name: feed
  required: false
  type: 8
- defaultvalue: https://api.gpcloudservice.com
  display: URL
  name: URL
  required: true
  type: 0
- display: ""
  displaypassword: Prisma Access API Key
  hiddenusername: true
  name: credentials
  required: false
  type: 9
- additionalinfo: https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-admin/prisma-access-overview/retrieve-ip-addresses-for-prisma-access
  defaultvalue: all
  display: Service Type
  name: serviceType
  options:
  - all
  - remote_network
  - gp_gateway
  - gp_portal
  - clean_pipe
  required: true
  type: 15
- additionalinfo: https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-admin/prisma-access-overview/retrieve-ip-addresses-for-prisma-access
  defaultvalue: all
  display: Address Type
  name: addrType
  options:
  - all
  - active
  - reserved
  required: true
  type: 15
- additionalinfo: https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-admin/prisma-access-overview/retrieve-ip-addresses-for-prisma-access
  defaultvalue: all
  display: Location
  name: location
  options:
  - all
  - deployed
  required: false
  type: 15
- additionalinfo: Indicators from this integration instance will be marked with this
    reputation
  defaultvalue: Good
  display: Indicator Reputation
  name: feedReputation
  options:
  - None
  - Good
  - Suspicious
  - Bad
  required: false
  type: 18
- additionalinfo: Reliability of the source providing the intelligence data
  defaultvalue: A - Completely reliable
  display: Source Reliability
  name: feedReliability
  options:
  - A - Completely reliable
  - B - Usually reliable
  - C - Fairly reliable
  - D - Not usually reliable
  - E - Unreliable
  - F - Reliability cannot be judged
  required: true
  type: 15
- additionalinfo: The Traffic Light Protocol (TLP) designation to apply to indicators
    fetched from the feed
  display: Traffic Light Protocol Color
  name: tlp_color
  options:
  - RED
  - AMBER
  - GREEN
  - WHITE
  required: false
  type: 15
- defaultvalue: suddenDeath
  display: ""
  name: feedExpirationPolicy
  options:
  - never
  - interval
  - indicatorType
  - suddenDeath
  required: false
  type: 17
- defaultvalue: "20160"
  display: ""
  name: feedExpirationInterval
  required: false
  type: 1
- defaultvalue: "30"
  display: Feed Fetch Interval
  name: feedFetchInterval
  required: false
  type: 19
- additionalinfo: When selected, the exclusion list is ignored for indicators from
    this feed. This means that if an indicator from this feed is on the exclusion
    list, the indicator might still be added to the system.
  defaultvalue: "true"
  display: Bypass exclusion list
  name: feedBypassExclusionList
  required: false
  type: 8
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- additionalinfo: Supports CSV values.
  display: Tags
  name: feedTags
  required: false
  type: 0
- additionalinfo: The Prisma Access API Key to use (retrieve via Panorama->Service
    Setup->Egress IP API)
  display: Prisma Access API Key (Deprecated)
  hidden: true
  name: api_key
  required: false
  type: 4
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 5.5.0
    itemVersion: 2.1.11
    packID: PrismaAccess
    packName: Palo Alto Networks - Strata Cloud Manager
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: Dynamically retrieve and add to allow list IPs Prisma Access uses to
  egress traffic to the internet and SaaS apps.
detaileddescription: |-
  ### Prisma Access Egress IP feed
  To retrieve the Egress API key from Panorama - Click "Generate API Key" under **Panorama->Cloud Services->Configuration->Service Setup.**

  ## Prisma Access Egress API
  [https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-admin/prisma-access-overview/retrieve-ip-addresses-for-prisma-access](https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-admin/prisma-access-overview/retrieve-ip-addresses-for-prisma-access)

  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/prisma-access-egress-ip-feed)
display: Prisma Access Egress IP feed
image: data:image/png;base64,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
name: Prisma Access Egress IP feed
script:
  commands:
  - arguments:
    - description: The maximum number of results to return.  By default all IPs are
        returned.
      name: limit
    description: Gets indicators from the feed.
    name: prisma-access-get-indicators
    outputs:
    - contextPath: PrismaAccess.Egress.IP.Address
      description: Prisma Access Egress IP address.
      type: string
    - contextPath: PrismaAccess.Egress.IP.Zone
      description: Prisma Access Egress IP zone.
      type: string
  dockerimage: demisto/python3:3.11.10.115186
  feed: true
  runonce: false
  script: |
    register_module_line('Prisma Access Egress IP feed', 'start', __line__())
    demisto.debug('pack name = Palo Alto Networks - Strata Cloud Manager, pack version = 2.1.11')


    from typing import Any, Callable, Dict, List, Tuple, Optional

    import urllib3


    # disable insecure warnings
    urllib3.disable_warnings()
    INTEGRATION_NAME = 'Prisma Access'


    class Client(BaseClient):
        """
        Client to use in the Prisma Access Feed integration. Overrides BaseClient.
        Prisma Access V2 API: https://api.gpcloudservice.com/getPrismaAccessIP/v2
        https://docs.paloaltonetworks.com/prisma/prisma-access/prisma-access-panorama-admin/prisma-access-overview/retrieve-ip-addresses-for-prisma-access
        """

        def __init__(self, clientConfigs: list, api_key: str, insecure: bool = False, proxy: bool = False,
                     tags: Optional[list] = [], tlp_color: Optional[str] = None):
            """
            Implements class for Prisma Access feed.
            :param clientConfigs: config data
            :param insecure: boolean, if *false* feed HTTPS server certificate is verified. Default: *false*
            :param proxy: boolean, if *false* feed HTTPS server certificate will not use proxies. Default: *false*
            :param tlp_color: Traffic Light Protocol color.
            """
            self._apiKey = api_key
            self.tags = [] if tags is None else tags
            self.tlp_color = tlp_color
            super().__init__(base_url=clientConfigs, verify=not insecure, proxy=proxy)

        def build_iterator(self) -> List:
            """Retrieves all entries from the feed.

            Returns:
                A list of objects, containing the indicators.
            """
            result = []
            for feed_obj in self._base_url:
                feed_url = feed_obj.get('FeedURL')
                postData = feed_obj.get('feedParams',
                                        {"serviceType": 'all',
                                         "addrType": 'all',
                                         "location": 'all'})

                try:
                    response = requests.post(
                        url=feed_url,
                        verify=self._verify,
                        headers={
                            'header-api-key': self._apiKey
                        },
                        data=json.dumps(postData)
                    )
                    response.raise_for_status()
                    responseData = response.json()
                    prismaStatus = responseData.get('status', '')
                    if 'success' == prismaStatus:
                        zones = responseData.get('result', [])
                        for z in zones:
                            zoneName = z.get('zone', '')
                            addresses = z.get('addresses', [])
                            for addr in addresses:
                                indicator = {
                                    "zone": zoneName,
                                    "value": addr,
                                    "FeedURL": feed_url
                                }
                                if postData['serviceType'] != 'all':
                                    indicator['serviceType'] = postData['serviceType']
                                if postData['addrType'] != 'all':
                                    indicator['addrType'] = postData['addrType']
                                result.append(indicator)
                    else:
                        demisto.debug(str(prismaStatus))
                        raise Exception(f'Non-success status returned from call to {INTEGRATION_NAME}.\n'
                                        f'Raw response: ' + json.dumps(responseData, indent=2))
                except requests.exceptions.SSLError as err:
                    demisto.debug(str(err))
                    raise Exception(f'SSL error in the API call to {INTEGRATION_NAME}.\n'
                                    f'Check your not secure parameter.\n\n{err}')
                except requests.ConnectionError as err:
                    demisto.debug(str(err))
                    raise Exception(f'Connection error in the API call to {INTEGRATION_NAME}.\n'
                                    f'Check your Server URL parameter.\n\n{err}')
                except requests.exceptions.HTTPError as err:
                    demisto.debug(str(err))
                    raise Exception(f'HTTP error in the API call to {INTEGRATION_NAME}:\n\n' + str(err))
                except ValueError as err:
                    demisto.debug(str(err))
                    raise ValueError(f'Could not parse returned data to Json. \n\nError message: {err}')
            return result


    def test_module(client: Client, *_) -> Tuple[str, Dict[Any, Any], Dict[Any, Any]]:
        """Builds the iterator to check that the feed is accessible.
        Args:
            client: Client object.

        Returns:
            Outputs.
        """
        client.build_iterator()
        return 'ok', {}, {}


    def fetch_indicators(client: Client, limit: int = -1) -> List[Dict]:
        """Retrieves indicators from the feed

        Args:
            client: Client object with request
            limit: limit the results

        Returns:
            Indicators.
        """
        iterator = client.build_iterator()
        indicators = []
        if limit > 0:
            iterator = iterator[:limit]

        for item in iterator:
            value = item.get('value')
            raw_data = {
                "value": value,
                "serviceType": item.get('serviceType', ''),
                "addrType": item.get('addrType', ''),
                "zone": item.get('zone', '')
            }
            indicator_mapping_fields = {}
            indicator_mapping_fields['geocountry'] = item.get('zone', '')
            indicator_mapping_fields["description"] = 'IP from Prisma Access Egress API'
            indicator_mapping_fields['tags'] = client.tags
            if client.tlp_color:
                indicator_mapping_fields['trafficlightprotocol'] = client.tlp_color

            indicators.append({
                "value": value,
                "type": FeedIndicatorType.IP,
                "rawJSON": raw_data,
                "fields": indicator_mapping_fields,
                "zone": item.get('zone', '')
            })

        return indicators


    def get_indicators_command(client: Client, args: Dict[str, str]) -> Tuple[str, Dict[Any, Any], Dict[Any, Any]]:
        """Wrapper for retrieving indicators from the feed to the war-room.

        Args:
            client: Client object with request
            args: demisto.args()

        Returns:
            Outputs.
        """
        limit = int(demisto.args().get('limit')) if 'limit' in demisto.args() else 0
        indicators = fetch_indicators(client, limit)
        human_readable = tableToMarkdown('Prisma Access Egress IPs:', indicators,
                                         headers=['zone', 'value'], removeNull=True)

        outputs = {
            'PrismaAccess.Egress.IP':
                [
                    {
                        'Address': ip.get('value', ''),
                        'Zone': ip.get('zone', '')
                    } for ip in indicators
                ]
        }

        retIndicators = {'raw_response': indicators}

        return human_readable, outputs, retIndicators


    def fetch_indicators_command(client: Client) -> List[Dict]:
        """Wrapper for fetching indicators from the feed to the Indicators tab.

        Args:
            client: Client object with request

        Returns:
            Indicators.
        """
        indicators = fetch_indicators(client)
        return indicators


    def main():
        PRISMA_ACCESS_EGRESS_V2_URI = 'getPrismaAccessIP/v2'
        """
        PARSE AND VALIDATE INTEGRATION PARAMS
        """
        params = demisto.params()
        param_api_key = params.get('api_key') or (params.get('credentials') or {}).get('password')
        if not param_api_key:
            raise Exception('API Key must be provided.')
        insecure = params.get('insecure', False)
        proxy = params.get('proxy')
        tags = argToList(params.get('feedTags'))
        tlp_color = params.get('tlp_color')
        baseURL = params.get('URL')
        if baseURL[-1] != '/':
            baseURL += '/'
        feedURL = baseURL + PRISMA_ACCESS_EGRESS_V2_URI

        feedParams = {
            "serviceType": demisto.params().get('serviceType', 'all'),
            "addrType": demisto.params().get('addrType', 'all'),
            "location": demisto.params().get('location', 'all')
        }
        clientConfigs = [{'FeedURL': feedURL,
                          'feedParams': feedParams}]
        command = demisto.command()
        demisto.info(f'Command being called is {command}')

        try:
            client = Client(clientConfigs, param_api_key, insecure, proxy, tags, tlp_color)
            commands: Dict[str, Callable[[Client, Dict[str, str]], Tuple[str, Dict[Any, Any], Dict[Any, Any]]]] = {
                'test-module': test_module,
                'prisma-access-get-indicators': get_indicators_command
            }
            if command in commands:
                return_outputs(*commands[command](client, demisto.args()))

            elif command == 'fetch-indicators':
                indicators = fetch_indicators_command(client)
                for iter_ in batch(indicators, batch_size=2000):
                    demisto.createIndicators(iter_)

            else:
                raise NotImplementedError(f'Command {command} is not implemented.')

        except Exception as err:
            err_msg = f'Error in {INTEGRATION_NAME} Integration. [{err}]'
            return_error(err_msg)


    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()

    register_module_line('Prisma Access Egress IP feed', 'end', __line__())
  subtype: python3
  type: python
system: true
