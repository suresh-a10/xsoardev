commonfields:
  id: fbef7a0e-198f-46a8-8f27-428c9ec00639
  version: -1
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
dockerimage: demisto/python3:3.10.11.61265
enabled: true
engineinfo: {}
mainengineinfo: {}
name: CD_SNOW_Close_PostProcessing
pswd: ""
runas: DBotWeakRole
runonce: false
script: |-
  from datetime import datetime
  import pytz
  import time
  inc_data = demisto.incidents()[0]
  custom_fields = inc_data.get("CustomFields",{})
  def convert_datetime_timezone(dt, tz1, tz2):
      tz1 = pytz.timezone(tz1)
      tz2 = pytz.timezone(tz2)
      dt = datetime.strptime(dt,"%Y-%m-%d %H:%M:%S")
      dt = tz1.localize(dt)
      dt = dt.astimezone(tz2)
      dt = dt.strftime("%Y-%m-%d %H:%M:%S")
      dt = datetime.strptime(dt,"%Y-%m-%d %H:%M:%S")

      return dt

  demisto.results("Post-Processing")
  resolution_code = custom_fields.get("snowresolutioncode")
  resolution_notes = custom_fields.get('cdclosenotes')
  sys_id = custom_fields.get("snowincidentsysid")
  onhold_reason = custom_fields.get("snowonholdreason")
  snow_ticket_number = custom_fields.get("cdsnowincidentnumber")
  cd_close_reason = custom_fields.get("cdclosereason")
  cd_close_notes = custom_fields.get("cdclosednotes")
  snow_id = custom_fields.get("cdsnowincidentnumber")
  query = "number="+str(snow_id)
  resa = demisto.executeCommand('servicenow-query-tickets',{'query':query, "system_params":"sysparm_display_value=true", "using":"COSTA_ServiceNow _v2_Instance"})
  res = ""
  content = resa[0]["Contents"]["result"][0]
  while content["incident_state"] != "Resolved":
      res = demisto.executeCommand("servicenow-update-ticket", {"id":sys_id,"close_code":resolution_code,"close_notes":resolution_notes,"incident_state":6,"work_notes":resolution_notes,"using":"COSTA_ServiceNow _v2_Instance"})
      resa = demisto.executeCommand('servicenow-query-tickets',{'query':query, "system_params":"sysparm_display_value=true", "using":"COSTA_ServiceNow _v2_Instance"})
      content = resa[0]["Contents"]["result"][0]
  resolved_time = datetime.strptime(content["resolved_at"],"%Y-%m-%d %H:%M:%S")
  resolved_time = resolved_time.strftime('%Y-%m-%d %H:%M:%S')
  resolved_time_utc = convert_datetime_timezone(resolved_time, "US/Pacific", "Etc/UTC")
  resolved_time_utc = resolved_time_utc.strftime('%Y-%m-%dT%H:%M:%S+00:00')
  demisto.executeCommand("setIncident",{"snowincidentresolutiontime":resolved_time_utc, "snowonholdreason":"", "snowstate":content["incident_state"], "snowresolutioncode":resolution_code, "snowresolutionnotes":content["close_notes"], "snowonholdreason":"", "cdincidentstate":"Closed"})
  demisto.results("PostProcess result ")
  demisto.results(res)
scripttarget: 0
subtype: python3
tags:
- post-processing
timeout: 3.6Âµs
type: python
