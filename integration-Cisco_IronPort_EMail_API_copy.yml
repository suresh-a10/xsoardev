category: Network Security
commonfields:
  id: Cisco IronPort EMail API_copy
  version: -1
configuration:
- display: 'Base Url like : http://example.com'
  name: baseurl
  required: true
  type: 0
- display: User Name
  name: userName
  required: true
  type: 0
- display: Password
  name: password
  required: true
  type: 4
- defaultvalue: Policy
  display: Quarantine Name
  name: quarantineName
  required: false
  type: 0
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Cisco ESA IronPort EMail API
detaileddescription: |+
  ### Community Contributed Integration
   #### Integration Author: OsamaShenoda
   No support or maintenance is provided by the author. Customers are encouraged to engage with the user community for questions and guidance at the [Cortex XSOAR Live Discussions](https://live.paloaltonetworks.com/t5/cortex-xsoar-discussions/bd-p/Cortex_XSOAR_Discussions).
  ***

display: Cisco IronPort EMail API_copy
image: data:image/png;base64,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
name: Cisco IronPort EMail API_copy
script:
  commands:
  - arguments:
    - description: 'Message ID '
      name: mid
      required: true
    description: Release Email from Quaranties
    name: iron-port-quarantine-release-email
  - arguments:
    - defaultValue: "1"
      description: 'Last # number of Days to search in '
      name: periodInDays
      required: true
    - description: Sender CONTAINS "your Pattern"
      name: senderPattern
    - description: recipient CONTAINS "your Pattern"
      name: recipientPattern
    - description: subjectPattern
      name: subjectPattern
    - defaultValue: "50"
      description: limit
      name: limit
    description: ironPortSearchQuarantines Can combine multiple parameters
    name: iron-port-search-quarantines
    outputs:
    - contextPath: ironPortSearchQuarantinesOutput.data
      description: 'Search in Quarantines '
  - arguments:
    - defaultValue: "1"
      description: 'Last # number of Days to search in '
      name: periodInDays
      required: true
    - description: Sender CONTAINS "your Pattern"
      name: senderPattern
    - description: recipient CONTAINS "your Pattern"
      name: recipientPattern
    - description: subjectPattern
      name: subjectPattern
    - defaultValue: "50"
      description: limit
      name: limit
    description: 'Search in SPAM , Only One Parameter at once '
    name: iron-port-search-spam
  - arguments:
    - description: MID
      name: mid
      required: true
    description: Release Email from Spam
    name: iron-port-spam-release-Email
  - arguments:
    - description: periodInDays
      name: periodInDays
      required: true
    - description: senderPattern
      name: senderPattern
    - description: recipientPattern
      name: recipientPattern
    - description: subjectPattern
      name: subjectPattern
    - defaultValue: "50"
      description: limit of output
      name: limit
    description: Genral search , can combine multiple parameters
    name: iron-port-search
  dockerimage: demisto/python3:3.9.8.24399
  runonce: false
  script: |
    from base64 import b64encode
    from datetime import datetime, timedelta


    import requests


    requests.packages.urllib3.disable_warnings()


    quarantineName = demisto.params()['quarantineName']
    userName = demisto.params()['userName']
    password = demisto.params()['password']
    urlBase = demisto.params()['baseurl']

    passcode = bytes(userName + ":" + password, "utf-8")
    token = b64encode(passcode).decode("ascii")


    def ironportQuarantineReleaseEmail(mid):

        url = urlBase + "/sma/api/v2.0/quarantine/messages"

        payload = '{"action":"release","mids": [' + str(mid) + '],"quarantineName": "' + \
            str(quarantineName) + '","quarantineType":"pvo"}'
        headers = {
            'Authorization': 'Basic ' + str(token),
            'Content-Type': 'text/plain'
        }

        response = requests.request("POST", url, headers=headers, data=payload, verify=False)

        # print(response.text.encode('utf8'))
        # print(response.status_code)

        if str(response.status_code) == "200":
            # message = response.json()['data']['totalCount']
            if int(response.json()['data']['totalCount']) == 1:
                message = "The Email is Released Successfully!"
            else:
                message = "We could not find the EMail!"

        else:
            message = "Failed to Release!"
        return message


    def ironportSpamReleaseEmail(mid):

        url = urlBase + "/sma/api/v2.0/quarantine/messages"

        payload = '{"action":"release","mids": [' + str(mid) + '],"quarantineType":"spam"}'
        headers = {
            'Authorization': 'Basic ' + str(token),
            'Content-Type': 'text/plain'
        }

        response = requests.request("POST", url, headers=headers, data=payload, verify=False)

        # print(response.text.encode('utf8'))
        # print(response.status_code)

        if str(response.status_code) == "200":
            # print(response.json()['data']['totalCount'])
            if int(response.json()['data']['totalCount']) == 1:
                message = "The Email is Released Successfully!"
            else:
                message = "We could not find the EMail!"

        else:
            message = "Failed to Release!"
        return message


    def generateStartEndDates(x):
        myend = datetime.utcnow() + timedelta(days=int(1))
        end = myend.strftime("%Y-%m-%dT00:00:00.000Z")
        mystart = datetime.today() - timedelta(days=int(x))
        start = mystart.strftime("%Y-%m-%dT00:00:00.000Z")
        return start, end

    # Search in Policy-Based Quarantined


    def ironPortSearchQuarantines(periodInDays, senderPattern, recipientPattern, subjectPattern, limit):

        start, end = generateStartEndDates(periodInDays)
        searchPeriod = "&startDate=" + str(start) + "&endDate=" + str(end)
        searchOptions = "&limit=" + str(limit) + "&offset=0&orderBy=received&orderDir=desc"
        # envelopeSenderFilterBy=contains&envelopeSenderFilterValue=abc
        searchPart = ""
        if str(senderPattern) != "None":
            searchPart += "&envelopeSenderFilterBy=contains&envelopeSenderFilterValue=" + str(senderPattern)
        else:
            searchPart += ""
        # envelopeRecipientFilterBy=starts_with&envelopeRecipientFilterValue=xyz
        if str(recipientPattern) != "None":
            searchPart += "&envelopeRecipientFilterBy=contains&envelopeRecipientFilterValue=" + str(recipientPattern)
        else:
            searchPart += ""
        # subjectFilterBy=ends_with&subjectFilterValue=sub
        if str(subjectPattern) != "None":
            searchPart += "&subjectFilterBy=contains&subjectFilterValue=" + str(subjectPattern)
        else:
            searchPart += ""

        # print("senderSearchPart :", searchPart)
        # print("Serach Period start :",start , " END :",end)
        url = urlBase + \
            "/sma/api/v2.0/quarantine/messages?quarantineType=pvo&quarantines=Outbreak,Virus,File+Analysis,Unclassified,Policy" + \
            searchOptions + searchPeriod + searchPart
        # print("URL : ",url)

        headers = {
            'Authorization': 'Basic ' + str(token)
        }

        response = requests.request("GET", url, headers=headers, verify=False)
        r_j = response.json()
        # print("Output :", r_j)

        count = r_j['meta']['totalCount']
        data = r_j['data']
        # print(type(data))
        # print("Count :", count)
        # print("Emails :", tableToMarkdown('Email List: ', data))
        myoutput = []
        for i in data:
            email = {}
            email["MID"] = i['mid']
            email["received"] = i['attributes']['received']
            email["sender"] = i['attributes']['sender']
            email["recipient"] = i['attributes']['recipient']
            email["subject"] = i['attributes']['subject']
            email["esaHostName"] = i['attributes']['esaHostName']
            email["inQuarantines"] = i['attributes']['inQuarantines']
            email["quarantineForReason"] = i['attributes']['quarantineForReason'][0]
            email["quarantineName"] = i['attributes']['quarantineForReasonDict'][0]['quarantineName']
            email["scheduledExit"] = i['attributes']['scheduledExit']
            email["size"] = i['attributes']['size']

            myoutput.append(email)

        outputs = {
            "IronPortQuarantineSeacrhOutputCount": count,
            "IronPortQuarantineSeacrhOutput": myoutput
        }
        human_readable = tableToMarkdown("Emails Details :", myoutput, removeNull=True)
        return_outputs(human_readable, outputs)


    # Search in SPAM-Based Quarantined

    def ironPortSearchSpam(periodInDays, senderPattern, recipientPattern, subjectPattern, limit):

        start, end = generateStartEndDates(periodInDays)
        searchPeriod = "&startDate=" + str(start) + "&endDate=" + str(end)
        searchOptions = "&limit=" + str(limit) + "&offset=0&orderBy=date&orderDir=desc"

        # envelopeSenderFilterBy=contains&envelopeSenderFilterValue=xyz
        searchPart = ""

        # ilterBy=subject&filterOperator=contains&filterValue=abc.com
        if str(subjectPattern) != "None":
            searchPart += "&filterBy=subject&filterOperator=contains&filterValue=" + str(subjectPattern)
        else:
            searchPart += ""
        if str(senderPattern) != "None":
            searchPart += "&filterBy=from_address&filterOperator=contains&filterValue=" + str(senderPattern)
        else:
            searchPart += ""

        # envelopeRecipientFilterBy=contains&envelopeRecipientFilterValue=xyz
        if str(recipientPattern) != "None":
            searchPart += "&filterBy=to_address&filterOperator=contains&filterValue=" + str(recipientPattern)
        else:
            searchPart += ""

        # print("searchPart :", searchPart)
        # print("Search Period start :",start , " END :",end)
        url = urlBase + "/sma/api/v2.0/quarantine/messages?quarantineType=spam" + searchOptions + searchPeriod + searchPart
        # /esa/api/v2.0/quarantine/messages?quarantineType=spam&endDate=2020-06-30T00:00:00.000Z&limit=50&offset=0&startDate=2020-06-28T00:00:00.000Z&orderBy=date&orderDir=desc
        # print("URL : ", url)
        headers = {
            'Authorization': 'Basic ' + str(token)
        }

        response = requests.request("GET", url, headers=headers, verify=False)
        r_j = response.json()
        # print("Output :", r_j)

        count = r_j['meta']['totalCount']
        data = r_j['data']
        # print(type(data))
        # print("Count :", count)
        # print("Emails :", tableToMarkdown('Email List: ', data))
        myoutput = []
        for i in data:
            email = {}
            email["MID"] = i['mid']
            email["received"] = i['attributes']['date']
            email["sender"] = i['attributes']['fromAddress']
            email["recipient"] = i['attributes']['envelopeRecipient']
            email["subject"] = i['attributes']['subject']
            email["toAddress"] = i['attributes']['toAddress']
            email["size"] = i['attributes']['size']

            myoutput.append(email)

        outputs = {
            "ironPortSearchSpamCount": count,
            "IronPortSpamSeacrhOutput": myoutput
        }
        # print()
        human_readable = tableToMarkdown("Emails Details :", myoutput, removeNull=True)
        return_outputs(human_readable, outputs)


    # Search All Emails

    def ironPortSearch(periodInDays, senderPattern, recipientPattern, subjectPattern, limit):

        start, end = generateStartEndDates(periodInDays)
        searchPeriod = "&startDate=" + str(start) + "&endDate=" + str(end)
        searchOptions = "searchOption=messages&offset=0&limit=" + str(limit)
        # envelopeSenderfilterOperator=is&envelopeSenderfilterValue=confikr.qa
        searchPart = ""
        if str(senderPattern) != "None":
            searchPart += "&envelopeSenderfilterOperator=contains&envelopeSenderfilterValue=" + str(senderPattern)
            searchBy = "searchBySender"
        else:
            searchPart += ""
        # envelopeRecipientfilterOperator=contains&envelopeRecipientfilterValue=confikr
        if str(recipientPattern) != "None":
            searchPart += "&envelopeRecipientfilterOperator=contains&envelopeRecipientfilterValue=" + str(recipientPattern)
            searchBy = "searchByRecipient"
        else:
            searchPart += ""
        # subjectfilterOperator=begins_with&subjectfilterValue=test
        if str(subjectPattern) != "None":
            searchPart += "&subjectfilterOperator=contains&subjectfilterValue=" + str(subjectPattern)
            searchBy = "searchBySubject"
        else:
            searchPart += ""

        # print("senderSearchPart :", searchPart)
        # print("Serach Period start :",start , " END :",end)
        url = urlBase + "/sma/api/v2.0/message-tracking/messages?" + searchOptions + searchPeriod + searchPart
        # print("URL : ",url)

        headers = {
            'Authorization': 'Basic ' + str(token)
        }

        response = requests.request("GET", url, headers=headers, verify=False)
        r_j = response.json()
        # print("Output :", r_j)

        count = r_j['meta']['totalCount']
        data = r_j['data']
        # print(type(data))
        # print("Count :", count)
        # print("Emails :", tableToMarkdown('Email List: ', data))
        myoutput = []
        for i in data:
            email = {}
            email["MID"] = i['attributes']['mid']
            email["hostName"] = i['attributes']['hostName']
            email["sbrs"] = i['attributes']['sbrs']
            email["allIcid"] = i['attributes']['allIcid']
            email["serialNumber"] = i['attributes']['serialNumber']
            email["sender"] = i['attributes']['sender']
            email["recipient"] = i['attributes']['recipient']
            email["verdictChart"] = i['attributes']['verdictChart']
            email["messageID"] = i['attributes']['messageID']
            email["timestamp"] = i['attributes']['timestamp']
            email["replyTo"] = i['attributes']['replyTo']
            email["morDetails"] = i['attributes']['morDetails']
            email["icid"] = i['attributes']['icid']
            email["direction"] = i['attributes']['direction']
            # email["finalSubject"] = i['attributes']['finalSubject']
            email["senderDomain"] = i['attributes']['senderDomain']
            email["subject"] = i['attributes']['subject']
            email["senderGroup"] = i['attributes']['senderGroup']
            email["mailPolicy"] = i['attributes']['mailPolicy']
            email["senderIp"] = i['attributes']['senderIp']
            # email["recipientMap"] = i['attributes']['recipientMap']
            email["messageStatus"] = i['attributes']['messageStatus']
            email["isCompleteData"] = i['attributes']['isCompleteData']
            email["friendly_from"] = i['attributes']['friendly_from']

            myoutput.append(email)
        countOutput = "IronPortSeacrhOutputCount" + searchBy
        resultOutput = "IronPortSeacrhOutput" + searchBy
        # print("Names:", countOutput, resultOutput)
        outputs = {
            countOutput: count,
            resultOutput: myoutput
        }

        human_readable = tableToMarkdown("Emails Details :", myoutput, removeNull=True)
        return_outputs(human_readable, outputs)


    def main():

        try:

            if demisto.command() == 'test-module':
                # Tests connectivity and credentails on login
                # generateStartEndDates(1)
                return "ok"

            elif demisto.command() == 'iron-port-quarantine-release-email':
                mesId = demisto.args().get('mid')
                ironportQuarantineReleaseEmail(mesId)

            elif demisto.command() == 'iron-port-spam-release-Email':
                mesId = demisto.args().get('mid')
                ironportSpamReleaseEmail(mesId)

            elif demisto.command() == 'iron-port-search-quarantines':
                period = demisto.args().get('periodInDays')
                # senderPattern=""
                senderPattern = demisto.args().get('senderPattern')
                recipientPattern = demisto.args().get('recipientPattern')
                subjectPattern = demisto.args().get('subjectPattern')
                limit = demisto.args().get('limit')
                # print("senderPattern :",senderPattern)
                ironPortSearchQuarantines(period, senderPattern, recipientPattern, subjectPattern, limit)

            elif demisto.command() == 'iron-port-search-spam':
                period = demisto.args().get('periodInDays')
                # senderPattern=""
                senderPattern = demisto.args().get('senderPattern')
                recipientPattern = demisto.args().get('recipientPattern')
                subjectPattern = demisto.args().get('subjectPattern')
                limit = demisto.args().get('limit')
                # print("senderPattern :",senderPattern)
                ironPortSearchSpam(period, senderPattern, recipientPattern, subjectPattern, limit)

            elif demisto.command() == 'iron-port-search':
                period = demisto.args().get('periodInDays')
                # senderPattern=""
                senderPattern = demisto.args().get('senderPattern')
                recipientPattern = demisto.args().get('recipientPattern')
                subjectPattern = demisto.args().get('subjectPattern')
                limit = demisto.args().get('limit')
                # print("senderPattern :",senderPattern)
                ironPortSearch(period, senderPattern, recipientPattern, subjectPattern, limit)

        except Exception as e:
            LOG.print_log(e)
    #


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
sourcemoduleid: Cisco IronPort EMail API
