args:
- description: File entry ID
  name: entryID
  required: true
commonfields:
  id: 329e9c72-53ce-4dc2-8fd2-23cb51526a05
  version: -1
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
dockerimage: pandapack:latest
enabled: true
engineinfo: {}
mainengineinfo: {}
name: Test_NH_WIP
pswd: ""
runas: DBotWeakRole
runonce: false
script: |+
  """
  1) Check General Shift and Weekend Shift logics
  2) If any new person is added in roaster/ any existing person changes name/surname add them to list
  3) Vinay should send CSV format via mail
  4) Mail should be sent to demisto with the data of one week buffer time since last sheet(tom_index logic)
  """


  import pandas as pd
  import csv
  from datetime import date,timedelta


  args=demisto.args()

  entryID=args.get("entryID")

  file_info = demisto.getFilePath(entryID)
  file_path = file_info['path']

  shifts={}
  next_day_shifts={}

  today = date.today()
  tomorrow = today + timedelta(1)
  cur_day = today.strftime("%m/%d")
  print("today is =", cur_day)
  tom_day = tomorrow.strftime("%m/%d")
  print("tomorrow is =", tom_day)



  #code for finding the index of the current day

  with open(file_path, newline='') as csvfile:
      spamreader = csv.reader(csvfile, delimiter=',')
      header = []
      header = next(spamreader)
      #print(header)



  for i in header:
  # if isError(datetime.datetime.strptime(i,'%Y/%m/%d'):
  # header[i]=datetime.datetime.strptime(i,'%Y/%m/%d')
      try:
          #i=i[:4]
          dt = datetime.strptime(i, "%m/%d/%Y").strftime('%m/%d')
          header = list(map(lambda x: x.replace(i, dt), header))
          #print(type(dt))
          #print(dt)
      except ValueError:
          pass
  print(header)





  cur_index = header.index(cur_day)
  tom_index = header.index(tom_day)
  print(cur_index,tom_index)

  if (cur_day in header):
      cur_index = header.index(cur_day)
      # if(cur_index==6):
      #     tom_index = header.index(cur_day)
  else:
      print("Todays date not found in sheet")

  if (tom_day in header):
      tom_index = header.index(tom_day)
  else:
      print("Tommorows date not found in sheet")
      tom_index = header.index(cur_day)




  userlist=json.loads(demisto.executeCommand('getList', {'listName':"CSOC Team"})[0]['Contents'])

  with open(file_path, newline='') as csvfile:

      spamreader = csv.reader(csvfile, delimiter=',')
      for col in spamreader:
          if col[4]=="L2" or col[4]=="Manager":
              pass
          else:
              username=userlist.get(col[1])
              shifts[username]=col[cur_index]#Todays shifts for all-->While mapping will be for noon n night
              next_day_shifts[username]=col[tom_index]# Tomorrows shifts for all-->while mapping will be for morning






  def getKeysByValue(dictOfElements, valueToFind):
      listOfKeys = list()
      listOfItems = dictOfElements.items()
      for item  in listOfItems:
          if item[1] == valueToFind:
              listOfKeys.append(item[0])
      return  listOfKeys

  # #will have to think about general shift people where to add them




  first_shift=getKeysByValue(next_day_shifts,"E1")
  second_shift=getKeysByValue(shifts,"N1")
  third_shift=getKeysByValue(shifts,"T2")

  print("Below are the list of people in 3 shift")
  print(first_shift)
  print(second_shift)
  print(third_shift)
  demisto.setContext('FirstShift',first_shift)
  demisto.setContext('SecondShift',second_shift)
  demisto.setContext('ThirdShift',third_shift)


  """
  We can enter a small code that will fetech the username of these emp id present in list
  using azure ad integration comand and get the fist name and last name from context data which is our nomenclature for username
  and then run the integration command

  """

  # def maproles(shiftrole,shiftlist):
  #     for i in shiftlist:
  #         body={
  #             'id':i,
  #             'roles':{
  #                 'roles':[shiftrole,"Operator"],
  #                 'defaultAdmin':False
  #             }
  #         }
  #         demisto.executeCommand('demisto-api-post', {'body':body,'uri':"/users/update"})

  # maproles('First-Shift',first_shift)
  # maproles('Second-Shift',second_shift)
  # maproles('Third-Shift',third_shift)



scripttarget: 0
subtype: python3
tags: []
timeout: 3.6Âµs
type: python
