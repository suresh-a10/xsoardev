category: Utilities
commonfields:
  id: key value store
  version: -1
configuration:
- display: Incident type
  name: incidentType
  required: false
  type: 13
- display: Long running instance
  name: longRunning
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
display: key value store
image: data:image/png;base64,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
name: key value store
script:
  commands:
  - arguments:
    - name: to_check
      required: true
    name: keyvalue-check-value
    outputs:
    - {}
  - arguments:
    - name: value
      required: true
    - description: in seconds
      name: timeout
      required: true
    name: keyvalue-append-value
  - arguments: []
    name: keyvalue-clear-context
  dockerimage: demisto/python3:3.8.3.9324
  longRunning: true
  runonce: false
  script: |
    import datetime
    def run_long_running(params):
        context = demisto.getIntegrationContext()
        if not isinstance(context, dict):
            context = json.loads(context)
        rn = int(time.time())
        if context:
            for k,v in context.items():
                if rn - int(v) > int(k.split(',')[1]):
                    print('deleting')
                    context.pop(k)
                    print(context)
                    if context:
                        demisto.setIntegrationContext(context)
                    else:
                        demisto.setIntegrationContext({})
                else:
                    print('not')

    def main():

        command = demisto.command()
        params = demisto.params()

        demisto.debug(f'Command being called is {demisto.command()}')
        if demisto.command() == 'test-module':
            # This is the call made when pressing the integration Test button.
            demisto.results('ok')

        if command == 'long-running-execution':
                run_long_running(params)

        elif demisto.command() == 'keyvalue-check-value':
            context = demisto.getIntegrationContext()
            if not isinstance(context, dict):
                context = json.loads(context)
            val = demisto.args().get('to_check')
            value = 0
            if context:
                for k,v in context.items():
                    if k.split(',')[0] == val:
                        value = v
                if value:
                    demisto.results('Present')
                else:
                    demisto.results(None)
            else:
                demisto.results(None)

        elif demisto.command() == 'keyvalue-append-value':
            context = demisto.getIntegrationContext()
            if not isinstance(context, dict):
                context = json.loads(context)
            k = demisto.args().get('value') + "," + demisto.args().get('timeout')
            v = str(int(time.time()))
            flag = 0
            if context:
                for key,value in context.items():
                    if key.split(",")[0] == k.split(",")[0]:
                        flag = key
            else:
                context[k] = v
            if flag:
                context.pop(flag)
                context[k] = v
            else:
                context[k] = v
            demisto.setIntegrationContext(json.dumps(context))
            demisto.results('done')


        elif demisto.command() == 'keyvalue-clear-context':
            demisto.setIntegrationContext(json.dumps({}))
            demisto.results('done')

        elif demisto.command() == 'keyvalue-check-longrunning':
            demisto.results(run_long_running(params))




    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
