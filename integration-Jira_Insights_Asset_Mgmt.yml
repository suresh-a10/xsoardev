category: Utilities
commonfields:
  id: Jira Insights Asset Mgmt
  version: -1
configuration:
- defaultvalue: https://<server hostname>/portal
  display: Server URL (e.g. https://soar.monstersofhack.com)
  name: url
  required: true
  type: 0
- display: Username or Email
  name: username
  required: true
  type: 0
- display: API Key
  name: apikey
  required: true
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: This integration is used to get Asset Information from JIRA Insight.
detaileddescription: |-
  ### Community Contributed Integration
   #### Integration Author: Cortex XSOAR
   No support or maintenance is provided by the author. Customers are encouraged to engage with the user community for questions and guidance at the [Cortex XSOAR Live Discussions](https://live.paloaltonetworks.com/t5/cortex-xsoar-discussions/bd-p/Cortex_XSOAR_Discussions).
  ***
  ## Hello World
  - This section explains how to configure the instance of HelloWorld in Cortex XSOAR.
  - You can use the following API Key: `43ea9b2d-4998-43a6-ae91-aba62a26868c`

  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/hello-world)
display: Jira Insights Asset Mgmt
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAF8ElEQVRo3tVaa2wUVRQ+lUeolLZQHwQxEUIi/GgpakvTst2d7fax7RaEUFOIRW2x7e7cme220BawNSQ1MQZFgYaH8gvlFVAxUYIIJPxRA7FSLCpBJMYnL5FEyh8cvzttodvd6e527izpJCezO3Pn3Pvde853zzkzRKKPAmUOScp+Kg/MoVF7FCiZJLHz5JA1nL8jlzxzxLoklgw908iBc5xBZKPTSzqIAcmvPU3Ltk+NSc/S5vGUz9YASBd0XIXOb2jpKm+cQDAnOvw9CAQXm1ej0ubj9PW5yVHpaXplLJU3bKN83xA9+F+gtJAnkGAdCIm50dm1EBADYgeYrJrDlF0d2UTscj7ZfXcMdN2kJW2PWwPCIZdC/jYEESwHATopwsquHVZHgb9IPAinvhI3owTRJ5L8ITm8xisjye8N+7xLtQk2JyUHPnElJhB3CcB7hCpff9TATI8bPmfzXUCfqeJAuPyzoPinEYEYkMKGr8jtnztkhbmZ3gr1MYiTXaPFgWKRFDuenMpBUyD0wemsBGqVt2EVWmgRmMoh3wjTthdAdlGpP120cz8EO/7FNJBQswm95mR7qKTBoujAqUzADJ4QDiREWDe5lInWbn5FgWysyiEAOmNgDuZFkt+N107+AGw3hUrU6VSsLsTvo4LBHMFEJVDcD7syBh1vEQikFz5SRPflkNRU2PY5cebF/oBPLjM/sMWBVEShKpRuJxeLjsMdyibx/sL2UUXHCNmrtiUZ9n/0bhSaW3uL1A2RuVxiqy1ismvQvR7ycKxx1GuUP0hRdo1GLVvfjsK8NlpMzRdhbowKlSmRQVSumg/kt4csr0Y5dZepyvuEMXh/Ctr1kA1t56vDC28jmaLnbkQZ9VSoJhqxzzh08rmhguyXPqI9xxINzOotPsDkhbXavMZlWmZgeVjh93gbHYx5//kWYFZQkfLg0P2hAg3+M3xwQb1GFe0nacVaDz3XOB3m9xiU5UP64i/M9rzG5dq+6xnanqsZ2u4rc4OEX+P3eBt9ZYQRgnf/4IAwERe7IsyARnl1PBTX9IRKYteD7mNwfNb5gD+4nKG9/9fcIOHX+D3eRggQbp42Pp616wYBUVeaVtwPhM8+H/iuPzODhF/j94QB4RNaFviR1h1K6wPxYkcyZvqHUQckC2y6utN3bzWatzDKqtZGHZDcuh56oWNSH4h3dqRRSdP5frsfXUAkVn1vNTxyO+V5zfG6GGe/ohMIn1BOKFJEej5NBfKEwfHRAWE0OBL6ldh+0H4ussRpOqVXrfFQRdtJneqN+7qD+G9J8N7hbkzEalRBusynrDFuiE7lzbCbK990s6s/Ns732WGkweMMQgxs95JSB0BnzPF61CHKWVC+cY1rZWAG5fmuhs1Vlq96JprsbzLyZRmoL1gaADrZGxHHsiSwKagwwUtDLmV9rBEwKiasvb9sY0FezgIRx/BsUybCoN5Bz32G2CppZLlJTfNssrO94sEoG6MrCLIytN8KS/EB/CQBNS1WCflNIJgeOHvKfcrLlULd2YT5ibwZ5zHxB+JAicbBjgg1MV5KcjcuIk/TdFBrKnwzTsCcyk6LmIynBd04f0Lu1qctNi05CZ2dtbxkKiknyNmQaA0Il5qOTkLDmZyXrQDzMyRNLACPmgmlu+Ebt0MTG991Yhs6sUM34n6nvufYTfsMJ4G9VMjGigNR0+LRbTf84P4lW31wWdOtZlCx8qUpMPw9fZEyUxyI1rYpCA8uGQ5Kkr8I+5y39RFa4Ds8QiCXwVpZYk2q1C9FeIexw/BZm5yMmY01PbgBJ7egcF3oLxnWjl1Kc4Ty6USAPRBDSbTYGpZqacMGJf8TvnqBxEaS8yLqyKpJhnyqfzRgHPrzzzQsfIWweE0CuHw12euHMpVG5f7N+Nwiuh2Yf77hbj6mf84Rap6/YoO1x2cnL3m1Dp2e0h1RwtkuB5CSxhZGPL9zKj4UONX/NncAxEWS/E/FOcaSJ+mfHDlNhNFlrTP0l5x9weL38LF0GrWHq2m2/uLGpT4pWvX/zRDqQjZWrVoAAAAASUVORK5CYII=
name: Jira Insights Asset Mgmt
script:
  commands:
  - arguments:
    - description: Provide the Hostname
      name: Hostname
    - description: Provide the Hostname
      name: IPAddress
    description: Get asset details using Hostname or IP address
    name: jira-get-asset-details
  - arguments:
    - description: Provide the Owner Key which was fetched from command "jira-get-asset-details"
      name: OwnerKey
    - description: Provide the Planner Key which was fetched from command "jira-get-asset-details"
      name: PlannerKey
    - description: Provide the Operations Key which was fetched from command "jira-get-asset-details"
      name: OperationsKey
    description: Get owner,planner,operation details from JIRA Insight
    name: jira-get-owner-planner-operations-details
  dockerimage: demisto/python3:3.10.5.31928
  runonce: false
  script: |
    import json
    import requests
    from requests.auth import HTTPBasicAuth
    from typing import Any, Dict, Tuple, List, Optional, Union, cast

    # Disable insecure warnings

    requests.packages.urllib3.disable_warnings()

    ''' GLOABAL VARIABLES '''
     # get the service API url
    BASEURL = demisto.params()['url']
    USERNAME = demisto.params()['username']
    APIKEY = demisto.params()['apikey']
    VERIFY_CERTIFICATE = not demisto.params().get('insecure', False)
    PROXY = demisto.params().get('proxy', False)
    DEFAULT_HEADERS= {'Accept':'application/json'}
    BasicAUTH= HTTPBasicAuth(USERNAME,APIKEY)

    def http_request(method,url,headers,verify,params=None):

        try:
            if method == 'GET':
                response = requests.get(url=url,auth=BasicAUTH,headers=headers,verify=verify,params=params)
        except requests.exceptions.HTTPError as e:
            raise e

        return response


    def jira_get_asset_details(hostname,ip_address):

        url_suffix = '/rest/insight/1.0/iql/objects'
        #url_suffix = 'jsm/assets/workspace/11c9694a-c6f4-4ccd-a712-97c2e8ff8a21/v1/aql/objects'
        url = BASEURL+url_suffix
        #print(url)
        method = 'GET'
        if hostname is not None:
            query = 'Hostname='+hostname
            params = {'iql':query}
            res = http_request(method,url,DEFAULT_HEADERS,VERIFY_CERTIFICATE,params)
        else:
            query = 'IPv4='+ip_address
            params = {'iql':query}
            #params = {'iql':'IPv4='+ip_address}
            res = http_request(method,url,DEFAULT_HEADERS,VERIFY_CERTIFICATE,params)



        data=res.json()
        #print(result)

    #    data = json.load(result)
        AttributeKeys= {'Owner Key':'Owner','Planner Key': 'Planner','Operations Key':'Operation'}
        result_dict = {}
        for item in data['objectEntries']:
            try:

                for i in range(len(item['attributes'])):
                    for j in range(len(data['objectTypeAttributes'])):
                        if item['attributes'][i]['objectTypeAttributeId'] == data['objectTypeAttributes'][j]['id']:
                            for k in item['attributes'][i]['objectAttributeValues']:
                                result_dict[data['objectTypeAttributes'][j]['name']] = k['displayValue']
                                if "referencedObject" in k:
                                    for key,value in AttributeKeys.items():
                                        if k['referencedObject']['objectType']['name'] == value:
                                            result_dict[key] = k['searchValue']


            except IndexError:
                continue
        #print(result_dict)

        md = tableToMarkdown("Asset Information",result_dict)
        demisto.results({
            'Type': entryTypes['note'],
            'Contents': result_dict,
            'ContentsFormat': formats['json'],
            'HumanReadable': md,
            'ReadableContentsFormat' : formats['markdown'],
            'EntryContext':{'AssetDetails':result_dict}
        })


    def jira_get_owner_planner_operation_details(owner_key,planner_key,operations_key):

        url_suffix = '/rest/insight/1.0/iql/objects'
        #url_suffix = 'jsm/assets/workspace/11c9694a-c6f4-4ccd-a712-97c2e8ff8a21/v1/aql/objects'
        url = BASEURL+url_suffix
        #print(url)
        method = 'GET'
        AttributeInfo = {'OwnerInformation':owner_key,'PlannerInformation':planner_key,'OperationInformation':operations_key}
        for key,value in AttributeInfo.items():
            if value is not None:

                query = 'Key='+value
                params = {'iql':query}

                res = http_request(method,url,DEFAULT_HEADERS,VERIFY_CERTIFICATE,params)

                data=res.json()
            #print(result)

        #    data = json.load(result)

                result_dict = {}
                for item in data['objectEntries']:
                    try:

                        for i in range(len(item['attributes'])):
                            for j in range(len(data['objectTypeAttributes'])):
                                if item['attributes'][i]['objectTypeAttributeId'] == data['objectTypeAttributes'][j]['id']:
                                    for k in item['attributes'][i]['objectAttributeValues']:
                                        result_dict[data['objectTypeAttributes'][j]['name']] = k['displayValue']

                    except IndexError:
                        continue



                md = tableToMarkdown(key,result_dict)
                demisto.results({
                    'Type': entryTypes['note'],
                    'Contents': result_dict,
                    'ContentsFormat': formats['json'],
                    'HumanReadable': md,
                    'ReadableContentsFormat' : formats['markdown'],
                    'EntryContext':{key:result_dict}
                })

            else:
                demisto.results(f'No {keys} are present')

    def test_module():
        """
        Tests API connectivity and authentication'
        When 'ok' is returned it indicates the integration works like it is supposed to and connection to the service is
        successful.
        Raises exceptions if something goes wrong.


        Returns:
            str: 'ok' if test passed, anything else will raise an exception and will fail the test.
        """


        try:

            res=http_request('GET',BASEURL,DEFAULT_HEADERS,VERIFY_CERTIFICATE)
            if res.status_code==200:
                return 'ok'
        except requests.exceptions.HTTPError as e:
            raise e



    ''' MAIN FUNCTION '''


    def main() -> None:
        """
        main function, parses params and runs command functions
        """

        # INTEGRATION DEVELOPER TIP
        # You can use functions such as ``demisto.debug()``, ``demisto.info()``,
        # etc. to print information in the XSOAR server log. You can set the log
        # level on the server configuration
        # See: https://xsoar.pan.dev/docs/integrations/code-conventions#logging

        #demisto.debug(f'Command being called is {command}')
        command = demisto.command()
        try:
            if command == 'test-module':
                demisto.results(test_module())
                # This is the call made when pressing the integration Test button
            elif command == 'jira-get-asset-details':
                hostname = demisto.args().get('Hostname',None)
                ip_address = demisto.args().get('IPAddress',None)

                if hostname is not None:
                    #print(hostname)
                    jira_get_asset_details(hostname,ip_address)
                elif ip_address is not None:
                    jira_get_asset_details(hostname,ip_address)
                else:
                    demisto.results('Provide Hostname or IP Address to get asset details')
            elif command =="jira-get-owner-planner-operations-details":
                owner_key = demisto.args().get('OwnerKey',None)
                planner_key = demisto.args().get('PlannerKey',None)
                operations_key = demisto.args().get('OperationsKey',None)

                jira_get_owner_planner_operation_details(owner_key,planner_key,operations_key)
        # Log exceptions and return errors
        except Exception as e:
            return_error(f'Failed to execute command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''

    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
