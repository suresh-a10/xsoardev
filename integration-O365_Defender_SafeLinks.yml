category: Utilities
commonfields:
  id: O365 Defender SafeLinks
  version: -1
configuration:
- additionalinfo: A pfx certificate encoded in Base64.
  display: Certificate
  displaypassword: Password - Used to generate the certificate
  name: certificate
  required: true
  section: Connect
  type: 9
- additionalinfo: The organization used in app-only authentication.
  display: Organization
  name: organization
  required: true
  section: Connect
  type: 0
- display: The application ID from the Azure portal
  name: app_id
  required: true
  section: Connect
  type: 0
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.0.0
    itemVersion: 4.5.30
    packID: Microsoft365Defender
    packName: Microsoft 365 Defender
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: Provides URL scanning and rewriting of inbound email messages in mail
  flow, and time-of-click verification of URLs and links in email messages and other
  locations.
detaileddescription: |-
  ## O365 Defender Safe Links

  ### App authentication
  To use this integration, you need to add a new Azure App Registration in the Azure Portal.
  1. To create the application, follow the instructions in this [guide](https://docs.microsoft.com/en-us/powershell/exchange/app-only-auth-powershell-v2?view=exchange-ps).
  2. Run the **CreateCertificate** script from the `EWS` pack in Cortex XSOAR to acquire the certificate. You can also provide your own certificate or perform the instructions in the following Microsoft article: [Generate a self-signed certificate](https://docs.microsoft.com/en-us/powershell/exchange/app-only-auth-powershell-v2?view=exchange-ps#step-3-generate-a-self-signed-certificate).
  3. Attach the .cer file to your Azure App. See the following [article](https://docs.microsoft.com/en-us/powershell/exchange/app-only-auth-powershell-v2?view=exchange-ps#step-4-attach-the-certificate-to-the-azure-ad-application) for an example.
  4. Copy the contents of the .txt file and paste it in the Certificate parameter of the integration's instance.

  #### Required Permissions
  * In the Azure Application you created give the following application permission:

          Office 365 Exchange Online -> Exchange.ManageAsApp - Application
  * To create, modify, and delete Safe Links policies, you need to be a member of the `Organization Management` or `Security Administrator` role groups.
  * To manage permissions in the Microsoft Defender XDR portal, go to `Permissions & roles` or https://security.microsoft.com/securitypermissions. You need to be a global administrator or a member of the Organization Management role group in the Microsoft Defender XDR portal. Specifically, the Role Management role allows users to view, create, and modify role groups in the Microsoft Defender XDR portal, and by default, that role is assigned only to the Organization Management role group.
  * See [Permissions in the Microsoft Defender XDR portal](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/permissions-microsoft-365-security-center?view=o365-worldwide) for more information.

  -------
  ##### Note
  If the credentials object is used, make sure to set the `certificate` value as the `username` property and not as the certificate field
  ![](https://raw.githubusercontent.com/demisto/content/11209e3d0765c82470665ec787f3f68ba09c05bd/Packs/Microsoft365Defenderhttps://storage.googleapis.com/marketplace-dist/content/packs/Microsoft365Defender/integration_description_images/credentials_example.png
  )


  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/o365-defender-safe-links)
display: O365 Defender SafeLinks
image: data:image/png;base64,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
name: O365 Defender SafeLinks
script:
  commands:
  - arguments:
    - description: 'The identity of the Safe Links policy that you want to view. Available
        identity fields of the policy are: Name, Distinguished name (DN), and GUID.'
      name: identity
    description: List the Safe Links policies in your cloud-based organization.
    name: o365-defender-safelinks-policy-list
    outputs:
    - contextPath: O365Defender.SafeLinks.AdminDisplayName
      description: Policy description.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.AllowClickThrough
      description: Whether users are allowed to click through the original URL.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.CustomNotificationText
      description: The customized notification text to show to users.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.DeliverMessageAfterScan
      description: Whether the mail is delivered after Safe Links scanning was completed.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DisableUrlRewrite
      description: Whether URLs are rewritten (wrapped) in email messages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DistinguishedName
      description: Policy distinguished name (DN).
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.DoNotAllowClickThrough
      description: Whether users can click through the original URLs.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DoNotTrackUserClicks
      description: Whether user clicks are tracked.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DoNotRewriteUrls
      description: List of URLs that are not rewritten by Safe Links scanning.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Policy.EnableForInternalSenders
      description: Whether the Safe Links policy is applied to messages sent between
        internal senders and internal recipients within the same Exchange Online organization.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.EnableOrganizationBranding
      description: Whether the organization's logo is displayed on Safe Links warning
        and notification pages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.EnableSafeLinksForTeams
      description: Whether the Safe Links policy is enabled for Microsoft Teams.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.ExchangeObjectId
      description: Exchange object ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ExchangeVersion
      description: The version of the Exchange server.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Guid
      description: The GUID of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Id
      description: The ID of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Identity
      description: The identity of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.IsDefault
      description: Whether the Safe Links policy is the default policy.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.IsEnabled
      description: Whether Safe Links protection is enabled for email messages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.IsValid
      description: Whether the Safe Links policy is valid.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.Name
      description: Policy name.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ObjectState
      description: The Safe Links policy state.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.OrganizationId
      description: The organization ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ScanUrls
      description: Whether real-time scanning of clicked links in email messages is
        enabled.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.WhenChanged
      description: 'The date and time the Safe Links policy was modified. Time format:
        YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenChangedUTC
      description: 'The date and time (in UTC) the  Safe Links policy was modified.
        Time format: YYYY-MM-DDTHH:MM:SSZ.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenCreated
      description: 'The date and time the Safe Links policy was created. Time format:
        YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenCreatedUTC
      description: 'The date and time (in UTC) the Safe Links policy was created.
        Time format: YYYY-MM-DDTHH:MM:SSZ.'
      type: Date
  - arguments:
    - description: A unique name for the Safe Links policy.
      name: name
      required: true
    - description: The description for the policy.
      name: admin_display_name
    - description: The custom notification text to show to users.
      name: custom_notification_text
    - auto: PREDEFINED
      description: Whether to deliver email messages only after Safe Links scanning
        was completed. When true, messages that contain malicious links are not delivered.
        Default is false.
      name: deliver_message_after_scan
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to allow users to click through to the original URL on
        warning pages. Default is false.
      name: do_not_allow_click_through
      predefined:
      - "true"
      - "false"
    - description: Comma-separated list of URLs that are not rewritten by Safe Links
        scanning.
      name: do_not_rewrite_urls
    - auto: PREDEFINED
      description: Whether to track user clicks related to Safe Links protection of
        links in email messages. Default is false.
      name: do_not_track_user_clicks
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether the Safe Links policy is applied to messages sent between
        internal senders and internal recipients within the same Exchange Online organization.Default
        is false.
      name: enable_for_internal_senders
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to display the organization's logo on Safe Links warning
        and notification pages. Default is false.
      name: enable_organization_branding
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to enable Safe Links for Microsoft Teams. Default is false.
      name: enable_safe_links_for_teams
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to enable Safe Links protection for email messages. Default
        is false.
      name: is_enabled
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to enable or disable real-time scanning of clicked links
        in email messages. Default is false.
      name: scan_urls
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to use Microsoft Translator to automatically localize the
        custom notification text that you specified with the CustomNotificationText
        parameter. Default is false.
      name: use_translated_notification_text
      predefined:
      - "true"
      - "false"
    description: Create a new Safe Links policy.
    name: o365-defender-safelinks-policy-create
    outputs:
    - contextPath: O365Defender.SafeLinks.AdminDisplayName
      description: Policy description.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.AllowClickThrough
      description: Whether users are allowed to click through the original URL.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.CustomNotificationText
      description: The customized notification text to show to users.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.DeliverMessageAfterScan
      description: Whether the mail is delivered after Safe Links scanning was completed.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DisableUrlRewrite
      description: Whether URLs are rewritten (wrapped) in email messages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DistinguishedName
      description: Policy distinguished name (DN).
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.DoNotAllowClickThrough
      description: Whether users can click through the original URLs.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DoNotTrackUserClicks
      description: Whether user clicks are tracked.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DoNotRewriteUrls
      description: List of URLs that are not rewritten by Safe Links scanning.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Policy.EnableForInternalSenders
      description: Whether the Safe Links policy is applied to messages sent between
        internal senders and internal recipients within the same Exchange Online organization.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.EnableOrganizationBranding
      description: Whether the organization's logo is displayed on Safe Links warning
        and notification pages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.EnableSafeLinksForTeams
      description: Whether the Safe Links policy is enabled for Microsoft Teams.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.ExchangeObjectId
      description: Exchange object ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ExchangeVersion
      description: The version of the Exchange server.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Guid
      description: The GUID of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Id
      description: The ID of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Identity
      description: The identity of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.IsDefault
      description: Whether the Safe Links policy is the default policy.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.IsEnabled
      description: Whether Safe Links protection is enabled for email messages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.IsValid
      description: Whether the Safe Links policy is valid.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.Name
      description: Policy name.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ObjectState
      description: The Safe Links policy state.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.OrganizationId
      description: The organization ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ScanUrls
      description: Whether real-time scanning of clicked links in email messages is
        enabled.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.WhenChanged
      description: 'The date and time the Safe Links policy was modified. Time format:
        YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenChangedUTC
      description: 'The date and time (in UTC) the Safe Links policy was modified.
        Time format: YYYY-MM-DDTHH:MM:SSZ.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenCreated
      description: 'The date and time the Safe Links policy was created. Time format:
        YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenCreatedUTC
      description: 'The date and time (in UTC) the Safe Links policy was created.
        Time format: YYYY-MM-DDTHH:MM:SSZ.'
      type: Date
  - arguments:
    - description: A unique name for the Safe Links policy.
      name: name
      required: true
    - description: The description for the policy.
      name: admin_display_name
    - description: The custom notification text to show to users.
      name: custom_notification_text
    - auto: PREDEFINED
      description: Whether to deliver email messages only after Safe Links scanning
        was completed. When true, messages that contain malicious links are not delivered.
        Default is false.
      name: deliver_message_after_scan
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to allow users to click through to the original URL on
        warning pages. Default is false.
      name: do_not_allow_click_through
      predefined:
      - "true"
      - "false"
    - description: Comma-separated list of URLs that are not rewritten by Safe Links
        scanning.
      name: do_not_rewrite_urls
    - auto: PREDEFINED
      description: Whether to track user clicks related to Safe Links protection of
        links in email messages. Default is false.
      name: do_not_track_user_clicks
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether the Safe Links policy is applied to messages sent between
        internal senders and internal recipients within the same Exchange Online organization.
        Default is false.
      name: enable_for_internal_senders
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to display the organization's logo on Safe Links warning
        and notification pages. Default is false.
      name: enable_organization_branding
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to enable the Safe Links for Microsoft Teams. Default is
        false.
      name: enable_safe_links_for_teams
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to enable Safe Links protection for email messages. Default
        is false.
      name: is_enabled
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to enable or disable real-time scanning of clicked links
        in email messages. Default is false.
      name: scan_urls
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Whether to use Microsoft Translator to automatically localize the
        custom notification text that you specified with the CustomNotificationText
        parameter. Default is false.
      name: use_translated_notification_text
      predefined:
      - "true"
      - "false"
    description: Update a Safe Links policy.
    name: o365-defender-safelinks-policy-update
    outputs:
    - contextPath: O365Defender.SafeLinks.AdminDisplayName
      description: Policy description.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.AllowClickThrough
      description: Whether users are allowed to click through the original URL.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.CustomNotificationText
      description: The customized notification text to show to users.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.DeliverMessageAfterScan
      description: Whether the mail is delivered after Safe Links scanning was completed.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DisableUrlRewrite
      description: Whether URLs are rewritten (wrapped) in email messages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DistinguishedName
      description: Policy distinguished name (DN).
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.DoNotAllowClickThrough
      description: Whether users can click through the original URLs.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DoNotTrackUserClicks
      description: Whether user clicks are tracked.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.DoNotRewriteUrls
      description: List of URLs that are not rewritten by Safe Links scanning.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Policy.EnableForInternalSenders
      description: Whether the Safe Links policy is applied to messages sent between
        internal senders and internal recipients within the same Exchange Online organization.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.EnableOrganizationBranding
      description: whether the organization's logo is displayed on Safe Links warning
        and notification pages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.EnableSafeLinksForTeams
      description: Whether the Safe Links policy is enabled for Microsoft Teams.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.ExchangeObjectId
      description: Exchange object ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ExchangeVersion
      description: The version of the Exchange server.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Guid
      description: The GUID of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Id
      description: The ID of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.Identity
      description: The identity of the Safe Links policy.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.IsDefault
      description: Whether the Safe Links policy is the default policy.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.IsEnabled
      description: Whether Safe Links protection is enabled for email messages.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.IsValid
      description: Whether the Safe Links policy is valid.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.Name
      description: Policy name.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ObjectState
      description: The Safe Links policy state.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.OrganizationId
      description: The organization ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Policy.ScanUrls
      description: Whether real-time scanning of clicked links in email messages is
        enabled.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Policy.WhenChanged
      description: 'The date and time the Safe Links policy was modified. Time format:
        YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenChangedUTC
      description: 'The date and time (in UTC) the Safe Links policy was modified.
        Time format: YYYY-MM-DDTHH:MM:SSZ.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenCreated
      description: 'The date and time the Safe Links policy was created. Time format:
        YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
    - contextPath: O365Defender.SafeLinks.Policy.WhenCreatedUTC
      description: 'The date and time (in UTC) the Safe Links policy was created.
        Time format: YYYY-MM-DDTHH:MM:SSZ.'
      type: Date
  - arguments:
    - description: 'The identity of the Safe Links policy that you want to remove.
        Available identity fields of the policy are: Name, Distinguished name (DN),
        and GUID.'
      name: identity
      required: true
    description: Remove a Safe Links policy.
    name: o365-defender-safelinks-policy-remove
  - arguments:
    - description: 'The identity of the Safe Links rule that you want to view. Available
        identity fields are: Name, Distinguished name (DN), and GUID.'
      name: identity
    - auto: PREDEFINED
      description: The state of the rules.
      name: state
      predefined:
      - Enabled
      - Disabled
    description: List Safe Links rules in your cloud-based organization.
    name: o365-defender-safelinks-rule-list
    outputs:
    - contextPath: O365Defender.SafeLinks.Rule.Comments
      description: Informative comments for the rule, such as what the rule is used
        for or how it has changed over time. The length of the comment cannot exceed
        1024 characters.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Conditions
      description: The rule condition.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Description
      description: The description of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.DistinguishedName
      description: Rule distinguished name (DN).
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfRecipientDomainIs
      description: Recipients with email address in the specified domains are excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfSentTo
      description: Recipients to be excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfSentToMemberOf
      description: Recipients in these groups are excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Exceptions
      description: Rule exceptions.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Guid
      description: The GUID of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Identity
      description: The identity of the Safe Links rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.IsValid
      description: Whether the rule is valid.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Rule.Name
      description: Rule name.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.ObjectState
      description: The state of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Priority
      description: The priority of the rule.
      type: Number
    - contextPath: O365Defender.SafeLinks.Rule.RecipientDomainIs
      description: List of domains that are included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.RuleVersion.Build
      description: Rule build number.
      type: Number
    - contextPath: O365Defender.SafeLinks.Rule.RunspaceId
      description: Run space ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.SafeLinksPolicy
      description: The Safe Links policy that's associated with this Safe Links rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.SentTo
      description: List of recipients included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.SentToMemberOf
      description: List of distribution groups, dynamic distribution groups, or mail-enabled
        security groups included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.State
      description: The state of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.WhenChanged
      description: 'The date and time the rule was modified. Time format: YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
  - arguments:
    - description: A unique name for the Safe Links rule.
      name: name
      required: true
    - description: The Safe Links policy to associate with this Safe Links rule.
      name: safe_links_policy
      required: true
    - description: An informative comment for the rule, such as what the rule is used
        for or how it has changed over time. The length of the comment cannot exceed
        1024 characters.
      name: comments
    - auto: PREDEFINED
      description: Whether the rule is enabled.
      name: enabled
      predefined:
      - "true"
      - "false"
    - description: A comma-separated list of exceptions of recipients with email address
        in the specified domains.
      isArray: true
      name: except_if_recipient_domain_is
    - description: A comma-separated list of exceptions of recipients in messages.
      isArray: true
      name: except_if_sent_to
    - description: A comma-separated list of exceptions of messages sent to members
        of groups.
      isArray: true
      name: except_if_sent_to_member_of
    - description: The priority value for the rule to determines the order of rule
        processing. A lower integer value indicates a higher priority. The value 0
        is the highest priority. Rules cannot have the same priority value.
      name: priority
    - description: A comma-separated list of recipients with email address in the
        specified domains.
      isArray: true
      name: recipient_domain_is
    - description: A comma-separated list of recipients in messages. You can use any
        value that uniquely identifies the recipient.
      isArray: true
      name: sent_to
    - description: A comma-separated list of messages sent to members of distribution
        groups, dynamic distribution groups, or mail-enabled security groups. You
        can use any value that uniquely identifies the group.
      isArray: true
      name: sent_to_member_of
    description: Create a Safe Links rule in your cloud-based organization.
    name: o365-defender-safelinks-rule-create
    outputs:
    - contextPath: O365Defender.SafeLinks.Rule.Comments
      description: Informative comments for the rule, such as what the rule is used
        for or how it has changed over time. The length of the comment cannot exceed
        1024 characters.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Conditions
      description: The rule condition.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Description
      description: The description of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.DistinguishedName
      description: Rule distinguished name (DN).
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfRecipientDomainIs
      description: Recipients with an email address in the specified domains are excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfSentTo
      description: Recipients to be excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfSentToMemberOf
      description: Recipients in these groups are excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Exceptions
      description: Rule exceptions.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Guid
      description: The GUID of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Identity
      description: The identity of the Safe Links rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.IsValid
      description: Whether the rule is valid.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Rule.Name
      description: Rule name.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.ObjectState
      description: The state of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Priority
      description: The priority of the rule.
      type: Number
    - contextPath: O365Defender.SafeLinks.Rule.RecipientDomainIs
      description: List of domains that are included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.RuleVersion.Build
      description: Rule build number.
      type: Number
    - contextPath: O365Defender.SafeLinks.Rule.RunspaceId
      description: Run space ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.SafeLinksPolicy
      description: The Safe Links policy that's associated with this Safe Links rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.SentTo
      description: List of recipients included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.SentToMemberOf
      description: List of distribution groups, dynamic distribution groups, or mail-enabled
        security groups included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.State
      description: The state of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.WhenChanged
      description: 'The date and time the rule was modified. Time format: YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
  - arguments:
    - description: A unique name for the Safe Links rule.
      name: name
      required: true
    - description: The Safe Links policy to associate with this Safe Links rule.
      name: safe_links_policy
      required: true
    - description: An informative comment for the rule, such as what the rule is used
        for or how it has changed over time. The length of the comment cannot exceed
        1024 characters.
      name: comments
    - auto: PREDEFINED
      description: Whether the rule is enabled.
      name: enabled
      predefined:
      - "true"
      - "false"
    - description: A comma-separated list of exceptions of recipients with an email
        address in the specified domains.
      isArray: true
      name: except_if_recipient_domain_is
    - description: A comma-separated list of exceptions of recipients in messages.
      isArray: true
      name: except_if_sent_to
    - description: A comma-separated list of exceptions of messages sent to members
        of groups.
      isArray: true
      name: except_if_sent_to_member_of
    - description: The priority value for the rule to determines the order of rule
        processing. A lower integer value indicates a higher priority. The value 0
        is the highest priority. Rules cannot have the same priority value.
      name: priority
    - description: A comma-separated list of recipients with an email address in the
        specified domains.
      isArray: true
      name: recipient_domain_is
    - description: A comma-separated list of recipients in messages. You can use any
        value that uniquely identifies the recipient.
      isArray: true
      name: sent_to
    - description: A comma-separated list of messages sent to members of distribution
        groups, dynamic distribution groups, or mail-enabled security groups. You
        can use any value that uniquely identifies the group.
      isArray: true
      name: sent_to_member_of
    description: Update a given Safe Links rule.
    name: o365-defender-safelinks-rule-update
    outputs:
    - contextPath: O365Defender.SafeLinks.Rule.Comments
      description: Informative comments for the rule, such as what the rule is used
        for or how it has changed over time. The length of the comment cannot exceed
        1024 characters.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Conditions
      description: The rule condition.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Description
      description: The description of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.DistinguishedName
      description: Rule distinguished name (DN).
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfRecipientDomainIs
      description: Recipients with email address in the specified domains are excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfSentTo
      description: Recipients to be excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.ExceptIfSentToMemberOf
      description: Recipients in these groups are excluded.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Exceptions
      description: Rule exceptions.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.Guid
      description: The GUID of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Identity
      description: The identity of the Safe Links rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.IsValid
      description: Whether the rule is valid.
      type: Boolean
    - contextPath: O365Defender.SafeLinks.Rule.Name
      description: Rule name.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.ObjectState
      description: The state of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.Priority
      description: The priority of the rule.
      type: Number
    - contextPath: O365Defender.SafeLinks.Rule.RecipientDomainIs
      description: List of domains that are included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.RuleVersion.Build
      description: Rule build number.
      type: Number
    - contextPath: O365Defender.SafeLinks.Rule.RunspaceId
      description: Run space ID.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.SafeLinksPolicy
      description: The Safe Links policy that's associated with this Safe Links rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.SentTo
      description: List of recipients included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.SentToMemberOf
      description: List of distribution groups, dynamic distribution groups, or mail-enabled
        security groups included in the rule.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.Rule.State
      description: The state of the rule.
      type: String
    - contextPath: O365Defender.SafeLinks.Rule.WhenChanged
      description: 'The date and time the rule was modified. Time format: YYYY-MM-DDThh:mm:ss+00:00.'
      type: Date
  - arguments:
    - description: Start date of the date range in MM-DD-YYYY format. Yesterday is
        the most recent date that you can specify. You can't specify a date that's
        older than 7 days.
      name: start_date
      predefined:
      - ""
      required: true
    - description: End date of the date range in MM-DD-YYYY format. Yesterday is the
        most recent date that you can specify. You can't specify a date that's older
        than 7 days.
      name: end_date
      predefined:
      - ""
      required: true
    - description: ' filters the results by the domain in the URL.'
      isArray: true
      name: domain
      predefined:
      - ""
    - auto: PREDEFINED
      description: ' filters the results by the app where the link was found. You
        can enter multiple values separated by commas e.g "Value1,Value2,...ValueN".'
      isArray: true
      name: app_names
      predefined:
      - Email Client
      - OfficeDocs
      - Teams
    - auto: PREDEFINED
      description: filters the results by action. You can enter multiple values separated
        by commas e.g Value1,Value2,...ValueN.
      isArray: true
      name: action
      predefined:
      - Allowed
      - Blocked
      - ClickedDuringScan
      - ClickedEvenBlocked
      - Scanning
      - TenantAllowed
      - TenantBlocked
      - TenantBlockedAndClickedThrough
    - description: ' filters the results by the recipient''s email address.'
      isArray: true
      name: recipient_address
      predefined:
      - ""
    - description: Page number of the results you want to view. Valid input for this
        parameter is an integer between 1 and 1000. The default value is 1.
      name: page
      predefined:
      - ""
    - description: Specifies the maximum number of entries per page. Valid input for
        this parameter is an integer between 1 and 5000. The default value is 1000.
      name: page_size
      predefined:
      - ""
    description: Get detailed information about Safe Links results for the last 7
      days. Yesterday is the most recent date that you can specify.
    name: o365-defender-safelinks-detailed-report-get
    outputs:
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.ClickTime
      description: Time the url was clicked.
      type: Date
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.InternalMessageId
      description: Internal message id.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.ClientMessageId
      description: Client message id.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.SenderAddress
      description: Sender of the email with the clicked URL.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.RecipientAddress
      description: Receiver of the email with the clicked URL.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.Url
      description: Clicked URL.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.UrlDomain
      description: Domain of th clicked URL.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.Action
      description: Action type.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.AppName
      description: App where the link was found.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.SourceId
      description: Source id.
      type: Unknown
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.Organization
      description: Organization.
      type: String
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.DetectedBy
      description: ""
      type: Unknown
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.UrlType
      description: ""
      type: Unknown
    - contextPath: O365Defender.SafeLinks.DetailedReport.Data.Flags
      description: '0: Allowed 1: Blocked 2: ClickedEvenBlocked 3: ClickedDuringScan.'
      type: Number
    - contextPath: O365Defender.SafeLinks.DetailedReport.ReportId
      description: The report id, unique for every run.
      type: Number
  - arguments:
    - description: Start date of the date range in MM-DD-YYYY format. Yesterday is
        the most recent date that you can specify. You can't specify a date that's
        older than 90 days.
      name: start_date
      predefined:
      - ""
      required: true
    - description: End date of the date range in MM-DD-YYYY format. Yesterday is the
        most recent date that you can specify. You can't specify a date that's older
        than 90 days.
      name: end_date
      predefined:
      - ""
      required: true
    - auto: PREDEFINED
      description: ' filters the results by the app where the link was found. You
        can enter multiple values separated by commas e.g "Value1,Value2,...ValueN".'
      isArray: true
      name: app_names
      predefined:
      - Email Client
      - OfficeDocs
      - Teams
    - auto: PREDEFINED
      description: filters the results by action. You can enter multiple values separated
        by commas e.g Value1,Value2,...ValueN.
      isArray: true
      name: action
      predefined:
      - Allowed
      - Blocked
      - ClickedDuringScan
      - ClickedEvenBlocked
      - Scanning
      - TenantAllowed
      - TenantBlocked
      - TenantBlockedAndClickedThrough
    - auto: PREDEFINED
      description: Returns totals based on the values you specify. Summarizing reduces
        the amount of data that's retrieved for the report, and delivers the report
        faster. By default the summrize is by Action.
      name: summerize_by
      predefined:
      - Action
      - App
    description: general information about Safe Links results for the last 90 days.
      Yesterday is the most recent date that you can specify.
    name: o365-defender-safelinks-aggregate-report-get
    outputs:
    - contextPath: O365Defender.SafeLinks.AggregateReport.Data.App
      description: App where the link was found.
      type: String
    - contextPath: O365Defender.SafeLinks.AggregateReport.Data.Action
      description: Action type.
      type: String
    - contextPath: O365Defender.SafeLinks.AggregateReport.Data.MessageCount
      description: Number of messages with a link.
      type: Number
    - contextPath: O365Defender.SafeLinks.AggregateReport.Data.RecipientCount
      description: Number of recipients of the link.
      type: Number
    - contextPath: O365Defender.SafeLinks.AggregateReport.ReportId
      description: The report id, unique for every run.
      type: Number
  - arguments: []
    description: Get Advanced Threat Protection policies.
    name: o365-defender-safelinks-atp-policy-get
    outputs:
    - contextPath: O365Defender.SafeLinks.AtpPolicy.Name
      description: ATP policy name.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.AdminDisplayName
      description: ATP policy admin display name.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.EnableATPForSPOTeamsODB
      description: ATP policy enabled for SPOT teams.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.AllowSafeDocsOpen
      description: Whether the ATP policy allows safe docs to open.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.EnableSafeDocs
      description: Whether the ATP policy enables safe docs.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.Identity
      description: ATP policy ID.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.IsValid
      description: Is the ATP policy valid.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.WhenCreatedUTC
      description: When the ATP policy was created in UTC format.
      type: String
    - contextPath: O365Defender.SafeLinks.AtpPolicy.WhenChangedUTC
      description: When the ATP policy was changed in UTC format.
      type: String
  - arguments:
    - auto: PREDEFINED
      description: Whether users can click through and bypass the Protected View container
        even when Safe Documents identifies a file as malicious.
      name: allow_safe_docs_open
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Enable or disable O365 Defender for SharePoint, OneDrive, and Microsoft
        Teams.
      name: enable_atp_spo_teams_odb
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: Enable or disable safe Documents in organizations with Microsoft
        365 A5 or Microsoft 365 E5 Security licenses.
      name: enable_safe_docs
      predefined:
      - "true"
      - "false"
    description: Set Advanced Threat Protection policy.
    name: o365-defender-safelinks-atp-policy-set
  dockerimage: demisto/pwsh-exchangev3:1.0.0.88371
  runonce: false
  script: |-
    ### pack version: 4.5.30
    Import-Module ExchangeOnlineManagement


    $COMMAND_PREFIX = "o365-defender-safelinks"
    $INTEGRATION_ENTRY_CONTEXT = "O365Defender.SafeLinks"

    function CreateContextForReport{
        Param(
            $raw_response
        )
        $context_data = @{"Data"=$raw_response}
        if ($raw_response -is [array]) {
            # RunSapceId is the same for all items in data.
            $context_data.ReportId=$raw_response[0].RunspaceId
        }

        else {
            $context_data.ReportId=$raw_response.RunspaceId
        }

        return $context_data
    }
        <#
        .DESCRIPTION
        Create context data for report commands. Where the context is divided to "Data" and "ReportId"

        .PARAMETER arg_value
        The raw value of the response.

        .EXAMPLE
        CreateContextForReport {field="data_1";RunspaceId="1"} -> {"Data"={field="data_1";RunspaceId="1"};
                                                                   "ReportId" = "1"}
        #>

    function EncloseArgWithQuotes {
        Param (
            [string]$arg_value
        )
        if (!($arg_value)) {
            return ""
        }

        $arrayed_value = $arg_value -split ","
        if ($arrayed_value.Length -eq 1) {
            return $arrayed_value
        }
        for ($i = 0; $i -lt $arrayed_value.Count; $i++) {
            $temp_val = $arrayed_value[$i]
            if ($temp_val[0] -ne '"') {
                $arrayed_value[$i] = '"' + $arrayed_value[$i].Trim() + '"'
            }
        }

        $return_value = $arrayed_value -join ","

        return $return_value

        <#
        .DESCRIPTION
        Encloses the value of an argument with double quotes and trim it. In the case it's a CSV value
        it will do that for every value in the list.

        .PARAMETER arg_value
        The raw value of the argument.

        .EXAMPLE
        EncloseArgWithQuotes("a,b,c") -> "a","b","c"
        EncloseArgWithQuotes("a, b,c ") -> "a","b","c"
        EncloseArgWithQuotes("\"a\",b,c") -> "a","b","c"
        EncloseArgWithQuotes("") -> ""
        EncloseArgWithQuotes -> ""
        #>
    }

    class ExchangeOnlinePowershellV2Client {
        [string]$url
        [System.Security.Cryptography.X509Certificates.X509Certificate2]$certificate
        [string]$organization
        [string]$app_id
        [SecureString]$password
        ExchangeOnlinePowershellV2Client(
            [string]$url,
            [string]$app_id,
            [string]$organization,
            [string]$certificate,
            [SecureString]$password
        ) {
            $this.url = $url
            try {
                $ByteArray = [System.Convert]::FromBase64String($certificate)
            }
            catch {
                throw "Could not decode the certificate. Try to re-enter it"
            }
            $this.certificate = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new($ByteArray, $password)

            $this.organization = $organization
            $this.app_id = $app_id
        }
        CreateSession() {
            $cmd_params = @{
                "AppID"        = $this.app_id
                "Organization" = $this.organization
                "Certificate"  = $this.certificate
            }
            Connect-ExchangeOnline @cmd_params -CommandName Get-SafeLinksPolicy,New-SafeLinksPolicy,Set-SafeLinksPolicy,Remove-SafeLinksPolicy,Get-SafeLinksRule,New-SafeLinksRule,Set-SafeLinksRule,Get-SafeLinksDetailReport,Get-SafeLinksAggregateReport,Get-AtpPolicyForO365,Set-AtpPolicyForO365 -ShowBanner:$false -WarningAction:SilentlyContinue | Out-Null
        }
        DisconnectSession() {
            Disconnect-ExchangeOnline -Confirm:$false -WarningAction:SilentlyContinue -InformationAction:Ignore | Out-Null
        }

        [PSObject]
        GetPolicyList(
            [string]$identity
        ) {
            try
            {
                $cmd_params = @{ }
                if ($identity)
                {
                    $cmd_params.Identity = $identity
                }
                $this.CreateSession()
                $results = Get-SafeLinksPolicy @cmd_params
                return $results
            }
            finally {
                $this.DisconnectSession()
            }

            <#
            .DESCRIPTION
            Use this cmdlet to view Safe Links policies in your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .PARAMETER identity
            The Identity parameter specifies the Safe Links policy that you want to view.

            You can use any value that uniquely identifies the policy. For example:
            * Name
            * Distinguished name (DN)
            * GUID

            .EXAMPLE
            GetPolicyList("1254y894-feae-9yn7-a3e1-f2483a154tft")

            .OUTPUTS
            PSObject - Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/get-safelinkspolicy?view=exchange-ps
            #>
        }

        [PSObject]
        CreateUpdatePolicy(
            [string]$command_type,
            [hashtable]$kwargs
        ) {
            try
            {
                $cmd_params = @{
                Name = $kwargs.name
                }
                if ($kwargs.admin_display_name) {
                    $cmd_params.AdminDisplayName = $kwargs.admin_display_name
                }
                if ($kwargs.custom_notification_text) {
                    $cmd_params.CustomNotificationText = $kwargs.custom_notification_text
                }
                if ($kwargs.deliver_message_after_scan) {
                    $cmd_params.DeliverMessageAfterScan = ConvertTo-Boolean $kwargs.deliver_message_after_scan
                }
                if ($kwargs.do_not_allow_click_through) {
                    $cmd_params.DoNotAllowClickThrough = ConvertTo-Boolean $kwargs.do_not_allow_click_through
                }
                if ($kwargs.do_not_rewrite_urls) {
                    $cmd_params.DoNotRewriteUrls = EncloseArgWithQuotes($kwargs.do_not_rewrite_urls)
                }
                if ($kwargs.do_not_track_user_clicks) {
                    $cmd_params.DoNotTrackUserClicks = ConvertTo-Boolean $kwargs.do_not_track_user_clicks
                }
                if ($kwargs.enable_for_internal_senders) {
                    $cmd_params.EnableForInternalSenders = ConvertTo-Boolean $kwargs.enable_for_internal_senders
                }
                if ($kwargs.enable_organization_branding) {
                    $cmd_params.EnableOrganizationBranding = ConvertTo-Boolean $kwargs.enable_organization_branding
                }
                if ($kwargs.enable_safe_links_for_teams) {
                    $cmd_params.EnableSafeLinksForTeams = ConvertTo-Boolean $kwargs.enable_safe_links_for_teams
                }
                if ($kwargs.is_enabled) {
                    $cmd_params.IsEnabled = ConvertTo-Boolean $kwargs.is_enabled
                }
                if ($kwargs.scan_urls) {
                    $cmd_params.ScanUrls = ConvertTo-Boolean $kwargs.scan_urls
                }
                if ($kwargs.use_translated_notification_text) {
                    $cmd_params.UseTranslatedNotificationText = ConvertTo-Boolean $kwargs.use_translated_notification_text
                }

                $this.CreateSession()

                if ($command_type -eq "create") {
                    $results = New-SafeLinksPolicy @cmd_params
                }
                else {
                    $results = Set-SafeLinksPolicy @cmd_params
                }
                return $results
            }
            finally
            {
                $this.DisconnectSession()
            }

            <#
            .DESCRIPTION
            Use this cmdlet to create or update Safe Links policies in your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .EXAMPLE
            CreateUpdatePolicy("1254y894-feae-9yn7-a3e1-f2483a154tft")

            .OUTPUTS
            PSObject - Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/new-safelinkspolicy?view=exchange-ps
            https://docs.microsoft.com/en-us/powershell/module/exchange/set-safelinkspolicy?view=exchange-ps
            #>
        }

        RemovePolicy([string]$identity) {

            try
            {
                $this.CreateSession()
                Remove-SafeLinksPolicy -Identity $identity -Confirm:$false -WarningAction:SilentlyContinue > $null
            }

            finally
            {
                $this.DisconnectSession()
            }


            <#
            .DESCRIPTION
            Use this cmdlet to remove Safe Links policies from your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .PARAMETER identity
            The Identity parameter specifies the Safe Links policy that you want to remove.

            You can use any value that uniquely identifies the policy. For example:
            * Name
            * Distinguished name (DN)
            * GUID

            .EXAMPLE
            RemovePolicy("1254y894-feae-9yn7-a3e1-f2483a154tft")

            .OUTPUTS
            PSObject - Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/remove-safelinkspolicy?view=exchange-ps
            #>
        }

        [PSObject]
        GetRules(
            [string]$identity,
            [string]$state
        ) {
            try
            {
                $cmd_params = @{ }
                if ($identity) {
                    $cmd_params.Identity = $identity
                }
                if ($state) {
                    $cmd_params.State = $state
                }
                $this.CreateSession()
                $results = Get-SafeLinksRule @cmd_params

                return $results

            }
            finally
            {
                $this.DisconnectSession()
            }

            <#
            .DESCRIPTION
            Use this cmdlet to view Safe Links rules in your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .PARAMETER identity
            The Identity parameter specifies the Safe Links rule that you want to view.

            You can use any value that uniquely identifies the policy. For example:
            * Name
            * Distinguished name (DN)
            * GUID

            .EXAMPLE
            GetRules("1254y894-feae-9yn7-a3e1-f2483a154tft")

            .OUTPUTS
             PSObject- Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/get-safelinksrule?view=exchange-ps
            #>
        }

        [PSObject]
        CreateUpdateRule(
            [string]$command_type,
            [hashtable]$kwargs
        ) {
            try {
                $cmd_params = @{
                Name = $kwargs.name
                }

                if ($kwargs.safe_links_policy) {
                    $cmd_params.SafeLinksPolicy = $kwargs.safe_links_policy
                }
                if ($kwargs.comments) {
                    $cmd_params.Comments = $kwargs.comments
                }
                if ($kwargs.enabled) {
                    $cmd_params.Enabled = ConvertTo-Boolean $kwargs.enabled
                }
                if ($kwargs.except_if_recipient_domain_is) {
                    $cmd_params.ExceptIfRecipientDomainIs = $kwargs.except_if_recipient_domain_is
                }
                if ($kwargs.except_if_sent_to) {
                    $cmd_params.ExceptIfSentTo = EncloseArgWithQuotes($kwargs.except_if_sent_to)
                }
                if ($kwargs.except_if_sent_to_member_of) {
                    $cmd_params.ExceptIfSentToMemberOf = $kwargs.except_if_sent_to_member_of
                }
                if ($kwargs.priority) {
                    $cmd_params.Priority = $kwargs.priority -as [Int32]
                }
                if ($kwargs.recipient_domain_is) {
                    $cmd_params.RecipientDomainIs = EncloseArgWithQuotes($kwargs.recipient_domain_is)
                }
                if ($kwargs.sent_to) {
                    $cmd_params.SentTo =  EncloseArgWithQuotes($kwargs.sent_to)
                }
                if ($kwargs.sent_to_member_of) {
                    $cmd_params.SentToMemberOf = EncloseArgWithQuotes($kwargs.sent_to_member_of)
                }

                $this.CreateSession()

                if ($command_type -eq "create") {
                    $results = New-SafeLinksRule @cmd_params
                }
                else {
                    $results = Set-SafeLinksRule @cmd_params
                }
                return $results
            }
            finally {
                $this.DisconnectSession()
            }

            <#
            .DESCRIPTION
            Use this cmdlet to create or update Safe Links rules in your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .EXAMPLE
            CreateUpdatePolicy("1254y894-feae-9yn7-a3e1-f2483a154tft")

            .OUTPUTS
            PSObject - Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/new-safelinksrule?view=exchange-ps
            https://docs.microsoft.com/en-us/powershell/module/exchange/set-safelinksrule?view=exchange-ps
            #>
        }
        [PSObject]
        GetSafeLinksDetailReport(
            [hashtable]$kwargs
        ) {
            try
            {
                $cmd_params = @{
                    "StartDate" = $kwargs.start_date
                    "EndDate" = $kwargs.end_date
                }
                if ($kwargs.domain) {
                    $cmd_params.Domain = $kwargs.domain
                }
                if ($kwargs.app_names) {
                    $cmd_params.AppNameList = ArgToList($kwargs.app_names)
                }
                if ($kwargs.action) {
                    $cmd_params.Action = $kwargs.action
                }
                if ($kwargs.recipient_address) {
                    $cmd_params.RecipientAddress = ArgToList($kwargs.recipient_address)
                }
                if ($kwargs.page) {
                    $cmd_params.Page = [int]$kwargs.page
                }
                if ($kwargs.page_size) {
                    $cmd_params.PageSize = [int]$kwargs.page_size
                }

                $this.CreateSession()
                $results = Get-SafeLinksDetailReport @cmd_params

                return $results

            }
            finally
            {
                $this.DisconnectSession()
            }

            <#
            .DESCRIPTION
            Use this cmdlet to view Safe Links report in your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .OUTPUTS
            PSObject- Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/get-safelinksdetailreport?view=exchange-ps
            #>
        }
        [PSObject]
        GetSafeLinksAggregateReport(
            [hashtable]$kwargs
        ) {
            try
            {
                $cmd_params = @{
                    "StartDate" = $kwargs.start_date
                    "EndDate" = $kwargs.end_date
                }
                if ($kwargs.app_names) {
                    $cmd_params.AppNameList = ArgToList($kwargs.app_names)
                }
                if ($kwargs.action) {
                    $cmd_params.Action = $kwargs.action
                }
                if ($kwargs.summerize_by) {
                    $cmd_params.SummarizeBy = $kwargs.summerize_by
                }

                $this.CreateSession()
                $results = Get-SafeLinksAggregateReport @cmd_params

                return $results

            }
            finally
            {
                $this.DisconnectSession()
            }

            <#
            .DESCRIPTION
            Use this cmdlet to view Safe Links report in your cloud-based organization.
            This cmdlet is available only in the cloud-based service.

            .OUTPUTS
            PSObject- Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/get-safelinksaggregatereport?view=exchange-ps
            #>
        }
        [PSObject]
        GetAtpPolicy() {
            try{
                $this.CreateSession()
                $results = Get-AtpPolicyForO365
                return $results
            }
            finally {
                $this.DisconnectSession()
            }
            <#
            .DESCRIPTION
            Use this cmdlet to get the ATP policy.

            .OUTPUTS
            PSObject- Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/get-atppolicyforo365
            #>
        }
        [PSObject]
        SetAtpPolicy(
            [hashtable]$kwargs
        ) {
            try{
                $cmd_params = @{}
                if ($kwargs.allow_safe_docs_open) {
                    $cmd_params.AllowSafeDocsOpen = ConvertTo-Boolean $kwargs.allow_safe_docs_open
                }
                if ($kwargs.enable_atp_spo_teams_odb) {
                    $cmd_params.EnableATPForSPOTeamsODB = ConvertTo-Boolean $kwargs.enable_atp_spo_teams_odb
                }
                if ($kwargs.enable_safe_docs) {
                    $cmd_params.EnableSafeDocs = ConvertTo-Boolean $kwargs.enable_safe_docs
                }
                $this.CreateSession()
                $results = Set-AtpPolicyForO365 @cmd_params
                return $results
            }
            finally {
                $this.DisconnectSession()
            }
            <#
            .DESCRIPTION
            Use this cmdlet to set the ATP policy.

            .OUTPUTS
            PSObject- Raw response

            .LINK
            https://docs.microsoft.com/en-us/powershell/module/exchange/set-atppolicyforo365
            #>
        }
    }


    function GetPolicyListCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [hashtable]$kwargs
        )
        $raw_response = $client.GetPolicyList($kwargs.identity)
        if (!$raw_response){
            return "#### No policies were found.", @{}, @{}
        }

        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.Policy(obj.Guid === val.Guid)" = $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function CreateUpdatePolicyCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [Parameter(Mandatory)][string]$command_type,
            [hashtable]$kwargs
        )
        $raw_response = $client.CreateUpdatePolicy(
            $command_type,
            $kwargs
        )
        if (!$raw_response){
            return "#### The policy was not ${command_type}d successfully.", @{}, @{}
        }

        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.Policy(obj.Guid === val.Guid)" = $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function RemovePolicyCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [hashtable]$kwargs
        )
        $identity = $kwargs.identity
        $client.RemovePolicy($identity)
        $human_readable = "#### Policy with Identity: ${identity} was removed successfully."
        return $human_readable, $null, $null
    }

    function GetRulesCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [hashtable]$kwargs
        )
        $identity = $kwargs.identity
        $raw_response = $client.GetRules($identity, $kwargs.state)

        if (!$raw_response){
            return "#### No rules were found.", @{}, @{}
        }

        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.Rule(obj.Guid === val.Guid)" = $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function CreateUpdateRuleCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [Parameter(Mandatory)][string]$command_type,
            [hashtable]$kwargs
        )

        $raw_response = $client.CreateUpdateRule(
            $command_type,
            $kwargs
        )
        if (!$raw_response){
            return "#### The rule was not ${command_type}d successfully.", @{}, @{}
        }

        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.Policy(obj.Guid === val.Guid)" = $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function GetDetailedReportCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [hashtable]$kwargs
        )

        $raw_response = $client.GetSafeLinksDetailReport($kwargs)
        if (!$raw_response){
            return "#### No records were found.", @{}, @{}
        }

        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.DetailedReport" = CreateContextForReport $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function GetAggregateReportCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [hashtable]$kwargs
        )

        $raw_response = $client.GetSafeLinksAggregateReport($kwargs)
        if (!$raw_response){
            return "#### No records were found.", @{}, @{}
        }

        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.AggregateReport" = CreateContextForReport $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function GetAtpPolicyCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client
        )

        $raw_response = $client.GetAtpPolicy()
        if (!$raw_response){
            return "#### No records were found.", @{}, @{}
        }
        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.AtpPolicy(obj.Guid === val.Guid)" = $raw_response }
        return $human_readable, $entry_context, $raw_response

    }

    function SetAtpPolicyCommand {
        [CmdletBinding()]
        [OutputType([System.Object[]])]
        Param (
            [Parameter(Mandatory)][ExchangeOnlinePowershellV2Client]$client,
            [hashtable]$kwargs
        )

        $raw_response = $client.SetAtpPolicy($kwargs)
        if (!$raw_response){
            return "#### SetAtpPolicyCommand finished with no output.", @{}, @{}
        }
        $human_readable = TableToMarkdown $raw_response "Results of $command"
        $entry_context = @{ "$script:INTEGRATION_ENTRY_CONTEXT.AtpPolicy(obj.Guid === val.Guid)" = $raw_response }
        return $human_readable, $entry_context, $raw_response
    }

    function TestModuleCommand($client) {
        try {
            $client.CreateSession()
            $demisto.results("ok")
        }
        finally {
            $client.DisconnectSession()
        }

    }

    function Main {
        [Diagnostics.CodeAnalysis.SuppressMessageAttribute('PSAvoidUsingConvertToSecureStringWithPlainText', '')]
        param()
        $command = $demisto.GetCommand()
        $command_arguments = $demisto.Args()
        $integration_params = [Hashtable] $demisto.Params()

        if ($integration_params.certificate.password) {
            $password = ConvertTo-SecureString $integration_params.certificate.password -AsPlainText -Force
        }
        else {
            $password = $null
        }

        $exo_client = [ExchangeOnlinePowershellV2Client]::new(
            $integration_params.url,
            $integration_params.app_id,
            $integration_params.organization,
            $integration_params.certificate.identifier,
            $password
        )
        try {
            # Executing command
            $Demisto.Debug("Command being called is $command")
            switch ($command) {
                "test-module" {
                    ($human_readable, $entry_context, $raw_response) = TestModuleCommand $exo_client
                }
                "$script:COMMAND_PREFIX-policy-list" {
                    ($human_readable, $entry_context, $raw_response) = GetPolicyListCommand -client $exo_client -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-policy-create" {
                    ($human_readable, $entry_context, $raw_response) = CreateUpdatePolicyCommand -client $exo_client "create" -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-policy-update" {
                    ($human_readable, $entry_context, $raw_response) = CreateUpdatePolicyCommand -client $exo_client "update" -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-policy-remove" {
                    ($human_readable, $entry_context, $raw_response) = RemovePolicyCommand -client $exo_client -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-rule-list" {
                    ($human_readable, $entry_context, $raw_response) = GetRulesCommand -client $exo_client -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-rule-create" {
                    ($human_readable, $entry_context, $raw_response) = CreateUpdateRuleCommand -client $exo_client -command_type "create" -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-rule-update" {
                    ($human_readable, $entry_context, $raw_response) = CreateUpdateRuleCommand -client $exo_client -command_type "update" -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-detailed-report-get" {
                    ($human_readable, $entry_context, $raw_response) = GetDetailedReportCommand -client $exo_client -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-aggregate-report-get" {
                    ($human_readable, $entry_context, $raw_response) = GetAggregateReportCommand -client $exo_client -kwargs $command_arguments
                }
                "$script:COMMAND_PREFIX-atp-policy-get" {
                    ($human_readable, $entry_context, $raw_response) = GetAtpPolicyCommand -client $exo_client
                }
                "$script:COMMAND_PREFIX-atp-policy-set" {
                    ($human_readable, $entry_context, $raw_response) = SetAtpPolicyCommand -client $exo_client -kwargs $command_arguments
                }

                default {
                    ReturnError "Could not recognize $command"
                }
            }
            # Return results to Demisto Server
            ReturnOutputs $human_readable $entry_context $raw_response
        }
        catch {
            $Demisto.debug("Integration: $script:INTEGRATION_NAME
            Command: $command
            Arguments: $($command_arguments | ConvertTo-Json)
            Error: $($_.Exception.Message)")
            if ($command -ne "test-module") {
                ReturnError "Error:
                Integration: $script:INTEGRATION_NAME
                Command: $command
                Arguments: $($command_arguments | ConvertTo-Json)
                Error: $($_.Exception)" | Out-Null
            }
            else {
                ReturnError $_.Exception.Message
            }
        }
    }

    # Execute Main when not in Tests
    if ($MyInvocation.ScriptName -notlike "*.tests.ps1" -AND -NOT $Test) {
        Main
    }
  type: powershell
system: true
