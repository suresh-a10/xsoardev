contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.5.0
    itemVersion: 4.3.12
    packID: PrismaCloud
    packName: Prisma Cloud by Palo Alto Networks
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: |
  This playbook remediates Prisma Cloud Azure AKS alerts.  It calls sub-playbooks that perform the actual remediation steps.

  Remediation:
  - Azure AKS cluster monitoring not enabled
  - Azure AKS cluster HTTP application routing enabled
id: Prisma Cloud Remediation - Azure AKS Misconfiguration v2
inputs:
- description: Grab the Prisma Cloud policy ID.
  key: policyId
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: labels.policy
      root: incident
      transformers:
      - operator: ParseJSON
      - args:
          field:
            value:
              simple: policyId
        operator: getField
- description: Execute Azure AKS remediation automatically?
  key: AutoRemediateAzureAKS
  playbookInputQuery: null
  required: false
  value:
    simple: "no"
name: Prisma Cloud Remediation - Azure AKS Misconfiguration v2
outputs:
- contextPath: incident.labels.resource.name
  description: AKS cluster name.
  type: string
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 61bee172-14d4-4a48-815c-913b49bef800
      iscommand: false
      name: ""
      version: -1
    taskid: 61bee172-14d4-4a48-815c-913b49bef800
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 630,
          "y": 0
        }
      }
  "2":
    continueonerrortype: ""
    id: "2"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "3"
      "yes":
      - "4"
    note: false
    quietmode: 0
    scriptarguments:
      brandname:
        simple: Azure Kubernetes Services
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      id: 792a6a96-0d68-4feb-80cb-beabe2d48df9
      iscommand: false
      name: Is Azure Kubernetes Services integration enabled?
      script: IsIntegrationAvailable
      type: condition
      version: -1
    taskid: 792a6a96-0d68-4feb-80cb-beabe2d48df9
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 630,
          "y": 140
        }
      }
  "3":
    continueonerrortype: ""
    id: "3"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 1abd9220-e39e-4206-8aa3-dba2695c7f4e
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: 1abd9220-e39e-4206-8aa3-dba2695c7f4e
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 630,
          "y": 1670
        }
      }
  "4":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.policyId
          operator: isNotEmpty
      label: "yes"
    continueonerrortype: ""
    id: "4"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "8"
      "yes":
      - "5"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks for a Prisma Cloud policy Id.
      id: 7b8af710-d3f1-47db-8ed0-13cd281e5fcf
      iscommand: false
      name: Is there a policy to remediate?
      type: condition
      version: -1
    taskid: 7b8af710-d3f1-47db-8ed0-13cd281e5fcf
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 350,
          "y": 310
        }
      }
  "5":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.AutoRemediateAzureAKS
                transformers:
                - operator: toLowerCase
          operator: isEqualString
          right:
            value:
              simple: "yes"
      label: "yes"
    continueonerrortype: ""
    id: "5"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "7"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Auto remediate?
      id: 223581df-ba64-4269-8106-bb59ee39ff7a
      iscommand: false
      name: Update AKS automatically?
      type: condition
      version: -1
    taskid: 223581df-ba64-4269-8106-bb59ee39ff7a
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -200,
          "y": 480
        }
      }
  "6":
    continueonerrortype: ""
    id: "6"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    message:
      bcc: null
      body:
        simple: ${incident.id} Autoremediate?
      cc: null
      format: ""
      methods: []
      replyOptions:
      - "Yes"
      - "No"
      subject: null
      timings:
        completeafterreplies: 1
        completeaftersla: false
        completeafterv2: false
        retriescount: 2
        retriesinterval: 360
      to: null
    nexttasks:
      '#default#':
      - "8"
      "Yes":
      - "7"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Remediate automatically or manually update?
      id: 010afabc-1338-4af0-8e6f-73669e94dae7
      iscommand: false
      name: Auto remediate?
      type: condition
      version: -1
    taskid: 010afabc-1338-4af0-8e6f-73669e94dae7
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 90,
          "y": 650
        }
      }
  "7":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                root: inputs.policyId
          operator: isEqualString
          right:
            value:
              simple: be55c11a-981a-4f34-a2e7-81ce40d71aa5
        - left:
            iscontext: true
            value:
              complex:
                root: inputs.policyId
          operator: isEqualString
          right:
            value:
              simple: 0429670c-5d2d-4d0f-ab33-59eb5e000305
      label: cluster
    continueonerrortype: ""
    id: "7"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "8"
      cluster:
      - "15"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Execute the appropriate remediation sub-playbook based on the Prisma
        Cloud policy Id.
      id: 7fda9780-599c-4ed2-81ab-6a595e1f285c
      iscommand: false
      name: Execute playbook
      type: condition
      version: -1
    taskid: 7fda9780-599c-4ed2-81ab-6a595e1f285c
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -200,
          "y": 820
        }
      }
  "8":
    continueonerrortype: ""
    id: "8"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "11"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        1. Sign in to the Azure portal.
        2. Goto the Kubernetes Service and select your cluster.
        3. Click Insights in the left window pane.
        4. If you have an existing Log Analytics workspace in the same subscription as the cluster, select it in the drop-down list.
        5. Select Enable.
      id: 1d094fa9-2603-45c3-8869-af2e0194da65
      iscommand: false
      name: Manually update AKS
      type: regular
      version: -1
    taskid: 1d094fa9-2603-45c3-8869-af2e0194da65
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 350,
          "y": 990
        }
      }
  "9":
    continueonerrortype: ""
    id: "9"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "3"
    note: false
    quietmode: 0
    scriptarguments:
      id:
        complex:
          accessor: id
          root: incident
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Close the current incident.
      id: c3d736e6-e9ab-4cfc-8ed0-7276f754c074
      iscommand: true
      name: Close investigation
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: c3d736e6-e9ab-4cfc-8ed0-7276f754c074
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 350,
          "y": 1500
        }
      }
  "11":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: brand
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: PrismaCloud v2
                - - left:
                      iscontext: true
                      value:
                        simple: modules.state
                    operator: isEqualString
                    right:
                      value:
                        simple: active
                root: modules
          operator: isExists
      label: "yes"
    continueonerror: true
    continueonerrortype: ""
    id: "11"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "14"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: PrismaCloud v2
      description: Is Prisma Cloud v2 integration enabled?
      id: edf547ca-7606-4d2b-8c3c-fc5cb0348c6e
      iscommand: false
      name: Is Prisma Cloud v2 integration enabled?
      type: condition
      version: -1
    taskid: edf547ca-7606-4d2b-8c3c-fc5cb0348c6e
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 350,
          "y": 1160
        }
      }
  "14":
    continueonerror: true
    continueonerrortype: ""
    id: "14"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "9"
    note: false
    quietmode: 0
    scriptarguments:
      alert_ids:
        complex:
          accessor: labels
          root: incident
          transformers:
          - args:
              field:
                value:
                  simple: id
            operator: getField
      dismissal_note:
        simple: ${incident.labels.id} has been remediated by Cortex XSOAR.
    separatecontext: false
    skipunavailable: true
    task:
      brand: PrismaCloud v2
      description: Dismiss the alerts matching the given filter. Must provide either
        policy IDs or alert IDs.
      id: 5eb90a78-eb8e-4c19-8e15-d4fbacae6996
      iscommand: true
      name: Dismiss Prisma Cloud alert
      script: PrismaCloud v2|||redlock-dismiss-alerts
      type: regular
      version: -1
    taskid: 5eb90a78-eb8e-4c19-8e15-d4fbacae6996
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 110,
          "y": 1330
        }
      }
  "15":
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "11"
    note: false
    quietmode: 0
    scriptarguments:
      policyId:
        complex:
          root: inputs.policyId
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: |-
        This playbook remediates the following Prisma Cloud Azure AKS cluster alerts.

        Prisma Cloud policies remediated:

        - Azure AKS cluster monitoring not enabled
        - Azure AKS cluster HTTP application routing enabled
      id: 8290524b-0b84-4298-8939-20bba38caadf
      iscommand: false
      name: Prisma Cloud Remediation - Azure AKS Cluster Misconfiguration
      playbookId: Prisma Cloud Remediation - Azure AKS Cluster Misconfiguration
      type: playbook
      version: -1
    taskid: 8290524b-0b84-4298-8939-20bba38caadf
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -480,
          "y": 990
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "11_14_yes": 0.61,
      "11_9_#default#": 0.53,
      "2_3_#default#": 0.2,
      "2_4_yes": 0.52,
      "4_5_yes": 0.3,
      "4_8_#default#": 0.22,
      "5_6_#default#": 0.55,
      "5_7_yes": 0.46,
      "6_7_Yes": 0.46,
      "6_8_#default#": 0.35,
      "7_15_cluster": 0.58,
      "7_8_#default#": 0.24
    },
    "paper": {
      "dimensions": {
        "height": 1735,
        "width": 1490,
        "x": -480,
        "y": 0
      }
    }
  }
