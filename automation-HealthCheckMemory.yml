args:
- auto: PREDEFINED
  defaultValue: "True"
  description: Define if that in Widget Context or analyse data.
  name: isWidget
  predefined:
  - "True"
  - "False"
comment: Present or analyze memory usage.
commonfields:
  id: HealthCheckMemory
  version: -1
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.0.0
    itemVersion: 2.1.3
    packID: HealthCheck
    packName: System Diagnostics and Health Check
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
dockerimage: demisto/python3:3.10.13.83255
enabled: true
engineinfo: {}
mainengineinfo: {}
name: HealthCheckMemory
pswd: ""
runas: DBotWeakRole
runonce: false
script: |
  register_module_line('HealthCheckMemory', 'start', __line__())
  demisto.debug('pack name = System Diagnostics and Health Check, pack version = 2.1.3')




  RESOLUTION = ["Performance Tuning of Cortex XSOAR Server: https://docs.paloaltonetworks.com/cortex/cortex-xsoar/6-0/"
                "cortex-xsoar-admin/cortex-xsoar-overview/performance-tuning-of-cortex-xsoar-server"]


  def analyzeData(res):

      lowFound = 0
      medFound = 0
      lowRes = False
      medRes = False
      highRes = False

      for item in res:
          if not lowRes:
              if item['data'][0] >= 70:
                  lowFound += 1
                  if lowFound >= 30:
                      lowRes = True
              else:
                  lowFound = 0

          if not medRes:
              if item['data'][0] >= 80:
                  medFound += 1
                  if medFound >= 10:
                      medRes = True
              else:
                  medFound = 0

          if not highRes and item['data'][0] >= 90:
              highRes = True
      if lowRes or medRes or highRes:
          addActions = []

          if highRes:
              addActions.append({'category': 'Memory analysis', 'severity': 'High',
                                 'description': "Memory has reached 90%", "resolution": f"{RESOLUTION[0]}"})

          if medRes:
              addActions.append({'category': 'Memory analysis', 'severity': 'Medium',
                                 'description': "Memory has reached 80% for 10 minutes", "resolution": f"{RESOLUTION[0]}"})

          if lowRes:
              addActions.append({'category': 'Memory analysis', 'severity': 'Low',
                                 'description': "Memory has reached 70% for 30 minutes", "resolution": f"{RESOLUTION[0]}"})
          return addActions
      else:
          return None


  # Main
  incident = demisto.incidents()[0]
  accountName = incident.get('account')
  accountName = f"acc_{accountName}/" if accountName != "" else ""

  args = demisto.args()
  isWidget = argToBoolean(args.get('isWidget', True))
  stats = demisto.executeCommand(
      "core-api-post",
      {
          "uri": f"{accountName}/statistics/widgets/query",
          "body": {
              "size": 1440,
              "dataType": "system",
              "params": {
                  "timeFrame": "minutes",
                  "format": "HH:mm",
              },
              "query": "memory.usedPercent",
              "dateRange": {
                  "period": {
                      "byFrom": "hours",
                      "fromValue": 24
                  }
              },
              "widgetType": "line"
          }
      })

  res = stats[0]["Contents"]["response"]
  output = []
  counter = 0
  higher = 0

  if isWidget is True:
      ctx = demisto.context()
      dataFromCtx = ctx.get("widgets")
      if not dataFromCtx:
          for entry in res:
              higher = max(entry["data"][0], higher)
              if counter % 2 == 0:
                  output.append({"name": counter, "data": [higher]})
                  higher = 0
              counter += 1

          data = {
              "Type": 17,
              "ContentsFormat": "line",
              "Contents": {
                  "stats": output,
                  "params": {
                      "timeFrame": "minutes",
                      "format": "HH:mm",
                      "layout": "vertical"
                  }
              }
          }
          demisto.results(data)
      else:
          data = {
              "Type": 17,
              "ContentsFormat": "line",
              "Contents": {
                  "stats": dataFromCtx['MemoryUsage'],
                  "params": {
                      "timeFrame": "minutes",
                      "format": "HH:mm",
                      "layout": "vertical"
                  }
              }
          }
          demisto.results(data)
  else:
      addActions = analyzeData(res)

      results = CommandResults(
          readable_output="analyzeCPUUsage Done",
          outputs_prefix="HealthCheck.ActionableItems",
          outputs=addActions)

      return_results(results)

  register_module_line('HealthCheckMemory', 'end', __line__())
scripttarget: 0
subtype: python3
system: true
tags:
- widget
- dynamic-section
type: python
