contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.0.0
    itemVersion: 1.10.54
    packID: ExpanseV2
    packName: Cortex Xpanse by Palo Alto Networks
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: |
  Subplaybook for bringing rogue cloud accounts under management.
id: Expanse Unmanaged Cloud
inputs:
- description: The Expanse Issue ID associated with the incident
  key: ExpanseCloudManagedIssueId
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: expanseissueid}
      root: ${incident
- description: The IP associated with an Expanse Issue
  key: ExpanseCloudManagedIPv4
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: ip}
      root: ${incident.labels
- description: Email body to send to potential owner
  key: ExpanseCloudManagedEmailBody
  playbookInputQuery: null
  required: false
  value:
    simple: "Infosec has identified a security issue on a cloud service we believe
      may belong to you or your team. This asset or service does not appear to be
      behind proper compliance controls. \n\nPlease get in touch with your Infosec
      team to define proper remediation access."
name: Expanse Unmanaged Cloud
outputs: []
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "8"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 2ec43d18-a2c3-4a9f-801f-7d58c2f13052
      iscommand: false
      name: ""
      version: -1
    taskid: 2ec43d18-a2c3-4a9f-801f-7d58c2f13052
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 450,
          "y": 50
        }
      }
  "1":
    continueonerrortype: ""
    id: "1"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 966cfc74-e977-42b5-8c0d-324a24149d09
      iscommand: false
      name: Find Related Assets from Expanse
      type: title
      version: -1
    taskid: 966cfc74-e977-42b5-8c0d-324a24149d09
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -810,
          "y": 1210
        }
      }
  "2":
    continueonerrortype: ""
    id: "2"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "7"
    note: false
    quietmode: 0
    scriptarguments:
      inet_search:
        simple: ${inputs.ExpanseCloudManagedIPv4}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ExpanseV2
      description: Retrieve all Expanse services matching the supplied parameters.
      id: 9e2b6d27-d02a-4f38-8a6a-eed143a47722
      iscommand: true
      name: expanse-get-services
      script: ExpanseV2|||expanse-get-services
      type: regular
      version: -1
    taskid: 9e2b6d27-d02a-4f38-8a6a-eed143a47722
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -810,
          "y": 1360
        }
      }
  "3":
    continueonerrortype: ""
    id: "3"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "6"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        complex:
          accessor: domains
          root: Expanse.Service
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if a given value exists in the context. Will return 'no'
        for empty arrays. To be used mostly with DQ and selectors.
      id: e9c90fa5-0954-4431-8ec7-88b53ca53fec
      iscommand: false
      name: Was associated domain found?
      script: Exists
      type: condition
      version: -1
    taskid: e9c90fa5-0954-4431-8ec7-88b53ca53fec
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -1030,
          "y": 1705
        }
      }
  "4":
    continueonerrortype: ""
    id: "4"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "5"
      - "14"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        complex:
          accessor: md5Fingerprint
          root: Expanse.Service.certificates.certificate
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if a given value exists in the context. Will return 'no'
        for empty arrays. To be used mostly with DQ and selectors.
      id: 5a57b39e-8dfc-4811-8b70-c4b93f9b0536
      iscommand: false
      name: Was associated certificate found?
      script: Exists
      type: condition
      version: -1
    taskid: 5a57b39e-8dfc-4811-8b70-c4b93f9b0536
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -610,
          "y": 1705
        }
      }
  "5":
    continueonerrortype: ""
    id: "5"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "19"
    note: false
    quietmode: 0
    scriptarguments:
      certificate:
        complex:
          accessor: md5Fingerprint
          root: Expanse.Service.certificates.certificate
    separatecontext: false
    skipunavailable: false
    task:
      brand: ExpanseV2
      description: Provides data enrichment for an X509 Certificate from Expanse.
      id: 614f810f-10d8-457c-89fc-772eda0b8457
      iscommand: true
      name: Fetch Certificate
      script: ExpanseV2|||certificate
      type: regular
      version: -1
    taskid: 614f810f-10d8-457c-89fc-772eda0b8457
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -610,
          "y": 2020
        }
      }
  "6":
    continueonerrortype: ""
    id: "6"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "18"
    note: false
    quietmode: 0
    scriptarguments:
      domain:
        complex:
          accessor: domain
          root: Expanse.Service.domains
          transformers:
          - operator: FirstArrayElement
    separatecontext: false
    skipunavailable: false
    task:
      brand: ExpanseV2
      description: Provides data enrichment for domains.
      id: 0271cea7-5da9-4572-834f-4c169c970cab
      iscommand: true
      name: Fetch Domain
      script: ExpanseV2|||domain
      type: regular
      version: -1
    taskid: 0271cea7-5da9-4572-834f-4c169c970cab
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -1030,
          "y": 2020
        }
      }
  "7":
    continueonerrortype: ""
    id: "7"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "3"
      - "4"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        simple: ${Expanse.Service}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if a given value exists in the context. Will return 'no'
        for empty arrays. To be used mostly with DQ and selectors.
      id: 3de4838c-0e07-4bb8-8cf1-0982de9c844b
      iscommand: false
      name: Do Services Exist?
      script: Exists
      type: condition
      version: -1
    taskid: 3de4838c-0e07-4bb8-8cf1-0982de9c844b
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -810,
          "y": 1530
        }
      }
  "8":
    continueonerrortype: ""
    id: "8"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "10"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 6d99090b-9a10-4ffc-8408-10eabdd01fb9
      iscommand: false
      name: Is Asset Unmanaged?
      type: title
      version: -1
    taskid: 6d99090b-9a10-4ffc-8408-10eabdd01fb9
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 450,
          "y": 235
        }
      }
  "9":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: id
                root: Expanse.Issue.cloudManagementStatus
                transformers:
                - operator: FirstArrayElement
          operator: isEqualString
          right:
            value:
              simple: UnmanagedCloud
      label: "yes"
    continueonerrortype: ""
    id: "9"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "12"
      "yes":
      - "11"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: e994a279-bdf6-422a-8f1e-8b4197590f3c
      iscommand: false
      name: Is Incident Asset Unmanaged?
      type: condition
      version: -1
    taskid: e994a279-bdf6-422a-8f1e-8b4197590f3c
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 450,
          "y": 550
        }
      }
  "10":
    continueonerrortype: ""
    id: "10"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "9"
    note: false
    quietmode: 0
    scriptarguments:
      issue_id:
        simple: ${inputs.ExpanseCloudManagedIssueId}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ExpanseV2
      description: Retrieve Expanse issue by issue ID.
      id: aad784b8-2fdc-4cbc-8ef3-872fdff3e6db
      iscommand: true
      name: Fetch Issue From Expanse
      script: ExpanseV2|||expanse-get-issue
      type: regular
      version: -1
    taskid: aad784b8-2fdc-4cbc-8ef3-872fdff3e6db
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 450,
          "y": 385
        }
      }
  "11":
    continueonerrortype: ""
    id: "11"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "1"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 2b878eb8-725b-41cf-8591-03d1b7c7eab8
      iscommand: false
      name: Enrichment
      type: title
      version: -1
    taskid: 2b878eb8-725b-41cf-8591-03d1b7c7eab8
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -810,
          "y": 1070
        }
      }
  "12":
    continueonerrortype: ""
    id: "12"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: d725a3ff-dd03-471e-8bcf-60aa729185a0
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: d725a3ff-dd03-471e-8bcf-60aa729185a0
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 450,
          "y": 3550
        }
      }
  "14":
    continueonerrortype: ""
    evidencedata:
      customfields: {}
      description: {}
    id: "14"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "24"
    note: false
    quietmode: 0
    scriptarguments:
      columns:
        simple: subjectName,subjectAlternativeNames,subjectEmail,subjectOrg
      data:
        complex:
          accessor: certificate
          root: Expanse.Service.certificates
      title:
        simple: Related Certificates Subject Details
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Convert an array to a nice table display. Usually, from the context.
      id: 50be9179-755c-4633-811f-767407b702de
      iscommand: false
      name: Print Related Certificates
      script: ToTable
      type: regular
      version: -1
    taskid: 50be9179-755c-4633-811f-767407b702de
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -190,
          "y": 2390
        }
      }
  "15":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: subjectEmail
                root: Expanse.Service.certificates.certificate
          operator: isNotEmpty
      label: subjectEmail
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: email
                root: Expanse.Certificate.annotations.pointOfContact
          operator: isNotEmpty
      label: certificatePoC
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: email
                root: Expanse.Domain.annotations.pointOfContact
          operator: isNotEmpty
      label: domainPoC
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "23"
      certificatePoC:
      - "21"
      domainPoC:
      - "22"
      subjectEmail:
      - "20"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: ed47d70f-bede-4a5d-8194-b0e2798625aa
      iscommand: false
      name: Do Related Emails Exist?
      type: condition
      version: -1
    taskid: ed47d70f-bede-4a5d-8194-b0e2798625aa
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -610,
          "y": 2770
        }
      }
  "16":
    continueonerrortype: ""
    id: "16"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "24"
    note: false
    quietmode: 0
    scriptarguments:
      columns:
        simple: commonName,annotations.contact.email,providers.name
      data:
        simple: ${Expanse.Certificate}
      title:
        simple: Related Certificate Details
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Convert an array to a nice table display. Usually, from the context.
      id: 24039c66-2cee-4f0e-868a-8f2705a2662a
      iscommand: false
      name: Print Found Certificates
      script: ToTable
      type: regular
      version: -1
    taskid: 24039c66-2cee-4f0e-868a-8f2705a2662a
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -610,
          "y": 2390
        }
      }
  "17":
    continueonerrortype: ""
    id: "17"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "24"
    note: false
    quietmode: 0
    scriptarguments:
      columns:
        simple: domain, annotations.contact.email,providers.name
      data:
        simple: ${Expanse.Domain}
      title:
        simple: Related Domain Details
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Convert an array to a nice table display. Usually, from the context.
      id: 394df8b0-188b-4c81-8b8b-0498c064125d
      iscommand: false
      name: Print Found Domains
      script: ToTable
      type: regular
      version: -1
    taskid: 394df8b0-188b-4c81-8b8b-0498c064125d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -1030,
          "y": 2390
        }
      }
  "18":
    continueonerrortype: ""
    id: "18"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "17"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        simple: ${Expanse.Domain}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if a given value exists in the context. Will return 'no'
        for empty arrays. To be used mostly with DQ and selectors.
      id: 8133aacc-644b-473e-82ef-80c5e39e9281
      iscommand: false
      name: Domain Exists
      script: Exists
      type: condition
      version: -1
    taskid: 8133aacc-644b-473e-82ef-80c5e39e9281
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -1030,
          "y": 2210
        }
      }
  "19":
    continueonerrortype: ""
    id: "19"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "16"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        simple: ${Expanse.Certificate}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if a given value exists in the context. Will return 'no'
        for empty arrays. To be used mostly with DQ and selectors.
      id: 85f5f08c-6fed-4162-8f3d-479d857ff2d0
      iscommand: false
      name: Certificate Exists
      script: Exists
      type: condition
      version: -1
    taskid: 85f5f08c-6fed-4162-8f3d-479d857ff2d0
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -610,
          "y": 2210
        }
      }
  "20":
    continueonerror: true
    continueonerrortype: ""
    id: "20"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "23"
    note: false
    quietmode: 0
    scriptarguments:
      body:
        simple: ${inputs.ExpanseCloudManagedEmailBody}
      subject:
        simple: Security Issue on cloud asset - ${Expanse.Certificate}
      to:
        complex:
          accessor: subjectEmail
          root: Expanse.Service.certificates.certificate
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Send an email
      id: 2849ab02-f465-4024-8444-a45d144ff34d
      iscommand: true
      name: Send email to certificate Subject email
      script: '|||send-mail'
      type: regular
      version: -1
    taskid: 2849ab02-f465-4024-8444-a45d144ff34d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 40,
          "y": 2940
        }
      }
  "21":
    continueonerror: true
    continueonerrortype: ""
    id: "21"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "23"
    note: false
    quietmode: 0
    scriptarguments:
      body:
        simple: ${inputs.ExpanseCloudManagedEmailBody}
      subject:
        simple: Security Issue on cloud asset - ${Expanse.Certificate}
      to:
        complex:
          accessor: email
          root: Expanse.Certificate.annotations.pointOfContact
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Send an email
      id: 8fbeb774-464c-4fde-81d0-0ff44f384047
      iscommand: true
      name: Send email to certificate owner
      script: '|||send-mail'
      type: regular
      version: -1
    taskid: 8fbeb774-464c-4fde-81d0-0ff44f384047
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -390,
          "y": 2940
        }
      }
  "22":
    continueonerror: true
    continueonerrortype: ""
    id: "22"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "23"
    note: false
    quietmode: 0
    scriptarguments:
      body:
        simple: ${inputs.ExpanseCloudManagedEmailBody}
      subject:
        complex:
          accessor: domain}
          root: Security Issue on cloud asset - ${Expanse.Domain
      to:
        complex:
          accessor: email
          root: Expanse.Domain.annotations.pointOfContact
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Send an email
      id: 3ea1e331-fdb3-4845-8954-8406800df5be
      iscommand: true
      name: Send Email to domain owner
      script: '|||send-mail'
      type: regular
      version: -1
    taskid: 3ea1e331-fdb3-4845-8954-8406800df5be
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -1020,
          "y": 2940
        }
      }
  "23":
    continueonerrortype: ""
    id: "23"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "12"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    sla:
      days: 1
      hours: 0
      minutes: 0
      weeks: 0
    task:
      brand: ""
      id: 23b26c04-a623-45a0-8b88-6a15b3e3bc52
      iscommand: false
      name: Add Account to Prisma Cloud
      type: regular
      version: -1
    taskid: 23b26c04-a623-45a0-8b88-6a15b3e3bc52
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -610,
          "y": 3240
        }
      }
  "24":
    continueonerrortype: ""
    id: "24"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: dbd8c2b7-380f-400f-8fe0-c66e8fe848a1
      iscommand: false
      name: Notify Potential Owner
      type: title
      version: -1
    taskid: dbd8c2b7-380f-400f-8fe0-c66e8fe848a1
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -610,
          "y": 2590
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 3565,
        "width": 1860,
        "x": -1030,
        "y": 50
      }
    }
  }
