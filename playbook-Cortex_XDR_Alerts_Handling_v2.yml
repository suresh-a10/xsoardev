contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.5.0
    itemVersion: 6.1.65
    packID: CortexXDR
    packName: Cortex XDR by Palo Alto Networks
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: "This playbook is used to loop over every alert in a Cortex XDR incident.
  \nSupported alert categories:\n- Malware\n- Port Scan\n- Cloud Cryptojacking\n-
  Cloud Token Theft\n- RDP Brute-Force\n- First SSO Access\n- Cloud IAM User Access
  Investigation\n- Identity Analytics\n- Malicious Pod."
id: Cortex XDR Alerts Handling v2
inputs:
- description: Incident ID.
  key: incident_id
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: Incident.incident_id
      root: PaloAltoNetworksXDR
- description: Alert ID.
  key: alert_id
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: alert_id
      root: PaloAltoNetworksXDR.Incident.alerts
- description: 'A list of IP ranges to check the IP against. The list should be provided
    in CIDR notation, separated by commas. An example of a list of ranges would be:
    "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16" (without quotes). If a list is not provided,
    will use default list provided in the IsIPInRanges script (the known IPv4 private
    address ranges).'
  key: InternalIPRanges
  playbookInputQuery: null
  required: false
  value:
    complex:
      accessor: PrivateIPs
      root: lists
      transformers:
      - args:
          action_dt: {}
          ignore_case: {}
          multi_line: {}
          output_format: {}
          period_matches_newline: {}
          regex:
            value:
              simple: IANA_Private_Address
        operator: RegexReplace
name: Cortex XDR Alerts Handling v2
outputs: []
starttaskid: "0"
system: true
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "1"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 9c36d95d-b324-4c82-8a03-1994ede59fdf
      iscommand: false
      name: ""
      version: -1
    taskid: 9c36d95d-b324-4c82-8a03-1994ede59fdf
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 480,
          "y": 70
        }
      }
  "1":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: Incident.alerts.category
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR
          operator: isEqualString
          right:
            value:
              simple: Malware
      label: Malware
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: Incident.alerts.name
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR
          operator: isEqualString
          right:
            value:
              simple: Port Scan
      label: Port Scan
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: tags
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: containsString
          right:
            value:
              simple: DT:Identity Analytics
      label: Identity Analytics
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: event_type
                root: incident.xdralerts
          operator: containsGeneral
          right:
            value:
              simple: Cloud Audit Log
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.module_id
          operator: isEqualString
          right:
            value:
              simple: Cryptominers Protection
      label: Cloud
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: name
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: containsGeneral
          right:
            value:
              simple: Possible external RDP Brute-Force
      label: RDP Brute-Force
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: name
                filters:
                - - ignorecase: true
                    left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: isEqualString
          right:
            value:
              simple: First SSO access from ASN in organization
        - left:
            iscontext: true
            value:
              complex:
                accessor: name
                filters:
                - - ignorecase: true
                    left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: isEqualString
          right:
            value:
              simple: First successful SSO connection from a country in organization
      label: First SSO Access
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: name
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: containsString
          right:
            value:
              simple: Remote PsExec-like LOLBIN command execution from an unsigned
                non-standard PsExec service
      label: ' Remote PsExec with LOLBIN command'
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: name
                filters:
                - - ignorecase: true
                    left:
                      iscontext: true
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                    operator: isEqualString
                    right:
                      iscontext: true
                      value:
                        simple: inputs.alert_id
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: containsString
          right:
            value:
              simple: Large Upload
      label: Large Upload
    continueonerrortype: ""
    id: "1"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      ' Remote PsExec with LOLBIN command':
      - "18"
      '#default#':
      - "7"
      Cloud:
      - "11"
      First SSO Access:
      - "14"
      Identity Analytics:
      - "19"
      Large Upload:
      - "20"
      Malware:
      - "9"
      Port Scan:
      - "8"
      RDP Brute-Force:
      - "13"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Choose the playbook to run by the alert category.
      id: 3779395c-e33b-45d4-8084-c8658dfc1c7e
      iscommand: false
      name: Choose playbook by category
      type: condition
      version: -1
    taskid: 3779395c-e33b-45d4-8084-c8658dfc1c7e
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 480,
          "y": 200
        }
      }
  "5":
    continueonerrortype: ""
    id: "5"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 3ee49877-ed34-469e-8f5b-73536d3d40bd
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: 3ee49877-ed34-469e-8f5b-73536d3d40bd
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 480,
          "y": 930
        }
      }
  "7":
    continueonerrortype: ""
    id: "7"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "21"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: 73393504-1664-4f81-8baf-f5e29f222cea
      iscommand: false
      name: Other alert category
      type: title
      version: -1
    taskid: 73393504-1664-4f81-8baf-f5e29f222cea
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 2230,
          "y": 405
        }
      }
  "8":
    continueonerrortype: ""
    id: "8"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      AutoBlockIndicators:
        simple: "True"
      AutoIsolateEndpoint:
        simple: "False"
      DstIPAddress:
        complex:
          accessor: action_remote_ip
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
      DstPort:
        complex:
          accessor: action_remote_port
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
      EarlyContainment:
        simple: "True"
      EndpointID:
        complex:
          accessor: endpoint_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
              operator: containsGeneral
              right:
                value:
                  simple: port scan
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
      Initiator_CMD:
        complex:
          accessor: action_process_image_command_line
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - args:
              item:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.causality_actor_process_command_line
            operator: append
          - operator: uniq
      Initiator_Process_SHA256:
        complex:
          accessor: action_process_image_sha256
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - args:
              item:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.causality_actor_process_image_sha256
            operator: append
          - operator: uniq
      InternalIPRanges:
        complex:
          root: inputs.InternalIPRanges
      SrcHostname:
        complex:
          accessor: host_name
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - args:
              item:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.action_external_hostname
            operator: append
          - operator: uniq
      SrcIPAddress:
        complex:
          accessor: action_local_ip
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
      Username:
        complex:
          accessor: user_name
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: "The playbook investigates Cortex XDR incidents involving port
        scan alerts. The playbook is designed to run as a sub-playbook of ‘Cortex
        XDR Alerts Handling’. \n\nThe playbook consists of the following procedures:\n-
        Enrichment and investigation of the scanner and scanned hostname and IP address.\n-
        Enrichment and investigation of the initiator user, process, file, or command
        if it exists.\n- Detection of related indicators and analysis of the relationship
        between the detected indicators.\n- Utilize the detected indicators to conduct
        threat hunting.\n- Blocks detected malicious indicators.\n- Endpoint isolation.\n\nThis
        playbook supports the following Cortex XDR alert names:\n- Suspicious port
        scan\n- Port scan by suspicious process\n- Highly suspicious port scan\n-
        Port scan."
      id: a43485fb-8b99-42d3-838d-df0065c30417
      iscommand: false
      name: Cortex XDR - Port Scan - Adjusted
      playbookId: Cortex XDR - Port Scan - Adjusted
      type: playbook
      version: -1
    taskid: a43485fb-8b99-42d3-838d-df0065c30417
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 480,
          "y": 405
        }
      }
  "9":
    continueonerrortype: ""
    id: "9"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "21"
    note: false
    quietmode: 0
    scriptarguments:
      endpoint_id:
        complex:
          accessor: endpoint_id
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      file_name:
        complex:
          accessor: action_file_name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.action_file_name
              operator: in
              right:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_name
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      file_path:
        complex:
          accessor: action_file_path
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      file_sha256:
        complex:
          accessor: action_file_sha256
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.action_file_sha256
              operator: in
              right:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_sha256
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      host_ip:
        complex:
          accessor: host_ip_list
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      xdr_alert_id:
        complex:
          root: inputs.alert_id
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |
        Investigates a Cortex XDR incident containing internal malware alerts. The playbook:
        - Enriches the infected endpoint details.
        - Lets the analyst manually retrieve the malicious file.
        - Performs file detonation.

        The playbook is used as a sub-playbook in 'Cortex XDR Incident Handling - v2'.
      id: af3de00a-e938-41a9-8756-de6e561c3b20
      iscommand: false
      name: Cortex XDR - Malware Investigation
      playbookId: Cortex XDR - Malware Investigation
      type: playbook
      version: -1
    taskid: af3de00a-e938-41a9-8756-de6e561c3b20
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 1800,
          "y": 405
        }
      }
  "10":
    continueonerrortype: ""
    id: "10"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      AWS-accessKeyRemediationType:
        simple: Disable
      AWS-resourceRemediationType:
        simple: Stop
      AWS-userRemediationType:
        simple: Revoke
      Azure-resourceRemediationType:
        simple: Poweroff
      Azure-userRemediationType:
        simple: Disable
      GCP-accessKeyRemediationType:
        simple: Disable
      GCP-resourceRemediationType:
        simple: Stop
      GCP-userRemediationType:
        simple: Disable
      InternalRange:
        complex:
          root: inputs.InternalIPRanges
      ResolveIP:
        simple: "True"
      alert_id:
        complex:
          accessor: alert_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
              operator: isEqualString
              right:
                value:
                  simple: Unusual allocation of multiple cloud compute resources
          root: PaloAltoNetworksXDR.Incident.alerts
      autoAccessKeyRemediation:
        simple: "False"
      autoBlockIndicators:
        simple: "False"
      autoResourceRemediation:
        simple: "False"
      autoUserRemediation:
        simple: "False"
      cloudProvider:
        complex:
          accessor: cloud_provider
          root: PaloAltoNetworksXDR.OriginalAlert.event
      incident_id:
        complex:
          root: inputs.incident_id
      requireAnalystReview:
        simple: "True"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: "Investigates a Cortex XDR incident containing a Cloud Cryptojacking
        related alert. \nThe playbook supports AWS, Azure, and GCP and executes the
        following:\n\n- Cloud enrichment:\n   - Collects info about the involved resources\n
        \  - Collects info about the involved identities\n   - Collects info about
        the involved IPs\n- Verdict decision tree\n- Verdict handling:\n   - Handle
        False Positives\n   - Handle True Positives\n      - Cloud Response - Generic
        sub-playbook.\n- Notifies the SOC if a malicious verdict was found"
      id: cc605fa2-db11-46dd-83f6-9781e4196c61
      iscommand: false
      name: Cortex XDR - XCloud Cryptojacking
      playbookName: Cortex XDR - XCloud Cryptojacking
      type: playbook
      version: -1
    taskid: cc605fa2-db11-46dd-83f6-9781e4196c61
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -1580,
          "y": 750
        }
      }
  "11":
    continueonerrortype: ""
    id: "11"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "12"
    note: false
    quietmode: 0
    scriptarguments:
      Ids:
        simple: ${incident.xdrincidentid}
      Interval:
        simple: "1"
      PollingCommandArgName:
        simple: incident_id
      PollingCommandName:
        simple: 'xdr-get-incident-extra-data '
      Timeout:
        simple: "3"
      dt:
        simple: PaloAltoNetworksXDR.Incident.alerts.name(val.name!=='Unusual allocation
          of multiple cloud compute resources')
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: |-
        Use this playbook as a sub-playbook to block execution of the master playbook until a remote action is complete.
        This playbook implements polling by continuously running the command in Step \#2 until the operation completes.
        The remote action should have the following structure:

        1. Initiate the operation.
        2. Poll to check if the operation completed.
        3. (optional) Get the results of the operation.
      id: 0aa062ec-14be-440b-8606-a05efe27dd8f
      iscommand: false
      name: GenericPolling
      playbookId: GenericPolling
      type: playbook
      version: -1
    taskid: 0aa062ec-14be-440b-8606-a05efe27dd8f
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -1580,
          "y": 405
        }
      }
  "12":
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                accessor: name
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: containsGeneral
          right:
            value:
              simple: Unusual allocation of multiple cloud compute resources
      label: Cryptojacking
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: name
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: isEqualString
          right:
            value:
              simple: Suspicious API call from a Tor exit node
        - left:
            iscontext: true
            value:
              complex:
                accessor: name
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: isEqualString
          right:
            value:
              simple: Penetration testing tool activity
        - left:
            iscontext: true
            value:
              complex:
                accessor: name
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: isEqualString
          right:
            value:
              simple: Penetration testing tool attempt
      label: IAM User Access
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of EC2 token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of VM Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of AWS Lambda’s token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of AWS Lambda’s role
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Remote usage of an AWS service token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Remote usage of an AWS EKS token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of an AWS EKS token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of an AWS ECS token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Remote usage of an AWS ECS token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of AWS service token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Remote usage of an App engine Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of App engine Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of App engine Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of VM Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Remote usage of an App engine Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Suspicious usage of App engine Service Account token
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsGeneral
          right:
            value:
              simple: Remote usage of VM Service Account token
      label: Token Theft
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: name
                root: PaloAltoNetworksXDR.Incident.alerts
          operator: containsString
          right:
            value:
              simple: An identity performed a suspicious download of multiple cloud
                storage object
      label: Data Exfiltration
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 2736470759
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 3395838097
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 4056473708
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 3906076747
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 1696441024
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 15999229
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 624304616
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 1099928083
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 779228750
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 807956875
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 3223457282
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 17641322
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
          operator: containsString
          right:
            value:
              simple: Cryptominers Protection - 2736470759
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.agent_device_domain
          operator: containsString
          right:
            value:
              simple: compute
      label: Malicious Pod
    continueonerrortype: ""
    id: "12"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "22"
      Cryptojacking:
      - "10"
      Data Exfiltration:
      - "17"
      IAM User Access:
      - "15"
      Malicious Pod:
      - "23"
      Token Theft:
      - "16"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Checks which XCLOUD alert was found in the incident.
      id: d876d66f-ca83-4565-8c73-bfcf47d74473
      iscommand: false
      name: Which XCLOUD alert was found?
      type: condition
      version: -1
    taskid: d876d66f-ca83-4565-8c73-bfcf47d74473
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -1580,
          "y": 560
        }
      }
  "13":
    continueonerrortype: ""
    id: "13"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      Alert_Name:
        complex:
          accessor: name
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      AlertDescription:
        complex:
          accessor: description
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      AutoRemediation:
        simple: "false"
      Country:
        complex:
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts.action_country
      EndpointID:
        complex:
          accessor: endpoint_id
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      ExternalIP:
        complex:
          accessor: action_local_ip
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      Final_Threshold:
        simple: "3"
      Hostname:
        complex:
          accessor: host_name
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      IsolateEndpoint:
        simple: "false"
      Username:
        complex:
          accessor: user_name
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: "This playbook investigates a “Possible External RDP Brute Force”
        XDR Alert by gathering user, IP, and hostname information, and investigates
        if the following suspicious elements exists:\n- \"IP Reputation\" - Dbot Score
        is 2-3 \n- \"Source geolocation\" - Connection from unusual country \n-  Related
        to campaign - IP address related to campaign, based on TIM module\n-  Hunting
        results - hunt for indicators related to the source IP and the related campaign
        returned results\n-  XDR Alert search - XDR Alerts related to the same username
        and endpoint\n\nSet verdict method:\n* Suspicious Element - The \"Suspicious
        Element\" input allows you to select a specific element that, if identified
        as suspicious, the investigation's final verdict will be deemed a \"True Positive\".\n\n*
        Final Verdict -  Each suspicious element is being added to an array called
        \"Suspicious Elements\", which is used to count potential security threats.
        The array size will be compared to a final threshold. If the size is greater
        than or equal to the threshold, the investigation's final verdict will be
        deemed a \"True Positive\".\n\n* User Engagement - The \"UserEngagementThreshold\"
        input allows you to set the number of suspicious elements that trigger user
        engagement. When this threshold is met, an email will be sent to the user
        and their manager asking for authorization of RDP activity. If the RDP activity
        is not authorized by the user, the investigation's final verdict will be deemed
        a \"True Positive\".\n\nUsed Sub-playbooks:\n* Account Enrichment - Generic
        v2.1\n* Block Indicators - Generic v3\n* Cortex XDR - Get entity alerts by
        MITRE tactics - Endpoint\n* Cortex XDR - Get entity alerts by MITRE tactics
        - user\n* User Investigation - Generic\n* TIM - Indicator Relationships Analysis\n*
        Threat Hunting - Generic\n* Cortex XDR - Possible External RDP Brute Force
        - Set Verdict\n* Cortex XDR - Isolate Endpoint\n"
      id: f2999d13-c387-4ef3-8e20-c44109eec244
      iscommand: false
      name: Cortex XDR - Possible External RDP Brute-Force
      playbookId: Cortex XDR - Possible External RDP Brute-Force
      type: playbook
      version: -1
    taskid: f2999d13-c387-4ef3-8e20-c44109eec244
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 40,
          "y": 405
        }
      }
  "14":
    continueonerrortype: ""
    id: "14"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 2
    scriptarguments:
      AlertID:
        complex:
          root: inputs.alert_id
      AlertName:
        complex:
          accessor: name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      AutomaticallyBlockAccount:
        simple: "False"
      AutomaticallyIsolateEndpoint:
        simple: "False"
      ContactUserManager:
        simple: "True"
      EndpointID:
        complex:
          accessor: endpoint_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      FailedlogonFromASNThreshold:
        simple: "20"
      FailedlogonUserThreshold:
        simple: "30"
      IPAddress:
        complex:
          accessor: host_ip_list
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      LoginCountry:
        complex:
          accessor: action_country
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      NumOfXdrAlertsThreshold:
        simple: "3"
      Username:
        complex:
          accessor: user_name
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: |-
        Investigates a Cortex XDR incident containing First SSO access from ASN in an organization
         or First successful SSO connection from a country in an organization.

        The playbook executes the following:
        - IP and User Enrichment.
        - User Investigation - Using 'User Investigation - Generic' sub-playbook.
        - First SSO Access investigation - Using 'Cortex XDR - First SSO Investigation' sub-playbook.
        - Set alert's verdict - Using 'Cortex XDR - First SSO access - Set Verdict' sub-playbook.
        - Response based on the verdict.

        The playbook is used as a sub-playbook in ‘Cortex XDR Incident Handling - v3’.
      id: 14129f69-d407-4640-8114-b5548a37dbc0
      iscommand: false
      name: Cortex XDR - First SSO Access
      playbookId: Cortex XDR - First SSO Access
      type: playbook
      version: -1
    taskid: 14129f69-d407-4640-8114-b5548a37dbc0
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -400,
          "y": 405
        }
      }
  "15":
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 0
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 2
    scriptarguments:
      AWS-accessKeyRemediationType:
        simple: Disable
      AWS-resourceRemediationType:
        simple: Stop
      AWS-userRemediationType:
        simple: Revoke
      Azure-resourceRemediationType:
        simple: Poweroff
      Azure-userRemediationType:
        simple: Disable
      GCP-accessKeyRemediationType:
        simple: Disable
      GCP-resourceRemediationType:
        simple: Stop
      GCP-userRemediationType:
        simple: Disable
      alert_id:
        complex:
          root: inputs.alert_id
      autoAccessKeyRemediation:
        simple: "False"
      autoBlockIndicators:
        simple: "False"
      autoResourceRemediation:
        simple: "False"
      autoUserRemediation:
        simple: "False"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: "Investigate and respond to Cortex XDR Cloud alerts where a Cloud
        IAM user`s access key is used suspiciously to access the cloud environment.
        \nThe following alerts are supported for AWS, Azure, and GCP environments.\n-
        Penetration testing tool attempt\n- Penetration testing tool activity\n- Suspicious
        API call from a Tor exit node\n\n"
      id: f9856c2e-ccdd-4156-8173-1867d2bd48f9
      iscommand: false
      name: Cortex XDR - Cloud IAM User Access Investigation
      playbookName: Cortex XDR - Cloud IAM User Access Investigation
      type: playbook
      version: -1
    taskid: f9856c2e-ccdd-4156-8173-1867d2bd48f9
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -2420,
          "y": 750
        }
      }
  "16":
    continueonerrortype: ""
    id: "16"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      InternalRange:
        complex:
          root: inputs.InternalIPRanges
      ResolveIP:
        simple: "True"
      alert_id:
        complex:
          accessor: alert_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
              operator: inList
              right:
                value:
                  simple: Suspicious usage of EC2 token, Suspicious usage of VM Service
                    Account token, Suspicious usage of AWS Lambda’s token, Suspicious
                    usage of AWS Lambda’s role, Remote usage of an AWS service token,
                    Remote usage of an AWS EKS token, Suspicious usage of an AWS EKS
                    token, Suspicious usage of an AWS ECS token, Remote usage of an
                    AWS ECS token, Suspicious usage of AWS service token, Remote usage
                    of an App engine Service Account token, Suspicious usage of App
                    engine Service Account token, Remote usage of VM Service Account
                    token, Suspicious usage of VM Service Account token, Remote usage
                    of an App engine Service Account token, Suspicious usage of App
                    engine Service Account token
          root: PaloAltoNetworksXDR.Incident.alerts
      autoAccessKeyRemediation:
        simple: "False"
      autoBlockIndicators:
        simple: "False"
      autoResourceRemediation:
        simple: "False"
      autoUserRemediation:
        simple: "False"
      earlyContainment:
        simple: "False"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: |-
        ---

        ## Cloud Token Theft Response Playbook

        The **Cloud Token Theft Response Playbook** provides a structured and comprehensive flow to effectively respond to and mitigate alerts involving the theft of cloud tokens. The playbook supports AWS, GCP, and Azure and executes the following:

        **Cloud Enrichment:**
        - Enriches the involved resources.
        - Enriches the involved identities.
        - Enriches the involved IPs.

        **Verdict Decision Tree:**
        - Determines the appropriate verdict based on the investigation findings.

        **Early Containment using the Cloud Response - Generic Playbook:**
        - Implements early containment measures to prevent further impact.

        **Cloud Persistence Threat Hunting:**
        - Conducts threat hunting activities to identify any cloud persistence techniques.

        **Enriching and Responding to Hunting Findings:**
        - Performs additional enrichment and responds to the findings from threat hunting.

        **Verdict Handling:**
        - Handles false positives identified during the investigation.
        - Handles true positives by initiating appropriate response actions.

        ---
      id: ddd822c1-677d-4ca3-80e1-c1068539f238
      iscommand: false
      name: Cortex XDR - XCloud Token Theft Response
      playbookName: Cortex XDR - XCloud Token Theft Response
      type: playbook
      version: -1
    taskid: ddd822c1-677d-4ca3-80e1-c1068539f238
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -2000,
          "y": 750
        }
      }
  "17":
    continueonerrortype: ""
    id: "17"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 0
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      alertID:
        complex:
          accessor: alert_id
          filters:
          - - left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
              operator: containsGeneral
              right:
                value:
                  simple: An identity performed a suspicious download of multiple
                    cloud storage objects
          root: PaloAltoNetworksXDR.Incident.alerts
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      id: be0cb5ec-08ca-4334-8efd-9c7c004aa362
      iscommand: false
      name: Cortex XDR - Cloud Data Exfiltration Response
      playbookName: Cortex XDR - Cloud Data Exfiltration Response
      type: playbook
      version: -1
    taskid: be0cb5ec-08ca-4334-8efd-9c7c004aa362
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -2840,
          "y": 750
        }
      }
  "18":
    continueonerrortype: ""
    id: "18"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      AutoRemediation:
        simple: "false"
      CriticalAlertsThreshold:
        simple: "1"
      EndpointIDs:
        complex:
          accessor: endpoint_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: incident.xdralerts.name
              operator: containsString
              right:
                value:
                  simple: Remote PsExec-like LOLBIN command execution from an unsigned
          root: incident.xdralerts
      HighAlertsThreshold:
        simple: "1"
      LOLBASFeedLimit:
        simple: "100"
      SrcIPAddress:
        complex:
          accessor: actionremoteip
          root: incident.xdralerts
          transformers:
          - operator: uniq
      alerts_ids:
        complex:
          accessor: alert_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: incident.xdralerts.name
              operator: containsString
              right:
                value:
                  simple: Remote PsExec-like LOLBIN command execution from an unsigned
          root: incident.xdralerts
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: "The \"Remote PsExec-like LOLBIN Command Execution\" playbook is
        designed to address and respond to alerts indicating suspicious activities
        related to remote PsExec-like LOLBIN command execution from an unsigned non-standard
        source. \nThe playbook aims to efficiently:\n\n- Get the alert data and check
        if the execution is blocked. If not will terminate the process (manually by
        default).\n- Enrich any entities and indicators from the alert and find any
        related campaigns.\n- Perform command analysis to provide insights and a verdict
        for the executed command.\n- Perform further endpoint investigation using
        Cortex XDR.\n- Checks for any malicious verdicts found to raise the severity
        of the alert.\n- Perform automatic/manual remediation response by blocking
        any malicious indicators found.\n\nThe playbook is designed to run as a sub-playbook
        in ‘Cortex XDR Incident Handling - v3 & Cortex XDR Alerts Handling’.\nIt depends
        on the data from the parent playbooks and cannot be used as a standalone version."
      id: b31ca834-7ac6-439d-8246-59fba730f75b
      iscommand: false
      name: Cortex XDR Remote PsExec with LOLBIN command execution alert
      playbookId: Cortex XDR Remote PsExec with LOLBIN command execution alert
      type: playbook
      version: -1
    taskid: b31ca834-7ac6-439d-8246-59fba730f75b
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 920,
          "y": 405
        }
      }
  "19":
    continueonerrortype: ""
    id: "19"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      AlertName:
        complex:
          accessor: name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      AutoRemediation:
        simple: "False"
      FailedLogonThreshold:
        simple: "30"
      IAMRemediationType:
        simple: Revoke
      IPAddress:
        complex:
          accessor: host_ip_list
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      OktaSuspiciousEventsThreshold:
        simple: "5"
      RelatedAlertsThreshold:
        simple: "5"
      Username:
        complex:
          accessor: user_name
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
              operator: isEqualString
              right:
                iscontext: true
                value:
                  simple: inputs.alert_id
          root: PaloAltoNetworksXDR.Incident.alerts
      alert_id:
        simple: ${inputs.alert_id}
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: |
        The `Cortex XDR - Identity Analytics` playbook is designed to handle Cortex XDR Identity Analytics alerts and executes the following:

        Analysis:
        - Enriches the IP address and the account, providing additional context and information about these indicators.

        Verdict:
        - Determines the appropriate verdict based on the data collected from the enrichment phase.

        Investigation:
        - Checks for related Cortex XDR alerts to the user by Mitre tactics to identify malicious activity.
        - Checks for specific arguments for malicious usage from Okta using the 'Okta User Investigation' sub-playbook.
        - Checks for specific arguments for malicious usage from Azure using the 'Azure User Investigation' sub-playbook.

        Verdict Handling:
        - Handles malicious alerts by initiating appropriate response actions, including blocking malicious IP addresses and revoking or clearing user's sessions.
        - Handles non-malicious alerts identified during the investigation.

        The playbook is used as a sub-playbook in ‘Cortex XDR Alerts Handling v2’.
      id: 85150d2a-010a-4720-8926-c0f9f711a68d
      iscommand: false
      name: Cortex XDR - Identity Analytics
      playbookId: Cortex XDR - Identity Analytics
      type: playbook
      version: -1
    taskid: 85150d2a-010a-4720-8926-c0f9f711a68d
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -840,
          "y": 405
        }
      }
  "20":
    continueonerrortype: ""
    id: "20"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      Alert_ID:
        complex:
          accessor: alert_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
              operator: containsGeneral
              right:
                value:
                  simple: Large Upload
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
      AutoBlockIndicators:
        simple: "True"
      AutoIsolateEndpoint:
        simple: "False"
      BlockIndicators_UserVerification:
        simple: "False"
      EarlyContainment:
        simple: "True"
      FWApps_Processes_Whitlist:
        simple: ip,tcp,udp,ssl,syslog,quic,Chrome.exe,Firefox.exe,Opera.exe,Safari.exe,iexplore.exe,msedge.exe,brave.exe
      FurtherInvestigation:
        simple: "False"
      InternalIPRanges:
        complex:
          root: inputs.InternalIPRanges
      Transferred_Data _Threshold:
        simple: "150"
    separatecontext: true
    skipunavailable: true
    task:
      brand: ""
      description: "The playbook investigates Cortex XDR incidents involving large
        upload alerts. The playbook is designed to run as a sub-playbook of ‘Cortex
        XDR Alerts Handling v2’. \n\nThe playbook consists of the following procedures:\n-
        Searches for similar previous incidents that were closed as false positives.\n-
        Enrichment and investigation of the initiator and destination hostname and
        IP address.\n- Enrichment and investigation of the initiator user, process,
        file, or command if it exists.\n- Detection of related indicators and analysis
        of the relationship between the detected indicators.\n- Utilize the detected
        indicators to conduct threat hunting.\n- Blocks detected malicious indicators.\n-
        Endpoint isolation.\n\nThis playbook supports the following Cortex XDR alert
        names:\n- Large Upload (Generic)\n- Large Upload (SMTP)\n- Large Upload (FTP)\n-
        Large Upload (HTTPS)"
      id: 031e700e-2cbd-474c-8d78-6a7364d2e8f1
      iscommand: false
      name: Cortex XDR - Large Upload
      playbookId: Cortex XDR - Large Upload
      type: playbook
      version: -1
    taskid: 031e700e-2cbd-474c-8d78-6a7364d2e8f1
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 1360,
          "y": 405
        }
      }
  "21":
    continueonerrortype: ""
    id: "21"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: ContinueResponseForAlerts
      value:
        simple: ${inputs.alert_id}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: 173fd476-12f1-403c-839d-8087028dbf73
      iscommand: false
      name: Set Alert ID to continue with the investigation and response
      script: Set
      type: regular
      version: -1
    taskid: 173fd476-12f1-403c-839d-8087028dbf73
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 2230,
          "y": 580
        }
      }
  "22":
    continueonerrortype: ""
    id: "22"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: ContinueResponseForAlerts
      value:
        simple: ${inputs.alert_id}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: b9efc9da-9971-4e94-885f-ad668b030f3c
      iscommand: false
      name: Set Alert ID to continue with the investigation and response
      script: Set
      type: regular
      version: -1
    taskid: b9efc9da-9971-4e94-885f-ad668b030f3c
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -1160,
          "y": 750
        }
      }
  "23":
    continueonerrortype: ""
    id: "23"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "5"
    note: false
    quietmode: 0
    scriptarguments:
      AlerID:
        complex:
          accessor: alert_id
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
              operator: containsGeneral
              right:
                value:
                  simple: Cryptominers Protection
          root: PaloAltoNetworksXDR.Incident.alerts
      ClusterName:
        complex:
          accessor: cluster_name
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - operator: uniq
      Region:
        complex:
          accessor: agent_device_domain
          root: PaloAltoNetworksXDR.Incident.alerts
          transformers:
          - args:
              delimiter:
                value:
                  simple: .
              fields:
                value:
                  simple: "1"
            operator: Cut
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ""
      description: "This playbook ensures a swift and effective response to malicious
        activities within Kubernetes environments, leveraging cloud-native tools to
        maintain cluster security and integrity.\n\nThe playbook is designed to handle
        agent-generated alerts due to malicious activities within Kubernetes (K8S)
        pods, such as mining activities, which requires immediate action. The playbook
        also addresses scenarios where the malicious pod is killed, but the malicious
        K8S workload repeatedly creates new pods.\n\nKey Features:\n\n1. Trigger:
        The playbook is activated when an agent-based mining alert is detected within
        a Kubernetes pod.\n2. AWS Function Integration: Utilizes an AWS Lambda function
        to facilitate rapid response actions.\n3. K8S Environment Remediation: \n
        \   - Pod Termination: The playbook includes steps to terminate the affected
        pod within the K8S environment safely.\n    - Workload Suspension: If necessary,
        the playbook can be escalated to suspend the entire workload associated with
        the mining activity.\n\nWorkflow:\n\n1. Alert Detection: The playbook begins
        with the monitoring agent detecting a mining alert within a Kubernetes pod.\n2.
        Alert Validation: Validates the alert to ensure it is not a false positive.\n3.
        Response Decision: \n    - Pod Termination: If the mining activity is isolated
        to a single pod, the AWS Lambda function is invoked to terminate the affected
        pod within the K8S environment.\n    - Workload Suspension: If the mining
        activity is widespread or poses a significant threat, the AWS Lambda function
        suspends the entire workload within the K8S environment.\n4. Cleanup: Initiates
        a complete removal of all objects created for the Lambda execution for security
        and hardening purposes."
      id: ce90ccfb-1742-4360-8ec4-90365ea2c191
      iscommand: false
      name: Cortex XDR - Malicious Pod Response - Agent
      playbookName: Cortex XDR - Malicious Pod Response - Agent
      type: playbook
      version: -1
    taskid: ce90ccfb-1742-4360-8ec4-90365ea2c191
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": -3260,
          "y": 750
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "12_15_IAM User Access": 0.84,
      "12_16_Token Theft": 0.65,
      "12_17_Data Exfiltration": 0.9,
      "1_11_Cloud": 0.9,
      "1_14_First SSO Access": 0.86,
      "1_18_ Remote PsExec with LOLBIN command": 0.67,
      "1_19_Identity Analytics": 0.9,
      "1_20_Large Upload": 0.89,
      "1_7_#default#": 0.9,
      "1_9_Malware": 0.9
    },
    "paper": {
      "dimensions": {
        "height": 925,
        "width": 5870,
        "x": -3260,
        "y": 70
      }
    }
  }
